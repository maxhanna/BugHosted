<div class="componentMain" #componentMain>
  <div *ngIf="!user">
    <div class="closeButton" (click)="remove_me('SocialComponent');"></div>
    <div class="menuButton" (click)="showMenuPanel();"></div>
    <div class="componentTitle">Social</div>
  </div>
  <div *ngFor="let notif of notifications" [innerHTML]="notif" class="notification" (click)="notifications = []"></div> 
  <div class="socialComponent">
    <div class="notificationCounterDiv" *ngIf="showTopicSelector">
      <app-notifications [minimalInterface]="true"
                         [inputtedParentRef]="parentRef">
      </app-notifications>
    </div>
    <!-- Search -->
    <div *ngIf="showTopicSelector" class="searchSocialsButtonDiv" (click)="showSearchSocialsPanel()">
      üîç
    </div>
    <!-- Search Popup -->
    <div class="popupPanel" *ngIf="isSearchSocialsPanelOpen">
      <div>Search the Socials</div>
      <div>
        <input type="text" #search placeholder="Search the socials" (keyup.enter)="searchStories()" *ngIf="!user" />
        <input type="submit" (click)="searchStories()" value="üîç" *ngIf="!user" />
      </div>
      <div>
        <button id="closeOverlay" (click)="closeSearchSocialsPanel()">Close</button>
      </div>
    </div>

    <!-- Menu Popup -->
    <div class="popupPanel" *ngIf="isMenuPanelOpen">
      <div>Menu</div>
      <div>
        <input type="text" #search placeholder="Search the socials" (keyup.enter)="searchStories()" *ngIf="!user" />
        <input type="submit" (click)="searchStories()" value="üîç" *ngIf="!user" />
        <div (click)="searchStories()">{{userSearch}}</div>
      </div>
      <div>
        <app-topics #topicComponent
                    [isDropdown]="true"
                    [user]="parentRef?.user"
                    [parent]="parent ?? parentRef"
                    [attachedTopics]="attachedTopics"
                    (topicAdded)="onTopicAdded($event)">
        </app-topics>
        <div style="display: inline-flex; background-color:red;">
          <span *ngFor="let topic of attachedTopics" (click)="removeTopic(topic)" style="cursor: pointer" title="{{topic.topicText}} : Click to remove topic">{{topic.topicText}}</span>
        </div>
      </div>
      <div>
        <button id="closeOverlay" (click)="closeMenuPanel()">Close</button>
      </div>
    </div>

    <!-- Story Options Popup -->
    <div class="popupPanel" *ngIf="isStoryOptionsPanelOpen && optionStory"> 
      <div *ngIf="optionStory.city || optionStory.country">
        {{optionStory.city}}<span *ngIf="optionStory.country"><span *ngIf="optionStory.city">,</span> {{optionStory.country}}</span>
      </div>
      <div>
        {{formatDate(optionStory.date)}}
      </div>
      <div>
        <app-user-tag [user]="optionStory.user" [inputtedParentRef]="parentRef ?? parent"></app-user-tag>
      </div>
      <div style="display: flex;">
        <button (click)="copyLink(optionStory.id)" title="Share Link" style="display:inline-block">üìãShare</button>
        <button (click)="edit(optionStory)" *ngIf="optionStory.user?.id == parentRef?.user?.id" title="Edit Post" style="display:inline-block">
          <span class="storyEditSpans storyRejectEdit" [style.display]="isEditButtonVisible(optionStory.id) ? 'block' : 'none'" [id]="'storyRejectEditButtonSpan' + optionStory.id">‚ùå</span>
          ‚úèÔ∏èEdit
        </button>
        <button (click)="delete(optionStory)" *ngIf="optionStory.user?.id == parentRef?.user?.id || (userProfileId && userProfileId == parentRef?.user?.id)" title="Delete Post" style="display:inline-block">‚ùåDelete</button>
      </div>
      <div>
        <button id="closeOverlay" (click)="closeStoryOptionsPanel()">Close</button>
      </div>
    </div>
    <!-- Pagination -->
    <div class="pagination" *ngIf="totalPagesArray.length > 1">
      <select [value]="currentPage" (change)="pageChanged()" #pageSelect>
        <option *ngFor="let page of totalPagesArray" [value]="page">{{ page }}</option>
      </select>
    </div>

    <!-- Top Topic Selector --> 
    <div style="display: inline-flex; position: relative; right: 0px; width: CALC(100% - 36px); height: 25px; line-height: 25px; overflow-x: auto; overflow-y: hidden; align-items: center; flex-wrap: nowrap; flex-direction: row;" *ngIf="showTopicSelector">
      <span style="display:inline-block; white-space:nowrap; padding:5px; width:80px" *ngIf="showTopicSelector">Top Topics: </span>
      <span *ngFor="let topic of topTopics | slice:0:15" style="border: 1px solid black; white-space: nowrap; cursor: pointer" (click)="topTopicClicked(topic.topicName, topic.topicId)">
        {{topic.topicName}}
        <span style="font-size: xx-small;">({{topic.storyCount}})</span>
      </span>
    </div>

    <!-- Story Input -->
    <div class="storyInputDiv">
      <div>
        <textarea #story
                  placeholder="Whats on your mind ?"
                  class="foodForThought"
                  (focus)="focusInput()"></textarea>
      </div>
      <div class="mainFileUploaderAndTopicSelectorDiv">
        <button (click)="post()">üó®Ô∏è Post</button>
        <app-media-selector *ngIf="parentRef"
                            #postMediaSelector
                            [currentDirectory]="parentRef.user?.username ? 'Users/' + parentRef!.user!.username! : user?.username ? 'Users/' + user!.username! :  'Users/Anonymous'"
                            [user]="parentRef.user"
                            [inputtedParentRef]="parentRef"
                            (selectFileEvent)="selectFile($event)"></app-media-selector>
        <button>‚öôÔ∏èOptions</button>
        <span *ngIf="attachedTopics && attachedTopics.length > 0">Topic(s):</span>
        <div style="display: inline-flex;">
          <span *ngFor="let topic of attachedTopics" (click)="removeTopic(topic)" style="cursor: pointer" title="{{topic.topicText}} : Click to remove topic">{{topic.topicText}}</span>
        </div>
      </div>
    </div>

    <div id="mainTableDiv" *ngIf="storyResponse && storyResponse.stories && storyResponse.stories.length > 0">
      <div *ngFor="let story of storyResponse?.stories" [id]="'storyDiv'+story.id" class="storyContainer">
        <div class="storyHeader">
          <span style="padding-right:10px"><app-user-tag [user]="story.user" [inputtedParentRef]="parentRef ?? parent" [displayMiniTag]="true"></app-user-tag></span>
          <div class="storyDate">
            {{ daysSinceDate(story.date) }}
          </div>
          <div class="commentVoteButtons">
            <button (click)="showStoryOptionsPanel(story);" style="border:0px;"><span style="text-shadow:1px 1px 2px black; font-size:12px; cursor: pointer">‚öôÔ∏è</span></button>
          </div>
        </div>

        <div *ngIf="story && story.id"
             [class]="'storyTextContainer' + (!isExpanded('storyTextContainer'+story.id) && hasOverflow('storyTextContainer'+story.id) ? ' collapsed': '')"
             [id]="'storyTextContainer'+story.id"
             (click)="toggleCollapse('storyTextContainer'+story.id)">
          <div class="avatarDiv">
            <!--<div class="usernameProfileLink">
            <app-user-tag [user]="story.user" [inputtedParentRef]="parentRef ?? parent"></app-user-tag>
          </div>-->
          </div>
          <div class="storyContentDiv">
            <div class="storyUserDetails">
              <div class="storyText" [class]="'hidden'" [innerHtml]="story.storyText | clickableUrls" [id]="'storyText' + story.id"></div>
              <textarea [style.display]="'none'" [id]="'storyTextTextarea' + story.id">{{story.storyText}}</textarea>
              <button [style.display]="'none'" [id]="'storyTextEditConfirmButton' + story.id" (click)="editStory(story)">
                <span class="storyEditSpans storyAcceptEdit" [style.display]="'none'" [id]="'storyAcceptEditButtonSpan' + story.id">‚úîÔ∏è</span>
                ‚úèÔ∏èEdit
              </button>
            </div>
          </div>
        </div>
        <div>
          <div class="textExpanderDiv" *ngIf="!isExpanded('storyTextContainer'+story.id) && hasOverflow('storyTextContainer'+story.id)" (click)="toggleCollapse('storyTextContainer'+story.id)">
            <span class="smallExpander">
              [Expand Text]
            </span>
          </div>
          <div class="reactionTopicsAndExpanderDiv" class="reactionTopics" *ngIf="story.storyText != ''">

            <span *ngIf="story.storyTopics && story.storyTopics.length > 0">Topics : <span *ngFor="let topic of story.storyTopics" class="matchingTopic" (click)="topicComponent.selectTopic(topic)">{{topic.topicText}}</span> </span>

            <span class="reactionsSpan">
              <app-reaction [storyId]="story.id"
                            [user]="parentRef?.user"
                            [inputtedParentRef]="parentRef"
                            [currentReactions]="story.reactions"></app-reaction>
            </span>
          </div>
          <div *ngIf="story.storyFiles && story.storyFiles.length > 0" class="attachmentsDiv">
            <div *ngFor="let file of story.storyFiles" class="attachment">
              <app-media-viewer [user]="file.user"
                                [inputtedParentRef]="parentRef"
                                [currentDirectory]="file.directory"
                                [file]="file"
                                [showCommentSection]="false"
                                [displayExpander]="false"
                                [displayExtraInfo]="false"
                                [autoplay]="false"
                                [autoload]="true"
                                [forceInviewLoad]="true">
              </app-media-viewer>
            </div>
          </div>
          <div *ngIf="story.metadata" class="metadataContent">
            <div *ngIf="story.metadata.title" class="metadataTitle">{{story.metadata.title}}</div>
            <div *ngIf="story.metadata.description" class="metadataDescription" [innerHtml]="story?.metadata?.description | clickableUrls"></div>
            <div *ngIf="story.metadata.imageUrl" (click)="goToLink(story)" class="cursorPointer metaImgDiv"><img class="metadataImage" [src]="story?.metadata?.imageUrl" /></div>
          </div>
        </div>
        <app-comments *ngIf="story"
                      [inputtedParentRef]="parentRef"
                      [type]="'Social'"
                      [component_id]="story.id!"
                      [commentList]="story!.storyComments!">
        </app-comments>
      </div>
      <div class="pagination" *ngIf="totalPagesArray.length > 1">
        <span class="xxSmallFont">Page:</span>
        <select [value]="currentPage" (change)="pageChanged(2)" #pageSelect2>
          <option *ngFor="let page of totalPagesArray" [value]="page">{{ page }}</option>
        </select>
      </div>
    </div>
    <div class="mainTableDiv emptyPage" *ngIf="storyResponse && storyResponse.stories && storyResponse.stories.length == 0">
      It's quiet here...
    </div>
    <div class="mainTableDiv emptyPage" *ngIf="!storyResponse && isLoading">
      Loading...
    </div>
  </div>
  
</div>
