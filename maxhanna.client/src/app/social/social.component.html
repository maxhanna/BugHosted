<div class="componentMain" #componentMain>
  <div *ngIf="!user">
    <div class="closeButton" (click)="remove_me('SocialComponent');"></div>
    <div class="menuButton" (click)="showMenuPanel();"></div>
    <div class="componentTitle"><span>Social</span></div>
  </div>
  <div [class]="user ? 'embeddedSocialComponentsContent' : 'socialComponentContents'">
    <div class="notificationCounterDiv" *ngIf="showTopicSelector">
      <app-notifications [minimalInterface]="true"
                         [inputtedParentRef]="parentRef">
      </app-notifications>
    </div>
    <!-- Search -->
    <div *ngIf="showTopicSelector" class="searchSocialsButtonDiv" (click)="showSearchSocialsPanel()">
      üîç
    </div>
    <!-- Search Popup -->
    <div class="popupPanel" *ngIf="isSearchSocialsPanelOpen">
      <div class="popupPanelTitle">Search the Socials</div>
      <div>
        <input type="text" #search placeholder="Search the socials" (input)="debouncedSearch()" *ngIf="!user" [value]="userSearch" />
        <input type="submit" (click)="searchStories()" value="üîç" *ngIf="!user" />
      </div>
      <div>
        <button id="closeOverlay" (click)="closeSearchSocialsPanel()">Close</button>
      </div>
    </div>

    <!-- Menu Popup -->
    <div class="popupPanel" style="overflow: auto;" *ngIf="isMenuPanelOpen">

      <div class="popupPanelTitle" style="margin-bottom:15px;">
        Menu
        <button id="closeOverlay" (click)="closeMenuPanel()">Close</button>
      </div>
      <div style="display:flex;margin-bottom:15px;">
        <div>
          <app-user-tag [user]="parentRef?.user" [inputtedParentRef]="parentRef ?? parent"></app-user-tag>
        </div>
        <div style="display: flex; flex-direction: column; align-content: center; justify-content: space-around; padding-left: 15px; font-family: var(--title-font-family)">
          <div>{{city}},</div>
          <div>{{country}}</div> 
        </div>
      </div>

      <!-- search input area -->
      <div style="margin-bottom:10px;">
        <input type="text" #search placeholder="Search the socials" (input)="debouncedSearch()" *ngIf="!user" [value]="userSearch" />
        <input type="submit" (click)="searchStories()" value="üîç" *ngIf="!user" />
        <div (click)="searchStories()">
          <span *ngIf="userSearch">Current Search : </span>
          {{userSearch}}
        </div>
      </div>
      <div>
        <app-topics #topicComponent
                    [isDropdown]="true"
                    [user]="parentRef?.user"
                    [parent]="parent ?? parentRef"
                    [attachedTopics]="attachedTopics"
                    (topicAdded)="onTopicAdded($event)">
        </app-topics>
        <div style="display: inline-flex;">
          <span *ngIf="attachedTopics && attachedTopics.length > 0">Attached Topics : </span><span *ngFor="let topic of attachedTopics" (click)="removeTopic(topic)" class="matchingTopic" title="{{topic.topicText}} : Click to remove topic">{{topic.topicText}}</span>
        </div>
      </div>

      <!-- Top Topic Selector -->
      <div>
        <div class="topTopicTitle" *ngIf="showTopicSelector">
          Top Topics:
        </div>
        <span *ngFor="let topic of topTopics | slice:0:15" (click)="topTopicClicked(topic.topicName, topic.topicId)" class="topTopicsDiv">
          <span class="matchingTopic">{{topic.topicName}}</span>
          <span class="topicStoryCount">({{topic.storyCount}})</span>
        </span>
      </div>

    </div>

    <!-- Post Options Popup -->
    <div class="popupPanel" *ngIf="isPostOptionsPanelOpen">
      <div class="popupPanelTitle">
        <span>Post Options</span>
        <div>
          <button id="closeOverlay" (click)="closePostOptionsPanel()">Close</button>
        </div>
      </div>
      <div class="smallFont">
        These options affect the post created.
      </div>
      <div>
        <label>
          <input type="checkbox" (change)="eachAttachmentSeperatePost = !eachAttachmentSeperatePost" [checked]="eachAttachmentSeperatePost" />
          Each Attachment In A Seperate Post.
        </label>
        <div class="smallFont">
          Select 'Each Attachment in a Seperate Post' to create a post for every file attachment attached to this post.
        </div>
      </div>

    </div>

    <!-- Post Topics Popup -->
    <div class="popupPanel largePopupPanel" *ngIf="isMobileTopicsPanelOpen">
      <div class="popupPanelTitle">Topics <button id="closeOverlay" (click)="closeMobileTopicsPanel()">Close</button></div>
      <div style="display: inline-flex;">
        <span *ngFor="let topic of attachedTopics" (click)="removeTopic(topic)" class="matchingTopic" title="{{topic.topicText}} : Click to remove topic">{{topic.topicText}}</span>
      </div>
      <app-topics #topicComponent
                  [isDropdown]="true"
                  [user]="parentRef?.user"
                  [parent]="parent ?? parentRef"
                  [attachedTopics]="attachedTopics"
                  (topicAdded)="onTopicAdded($event)">
      </app-topics>
      <!-- Top Topic Selector -->
      <div>
        <div class="topTopicTitle" *ngIf="showTopicSelector">
          Top Topics:
        </div>
        <span *ngFor="let topic of topTopics | slice:0:15" (click)="topTopicClicked(topic.topicName, topic.topicId)" class="topTopicSpan">
          <span class="matchingTopic">{{topic.topicName}}</span>
          <span class="topicStoryCount">({{topic.storyCount}})</span>
        </span>
      </div>
    </div>

    <!-- Story Options Popup -->
    <div class="popupPanel storyOptionsPopup" *ngIf="isStoryOptionsPanelOpen && optionStory">
      <div class="popupPanelTitle" style="margin-bottom: 15px;">
        Story Options
      </div>
      <div class="storyOptionsPopupButtons" style="margin-bottom: 15px;">
        <button (click)="copyLink(optionStory.id)" title="Share Link" style="display:inline-block">üìãShare</button>

        <button (click)="edit(optionStory)" *ngIf="optionStory.user?.id == parentRef?.user?.id" title="Edit Post Text" style="display:inline-block">
          <span class="storyEditSpans storyRejectEdit" [style.display]="isEditButtonVisible(optionStory.id) ? 'block' : 'none'" [id]="'storyRejectEditButtonSpan' + optionStory.id">‚ùå</span>
          ‚úèÔ∏è Edit Text
        </button>

        <button (click)="delete(optionStory)" *ngIf="optionStory.user?.id == parentRef?.user?.id || (userProfileId && userProfileId == parentRef?.user?.id)" title="Delete Post" style="display:inline-block">‚ùåDelete</button>
      </div>

      <div class="storyOptionsStatsWrapperDiv">
        <div class="storyOptionsStatsDiv">
          <div class="storyOptionsStatsHeader">
            Story Id:
          </div>
          <div class="storyOptionsStatsDescription">
            {{optionStory.id}}
          </div>
        </div>
        <div class="storyOptionsStatsDiv">
          <div class="storyOptionsStatsHeader"> 
            <span (click)="editTopic(optionStory)"
                  *ngIf="optionStory.user?.id == parentRef?.user?.id"
                  title="Edit Post Topic"
                  class="cursorPointer">Topics ‚úèÔ∏è:</span>
          </div>
          <div class="storyOptionsStatsDescription">
            <div class="reactionTopicsAndExpanderDiv reactionTopics">
              <span *ngIf="optionStory.storyTopics && optionStory.storyTopics.length > 0 && optionStory.id">
                <span *ngFor="let topic of optionStory.storyTopics" class="matchingTopic" (click)="editingTopics.includes(optionStory.id) ? removeTopicFromStory(topic, optionStory) : topicClicked(topic);">
                  {{topic.topicText}}
                  <span title="Remove Topic From Story"
                        *ngIf="optionStory && optionStory.id && editingTopics.includes(optionStory.id)"
                        (click)="removeTopicFromStory(topic, optionStory); $event.stopPropagation()">‚ùå</span>
                </span>
              </span>
              <div *ngIf="optionStory && optionStory.id && editingTopics.includes(optionStory.id)">
                <app-topics #topicComponent
                            [isDropdown]="true"
                            [user]="parentRef?.user"
                            [parent]="parent ?? parentRef"
                            [attachedTopics]="optionStory.storyTopics"
                            (topicAdded)="editStoryTopic($event, optionStory)">
                </app-topics>
              </div>
            </div>
          </div>
        </div>
        <div class="storyOptionsStatsDiv">
          <div class="storyOptionsStatsHeader">Created By:</div>
          <div class="storyOptionsStatsDescription">
            <app-user-tag [user]="optionStory.user" [inputtedParentRef]="parentRef ?? parent" [displayMiniTag]="true"></app-user-tag>
          </div>
        </div>
        <div class="storyOptionsStatsDiv" *ngIf="optionStory.city || optionStory.country">
          <div class="storyOptionsStatsHeader">Created From:</div>
          <div class="storyOptionsStatsDescription" [title]="optionStory.city + ', ' + optionStory.country">
            {{optionStory.city}}<span *ngIf="optionStory.country"><span *ngIf="optionStory.city">,</span> {{optionStory.country}}</span>
          </div>
        </div>
        <div class="storyOptionsStatsDiv">
          <div class="storyOptionsStatsHeader">Creation Date:</div>
          <div class="storyOptionsStatsDescription" [title]="formatDate(optionStory.date)">
            {{formatDate(optionStory.date)}}
          </div>
        </div>
        <div class="storyOptionsStatsDiv" *ngIf="extractUrl(optionStory.storyText)">
          <div class="storyOptionsStatsHeader">
            Metadata URL:
          </div>
          <div class="storyOptionsStatsDescription">
            <a [href]="extractUrl(optionStory.storyText)" target="_blank" [title]="extractUrl(optionStory.storyText)">{{extractUrl(optionStory.storyText)}}</a>
          </div>
        </div>
        <div class="storyOptionsStatsDiv" *ngIf="optionStory.metadata?.title">
          <div class="storyOptionsStatsHeader">
            Metadata Title:
          </div>
          <div class="storyOptionsStatsDescription" [title]="optionStory.metadata?.title">
            {{optionStory.metadata?.title?.replace(' - YouTube', '')}}
          </div>
        </div>
        <div class="storyOptionsStatsDiv addToMusicPlaylistButtonDiv" *ngIf="optionStory.metadata?.title && isYoutubeUrl(extractUrl(optionStory.storyText))">
          <div class="storyOptionsStatsHeader">
            Save to Music Playlist:
          </div>
          <div class="storyOptionsStatsDescription">
            <button (click)="addToMusicPlaylist(optionStory, $event);" title="Save this Youtube URL to your Music Playlist">üíæSave</button>
          </div>
        </div>
      </div>

      <button id="closeOverlay" (click)="closeStoryOptionsPanel()">Close</button>
    </div>
    <!-- Pagination -->
    <div class="pagination topPagination" *ngIf="totalPagesArray.length > 1">
      <select [value]="currentPage" (change)="pageChanged()" #pageSelect>
        <option *ngFor="let page of totalPagesArray" [value]="page">{{ page }}</option>
      </select>
    </div>

    <!-- Story Input -->
    <div class="storyInputDiv">
      <div>
        <textarea #story
                  placeholder="Whats on your mind ?"
                  class="foodForThought"></textarea>
      </div>
      <div class="mainFileUploaderAndTopicSelectorDiv">
        <button (click)="post()">üó®Ô∏è Post</button>
        <app-media-selector *ngIf="parentRef"
                            #postMediaSelector
                            [currentDirectory]="parentRef.user?.username ? 'Users/' + parentRef!.user!.username! : user?.username ? 'Users/' + user!.username! :  'Users/Anonymous'"
                            [user]="parentRef.user"
                            [inputtedParentRef]="parentRef"
                            (selectFileEvent)="selectFile($event)"></app-media-selector>
        <button (click)="showPostOptionsPanel()">
          ‚öôÔ∏èOptions
          <span class="xxSmallFont" *ngIf="getOptionsCount() > 0">
            ({{getOptionsCount()}})
          </span>
        </button>
        <button class="mainTopicSelectionsHeaderButton" (click)="showMobileTopicsPanel()">
          Topics<span class="matchingTopicsInsideButtonWrapper" *ngIf="attachedTopics && attachedTopics.length > 0">
            (
            <span *ngFor="let topic of attachedTopics; let i = index"
                  class="matchingTopic"
                  title="{{topic.topicText}} : Click to remove topic">
              {{topic.topicText}}
            </span>
            )
          </span>
        </button>
      </div>
    </div>

    <!-- POST -->
    <div id="mainTableDiv" [class]="!user ? 'storyContainerWrapper' : ''" *ngIf="storyResponse && storyResponse.stories && storyResponse.stories.length > 0">
      <div *ngFor="let story of storyResponse?.stories" [id]="'storyDiv'+story.id" class="storyContainer">
        <div class="storyHeader">
          <span style="padding-right:10px" (click)="viewProfile(story.user)">
            <app-user-tag [user]="story.user" [inputtedParentRef]="parentRef ?? parent" [displayMiniTag]="true"></app-user-tag>
          </span>
          <div class="storyDate">
            {{ daysSinceDate(story.date) }}
          </div>
          <div class="commentVoteButtons">
            <button (click)="showStoryOptionsPanel(story);" style="border:0px;">
              <span style="text-shadow:1px 1px 2px black; font-size:16px; cursor: pointer">‚öôÔ∏è</span>
            </button>
            <span class="showCommentSpan" (click)="showComments(story.id)">
              üó®Ô∏è{{story.storyComments?.length}}
            </span>
            <span class="reactionsSpan">
              <app-reaction [storyId]="story.id"
                            [user]="parentRef?.user"
                            [inputtedParentRef]="parentRef"
                            [currentReactions]="story.reactions"></app-reaction>
            </span>
          </div>
        </div>

        <div *ngIf="story && story.id && (story.storyText || isEditing.includes(story.id))"
             [class]="'storyTextContainer' + (!isExpanded('storyTextContainer'+story.id) && hasOverflow('storyTextContainer'+story.id) ? ' collapsed': '')"
             [id]="'storyTextContainer'+story.id"
             (click)="toggleCollapse('storyTextContainer'+story.id)">
          <div class="storyContentDiv">
            <div class="storyText" [style.display]="isEditing.includes(story.id) ? 'none' : 'block'" [innerHtml]="getStoryTextForDOM(story)" [id]="'storyText' + story.id"></div>
            <ng-container *ngIf="openedStoryYoutubeVideos.includes(story.id)">
              <iframe [id]="'storyIframe' + story.id" [src]="story.metadata?.imageUrl" style="height:500px; width:100%;"></iframe>
            </ng-container> 

            <textarea [id]="'storyTextTextarea' + story.id" [style.width]="isEditing.includes(story.id) ? '100%' : '0'" [style.display]="isEditing.includes(story.id) ? 'block' : 'none'">{{story.storyText}}</textarea>
            <button [id]="'storyTextEditConfirmButton' + story.id" (click)="editStory(story)" [style.display]="isEditing.includes(story.id) ? 'block' : 'none'">
              <span class="storyEditSpans storyAcceptEdit" [id]="'storyAcceptEditButtonSpan' + story.id">‚úîÔ∏è</span>
              ‚úèÔ∏èEdit
            </button>
          </div>
        </div>
        <div>
          <div class="textExpanderDiv" *ngIf="!isExpanded('storyTextContainer'+story.id) && hasOverflow('storyTextContainer'+story.id)" (click)="toggleCollapse('storyTextContainer'+story.id)">
            <span class="smallExpander">
              [Expand Text]
            </span>
          </div>
          <div class="reactionTopicsAndExpanderDiv reactionTopics">
            <span *ngIf="story.storyTopics && story.storyTopics.length > 0">
              <span *ngFor="let topic of story.storyTopics" class="matchingTopic" (click)="topicClicked(topic)">
                {{topic.topicText}}
              </span>
            </span>
          </div>
          <div *ngIf="story.storyFiles && story.storyFiles.length > 0" class="attachmentsDiv">
            <div *ngFor="let file of story.storyFiles" [class]="'attachment ' + (story.storyFiles.length > 1 ? 'multipleAttachments' : 'singleAttachment')">
              <app-media-viewer [user]="file.user"
                                [inputtedParentRef]="parentRef"
                                [currentDirectory]="file.directory"
                                [file]="file"
                                [showCommentSection]="false"
                                [displayExpander]="false"
                                [displayExtraInfo]="false"
                                [autoplay]="false"
                                [autoload]="true"
                                [forceInviewLoad]="true">
              </app-media-viewer>
            </div>
          </div>
          <div *ngIf="story.metadata" class="metadataContent">
            <div *ngIf="story.metadata.title" class="metadataTitle">{{story.metadata.title}}</div>
            <div *ngIf="story.metadata.description" class="metadataDescription" [innerHtml]="story?.metadata?.description | clickableUrls"></div>
            <div *ngIf="story.metadata.imageUrl" (click)="goToLink(story)" class="cursorPointerUnderlined metaImgDiv">
              <img class="metadataImage" [src]="story?.metadata?.imageUrl" /> 
              <button class="playButtonInMetadataImage playButton" *ngIf="isValidYoutubeImageUrl(story?.metadata?.imageUrl)"></button> 
            </div>
          </div>
        </div>
        <div>
          <app-comments *ngIf="story"
                        [inputtedParentRef]="parentRef"
                        [type]="'Social'"
                        [showComments]="openedStoryComments.includes(story?.id ?? 0)"
                        [showCommentsHeader]="true"
                        [component_id]="story.id!"
                        [component]="story"
                        [commentList]="story!.storyComments!"
                        (commentAddedEvent)="commentAddedEvent($event)"
                        (commentHeaderClickedEvent)="showComments(story.id)"
                        (commentRemovedEvent)="commentRemovedEvent($event)">
          </app-comments>
        </div>

      </div>
      <div style="display: flex;">
        <div class="pagination" *ngIf="totalPagesArray.length > 1" style="position:relative; top:0; left: 0; white-space: nowrap;">
          <span class="xxSmallFont">Page:</span>
          <select [value]="currentPage" (change)="pageChanged(2)" #pageSelect2>
            <option *ngFor="let page of totalPagesArray" [value]="page">{{ page }}</option>
          </select>
        </div>
        <div class="loadMoreResultsDiv" *ngIf="totalPagesArray.length > 1 && currentPage < totalPagesArray.length">
          <button (click)="loadMorePosts()">Load More</button>
        </div>
      </div>
    </div>
    <div class="mainTableDiv emptyPage" *ngIf="storyResponse && storyResponse.stories && storyResponse.stories.length == 0">
      It's quiet here...
    </div>
    <div class="mainTableDiv emptyPage" *ngIf="!storyResponse && isLoading">
      Loading...
    </div>
  </div>
  
</div>
<button id="youtubeVideoButton" [style.visibility]="'hidden'" (click)="playYoutubeVideo()"></button>
<input type="text" id="youtubeVideoIdInput" [style.visibility]="'hidden'" />
<input type="text" id="youtubeVideoStoryIdInput" [style.visibility]="'hidden'" />
