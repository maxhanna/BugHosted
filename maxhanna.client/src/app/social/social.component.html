<div class="componentMain">
  <div *ngIf="!user">
    <div class="closeButton" (click)="remove_me('SocialComponent');"></div>
    <div class="refreshButton" (click)="ngOnInit();"></div>
    <div class="componentTitle">Social</div>
    <div *ngFor="let notif of notifications" [innerHTML]="notif" class="notification" (click)="notifications = []"></div> 
  </div>
  
  <div class="inputDiv">
    <div class="mainFileUploaderAndTopicSelectorDiv">
      <app-file-upload (userUploadEvent)="uploadInitiate();"
                       (userUploadFinishedEvent)="uploadFinished($event)"
                       (userNotificationEvent)="uploadNotification($event);"
                       (userCancelEvent)="cancelMakeDirectoryOrFile();"
                       [currentDirectory]="'Users/'+parentRef?.user?.username"
                       [user]="parentRef?.user"
                       [showPrivatePublicOption]="false">
      </app-file-upload>
      <app-topics [user]="parentRef?.user" (topicAdded)="onTopicAdded($event)"></app-topics>
    </div>
    <textarea #story
              placeholder="Food for thought"
              class="foodForThought"
              (focus)="focusInput()"></textarea>
    <button (click)="post()" class="createStoryButton">üçå Post your story</button>
    <div *ngIf="attachedFiles.length > 0"> Attached: {{attachedFiles[0].fileName}}</div>
</div> 
  <div class="inputDiv searchInputs">
    <input type="text" #search placeholder="Search" (keyup.enter)="searchStories()" />
    <input type="submit" (click)="searchStories()" class="createStoryButton" value="üîç" />
    <span (click)="revealSearchFilters = revealSearchFilters!;" class="additionalSearchFiltersSpan">(+ Additional search filters)</span>
    <div *ngIf="revealSearchFilters"></div>
  </div>
  <div class="mainTableDiv">
    <div *ngFor="let story of stories" class="storyContainer" [id]="'storyDiv'+story.id">

      <div class="commentVoteButtons">
        <button (click)="upvoteStory(story)" class="vote-button">‚¨ÜÔ∏è{{ story.upvotes }}</button>
        <button (click)="downvoteStory(story)" class="vote-button">‚¨áÔ∏è{{ story.downvotes }}</button>
      </div>
      <div class="storyUserDetails">
        <div class="storyText" [class]="'hidden'" [innerHtml]="createClickableUrls(story.storyText)"></div>
        <div class="usernameProfileLink cursorPointer" (click)="viewProfile(story.user)">{{story.user.username}} </div>
        <div class="storyDate">{{story.date?.toString()?.replace('T', '@')}}</div>
      </div>
      <div class="storyTopics" *ngIf="story.storyTopics && story.storyTopics.length > 0">
        Topics : <span *ngFor="let topic of story.storyTopics" class="chosenTopic">{{topic.topicText}}</span>
      </div>
      <div *ngIf="story.storyFiles && story.storyFiles.length > 0">
        <div>Attachments:</div>
        <div *ngFor="let file of story.storyFiles" (click)="loadFile(file.fileName, 'Users/'+story?.user?.username+'/'+file.fileName, story.id)" class="attachment">
          <span class="attachedFileSpan">üçå{{file.fileName}}</span>
          <div [id]="'attachmentContainer'+story.id+file.id" class="attachmentContainer" *ngIf="selectedAttachment == file.fileName && selectedStoryId == story.id">
            <img [src]="selectedAttachmentUrl" alt="Attachment" class="attachmentImage" *ngIf="fileType?.includes('image') && selectedAttachment == file.fileName && selectedStoryId == story.id" />
            <video [src]="selectedAttachmentUrl" controls preload="auto" autoplay class="attachmentVideo" *ngIf="fileType?.includes('video') && selectedAttachment == file.fileName && selectedStoryId == story.id"></video>
            <div *ngIf="!fileType" class="fileNotImageOrVideo">ü•∑</div>
            <div *ngIf="fileType">File type: {{fileType}}</div>
            <div *ngIf="file.user.username" (click)="viewProfile(file.user)">Uploader: <span class="usernameProfileLink cursorPointer">{{ file.user.username }}</span></div>
            <div *ngIf="file.date">Uploaded: {{file.date}}</div>
            <div *ngIf="file" (click)="download(file.fileName, story.user)" class="downloadAttachmentLink">Download</div>
          </div>
        </div>
      </div>
      <div *ngIf="story.metadata">
        <div *ngIf="story.metadata.title" class="metadataTitle">{{story.metadata.title}}</div>
        <div *ngIf="story.metadata.description" class="metadataDescription" [innerHtml]="createClickableUrls(story?.metadata?.description)"></div>
        <div *ngIf="story.metadata.imageUrl"><img class="metadataImage" [src]="story?.metadata?.imageUrl" /></div>
      </div>
      <button (click)="copyLink(story.id!)" title="Share Link" style="display:inline-block">Share üìã</button>

      <!-- Comments Section -->
      <div class="commentsSection">
        <div class="commentsHeader"
             [style.cursor]="!story.storyComments || story.storyComments.length <= 0 ? 'default' : 'pointer'">
          Comments <span *ngIf="story.storyComments">({{story.storyComments!.length}})</span>
        </div>
        <div class="commentsInputArea">
          <input type="text" placeholder="üí≠Add a comment..." [id]="'addCommentInput'+story.id" class="addCommentTextArea" (keyup.enter)="addComment(story, $event)" />
          <button type="submit" (click)="addComment(story, $event)">üó®Ô∏è</button>
        </div>
        <div class="comments-section" *ngIf="story.storyComments">
          <div *ngFor="let comment of story.storyComments!">
            <div class="commentUsername">
              <span class="usernameProfileLink cursorPointer" (click)="viewProfile(comment.user!)">{{ comment.user!.username }}</span> <span class="commentDate">({{comment.date}})</span>:
            </div>
            <div class="commentText">{{ comment.text }}</div>
            <div class="commentVoteButtons">
              <button (click)="upvoteComment(comment)" class="vote-button">‚¨ÜÔ∏è{{ comment.upvotes }}</button>
              <button (click)="downvoteComment(comment)" class="vote-button">‚¨áÔ∏è{{ comment.downvotes }}</button>
            </div>
          </div>
        </div>
      </div>
      <!-- End Comments Section -->
    </div>
  </div>
</div>
