<div class="componentMain">
  <div class="closeButton" (click)="remove_me('ChatComponent');"></div>
  <div class="refreshButton" (click)="ngOnInit();"></div>
  <div class="componentTitle">Chat {{ getCommaSeperatedGroupChatUserNames() ? 'with ' + getCommaSeperatedGroupChatUserNames() : ''}} </div>

  <app-user-list (userClickEvent)="singleUserSelected($event);"
                 (userSelectClickEvent)="userSelectClickEvent($event)"
                 (groupChatEvent)="groupChatEvent($event)"
                 [user]="parentRef?.user"
                 [class.expanded]="isPanelExpanded"
                 [displayOnlyFriends]="true"
                 [displayRadioFilters]="true"
                 [inputtedParentRef]="parentRef"
                 class="userPanel"
                 *ngIf="isPanelExpanded">
  </app-user-list>

  <div class="chatArea" [class]="isPanelExpanded ? 'expanded' : ''">
    <div *ngIf="currentChatUsers">
      <div class="chatHeader">

        <div class="pagination-controls" *ngIf="!isPanelExpanded">
          <select (change)="changePage($event)">
            <option *ngFor="let page of totalPagesArray; let i = index" [value]="i+1">{{ i+1 }}</option>
          </select>
          <span style="margin-right:10px; overflow:hidden; white-space: nowrap; text-overflow: ellipsis;">
            <span (click)="displayChatMembers()" style="cursor:pointer;">Connected With</span>
            <span *ngIf="currentChatUsers.length > 1" style="font-size:x-small; cursor: pointer" (click)="displayChatMembers()"> ({{currentChatUsers.length}})</span> :
            <span *ngFor="let chatUser of getChatUsersWithoutCurrentUser()" class="chatUserConnected" (click)="viewProfile(chatUser); $event.preventDefault();">
              <span>{{chatUser.username}}</span>
            </span>
            <span *ngIf="getChatUsersWithoutCurrentUser()?.length == 0 && (parentRef?.user?.id == selectedUser?.id || inputtedParentRef?.user?.id == selectedUser?.id)" class="chatUserConnected" (click)="viewProfile(currentChatUsers[0]); $event.preventDefault();">
              <span>{{currentChatUsers[0].username}}</span>
            </span>
          </span>
        </div>

        <button (click)="closeChat()">Back</button>
      </div>
      <div class="chatWindow" *ngIf="chatHistory" #chatWindow (scroll)="onScroll();">
        <div *ngFor="let message of chatHistory"
             [class.messageContainer]="true"
             [class.otherPersonsMessage]="message.sender.id !== (parentRef?.user?.id ?? 0)"
             [class.align-left]="message.sender.id === (parentRef?.user?.id ?? 0)"
             [class.align-right]="message.sender.id !== (parentRef?.user?.id ?? 0)">
          <!-- USER MESSAGE -->
          <ng-container *ngIf="message.sender.id === (parentRef?.user?.id ?? 0)">
            <div class="profileTag">
              <div class="usernameProfileLink">
                <app-user-tag [user]="message.sender" [inputtedParentRef]="parentRef"></app-user-tag>
              </div>
              <span class="messageTimestamp">{{ formatTimestamp(message.timestamp) }}</span>
            </div>
            <div class="messageContent">
              {{ message.content }}
              <div class="reactionDiv">
                <app-reaction [messageId]="message.id"
                              [user]="parentRef?.user"
                              [inputtedParentRef]="parentRef"
                              [currentReactions]="message.reactions"></app-reaction>
              </div>
              <div *ngFor="let file of message.files" style="{{ message.files && message.files.length > 0 ? 'margin-top: 10px' : '' }}">
                <app-media-viewer [file]="file"
                                  [currentDirectory]="file.directory"
                                  [inputtedParentRef]="parentRef"
                                  [displayExtraInfo]="false"
                                  [displayExpander]="false"
                                  [showCommentSection]="false"
                                  [user]="parentRef?.user"
                                  [autoplay]="false"
                                  [autoload]="true">
                </app-media-viewer>
              </div>
            </div>
          </ng-container>
          <!-- RECEIVER MESSAGE -->
          <ng-container *ngIf="message.sender.id !== (parentRef?.user?.id ?? 0)">
            <div class="messageContent ">
              {{ message.content }}
              <div class="otherPersonsReactionDiv">
                <app-reaction [messageId]="message.id"
                              [user]="parentRef?.user"
                              [inputtedParentRef]="parentRef"
                              [currentReactions]="message.reactions"></app-reaction>
              </div>
              <div *ngFor="let file of message.files">
                <div class="attachmentMedia">
                  <app-media-viewer [file]="file"
                                    [currentDirectory]="file.directory"
                                    [inputtedParentRef]="parentRef"
                                    [displayExtraInfo]="false"
                                    [displayExpander]="false"
                                    [showCommentSection]="false"
                                    [user]="parentRef?.user"
                                    [autoplay]="false"
                                    [autoload]="true">
                  </app-media-viewer>
                </div>
              </div>
            </div>
            <div class="profileTag">
              <div class="usernameProfileLink">
                <app-user-tag [user]="message.sender" [inputtedParentRef]="parentRef"></app-user-tag>
              </div>
              <span class="messageTimestamp">{{ formatTimestamp(message.timestamp) }}</span>
            </div>
          </ng-container>
        </div>
        <div *ngIf="(!chatHistory  || chatHistory.length == 0 ) && !isLoading">
          ZZzzz. Empty chat!
        </div>
        <div *ngIf="(!chatHistory  || chatHistory.length == 0 ) && isLoading">
          Loading chat...
        </div>
      </div>
      <div class="messageInput">
        <input placeholder="Type a message" #newMessage (keydown.enter)="sendMessage()" />
        <button (click)="sendMessage()">üó®Ô∏èSend</button>
        <div>
          <app-media-selector #attachmentSelector
                              [currentDirectory]="'Users/' + (parentRef?.user && parentRef?.user?.id != 0 ? parentRef?.user?.username : 'Anonymous')"
                              [user]="parentRef?.user"
                              [inputtedParentRef]="parentRef"
                              (selectFileEvent)="selectFile($event)">
          </app-media-selector>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Chat Members Popup -->
<div class="popupPanel" *ngIf="isDisplayingChatMembersPanel">
  <div class="popupPanelTitle">
    <span>Chat Members</span>
    <div>
      <button id="closeOverlay" (click)="closeChatMembersPanel()">Close</button>
    </div>
  </div>
  <div style="margin-top: 15px; min-height:100px; overflow:auto;">
    <div *ngFor="let chatMember of currentChatUsers">
      <app-user-tag [user]="chatMember" [inputtedParentRef]="parentRef ?? inputtedParentRef" [displayMiniTag]="true"></app-user-tag>
    </div>
  </div>
  <div style="width: 100%; margin-top: 5px; text-align: center; max-height: 250px; overflow: auto">
    Add Chat Member(s) :
    <div style="max-height:200px; width: 100%; overflow:auto; display: inline;">
      <app-user-list [searchOnly]="true" [inputtedParentRef]="inputtedParentRef ?? parentRef" (groupChatEvent)="addChatMember($event)"></app-user-list>
    </div>
  </div>
</div>
 
