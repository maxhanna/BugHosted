<div class="componentMain">
  <div class="closeButton" (click)="remove_me('ChatComponent');"></div>
  <div class="refreshButton" (click)="ngOnInit();"></div>
  <div class="componentTitle">Chat</div>


  <app-user-list (userClickEvent)="openChat($event);"
                 [user]="parentRef?.user!"
                 [chatNotifications]="notifications"
                 [class.expanded]="isPanelExpanded"
                 class="userPanel"
                 *ngIf="isPanelExpanded">
  </app-user-list>

  <div class="chatArea" [class]="isPanelExpanded ? 'expanded' : ''">
    <div *ngIf="currentChatUser">
      <div class="chatHeader">
        <span style="margin-right:10px;">Chat with <span class="usernameProfileLink cursorPointer" (click)="viewProfile(currentChatUser);">{{ currentChatUser.username }}</span></span>
        <button (click)="closeChat()">Close Chat with {{ currentChatUser.username }}</button>
      </div>
      <div class="chatWindow" *ngIf="chatHistory" #chatWindow (scroll)="onScroll();">
        <div *ngFor="let message of chatHistory" [class]="{'align-left': message.sender.id === parentRef?.user!.id, 'align-right': message.sender.id !== parentRef?.user!.id, 'messageContainer': true}"> 
          <!-- USER MESSAGE -->
          <ng-container *ngIf="message.sender.id === parentRef?.user!.id">
            <div class="profileTag" (click)="viewProfile(message.sender)">
              <div class="usernameProfileLink">
                <app-user-tag [user]="message.sender"></app-user-tag>
              </div>
              ({{ formatTimestamp(message.timestamp) }})
            </div>
            <div class="messageContent">
              {{ message.content }}
              <app-reaction [messageId]="message.id" [user]="parentRef?.user" [currentReactions]="message.reactions"></app-reaction>
            </div>
          </ng-container>
          <!-- RECEIVER MESSAGE -->
          <ng-container *ngIf="message.sender.id !== parentRef?.user!.id">
            <div class="messageContent">
              {{ message.content }}
              <app-reaction [messageId]="message.id"
                            [user]="parentRef?.user"
                            [currentReactions]="message.reactions"></app-reaction>
            </div>
            <div class="profileTag" (click)="viewProfile(message.sender)">
              <div class="usernameProfileLink">
                <app-user-tag [user]="message.sender"></app-user-tag>
              </div>
              ({{ formatTimestamp(message.timestamp) }})
            </div>
          </ng-container>
        </div>

        <div *ngIf="(!chatHistory  || chatHistory.length == 0 ) && !isLoading">
          ZZzzz. Empty chat!
        </div>
        <div *ngIf="(!chatHistory  || chatHistory.length == 0 ) && isLoading">
          Loading chat...
        </div>
      </div>
      <div class="messageInput">
        <input placeholder="Type a message" #newMessage (keydown.enter)="sendMessage()" />
        <button (click)="sendMessage()">✉️</button>
      </div>
    </div>

  </div>
</div>
