<div class="componentMain" #componentMain>
  <div class="closeButton" [class.visually-hidden-operable]="user" (click)="remove_me('MusicComponent');"></div>
  <div class="menuButton" (click)="showMenuPanel();" [class.visually-hidden-operable]="user"></div>
  <div class="helpButton" [class.visually-hidden-operable]="user" (click)="openHelpPanel()"></div>
  <div class="componentTitle" [class.visually-hidden-operable]="user">Music</div>

  <fieldset [class.visually-hidden-operable]="user">
    <legend title="Add to the music list">Add to the music list</legend>
    <div class="addSongInputFieldset">
      <input type="text" #titleInput placeholder="Artist - Song Title" (keyup.enter)="addSong()" />
      <input type="text" #urlInput placeholder="URL" (keyup.enter)="addSong()" />
      <app-media-selector #mediaSelector
        [currentDirectory]="'Users/' + (parentRef?.user && parentRef?.user?.id != 0 ? parentRef?.user?.username : 'Anonymous')"
        [user]="parentRef?.user" 
        [inputtedParentRef]="parentRef" 
        [maxSelectedFiles]="1" 
        [uploadButtonText]="''"
        (expandFileSelectorEvent)="refreshDom()"
        (selectFileEvent)="selectFile($event)"></app-media-selector>
      <input type="submit" value="ğŸ’¾" (click)="addSong()" />
    </div>
  </fieldset> 
  <div id="musicPlayerDiv" [class]="smallPlayer ? 'smallSongList' : 'normalSongList'">
    <div id="iframeDiv" [class]="playerClasses">
      
      <div class="yt-box">
        <div id="musicVideo" #musicVideo></div>
      </div>

      <app-media-viewer
        #fileMediaViewer
        [class.file-active]="fileIdPlaying"
        [class.file-inactive]="!fileIdPlaying"
        [inputtedParentRef]="parentRef"
        [autoplay]="true"
        [autoload]="true"
        [loop]="false"
        [muted]="false"
        [showTopics]="false"
        [showCommentSection]="false"
        [previousComponent]="'Music'"
        [displayLoading]="true"
        (mediaEndedEvent)="mediaEndedEvent()"
        (finishedLoadingEvent)="mediaViewerFinishedLoading()">
      </app-media-viewer>
      <button title="Shrink Fullscreen" (click)="closeFullscreen()" id="closeOverlay" [class.visually-hidden-operable]="!isFullscreen">Shrink</button>
    </div>
    <div class="musicControls">
      <label id="stopMusicButton" (click)="stopMusic()" title="Stop">ğŸ›‘</label>
      <label id="fullscreenMusicButton" (click)="fullscreen()" title="Expand Fullscreen">â—¼</label>
      <label id="followLinkButton" [class.visually-hidden-operable]="fileIdPlaylist" (click)="followLink()" title="Open in Youtube">ğŸ•¸</label>
      <label (click)="randomSong()" title="Random Song">âš¡</label>
    </div>

    <div id="songlist">
      <div class="collapsible-header" (click)="toggleSongList()">
        Total: ({{songs.length}})
        <span class="collapse-icon">{{ isSongListCollapsed ? 'â–¼' : 'â–²' }}</span>
      </div>
      <div [class.visually-hidden-operable]="isSongListCollapsed">
        <div style="width:100%; text-align:center;">
          Order: <select id="orderSelect" (change)="reorderTable($event)" #orderSelect>
            <option *ngFor="let order of orders" [value]="order">{{order}}</option>
          </select><br />
          Search: <input placeholder="Keyword" #searchInput (input)="onSearchEnter()" />
          <input type="submit" value="ğŸ”" title="Search Music Playlist" (click)="searchForSong()" />
          <input type="submit" value="â–¶ï¸" title="Search YouTube" (click)="showYoutubeSearch()" [class.visually-hidden-operable]="selectedType != 'youtube'" />
        </div>
        <div class="musicTypeSelector">
          <label class="smallFont">
            <input type="radio" name="songType" (click)="selectType('youtube')" [checked]="selectedType == 'youtube'" />
            YouTube
          </label>
          <label class="smallFont">
            <input type="radio" name="songType" (click)="selectType('file')" [checked]="selectedType == 'file'" />
            Files
          </label>
          <label class="smallFont">
            <input type="radio" name="songType" (click)="selectType('radio')" [checked]="selectedType == 'radio'" />
            Radio
          </label>
        </div>
        <div class="mainTableContainer">
          <!-- Radio Stations View -->
          <div [class.visually-hidden-operable]="selectedType !== 'radio'" class="radioStationsContainer">
            <div class="radioFilters">
              <select (change)="onRadioFilterChange('country', $event)" class="radioFilterSelect">
                <option value="">All Countries</option>
                <option *ngFor="let country of radioCountries" [value]="country.name">{{country.name}} ({{country.stationcount}})</option>
              </select>
              <select (change)="onRadioFilterChange('language', $event)" class="radioFilterSelect">
                <option value="">All Languages</option>
                <option *ngFor="let lang of radioLanguages" [value]="lang.name">{{lang.name}} ({{lang.stationcount}})</option>
              </select>
              <select (change)="onRadioFilterChange('tag', $event)" class="radioFilterSelect">
                <option value="">All Genres</option>
                <option *ngFor="let tag of radioTags" [value]="tag.name">{{tag.name}} ({{tag.stationcount}})</option>
              </select>
            </div>
            <div class="radioStationsList" [class.visually-hidden-operable]="!radioStations || radioStations.length === 0">
              <div *ngFor="let station of radioStations" class="radioStationItem" (click)="playRadioStation(station)">
                <img [class.visually-hidden-operable]="!station.favicon" [src]="station.favicon" class="radioStationIcon" (error)="station.favicon = null" />
                <div class="radioStationInfo">
                  <div class="radioStationName">{{station.name}}</div>
                  <div class="radioStationDetails smallFont">
                    <span [class.visually-hidden-operable]="!station.country">{{station.country}}</span>
                    <span [class.visually-hidden-operable]="!station.language"> â€¢ {{station.language}}</span>
                    <span [class.visually-hidden-operable]="!station.tags"> â€¢ {{station.tags}}</span>
                  </div>
                </div>
                <button class="radioPlayButton" (click)="playRadioStation(station); $event.stopPropagation()">â–¶ï¸</button>
              </div>
            </div>
            <div [class.visually-hidden-operable]="!isLoadingRadio" style="text-align: center; padding: 20px;">Loading radio stations...</div>
            <div [class.visually-hidden-operable]="isLoadingRadio || (radioStations && radioStations.length > 0)" style="text-align: center; padding: 20px;">
              No radio stations found. Try different filters.
            </div>
          </div>

          <!-- YouTube/Files Table -->
          <table id="songListTable" [class]="isEditing.length ? '' : 'mainTable'" id="todoTable" [class.visually-hidden-operable]="selectedType === 'radio' || !(paginatedSongs && paginatedSongs.length > 0)">
            <tbody>
              <tr *ngFor="let song of paginatedSongs; trackBy: trackSong" id="songId{{song.id!}}" [class]="isEditing.length > 0 ? 'popupPanel' : ''">
                <td [class.visually-hidden-operable]="!song.id" [style.width]="isEditing.length > 0 ? '' : '100%'">
                  <span [class.visually-hidden-operable]="isEditing.length > 0" class="songTitle" (click)="play(song.url, song.fileId)" >{{song.todo}}</span>
                  <div [class.visually-hidden-operable]="!isEditing.length" class="popupPanelTitle">Edit Song</div>
                  <div>
                    <span [class.visually-hidden-operable]="!isEditing.length">Title:&nbsp;</span>
                    <textarea 
                      type=text 
                      id="editSongNameInput" 
                      [class.visually-hidden-operable]="!isEditing.length" 
                      [value]="song.todo" 
                      style="width:100%"
                      (click)="$event.stopPropagation()" 
                      (mousedown)="$event.stopPropagation()"
                      (input)="hasEditedSong = true;"></textarea>
                  </div>
                  <div>
                    <span [class.visually-hidden-operable]="!isEditing.length">Url:&nbsp;</span>
                    <textarea 
                    type=text 
                    id="editSongUrlInput" 
                      [class.visually-hidden-operable]="!isEditing.length" 
                      [value]="song.url" 
                      style="width:100%" 
                      (click)="$event.stopPropagation()" 
                      (mousedown)="$event.stopPropagation()"
                      (input)="hasEditedSong = true;"></textarea>
                  </div> 
                </td>
                <td class="actionTd" [class.visually-hidden-operable]="user || !song.id">
                  <button (click)="editSong(song.id)" class="xxSmallFont cursorPointer" [class.visually-hidden-operable]="isEditing.length">
                    {{ (isEditing.length > 0) ? 'ğŸ’¾':'âœï¸'}}
                  </button> 
                  <button 
                    (click)="closeEditPopup()" 
                    [title]="'Edit'" 
                    class="cursorPointer closeButton"
                    [class.hidden-operable]="(isEditing.length > 0) ? false : true" 
                    id="closeOverlay">
                    ğŸ’¾Update
                  </button>
                  <button (click)="deleteSong(song.id)" class="cursorPointer" [class.visually-hidden-operable]="!isEditing.length">âŒDelete</button>
                </td>
              </tr>
            </tbody>
          </table> 
          <div [class.visually-hidden-operable]="!isShowingYoutubeSearch" class="popupPanel">
            <app-youtube-search 
            [inputtedParentRef]="inputtedParentRef ?? parentRef" 
            [keyword]="ytSearchTerm"
            (selectVideoEvent)="selectYoutubeVideoEvent($event)"></app-youtube-search>
            <button id="closeOverlay" (click)="closeYoutubeSearch()" style="margin-top:10px;">Close</button>
          </div> 
        </div> 
        <div [class.visually-hidden-operable]="selectedType === 'radio' || !(paginatedSongs && paginatedSongs.length > 0)" class="extraMainDataInfo">
          <span [class.visually-hidden-operable]="!(paginatedSongs && paginatedSongs.length == 0)">No music added yet!</span>
          <button (click)="showYoutubeSearch()">Search Youtube</button>
        </div> 
      </div>
    </div> 
  </div>
      <div class="pagination-controls" [class.visually-hidden-operable]="songs.length <= itemsPerPage">
        <button [disabled]="currentPage === 1" (click)="goToPreviousPage()" class="pagination-button">
          Previous
        </button>
        <span class="pagination-info">
          Page {{ currentPage }} of {{ totalPages }}
        </span>
        <button [disabled]="currentPage === totalPages" (click)="goToNextPage()" class="pagination-button">
          Next
        </button>
        <button (click)="scrollToTop()" class="pagination-button">
          Scroll Up
        </button>
      </div>
</div>

<!-- Help Popup -->
<div class="popupPanel" [hidden]="!showHelpPopup">
  <div class="popupPanelTitle" style="margin-bottom:15px;">
    Music Player Help
  </div>
  <div class="helpContent">
    <h3>ğŸµ Music Player Features</h3>

    <h4>ğŸ”¹ Adding Songs</h4>
    <p>To add songs to your playlist:</p>
    <ol>
      <li>Enter the song title in format "Artist - Song Title"</li>
      <li>Either:
        <ul>
          <li>Paste a YouTube URL, OR</li>
          <li>Upload an audio file using the media selector</li>
        </ul>
      </li>
      <li>Click the ğŸ’¾ save button or press Enter</li>
    </ol>

    <h4>ğŸ”¹ Playing Music</h4>
    <ul>
      <li>Click any song in the list to play it</li>
      <li>YouTube videos will play in the embedded player</li>
      <li>Uploaded files will play in the audio player</li>
      <li>Click â—¼ to stop playback</li>
      <li>Click ğŸ›‘ to stop playback</li>
      <li>Click âš¡ to play a random song</li>
      <li>Click ğŸ•¸ to open the current YouTube video in a new tab</li>
    </ul>

    <h4>ğŸ”¹ Managing Your Playlist</h4>
    <ul>
      <li><strong>Edit:</strong> Click âœï¸ to edit a song title, then ğŸ’¾ to save</li>
      <li><strong>Delete:</strong> Click âŒ to remove a song</li>
      <li><strong>Search:</strong> Use the search box to find specific songs</li>
      <li><strong>Sort:</strong> Change the order using the dropdown:
        <ul>
          <li>Newest/Oldest - by added date</li>
          <li>Alphanumeric - A-Z or Z-A</li>
          <li>Random - shuffle your playlist</li>
        </ul>
      </li>
    </ul>

    <h4>ğŸ”¹ View Options</h4>
    <ul>
      <li>Click the header to collapse/expand the song list</li>
      <li>Toggle between YouTube and File songs using the radio buttons</li>
      <li>Use pagination controls when you have more than 50 songs</li>
    </ul>

    <h4>ğŸ”¹ Playback Features</h4>
    <ul>
      <li>YouTube videos will automatically play the rest of your playlist</li>
      <li>Uploaded files will play sequentially through your file list</li>
      <li>The player will automatically advance to the next song</li>
    </ul>

    <p class="note">Note: You must be logged in to add or edit songs.</p>
  </div>
  <button id="closeOverlay" class="closeButton" (click)="closeHelpPanel()" style="margin-top:6px;">Close</button>
</div>
<!-- Music Menu Popup -->
<div class="popupPanel" style="overflow: auto;" [hidden]="!isMenuPanelOpen">
  <div class="popupPanelTitle">Music</div>
  <div class="popupPanelContents gradientBackground" style="padding:10px;">
    <app-daily-music [inputtedParentRef]="inputtedParentRef ?? parentRef"></app-daily-music>
  </div>
  <button id="closeOverlay" class="closeButton" (click)="closeMenuPanel()">Close</button>
</div>