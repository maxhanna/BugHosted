<div class="componentMain">
    <div class="closeButton" (click)="remove_me('MastermindComponent')"></div>
    <div class="menuButton" (click)="showMenuPanel();"></div>
    <div class="componentTitle">Mastermind</div>

    <!-- Game Explanation & Start Button -->
    <div *ngIf="!gameStarted && !gameOver && !isLoading" class="game-explanation gradientBackground" style="margin:18px 0 24px 0;padding:16px;border-radius:8px;border:1px solid #e0e0e0;box-shadow:0 2px 8px rgba(0,0,0,0.04);">
        <b>How to Play Mastermind:</b><br>
        Try to guess the secret color code! Each guess gives feedback:<br>
        <ul style="margin:8px 0 0 18px;">
            <li><b>Black</b> peg: Correct color in the correct position.</li>
            <li><b>White</b> peg: Correct color, wrong position.</li>
        </ul>
        Crack the code in as few tries and as little time as possible.<br>
        <i>Choose your difficulty below and start the game!</i>
        <div class="difficulty-picker" style="margin:18px 0;">
            <label for="difficulty" style="font-weight:500;margin-right:8px;">Difficulty:</label>
            <select #difficultyDropdown id="difficulty" (change)="onDifficultyChange($event)">
                <option value="easy" [selected]="selectedDifficulty === 'easy'">Color Sleuth (Easy)</option>
                <option value="medium" [selected]="selectedDifficulty === 'medium'">Cipher Master (Medium)</option>
                <option value="hard" [selected]="selectedDifficulty === 'hard'">Quantum Enigma (Hard)</option>
            </select>
        </div>
        <button (click)="startNewGame()" style="margin-top:10px;">Start Game</button>
    </div>
    <div *ngIf="isLoading">Loading...</div>
    <div *ngIf="gameOver">
        <div *ngIf="gameWon" class="win">You cracked the code!</div>
        <div *ngIf="!gameWon" class="lose">
            Out of tries! The code was:
            <span *ngFor="let c of sequence" [style.background]="c" class="peg">{{c}}</span>
        </div>
        <button (click)="startNewGame()">Play Again</button>
    </div>
    <div *ngIf="gameStarted && !gameOver && !isLoading">
        <div>Tries left: {{triesLeft}}</div>
        <div class="guess-row" style="display: flex; gap: 12px; margin-bottom: 12px;">
            <span *ngFor="let color of currentGuess; let i = index">
                <span class="color-square selectable-peg" (click)="cycleColor(i)"
                            [style.background]="color || '#eee'"
                            [style.border]="color ? '2px solid ' + color : '2px dashed #aaa'"
                            style="width:40px;height:40px;display:inline-block;cursor:pointer;vertical-align:middle;text-align:center;line-height:40px;font-size:22px;border-radius:6px;box-shadow:0 1px 4px rgba(0,0,0,0.08);">
                    <span *ngIf="!color" style="color:#888;">?</span>
                </span>
            </span>
            <button (click)="submitGuess()" style="margin-left:16px;">Submit</button>
            <button (click)="exitGame()" style="margin-left:16px;background:#f8d7da;color:#721c24;border:1px solid #f5c6cb;">Exit Game</button>
        </div>
    </div>
    <div class="guesses">
        <div *ngFor="let guess of guesses; let i = index" class="guess-row">
            <span *ngFor="let c of guess.colors" [style.background]="c" class="peg"></span>
            <span class="feedback">Black: {{guess.feedback.black}}, White: {{guess.feedback.white}}</span>
        </div>
    </div> 
</div>

<!-- Menu Popup -->
<div class="popupPanel mmPopup" *ngIf="isMenuPanelOpen">
    <div class="popupPanelTitle popupPanelContents" style="margin-bottom:15px;">
        Mastermind Menu
    </div>
    <div class="popupPanelContents">
        <div class="popupPanelTitle">
            Best Scores:
        </div>
        <div *ngIf="bestScores && bestScores.length > 0">
            <table class="scoreTable">
                <thead>
                    <tr>
                        <th>User</th>
                        <th>Score</th>
                        <th>Tries</th>
                        <th>Time</th>
                    </tr>
                </thead>
                <tbody>
                    <tr *ngFor="let score of bestScores">
                        <td>
                            <app-user-tag [userId]="score.userId" [displayMiniTag]="true" [inputtedParentRef]="parentRef">
                            </app-user-tag>
                        </td>
                        <td>{{score.score}}</td>
                        <td>{{score.tries}}</td>
                        <td>{{score.time}}</td>
                    </tr>
                </tbody>
            </table>
        </div>
        <div *ngIf="!bestScores || bestScores.length === 0">No scores yet!</div>
    </div>
    <button id="closeOverlay" (click)="closeMenuPanel()" class="closeButton">Close</button>
</div>