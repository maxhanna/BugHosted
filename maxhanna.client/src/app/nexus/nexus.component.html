<div class=componentMain>
  <div class="closeButton" (click)="remove_me('NexusComponent');"></div>
  <div class="refreshButton" (click)="ngOnInit();"></div>
  <div class="componentTitle">War</div>


  <div *ngIf="!isUserComponentOpen && parentRef && parentRef.user && isUserNew">
    Welcome to Nexus wars.
    <button (click)="start()">Enter the fight</button>
  </div>

  <div class="gamescreen" [style.display]="!isUserNew ? 'block':'none'">
    <div>
      <span title="Gold" class="resourceSpan">ü™ô:{{ goldAmount | number:'1.2-2' }}</span>
      <span title="Supply Capacity" class="resourceSpan" *ngIf="nexusBase">üë§:{{calculateCurrentSupply()}}</span>
      <span title="Nexus location" class="resourceSpan">üìç:{{'{' + currentBaseLocationX + ',' + currentBaseLocationY + '}'}}</span>
    </div>

    <div class="mapComponentDiv" #mapComponentDiv *ngIf="parentRef && parentRef.user">
      <app-nexus-map #mapComponent [user]="parentRef.user"></app-nexus-map> 
    </div>


    <div class="nexusBackground" *ngIf="nexusBackgroundPicture" [style.display]="!isMinesOpen && !isWarehouseOpen && !isEngineeringBayOpen && !isCommandCenterOpen && !isSupplyDepotOpen && !isFactoryOpen && !isMinesOpen && !isStarportOpen && !isMapOpen ? 'block' : 'none' ">
      <app-media-viewer [file]="nexusBackgroundPicture"
                        [currentDirectory]="nexusBackgroundPicture.directory"
                        [inputtedParentRef]="parentRef"
                        [displayExtraInfo]="false"
                        [showCommentSection]="false"
                        [user]="parentRef?.user"
                        [autoplay]="true"
                        [displayExpander]="false">
      </app-media-viewer>
    </div>
    <div [style.display]="!isMinesOpen && !isCommandCenterOpen && !isSupplyDepotOpen && !isFactoryOpen && !isMinesOpen && !isStarportOpen && !isWarehouseOpen && !isEngineeringBayOpen && !isMapOpen && nexusBase ? 'block' : 'none'">
      <div class="building">
        <div class="commandCenter buildingPicture" *ngIf="commandCenterPicture" (click)="openCommandCenter()" title="Command Center">
          <app-media-viewer [file]="commandCenterPicture"
                            [currentDirectory]="commandCenterPicture.directory"
                            [inputtedParentRef]="parentRef"
                            [displayExtraInfo]="false"
                            [showCommentSection]="false"
                            [user]="parentRef?.user"
                            [autoplay]="true"
                            [displayExpander]="false">
          </app-media-viewer>
        </div>
        <span class="levelLabel commandCenterLevelDisplay" *ngIf="nexusBase">
          {{nexusBase.commandCenterLevel ? nexusBase.commandCenterLevel : ''}}
          <span class="timerLabel">
            {{getBuildingTimerForBuilding("command_center") ? formatTimer(getBuildingTimerForBuilding("command_center").endTime) : ''}}
          </span>
        </span>
      </div>

      <div class="building" [style.display]="displayMines ?  'block' : 'none'">
        <div class="buildingPicture mines" *ngIf="minesPicture" (click)="openMines();" title="Mines">
          <app-media-viewer [file]="minesPicture"
                            [currentDirectory]="minesPicture.directory"
                            [inputtedParentRef]="parentRef"
                            [displayExtraInfo]="false"
                            [showCommentSection]="false"
                            [user]="parentRef?.user"
                            [autoplay]="true"
                            [displayExpander]="false">
          </app-media-viewer>
        </div>
        <span class="levelLabel minesLevelDisplay" *ngIf="nexusBase">
          {{nexusBase.minesLevel ? nexusBase.minesLevel : ''}}
          <span class="timerLabel">
            {{getBuildingTimerForBuilding("mines") ? formatTimer(getBuildingTimerForBuilding("mines").endTime) : ''}}
          </span>
        </span>
      </div>


      <div class="building" [style.visibility]="displayEngineeringBay ?  'visible' : 'hidden'">
        <div class="buildingPicture engineeringBay" *ngIf="engineeringBayPicture" (click)="openEngineeringBay();" title="Engineering Bay">
          <app-media-viewer [file]="engineeringBayPicture"
                            [currentDirectory]="engineeringBayPicture.directory"
                            [inputtedParentRef]="parentRef"
                            [displayExtraInfo]="false"
                            [showCommentSection]="false"
                            [user]="parentRef?.user"
                            [autoplay]="true"
                            [displayExpander]="false">
          </app-media-viewer>
        </div>
        <span class="levelLabel engineeringBayLevelDisplay" *ngIf="nexusBase">
          {{nexusBase.engineeringBayLevel ? nexusBase.engineeringBayLevel : ''}}
          <span class="timerLabel">
            {{getBuildingTimerForBuilding("engineering_bay") ? formatTimer(getBuildingTimerForBuilding("engineering_bay").endTime) : ''}}
          </span>
        </span>
      </div>


      <div class="building" [style.visibility]="displayWarehouse ?  'visible' : 'hidden'">
        <div class="buildingPicture warehouse" *ngIf="warehousePicture" (click)="openWarehouse();" title="Warehouse">
          <app-media-viewer [file]="warehousePicture"
                            [currentDirectory]="warehousePicture.directory"
                            [inputtedParentRef]="parentRef"
                            [displayExtraInfo]="false"
                            [showCommentSection]="false"
                            [user]="parentRef?.user"
                            [autoplay]="true"
                            [displayExpander]="false">
          </app-media-viewer>
        </div>
        <span class="levelLabel warehouseLevelDisplay" *ngIf="nexusBase">
          {{nexusBase.warehouseLevel ? nexusBase.warehouseLevel : ''}}
          <span class="timerLabel">
            {{getBuildingTimerForBuilding("warehouse") ? formatTimer(getBuildingTimerForBuilding("warehouse").endTime) : ''}}
          </span>
        </span>
      </div>

      <div class="building" [style.visibility]="displayFactory ?  'visible' : 'hidden'">
        <div class="buildingPicture factory" *ngIf="factoryPicture" (click)="openFactory()" title="Factory">
          <app-media-viewer [file]="factoryPicture"
                            [currentDirectory]="factoryPicture.directory"
                            [inputtedParentRef]="parentRef"
                            [displayExtraInfo]="false"
                            [showCommentSection]="false"
                            [user]="parentRef?.user"
                            [autoplay]="true"
                            [displayExpander]="false">
          </app-media-viewer>
        </div>
        <span class="levelLabel factoryLevelDisplay" *ngIf="nexusBase">
          {{nexusBase.factoryLevel ? nexusBase.factoryLevel : ''}}
          <span class="timerLabel">
            {{getBuildingTimerForBuilding("factory") ? formatTimer(getBuildingTimerForBuilding("factory").endTime) : ''}}
          </span>
        </span>
      </div>

      <div class="building" [style.visibility]="displayStarport ?  'visible' : 'hidden'">
        <div class="buildingPicture starport" *ngIf="starportPicture" (click)="openStarport()" title="Starport">
          <app-media-viewer [file]="starportPicture"
                            [currentDirectory]="starportPicture.directory"
                            [inputtedParentRef]="parentRef"
                            [displayExtraInfo]="false"
                            [showCommentSection]="false"
                            [user]="parentRef?.user"
                            [autoplay]="true"
                            [displayExpander]="false">
          </app-media-viewer>
        </div>
        <span class="levelLabel starportLevelDisplay" *ngIf="nexusBase">
          {{nexusBase.starportLevel ? nexusBase.starportLevel : ''}}
          <span class="timerLabel">
            {{getBuildingTimerForBuilding("starport") ? formatTimer(getBuildingTimerForBuilding("starport").endTime) : ''}}
          </span>
        </span>
      </div>

      <div class="building" [style.visibility]="displaySupplyDepot ? 'visible' : 'hidden'">
        <div class="buildingPicture supplyDepot" *ngIf="supplyDepotPicture" (click)="openSupplyDepot()" title="Supply Depot">
          <app-media-viewer [file]="supplyDepotPicture"
                            [currentDirectory]="supplyDepotPicture.directory"
                            [inputtedParentRef]="parentRef"
                            [displayExtraInfo]="false"
                            [showCommentSection]="false"
                            [user]="parentRef?.user"
                            [autoplay]="true"
                            [displayExpander]="false">
          </app-media-viewer>
        </div>
        <span class="levelLabel supplyDepotLevelDisplay" *ngIf="nexusBase">
          {{nexusBase.supplyDepotLevel ? nexusBase.supplyDepotLevel : ''}}
          <span class="timerLabel">
            {{getBuildingTimerForBuilding("supply_depot") ? formatTimer(getBuildingTimerForBuilding("supply_depot").endTime) : ''}}
          </span>
        </span>
      </div>
    </div>


    <div class="commandCenterBackground" *ngIf="commandCenterPicture" [style.display]="isCommandCenterOpen && !isSupplyDepotOpen && !isFactoryOpen && !isMinesOpen && !isStarportOpen && !isMapOpen && !isUserNew ? 'block' : 'none'">
      <app-media-viewer [file]="commandCenterPicture"
                        [currentDirectory]="commandCenterPicture.directory"
                        [inputtedParentRef]="parentRef"
                        [displayExtraInfo]="false"
                        [showCommentSection]="false"
                        [user]="parentRef?.user"
                        [autoplay]="true"
                        [displayExpander]="false">
      </app-media-viewer>
    </div>
    <div *ngIf="nexusBase" [style.display]="isCommandCenterOpen && !isMapOpen && !isUserNew && nexusBase ? 'block' : 'none'" class="commandCenterScreen">
      <div>
        <p class="">
          Upgrade the Command Center to gain more worker slots.
          Worker slots allow you to upgrade more buildings simultaneously.
        </p>
        <p class="upgradeProgressDisplayP">Current upgrade limit : {{nexusBase.commandCenterLevel + 1}}</p>
        <button (click)="closeCommandCenter()">Back</button>
      </div>

    </div>

    <div class="supplyDepotBackground" *ngIf="supplyDepotPicture" [style.display]="supplyDepotPicture && isSupplyDepotOpen && !isFactoryOpen && !isMinesOpen && !isStarportOpen && !isCommandCenterOpen && !isMapOpen && !isUserNew ? 'block' : 'none'">
      <app-media-viewer [file]="supplyDepotPicture"
                        [currentDirectory]="supplyDepotPicture.directory"
                        [inputtedParentRef]="parentRef"
                        [displayExtraInfo]="false"
                        [showCommentSection]="false"
                        [user]="parentRef?.user"
                        [autoplay]="true"
                        [displayExpander]="false">
      </app-media-viewer>
    </div>
    <div [style.display]="isSupplyDepotOpen && !isMapOpen && !isUserNew ? 'block' : 'none'" class="supplyDepotScreen">
      <div *ngIf="nexusBase">
        <div class="supplyInfoDiv">
          <div class="supplyExplainDiv">
            For every supply depot level your supply capacity increases by 2500.
            <p>Current supply capacity: {{supplyCapacity}}</p>
            <p>Supply used: <span class="redText">{{nexusBase.supply}}</span></p>
          </div>
          <div class="supplyUsedDiv">
            <div *ngFor="let unit of filterUnitsForSupplyDisplay()">
              {{unit.unitType}}: {{getSupplyUsedPerUnit(unit.unitId)}}
            </div>
          </div>
        </div>
        <button (click)="closeSupplyDepot()">Back</button>
      </div>
    </div>


    <div class="factoryBackground" *ngIf="factoryPicture" [style.display]="factoryPicture && isFactoryOpen && !isMapOpen && !isUserNew ? 'block' : 'none'">
      <app-media-viewer [file]="factoryPicture"
                        [currentDirectory]="factoryPicture.directory"
                        [inputtedParentRef]="parentRef"
                        [displayExtraInfo]="false"
                        [showCommentSection]="false"
                        [user]="parentRef?.user"
                        [autoplay]="true"
                        [displayExpander]="false">
      </app-media-viewer>
    </div>
    <div [style.display]="isFactoryOpen && !isMapOpen && !isUserNew ? 'block' : 'none'" class="factoryScreen">
      <div>
        Upgrade the Factory to train more units simultaneously. Current training limit: <span class="redText">{{nexusBase?.factoryLevel ?? 0}}</span>
        <div class="unitsTableDiv">
          <table class="mainTable"> 
            <tbody *ngFor="let unit of getFactoryUnits()">
              <tr>
                <td class="unitPictureTd">
                  <span class="unitPicture" *ngIf="unit.picture">
                    <app-media-viewer [file]="unit.picture"
                                      [currentDirectory]="unit.picture.directory"
                                      [inputtedParentRef]="parentRef"
                                      [displayExtraInfo]="false"
                                      [showCommentSection]="false"
                                      [user]="parentRef?.user"
                                      [autoplay]="true"
                                      [displayExpander]="false">
                    </app-media-viewer>
                  </span>
                </td>
                <td class="unitPictureTd">
                  {{ unit.unitType }}
                </td>
                <td class="unitSliderTd">
                  <input type="range" class="unitSliderTd" [value]="unit.purchasedValue ?? 0" [min]="0" [max]="maxSliderValue(unit)" [step]="1" (input)="onSliderChange($event, unit)" />
                </td>
                <td>
                  {{unit.purchasedValue ? unit.purchasedValue : '0'}}
                </td>
                <td class="unitPictureTd">
                  <button [disabled]="!unit.purchasedValue" (click)="purchaseUnit(unit.unitId)">‚úîÔ∏è</button>
                </td>
              </tr>
              <tr>
                <td></td> 
                <td class="smallFont" colspan="3">
                  ü™ô{{ ((unit.purchasedValue ? unit.purchasedValue : 1) * unit.cost) }}
                  ‚è±Ô∏è{{ formatTimer(unit.duration * (unit.purchasedValue ? unit.purchasedValue : 1))}}
                  <span [class]="((unit.purchasedValue ? unit.purchasedValue : 1) * unit.supply) > supplyCapacity ? 'redText' : ''">üë§{{ unit.supply ? (unit.purchasedValue ? unit.purchasedValue : 1) * unit.supply : ''}}</span>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
        <button (click)="closeFactory()">Back</button>
      </div>
    </div>


    <div class="starportBackground" *ngIf="starportPicture && nexusBase" [style.display]="isStarportOpen && !isMapOpen && !isUserNew ? 'block' : 'none'">
      <app-media-viewer [file]="starportPicture"
                        [currentDirectory]="starportPicture.directory"
                        [inputtedParentRef]="parentRef"
                        [displayExtraInfo]="false"
                        [showCommentSection]="false"
                        [user]="parentRef?.user"
                        [autoplay]="true"
                        [displayExpander]="false">
      </app-media-viewer>
    </div>
    <div [style.display]="isStarportOpen && !isMapOpen && !isUserNew ? 'block' : 'none'" class="starportScreen">
      <div>
        <div>
          Upgrade the Starport to train more units simultaneously. Current training limit: <span class="redText">{{nexusBase?.starportLevel ?? 0}}</span>
          <div class="unitsTableDiv">
            <table class="mainTable"> 
              <tbody *ngFor="let unit of getStarportUnits()">
                <tr>
                  <td class="unitPictureTd">
                    <span class="unitPicture" *ngIf="unit.picture">
                      <app-media-viewer [file]="unit.picture"
                                        [currentDirectory]="unit.picture.directory"
                                        [inputtedParentRef]="parentRef"
                                        [displayExtraInfo]="false"
                                        [showCommentSection]="false"
                                        [user]="parentRef?.user"
                                        [autoplay]="true"
                                        [displayExpander]="false">
                      </app-media-viewer>
                    </span>
                  </td>
                  <td class="unitPictureTd">
                    {{ unit.unitType }}
                  </td>
                  <td class="unitSliderTd">
                    <input type="range" class="unitSliderTd" [value]="unit.purchasedValue ?? 0" [min]="0" [max]="maxSliderValue(unit)" [step]="1" (input)="onSliderChange($event, unit)" />
                  </td>
                  <td>
                    {{unit.purchasedValue ? unit.purchasedValue : '0'}}
                  </td>
                  <td class="unitPictureTd">
                    <button [disabled]="!unit.purchasedValue" (click)="purchaseUnit(unit.unitId)">‚úîÔ∏è</button>
                  </td>
                </tr>
                <tr>
                  <td></td>
                  <td class="smallFont" colspan="3">
                    ü™ô{{ ((unit.purchasedValue ? unit.purchasedValue : 1) * unit.cost) }}
                    ‚è±Ô∏è{{ formatTimer(unit.duration * (unit.purchasedValue ? unit.purchasedValue : 1))}}
                    <span [class]="((unit.purchasedValue ? unit.purchasedValue : 1) * unit.supply) > supplyCapacity ? 'redText' : ''">üë§{{ unit.supply ? (unit.purchasedValue ? unit.purchasedValue : 1) * unit.supply : ''}}</span>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
        <button (click)="closeStarport()">Back</button>
      </div>
    </div>


    <div class="warehouseBackground" *ngIf="warehousePicture" [style.display]="isWarehouseOpen && !isMapOpen && !isUserNew ? 'block' : 'none'">
      <app-media-viewer [file]="warehousePicture"
                        [currentDirectory]="warehousePicture.directory"
                        [inputtedParentRef]="parentRef"
                        [displayExtraInfo]="false"
                        [showCommentSection]="false"
                        [user]="parentRef?.user"
                        [autoplay]="true"
                        [displayExpander]="false">
      </app-media-viewer>
    </div>
    <div [style.display]="isWarehouseOpen && !isMapOpen && !isUserNew ? 'block' : 'none'" class="warehouseScreen">
      <div>
        <p></p>Current gold capacity : {{goldCapacity}}ü™ô
        <div class="warehouseLevelsDiv">
          <table class="mainTable">
            <thead>
              <tr>
                <th>Warehouse Level</th>
                <th>Capacity</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let i of warehouseUpgradeLevels">
                <td>{{i}}</td>
                <td>{{5000 * (i + 1)}}ü™ô</td>
              </tr>
            </tbody>
          </table>
        </div>
        <button (click)="closeWarehouse()">Back</button>
      </div>
    </div>


    <div class="engineeringBayBackground" *ngIf="engineeringBayPicture" [style.display]="isEngineeringBayOpen && !isMapOpen && !isUserNew ? 'block' : 'none'">
      <app-media-viewer [file]="engineeringBayPicture"
                        [currentDirectory]="engineeringBayPicture.directory"
                        [inputtedParentRef]="parentRef"
                        [displayExtraInfo]="false"
                        [showCommentSection]="false"
                        [user]="parentRef?.user"
                        [autoplay]="true"
                        [displayExpander]="false">
      </app-media-viewer>
    </div>
    <div [style.display]="isEngineeringBayOpen && !isMapOpen && !isUserNew ? 'block' : 'none'" class="engineeringBayScreen">
      <div>
        Upgrade units and create a drone that converts a Command Center to your ownership.
        <button (click)="closeEngineeringBay()">Back</button>
      </div>
    </div>


    <div class="minesBackground" *ngIf="minesPicture" [style.display]="isMinesOpen && !isMapOpen && !isUserNew ? 'block' : 'none'">
      <app-media-viewer [file]="minesPicture"
                        [currentDirectory]="minesPicture.directory"
                        [inputtedParentRef]="parentRef"
                        [displayExtraInfo]="false"
                        [showCommentSection]="false"
                        [user]="parentRef?.user"
                        [autoplay]="true"
                        [displayExpander]="false">
      </app-media-viewer>
    </div>
    <div [style.display]="isMinesOpen && !isMapOpen && !isUserNew ? 'block' : 'none'" class="minesScreen">
      <div>
        Current mining speed: {{miningSpeed}}
        <button (click)="closeMines()">Back</button>
      </div>
    </div>
  </div>

  <div class="upgradesTableDiv" [style.display]="isCommandCenterOpen && !isMapOpen && !isUserNew ? 'block' : 'none'">
    Upgrades Available:
    <table class="mainTable">
      <thead>
        <tr>
          <th>Building</th>
          <th>Level</th>
          <th>ü™ô</th>
          <th>Duration</th>
          <th></th>
        </tr>
      </thead>
      <tbody *ngIf="getValidBuildingUpgrades() && getValidBuildingUpgrades()!.length > 0">
        <tr *ngFor="let upgrade of getValidBuildingUpgrades()">
          <td>{{upgrade.building}}</td>
          <td>{{upgrade.nextLevel + 1}}</td>
          <td>{{upgrade.cost}}</td>
          <td>{{upgrade.duration}}s</td>
          <td>
            <button (click)="upgradeBuilding(upgrade, upgrade.duration)" #upgradeButton>
              {{ getBuildingTimerForBuilding(upgrade.building) ? formatTimer(getBuildingTimerForBuilding(upgrade.building).endTime) : 'üîß' }}
            </button>
          </td>
        </tr>
      </tbody>
      <tbody *ngIf="!getValidBuildingUpgrades() || getValidBuildingUpgrades()!.length == 0">
        <tr>
          <td colspan="5">All buildings are maxed out on upgrades.</td>
        </tr>
      </tbody>
    </table>
  </div>
  <div class="upgradeTimersTableDiv" [style.display]="!isCommandCenterOpen && !isMapOpen && !isUserNew && !isUserComponentOpen ? 'block' : 'none'">
    <ng-container *ngIf="activeBuildingTimers().length > 0">
      <div *ngFor="let timer of activeBuildingTimers()">
        <p [class]="timer.building.includes('.') ? 'unitProgressDisplayP' : 'upgradeProgressDisplayP'">
          {{ formatBuildingTimer(timer.building) }} - {{ formatTimer(timer.endTime) }}
        </p>
      </div>
    </ng-container>

    <ng-container *ngIf="activeUnitTimers().length > 0">
      <div *ngFor="let timer of activeUnitTimers()">
        <p [class]="timer.unit.includes('.') ? 'unitProgressDisplayP' : 'upgradeProgressDisplayP'">
          {{ timer.unit.includes(".") ? timer.unit.substring(timer.unit.indexOf('.') + 1, timer.unit.length) : timer.unit }} - {{ formatTimer(timer.endTime) }}
        </p>
      </div>
    </ng-container>
  </div>

  <div [style.display]="!isCommandCenterOpen && !isMapOpen && !isUserNew && !isUserComponentOpen ? 'block' : 'none'">
    <app-nexus-base-units [parentRef]="parentRef"
                          [nexusUnits]="nexusUnits"
                          [marinePicture]="marinePicture"
                          [goliathPicture]="goliathPicture"
                          [siegeTankPicture]="siegeTankPicture"
                          [scoutPicture]="scoutPicture"
                          [wraithPicture]="wraithPicture"
                          [battlecruiserPicture]="battlecruiserPicture"></app-nexus-base-units>
  </div>

  <div class="gameNotificationDiv">
    <div *ngFor="let notif of notifications" class="gameNotification" (click)="notifications = []" [style.display]="!isMapOpen ? 'block' : 'none'">>{{notif}}</div>
  </div>
  <div *ngIf="isUserComponentOpen">
    <app-user [loginOnly]="true"
              [inputtedParentRef]="parentRef"
              (closeUserComponentEvent)="closeUserComponent($event)"
              [loginReasonMessage]="'You must log in to fight in the Bug Wars.'"></app-user>
  </div>

  <div class="shareMapButtonDiv">
    <button (click)="copyLink()" title="Share Link">Share üìã</button>
    <button (click)="viewMap()" title="View Map">Map üó∫Ô∏è</button>
  </div>
</div>
