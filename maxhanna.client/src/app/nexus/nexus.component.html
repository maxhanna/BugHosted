<div class=componentMain>
  <div class="closeButton" (click)="remove_me('NexusComponent');"></div>
  <div class="refreshButton" (click)="ngOnInit();"></div>
  <div class="componentTitle">War</div>


  <div *ngIf="!isUserComponentOpen && parentRef && parentRef.user && isUserNew">
    Welcome to Nexus wars.
    <button (click)="start()">Enter the fight</button>
  </div>

  <div class="gamescreen" [style.display]="!isUserNew ? 'block':'none'">
    <div>
      <span title="Gold" class="resourceSpan">ğŸª™:{{ goldAmount | number:'1.2-2' }}</span>
      <span title="Supply Capacity" class="resourceSpan" *ngIf="nexusBase && nexusBase.supply && supplyCapacity">ğŸ‘¤:{{supplyCapacity - nexusBase.supply ?? 0}}</span>
      <span title="Nexus location" class="resourceSpan">ğŸ“:{{'{' + currentBaseLocationX + ',' + currentBaseLocationY + '}'}}</span>
    </div>

    <div class="mapComponentDiv" #mapComponentDiv *ngIf="parentRef && parentRef.user">
      <app-nexus-map #mapComponent [user]="parentRef.user"></app-nexus-map>
    </div>


    <div class="nexusBackground" *ngIf="nexusBackgroundPicture" [style.display]="!isMinesOpen && !isWarehouseOpen && !isEngineeringBayOpen && !isCommandCenterOpen && !isSupplyDepotOpen && !isFactoryOpen && !isMinesOpen && !isStarportOpen && !isMapOpen ? 'block' : 'none' ">
      <app-media-viewer [file]="nexusBackgroundPicture"
                        [currentDirectory]="nexusBackgroundPicture.directory"
                        [inputtedParentRef]="parentRef"
                        [displayExtraInfo]="false"
                        [showCommentSection]="false"
                        [user]="parentRef?.user"
                        [autoplay]="true"
                        [displayExpander]="false">
      </app-media-viewer>
    </div>
    <div [style.display]="!isMinesOpen && !isCommandCenterOpen && !isSupplyDepotOpen && !isFactoryOpen && !isMinesOpen && !isStarportOpen && !isWarehouseOpen && !isEngineeringBayOpen && !isMapOpen && nexusBase ? 'block' : 'none'">
      <div class="building">
        <div class="commandCenter buildingPicture" *ngIf="commandCenterPicture" (click)="openCommandCenter()" title="Command Center">
          <app-media-viewer [file]="commandCenterPicture"
                            [currentDirectory]="commandCenterPicture.directory"
                            [inputtedParentRef]="parentRef"
                            [displayExtraInfo]="false"
                            [showCommentSection]="false"
                            [user]="parentRef?.user"
                            [autoplay]="true"
                            [displayExpander]="false">
          </app-media-viewer>
        </div>
        <span class="levelLabel commandCenterLevelDisplay" *ngIf="nexusBase">
          {{nexusBase.commandCenterLevel ? nexusBase.commandCenterLevel : ''}}
          <span class="timerLabel">
            {{buildingTimers["command_center"] ? formatTimer(buildingTimers["command_center"].endTime) : ''}}
          </span>
        </span>
      </div>

      <div class="building" [style.display]="displayMines ?  'block' : 'none'">
        <div class="buildingPicture mines" *ngIf="minesPicture" (click)="openMines();" title="Mines">
          <app-media-viewer [file]="minesPicture"
                            [currentDirectory]="minesPicture.directory"
                            [inputtedParentRef]="parentRef"
                            [displayExtraInfo]="false"
                            [showCommentSection]="false"
                            [user]="parentRef?.user"
                            [autoplay]="true"
                            [displayExpander]="false">
          </app-media-viewer>
        </div>
        <span class="levelLabel minesLevelDisplay" *ngIf="nexusBase">
          {{nexusBase.minesLevel ? nexusBase.minesLevel : ''}}
          <span class="timerLabel">
            {{buildingTimers["mines"] ? formatTimer(buildingTimers["mines"].endTime) : ''}}
          </span>
        </span>
      </div>


      <div class="building" [style.visibility]="displayEngineeringBay ?  'visible' : 'hidden'">
        <div class="buildingPicture engineeringBay" *ngIf="engineeringBayPicture" (click)="openEngineeringBay();" title="Engineering Bay">
          <app-media-viewer [file]="engineeringBayPicture"
                            [currentDirectory]="engineeringBayPicture.directory"
                            [inputtedParentRef]="parentRef"
                            [displayExtraInfo]="false"
                            [showCommentSection]="false"
                            [user]="parentRef?.user"
                            [autoplay]="true"
                            [displayExpander]="false">
          </app-media-viewer>
        </div>
        <span class="levelLabel engineeringBayLevelDisplay" *ngIf="nexusBase">
          {{nexusBase.engineeringBayLevel ? nexusBase.engineeringBayLevel : ''}}
          <span class="timerLabel">
            {{buildingTimers["engineering_bay"] ? formatTimer(buildingTimers["engineering_bay"].endTime) : ''}}
          </span>
        </span>
      </div>


      <div class="building" [style.visibility]="displayWarehouse ?  'visible' : 'hidden'">
        <div class="buildingPicture warehouse" *ngIf="warehousePicture" (click)="openWarehouse();" title="Warehouse">
          <app-media-viewer [file]="warehousePicture"
                            [currentDirectory]="warehousePicture.directory"
                            [inputtedParentRef]="parentRef"
                            [displayExtraInfo]="false"
                            [showCommentSection]="false"
                            [user]="parentRef?.user"
                            [autoplay]="true"
                            [displayExpander]="false">
          </app-media-viewer>
        </div>
        <span class="levelLabel warehouseLevelDisplay" *ngIf="nexusBase">
          {{nexusBase.warehouseLevel ? nexusBase.warehouseLevel : ''}}
          <span class="timerLabel">
            {{buildingTimers["warehouse"] ? formatTimer(buildingTimers["warehouse"].endTime) : ''}}
          </span>
        </span>
      </div>

      <div class="building" [style.visibility]="displayFactory ?  'visible' : 'hidden'">
        <div class="buildingPicture factory" *ngIf="factoryPicture" (click)="openFactory()" title="Factory">
          <app-media-viewer [file]="factoryPicture"
                            [currentDirectory]="factoryPicture.directory"
                            [inputtedParentRef]="parentRef"
                            [displayExtraInfo]="false"
                            [showCommentSection]="false"
                            [user]="parentRef?.user"
                            [autoplay]="true"
                            [displayExpander]="false">
          </app-media-viewer>
        </div>
        <span class="levelLabel factoryLevelDisplay" *ngIf="nexusBase">
          {{nexusBase.factoryLevel ? nexusBase.factoryLevel : ''}}
          <span class="timerLabel">
            {{buildingTimers["factory"] ? formatTimer(buildingTimers["factory"].endTime) : ''}}
          </span>
        </span>
      </div>

      <div class="building" [style.visibility]="displayStarport ?  'visible' : 'hidden'">
        <div class="buildingPicture starport" *ngIf="starportPicture" (click)="openStarport()" title="Starport">
          <app-media-viewer [file]="starportPicture"
                            [currentDirectory]="starportPicture.directory"
                            [inputtedParentRef]="parentRef"
                            [displayExtraInfo]="false"
                            [showCommentSection]="false"
                            [user]="parentRef?.user"
                            [autoplay]="true"
                            [displayExpander]="false">
          </app-media-viewer>
        </div>
        <span class="levelLabel starportLevelDisplay" *ngIf="nexusBase">
          {{nexusBase.starportLevel ? nexusBase.starportLevel : ''}}
          <span class="timerLabel">
            {{buildingTimers["starport"] ? formatTimer(buildingTimers["starport"].endTime) : ''}}
          </span>
        </span>
      </div>

      <div class="building" [style.visibility]="displaySupplyDepot ? 'visible' : 'hidden'">
        <div class="buildingPicture supplyDepot" *ngIf="supplyDepotPicture" (click)="openSupplyDepot()" title="Supply Depot">
          <app-media-viewer [file]="supplyDepotPicture"
                            [currentDirectory]="supplyDepotPicture.directory"
                            [inputtedParentRef]="parentRef"
                            [displayExtraInfo]="false"
                            [showCommentSection]="false"
                            [user]="parentRef?.user"
                            [autoplay]="true"
                            [displayExpander]="false">
          </app-media-viewer>
        </div>
        <span class="levelLabel supplyDepotLevelDisplay" *ngIf="nexusBase">
          {{nexusBase.supplyDepotLevel ? nexusBase.supplyDepotLevel : ''}}
          <span class="timerLabel">
            {{buildingTimers["supply_depot"] ? formatTimer(buildingTimers["supply_depot"].endTime) : ''}}
          </span>
        </span>
      </div>
    </div>


    <div class="commandCenterBackground" *ngIf="commandCenterPicture" [style.display]="isCommandCenterOpen && !isSupplyDepotOpen && !isFactoryOpen && !isMinesOpen && !isStarportOpen && !isMapOpen && !isUserNew ? 'block' : 'none'">
      <app-media-viewer [file]="commandCenterPicture"
                        [currentDirectory]="commandCenterPicture.directory"
                        [inputtedParentRef]="parentRef"
                        [displayExtraInfo]="false"
                        [showCommentSection]="false"
                        [user]="parentRef?.user"
                        [autoplay]="true"
                        [displayExpander]="false">
      </app-media-viewer>
    </div>
    <div *ngIf="nexusBase" [style.display]="isCommandCenterOpen && !isMapOpen && !isUserNew && nexusBase ? 'block' : 'none'" class="commandCenterScreen">
      <div>
        <p class="">
          Upgrade the Command Center to gain more worker slots.
          Worker slots allow you to upgrade more buildings simultaneously.
        </p>
        <p class="upgradeProgressDisplayP">Current upgrade limit : {{nexusBase.commandCenterLevel + 1}}</p>
        <button (click)="closeCommandCenter()">Back</button>
      </div>

    </div>

    <div class="supplyDepotBackground" *ngIf="supplyDepotPicture" [style.display]="supplyDepotPicture && isSupplyDepotOpen && !isFactoryOpen && !isMinesOpen && !isStarportOpen && !isCommandCenterOpen && !isMapOpen && !isUserNew ? 'block' : 'none'">
      <app-media-viewer [file]="supplyDepotPicture"
                        [currentDirectory]="supplyDepotPicture.directory"
                        [inputtedParentRef]="parentRef"
                        [displayExtraInfo]="false"
                        [showCommentSection]="false"
                        [user]="parentRef?.user"
                        [autoplay]="true"
                        [displayExpander]="false">
      </app-media-viewer>
    </div>
    <div [style.display]="isSupplyDepotOpen && !isMapOpen && !isUserNew ? 'block' : 'none'" class="supplyDepotScreen">
      <div>
        Current supply capacity: {{supplyCapacity}}
        <button (click)="closeSupplyDepot()">Back</button>
      </div>
    </div>


    <div class="factoryBackground" *ngIf="factoryPicture" [style.display]="factoryPicture && isFactoryOpen && !isMapOpen && !isUserNew ? 'block' : 'none'">
      <app-media-viewer [file]="factoryPicture"
                        [currentDirectory]="factoryPicture.directory"
                        [inputtedParentRef]="parentRef"
                        [displayExtraInfo]="false"
                        [showCommentSection]="false"
                        [user]="parentRef?.user"
                        [autoplay]="true"
                        [displayExpander]="false">
      </app-media-viewer>
    </div>
    <div [style.display]="isFactoryOpen && !isMapOpen && !isUserNew ? 'block' : 'none'" class="factoryScreen">
      <div>
        Units currently available:
        <div class="unitsTableDiv">
          <table class="mainTable">
            <thead>
              <tr>
                <th>Unit</th>
                <th>Name</th>
                <th colspan="4">ğŸª™</th>
              </tr>
            </thead>
            <tbody *ngFor="let unit of getFactoryUnits()">
              <tr>
                <td class="unitPictureTd">
                  <span class="unitPicture" *ngIf="unit.picture">
                    <app-media-viewer [file]="unit.picture"
                                      [currentDirectory]="unit.picture.directory"
                                      [inputtedParentRef]="parentRef"
                                      [displayExtraInfo]="false"
                                      [showCommentSection]="false"
                                      [user]="parentRef?.user"
                                      [autoplay]="true"
                                      [displayExpander]="false">
                    </app-media-viewer>
                  </span>
                </td>
                <td class="unitPictureTd">
                  {{ unit.unitType }}
                </td>
                <td class="unitSliderTd">
                  <input type="range" class="unitSliderTd" [value]="unit.purchasedValue ?? 0" [min]="0" [max]="maxSliderValue(unit)" [step]="1" (input)="onSliderChange($event, unit)" />
                </td>
                <td>
                  {{unit.purchasedValue ? unit.purchasedValue : '0'}}
                </td>
                <td class="unitPictureTd">
                  <button [disabled]="!unit.purchasedValue" (click)="purchaseUnit(unit.unitId)">âœ”ï¸</button>
                </td>
              </tr>
              <tr *ngIf="unit.purchasedValue">
                <td></td>
                <td class="smallFont" colspan="3">
                  ğŸª™{{ unit.purchasedValue * unit.cost }}
                  â±ï¸{{ unit.purchasedValue ? formatTimer(unit.duration * ((unit.purchasedValue ?? 1) / unit.cost)) : '0' }}
                  <span [class]="(unit.purchasedValue * unit.supply) > supplyCapacity ? 'redText' : ''">ğŸ‘¤{{ unit.purchasedValue && unit.supply ? (unit.purchasedValue * unit.supply) : ''}}</span>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
        <button (click)="closeFactory()">Back</button>
      </div>
    </div>


    <div class="starportBackground" *ngIf="starportPicture" [style.display]="isStarportOpen && !isMapOpen && !isUserNew ? 'block' : 'none'">
      <app-media-viewer [file]="starportPicture"
                        [currentDirectory]="starportPicture.directory"
                        [inputtedParentRef]="parentRef"
                        [displayExtraInfo]="false"
                        [showCommentSection]="false"
                        [user]="parentRef?.user"
                        [autoplay]="true"
                        [displayExpander]="false">
      </app-media-viewer>
    </div>
    <div [style.display]="isStarportOpen && !isMapOpen && !isUserNew ? 'block' : 'none'" class="starportScreen">
      <div>
        <div>
          Units currently available:
          <div class="unitsTableDiv">
            <table class="mainTable">
              <thead>
                <tr>
                  <th>Unit</th>
                  <th>Name</th>
                  <th colspan="4">ğŸª™</th>
                </tr>
              </thead>
              <tbody *ngFor="let unit of getStarportUnits()">
                <tr>
                  <td class="unitPictureTd">
                    <span class="unitPicture" *ngIf="unit.picture">
                      <app-media-viewer [file]="unit.picture"
                                        [currentDirectory]="unit.picture.directory"
                                        [inputtedParentRef]="parentRef"
                                        [displayExtraInfo]="false"
                                        [showCommentSection]="false"
                                        [user]="parentRef?.user"
                                        [autoplay]="true"
                                        [displayExpander]="false">
                      </app-media-viewer>
                    </span>
                  </td>
                  <td class="unitPictureTd">
                    {{ unit.unitType }}
                  </td>
                  <td class="unitSliderTd">
                    <input type="range" class="unitSliderTd" [value]="unit.purchasedValue ?? 0" [min]="0" [max]="maxSliderValue(unit)" [step]="1" (input)="onSliderChange($event, unit)" />
                  </td>
                  <td>
                    {{unit.purchasedValue ? unit.purchasedValue : '0'}}
                  </td>
                  <td class="unitPictureTd">
                    <button [disabled]="!unit.purchasedValue" (click)="purchaseUnit(unit.unitId)">âœ”ï¸</button>
                  </td>
                </tr>
                <tr *ngIf="unit.purchasedValue">
                  <td></td>
                  <td class="smallFont" colspan="3">
                    ğŸª™{{ unit.purchasedValue * unit.cost }}
                    â±ï¸{{ unit.purchasedValue ? formatTimer(unit.duration * ((unit.purchasedValue ?? 1) / unit.cost)) : '0' }}
                    <span [class]="(unit.purchasedValue * unit.supply) > supplyCapacity ? 'redText' : ''">ğŸ‘¤{{ unit.purchasedValue && unit.supply ? (unit.purchasedValue * unit.supply) : ''}}</span>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
        <button (click)="closeStarport()">Back</button>
      </div>
    </div>


    <div class="warehouseBackground" *ngIf="warehousePicture" [style.display]="isWarehouseOpen && !isMapOpen && !isUserNew ? 'block' : 'none'">
      <app-media-viewer [file]="warehousePicture"
                        [currentDirectory]="warehousePicture.directory"
                        [inputtedParentRef]="parentRef"
                        [displayExtraInfo]="false"
                        [showCommentSection]="false"
                        [user]="parentRef?.user"
                        [autoplay]="true"
                        [displayExpander]="false">
      </app-media-viewer>
    </div>
    <div [style.display]="isWarehouseOpen && !isMapOpen && !isUserNew ? 'block' : 'none'" class="warehouseScreen">
      <div>
        <p></p>Current gold capacity : {{goldCapacity}}ğŸª™
        <div class="warehouseLevelsDiv">
          <table class="mainTable">
            <thead>
              <tr>
                <th>Warehouse Level</th>
                <th>Capacity</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let i of warehouseUpgradeLevels">
                <td>{{i}}</td>
                <td>{{5000 * (i + 1)}}ğŸª™</td>
              </tr>
            </tbody>
          </table>
        </div>
        <button (click)="closeWarehouse()">Back</button>
      </div>
    </div>


    <div class="engineeringBayBackground" *ngIf="engineeringBayPicture" [style.display]="isEngineeringBayOpen && !isMapOpen && !isUserNew ? 'block' : 'none'">
      <app-media-viewer [file]="engineeringBayPicture"
                        [currentDirectory]="engineeringBayPicture.directory"
                        [inputtedParentRef]="parentRef"
                        [displayExtraInfo]="false"
                        [showCommentSection]="false"
                        [user]="parentRef?.user"
                        [autoplay]="true"
                        [displayExpander]="false">
      </app-media-viewer>
    </div>
    <div [style.display]="isEngineeringBayOpen && !isMapOpen && !isUserNew ? 'block' : 'none'" class="engineeringBayScreen">
      <div>
        Upgrade units and create a drone that converts a Command Center to your ownership.
        <button (click)="closeEngineeringBay()">Back</button>
      </div>
    </div>


    <div class="minesBackground" *ngIf="minesPicture" [style.display]="isMinesOpen && !isMapOpen && !isUserNew ? 'block' : 'none'">
      <app-media-viewer [file]="minesPicture"
                        [currentDirectory]="minesPicture.directory"
                        [inputtedParentRef]="parentRef"
                        [displayExtraInfo]="false"
                        [showCommentSection]="false"
                        [user]="parentRef?.user"
                        [autoplay]="true"
                        [displayExpander]="false">
      </app-media-viewer>
    </div>
    <div [style.display]="isMinesOpen && !isMapOpen && !isUserNew ? 'block' : 'none'" class="minesScreen"> 
      <div>
        Current mining speed: {{miningSpeed}}
        <button (click)="closeMines()">Back</button>
      </div>
    </div>
  </div>

  <div class="upgradesTableDiv" [style.display]="isCommandCenterOpen && !isMapOpen && !isUserNew ? 'block' : 'none'">
    Upgrades Available:
    <table class="mainTable">
      <thead>
        <tr>
          <th>Building</th>
          <th>Level</th>
          <th>ğŸª™</th>
          <th>Duration</th>
          <th></th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let upgrade of getValidBuildingUpgrades()">
          <td>{{upgrade.building}}</td>
          <td>{{upgrade.nextLevel + 1}}</td>
          <td>{{upgrade.cost}}</td>
          <td>{{upgrade.duration}}s</td>
          <td>
            <button (click)="upgradeBuilding(upgrade, upgrade.duration)" #upgradeButton>
              {{ buildingTimers[upgrade.building] ? formatTimer(buildingTimers[upgrade.building].endTime) : 'ğŸ”§' }}
            </button>
          </td>
        </tr>
      </tbody>
    </table>
  </div>
  <div class="upgradeTimersTableDiv" [style.display]="!isCommandCenterOpen && !isMapOpen && !isUserNew && !isUserComponentOpen ? 'block' : 'none'">
    <ng-container *ngIf="activeBuildingTimers().length > 0">
      <p>Upgrades in progress:</p>
      <div *ngFor="let timer of activeBuildingTimers()">
        <p class="upgradeProgressDisplayP">
          {{ timer.building }} - {{ formatTimer(timer.endTime) }}
        </p>
      </div>
    </ng-container>
    <ng-container *ngIf="activeBuildingTimers().length === 0">
      <p>No upgrades in progress.</p>
    </ng-container>
  </div>

  <div *ngIf="nexusUnits && (nexusUnits.marineTotal > 0 || nexusUnits.goliathTotal > 0 || nexusUnits.battlecruiserTotal > 0 || nexusUnits.wraithTotal > 0 || nexusUnits.siegeTankTotal > 0)">
    <p *ngIf="nexusUnits.marineTotal > 0">Marines {{nexusUnits.marineTotal}}</p>
    <p *ngIf="nexusUnits.goliathTotal > 0">Goliath {{nexusUnits.goliathTotal}}</p>
    <p *ngIf="nexusUnits.siegeTankTotal > 0">Siege Tanks {{nexusUnits.siegeTankTotal}}</p>
    <p *ngIf="nexusUnits.wraithTotal > 0">Wraith {{nexusUnits.wraithTotal}}</p>
    <p *ngIf="nexusUnits.battlecruiserTotal > 0">Battlecruisers {{nexusUnits.battlecruiserTotal}}</p>
  </div>
  <div *ngIf="nexusUnits && !(nexusUnits.marineTotal > 0 || nexusUnits.goliathTotal > 0 || nexusUnits.battlecruiserTotal > 0 || nexusUnits.wraithTotal > 0 || nexusUnits.siegeTankTotal > 0)">
    No Units
  </div>

  <div *ngFor="let notif of notifications" class="notification" (click)="notifications = []">{{notif}}</div>

  <div *ngIf="isUserComponentOpen">
    <app-user [loginOnly]="true"
              [inputtedParentRef]="parentRef"
              (closeUserComponentEvent)="closeUserComponent($event)"
              [loginReasonMessage]="'You must log in to fight in the Bug Wars.'"></app-user>
  </div>

  <div class="shareMapButtonDiv">
    <button (click)="copyLink()" title="Share Link">Share ğŸ“‹</button>
    <button (click)="viewMap()" title="View Map">Map ğŸ—ºï¸</button>
  </div>
</div>
