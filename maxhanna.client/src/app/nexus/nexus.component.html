<div class=componentMain>
  <div class="closeButton" (click)="remove_me('NexusComponent');"></div>
  <div class="refreshButton" (click)="ngOnInit();"></div>
  <div class="componentTitle">Bug Wars</div>

  <div *ngIf="!isUserComponentOpen && parentRef && parentRef.user && isUserNew && !isLoading">
    Welcome to Nexus wars.
    <button (click)="start()">Enter the fight</button>
  </div>
  <div *ngIf="isUserComponentOpen">
    <app-user [loginOnly]="true"
              [inputtedParentRef]="parentRef"
              [canClose]="false"
              (closeUserComponentEvent)="closeUserComponent($event)"
              [loginReasonMessage]="'You must log in to volunteer in the Bug Wars.'"></app-user>
    <div class="bugWarsInfo">
      <div>
        Build your bases!
        <app-media-viewer [fileId]="6697"
                          [inputtedParentRef]="parentRef"
                          [displayExtraInfo]="false"
                          [showCommentSection]="false"
                          [displayExpander]="false">
        </app-media-viewer>
      </div>
      <div>
        Conquer the world!
        <app-media-viewer [fileId]="6698"
                          [inputtedParentRef]="parentRef"
                          [displayExtraInfo]="false"
                          [showCommentSection]="false"
                          [displayExpander]="false">
        </app-media-viewer>
      </div>
    </div>
  </div>

  <div class="gamescreen" *ngIf="!isUserNew">
    <!-- Conditionally display incoming attacks -->
    <div *ngIf="shouldShowIncomingAttacks()" class="attacksIncomingCount" (click)="toggleScreen('bases', !isBasesOpen)">
      {{attacksIncomingCount}}‚öîÔ∏è
    </div>
    <!-- Navigation -->
    <div *ngIf="shouldShowBaseNav()">
      <button class="previousBaseButton" [disabled]="isLoading" (click)="previousBase()">‚©§</button>
      <button class="nextBaseButton" [disabled]="isLoading" (click)="nextBase()">‚©•</button>
    </div>
    <!-- Resources -->
    <div *ngIf="shouldShowResources() && nexusBase" class="resourceDiv">
      <span title="Gold" class="resourceSpan goldText">üìÄ:{{ (nexusBase.gold || 0) | number:'1.0-2' }}</span>
      <span title="Supply Capacity" class="resourceSpan" *ngIf="supplyCapacity">ü•©:{{supplyCapacity - (nexusBase.supply || 0)}}</span>
      <span title="Nexus location" class="resourceSpan">üìç:<span class="invertedHighlights">{{'{' + nexusBase.coordsX + ',' + nexusBase.coordsY + '} '}}</span><span *ngIf="nexusBase && nexusBase.baseName" class="usernameProfileLink">{{nexusBase.baseName}}</span></span>
    </div>
    <!-- Reports -->
    <div *ngIf="parentRef && parentRef.user && isReportsOpen" class="battleReportComponentDiv">
      <app-nexus-reports [user]="parentRef.user"
                         (openMapEmitter)="emittedOpenMapAndScrollTo($event)"
                         *ngIf="isReportsOpen">
      </app-nexus-reports>
    </div>
    <!-- Map screen -->
    <div class="mapComponentDiv" #mapComponentDiv *ngIf="parentRef && parentRef.user && isMapOpen">
      <app-nexus-map #mapComponent
                     [user]="parentRef.user"
                     [inputtedParentRef]="parentRef"
                     [nexusBase]="nexusBase"
                     [nexusAvailableUnits]="nexusAvailableUnits"
                     [nexusUnitsOutsideOfBase]="nexusUnitsOutsideOfBase"
                     [unitStats]="units"
                     [lvl1Src]="nexusLevel1Src"
                     [lvl2Src]="nexusLevel2Src"
                     [lvl3Src]="nexusLevel3Src"
                     [marinePictureSrc]="marinePictureSrc"
                     [goliathPictureSrc]="goliathPictureSrc"
                     [siegeTankPictureSrc]="siegeTankPictureSrc"
                     [scoutPictureSrc]="scoutPictureSrc"
                     [wraithPictureSrc]="wraithPictureSrc"
                     [battlecruiserPictureSrc]="battlecruiserPictureSrc"
                     [glitcherPictureSrc]="glitcherPictureSrc"
                     [mapTileSrc]="mapTileSrc"
                     [mapTileSrc2]="mapTileSrc2"
                     [mapTileSrc3]="mapTileSrc3"
                     [numberOfPersonalBases]="numberOfPersonalBases"
                     [nexusAttacksSent]="nexusAttacksSent"
                     [nexusDefencesSent]="nexusDefencesSent"
                     [nexusAttacksIncoming]="nexusAttacksIncoming"
                     [nexusDefencesIncoming]="nexusDefencesIncoming"
                     (emittedNotifications)="emittedNotifications($event)"
                     (emittedReloadEvent)="emittedReloadEvent($event)"
                     (closeMapEvent)="viewMap()"
                     (emittedAttackEvent)="emittedAttackEvent($event)"
                     (emittedGoToBaseEvent)="emittedGoToBaseEvent($event)">
      </app-nexus-map>
    </div>
    <!-- Bases screen -->
    <app-nexus-bases class="baseListComponentDiv" *ngIf="parentRef && parentRef.user && mapData && nexusBase"
                     [style.display]="isBasesOpen ? 'block':'none'"
                     [mapData]="mapData"
                     [nexusBase]="nexusBase"
                     [allNexusUnits]="allNexusUnits"
                     [user]="parentRef.user"
                     [attacksIncoming]="nexusAttacksIncoming"
                     (emittedBaseChange)="emittedBaseChange($event)"
                     (emittedNotifications)="emittedNotifications($event)"
                     (emittedUpgrade)="emittedUpgrade($event)">
    </app-nexus-bases>
    <!-- Support screen -->
    <app-nexus-support-screen *ngIf="parentRef && parentRef.user && nexusBase"
                              class="baseListComponentDiv"
                              [style.display]="isSupportOpen ? 'block':'none'"
                              [user]="parentRef.user"
                              [inputtedParentRef]="parentRef"
                              [nexusDefencesIncoming]="nexusDefencesIncoming"
                              [nexusDefencesSent]="nexusDefencesSent"
                              (defenceReturnedEmitter)="emittedDefenceReturned($event)"
                              (openMapEmitter)="emittedOpenMapAndScrollTo($event)"></app-nexus-support-screen>
    <!-- Buildings -->
    <div *ngIf="!isMinesOpen && !isCommandCenterOpen && !isSupplyDepotOpen && !isFactoryOpen && !isMinesOpen && !isStarportOpen && !isWarehouseOpen && !isEngineeringBayOpen && !isMapOpen && !isBasesOpen && !isReportsOpen && !isSupportOpen && nexusBase">
      <img [src]="nexusBackgroundPictureSrc"
           class="nexusBackground"
           *ngIf="nexusBackgroundPictureSrc"
           loading="lazy" decoding="asynchronous" />

      <div class="building">
        <img [src]="currentCommandCenterSrc" class="commandCenter buildingPicture" *ngIf="nexusBase && cclvl1Src && cclvl2Src && cclvl3Src" (click)="openCommandCenter()" title="Command Center" loading="lazy" decoding="asynchronous" />
        <span class="levelLabel commandCenterLevelDisplay" *ngIf="nexusBase">
          {{nexusBase.commandCenterLevel || ''}}
          <span class="timerLabel">
            {{getFormattedBuildingTimer('command_center')}}
          </span>
        </span>
      </div>
      <ng-container *ngIf="nexusBaseUpgrades?.commandCenterUpgraded">
        <span class="glowingLight ccGlowLight1"></span>
      </ng-container>


      <div class="building" *ngIf="displayMines">
        <img [src]="currentMinesSrc"
             class="buildingPicture mines"
             *ngIf="nexusBase && mineslvl1Src && mineslvl2Src && mineslvl3Src" (click)="openMines();" title="Mines" loading="lazy" decoding="asynchronous" />
        <span class="levelLabel minesLevelDisplay" *ngIf="nexusBase">
          {{nexusBase.minesLevel || ''}}
          <span class="timerLabel">
            {{getFormattedBuildingTimer('mines')}}
          </span>
        </span>
      </div>
      <div *ngIf="nexusBaseUpgrades?.minesUpgraded">
        <span class="glowingLight minesGlowLight1"></span>
      </div>

      <div class="building" *ngIf="displayEngineeringBay">
        <img [src]="currentEngineeringBaySrc"
             class="buildingPicture engineeringBay"
             *ngIf="nexusBase && eblvl1Src && eblvl2Src && eblvl3Src" (click)="openEngineeringBay();" title="Engineering Bay" loading="lazy" decoding="asynchronous" />
        <span class="levelLabel engineeringBayLevelDisplay" *ngIf="nexusBase">
          {{nexusBase.engineeringBayLevel || ''}}
          <span class="timerLabel">
            {{getFormattedBuildingTimer('engineering_bay')}}
          </span>
        </span>
      </div>
      <ng-container *ngIf="nexusBaseUpgrades?.engineeringBayUpgraded || glitchersBeingBuilt > 0 || isUpgradingUnits">
        <span class="glowingLight engineeringBayLongGlowLight egineeringBayLongGlowLight1"></span>
        <span class="glowingLight engineeringBayLongGlowLight egineeringBayLongGlowLight2"></span>
        <span class="glowingLight engineeringBayLongGlowLight egineeringBayLongGlowLight3"></span>
        <span class="glowingLight ebSmallGlowLight1"></span>
        <span class="glowingLight ebSmallGlowLight2"></span>
        <span class="glowingLight ebSmallGlowLight3"></span>
      </ng-container>


      <div class="building" *ngIf="displayWarehouse">
        <img [src]="currentWarehouseSrc"
             class="buildingPicture warehouse"
             *ngIf="nexusBase && whlvl1Src && whlvl2Src && whlvl3Src" (click)="openWarehouse();" title="Warehouse" loading="lazy" decoding="asynchronous" />
        <span class="levelLabel warehouseLevelDisplay" *ngIf="nexusBase">
          {{nexusBase.warehouseLevel || ''}}
          <span class="timerLabel">
            {{getFormattedBuildingTimer('warehouse')}}
          </span>
        </span>
      </div>
      <ng-container *ngIf="nexusBaseUpgrades?.warehouseUpgraded">
        <span class="glowingLight warehouseGlowLight1"></span>
      </ng-container>


      <div class="building" *ngIf="displayFactory">
        <img [src]="currentFactorySrc"
             class="buildingPicture factory"
             *ngIf="nexusBase && flvl1Src && flvl2Src && flvl3Src"
             (click)="openFactory()" title="Factory"
             loading="lazy" decoding="asynchronous" />
        <span class="levelLabel factoryLevelDisplay" *ngIf="nexusBase">
          {{nexusBase.factoryLevel || ''}}
          <span class="timerLabel">
            {{ getFormattedBuildingTimer('factory') }}
          </span>
        </span>
      </div>
      <ng-container *ngIf="nexusBaseUpgrades?.factoryUpgraded || factoryUnitsBeingBuilt > 0">
        <span class="glowingLight factoryGlowLight factoryGlowLight1"></span>
        <span class="glowingLight factoryGlowLight factoryGlowLight2"></span>
        <span class="glowingLight factoryGlowLight factoryGlowLight3"></span>
      </ng-container>

      <div class="building" *ngIf="displayStarport">
        <img [src]="nexusBase.starportLevel < 3 ? splvl1Src : nexusBase.starportLevel < 4 ? splvl2Src : splvl3Src"
             class="buildingPicture starport"
             *ngIf="nexusBase && splvl1Src && splvl2Src && splvl3Src" (click)="openStarport()" title="Starport" loading="lazy" decoding="asynchronous" />
        <span class="levelLabel starportLevelDisplay" *ngIf="nexusBase">
          {{nexusBase.starportLevel || ''}}
          <span class="timerLabel">
            {{getFormattedBuildingTimer('starport')}}
          </span>
        </span>
      </div>
      <ng-container *ngIf="nexusBaseUpgrades?.starportUpgraded || starportUnitsBeingBuilt > 0">
        <span class="glowingLight starportGlowLight starportGlowLight1"></span>
        <span class="glowingLight starportGlowLight starportGlowLight2"></span>
        <span class="glowingLight starportGlowLight starportGlowLight3"></span>
        <span class="glowingLight starportWindowsGlowLight"></span>
      </ng-container>

      <div class="building" *ngIf="displaySupplyDepot">
        <img [src]="nexusBase.supplyDepotLevel < 3 ? sdlvl1Src : nexusBase.supplyDepotLevel < 4 ? sdlvl2Src : sdlvl3Src"
             class="buildingPicture supplyDepot"
             *ngIf="nexusBase && sdlvl1Src && sdlvl2Src && sdlvl3Src" (click)="openSupplyDepot()" title="Supply Depot" loading="lazy" decoding="asynchronous" />
        <span class="levelLabel supplyDepotLevelDisplay" *ngIf="nexusBase">
          {{nexusBase.supplyDepotLevel || ''}}
          <span class="timerLabel">
            {{getFormattedBuildingTimer('supply_depot')}}
          </span>
        </span>
      </div>
      <ng-container *ngIf="nexusBaseUpgrades?.supplyDepotUpgraded">
        <span class="glowingLight supplyDepotGlowLight1"></span>
        <div class="fan" *ngIf="nexusBase && nexusBase.supplyDepotLevel > 2">
          <div class="ceiling-container">
            <div class="ceiling-fan horizontal left"></div>
            <div class="ceiling-fan horizontal right"></div>
            <div class="ceiling-fan vertical rotated top"></div>
            <div class="ceiling-fan vertical rotated bottom"></div>
          </div>
        </div>
        <div class="fan2">
          <div class="ceiling-container">
            <div class="ceiling-fan horizontal left"></div>
            <div class="ceiling-fan horizontal right"></div>
            <div class="ceiling-fan vertical rotated top"></div>
            <div class="ceiling-fan vertical rotated bottom"></div>
          </div>
        </div>
      </ng-container>
    </div>


    <img [src]="currentCommandCenterSrc"
         class="commandCenterBackground"
         *ngIf="cclvl1Src && cclvl2Src && cclvl3Src && nexusBase && isCommandCenterOpen"
         loading="lazy" decoding="asynchronous" />
    <div *ngIf="nexusBase && isCommandCenterOpen" class="commandCenterScreen">
      <div>
        Upgrade the Command Center to gain more worker slots.
        Worker slots allow you to upgrade more buildings simultaneously.
      </div>
      <div class="upgradeProgressDisplayP">
        Current upgrade limit : {{nexusBase.commandCenterLevel + 1}}
      </div>
      <div>
        Base Name : <input type="text" #baseNameInput [placeholder]="nexusBase.baseName ?? ''" (onkeyup.Enter)="setBaseName()" /><button (click)="setBaseName()">Change</button>
      </div>
      <div><button (click)="closeCommandCenter()">Back</button></div>
    </div>


    <img [src]="currentSupplyDepotSrc"
         class="supplyDepotBackground"
         *ngIf="sdlvl1Src && sdlvl2Src && sdlvl3Src && nexusBase && isSupplyDepotOpen"
         loading="lazy" decoding="asynchronous" />
    <div *ngIf="isSupplyDepotOpen" class="supplyDepotScreen">
      <div class="supplyInfoDiv">
        <div class="supplyExplainDiv">
          For every supply depot level your supply capacity increases by 2500.
          <p class="gameNotification">ü•© Capacity: {{supplyCapacity}}</p>
          <p class="gameNotification" *ngIf="nexusBase && isSupplyDepotOpen">ü•© Used: <span [class]="supplyUsedPercentage > 95 ? 'redText' : ''">{{nexusBase.supply}} ({{ supplyUsedPercentage | number:'1.0-2' }}% of total capacity)</span></p>
        </div>
        <div class="supplyUsedDiv && isSupplyDepotOpen">
          <div *ngFor="let unit of units" class="capitalize">
            {{unit.unitType.replace('_',' ')}}: {{getSupplyUsedForUnit(unit.unitId)}}
          </div>
        </div>
      </div>
      <div><button (click)="closeSupplyDepot()">Back</button></div>
    </div>


    <img [src]="currentFactorySrc"
         class="factoryBackground"
         *ngIf="flvl1Src && flvl2Src && flvl3Src && nexusBase && isFactoryOpen" loading="lazy" decoding="asynchronous" />
    <div *ngIf="isFactoryOpen" class="factoryScreen">

      <div *ngIf="calculateCurrentSupply() > 0">
        Upgrade the Factory to train more units simultaneously. Current training limit: <span class="redText">{{nexusBase?.factoryLevel ?? 0}}</span>
      </div>
      <div *ngIf="calculateCurrentSupply() == 0" class="redText">You require more supply.</div>
      <div *ngIf="calculateCurrentSupply() == 0">Upgrade the Supply Depot to train more units.</div>

      <div class="unitsTableDiv">
        <table class="upgradeDisplayTable">
          <tbody *ngFor="let unit of getFactoryUnits()">
            <tr>
              <td class="unitPictureTd" (click)="toggleUnitScreen(unit, true)">
                <img [src]="unit.pictureSrc" class="unitPicture" *ngIf="unit.pictureSrc" loading="lazy" decoding="asynchronous" />
              </td>
              <td class="unitPictureTd capitalize smallFont usernameProfileLink">
                {{ unit.unitType.replace('_', ' ') }}
              </td>
              <td class="unitSliderTd">
                <input type="range" class="unitSliderTd" [value]="unit.purchasedValue ?? 0" [min]="0" [max]="maxSliderValue(unit)" [step]="1" (input)="onSliderChange($event, unit)" />
              </td>
              <td>
                <input [value]="unit.purchasedValue ? unit.purchasedValue : '0'" (keyup)="onSliderChange($event, unit)" class="unitInput" />
              </td>
              <td class="unitPictureTd xxSmallFont invertedHighlights cursorPointer centeredText" (click)="unit.purchasedValue = maxSliderValue(unit)">
                {{maxSliderValue(unit)}}
              </td>
              <td class="unitPictureTd">
                <button [disabled]="!unit.purchasedValue || isLoading || (nexusBase && nexusBase.gold < unit.cost)" (click)="purchaseUnit(unit.unitId)">‚úîÔ∏è</button>
              </td>
            </tr>
            <tr>
              <td></td>
              <td class="smallFont" colspan="3">
                <span class="goldText">üìÄ{{ ((unit.purchasedValue ? unit.purchasedValue : 1) * unit.cost) }}</span>
                ‚è±Ô∏è{{ formatTimer(unit.duration * (unit.purchasedValue ? unit.purchasedValue : 1))}}
                <span [class]="((unit.purchasedValue ? unit.purchasedValue : 1) * unit.supply) > supplyCapacity ? 'redText' : ''">ü•©{{ unit.supply ? (unit.purchasedValue ? unit.purchasedValue : 1) * unit.supply : ''}}</span>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
      <div><button (click)="closeFactory()">Back</button></div>
    </div>


    <img [src]="currentStarportSrc"
         class="starportBackground"
         *ngIf="splvl1Src && splvl2Src && splvl3Src && nexusBase && isStarportOpen"
         loading="lazy" decoding="asynchronous" />
    <div *ngIf="isStarportOpen" class="starportScreen">

      <div *ngIf="calculateCurrentSupply() > 0">
        Upgrade the Starport to train more units simultaneously. Current training limit: <span class="redText">{{nexusBase?.starportLevel ?? 0}}</span>
      </div>
      <div *ngIf="calculateCurrentSupply() == 0" class="redText">You require more supply.</div>
      <div *ngIf="calculateCurrentSupply() == 0">Upgrade the Supply Depot to train more units.</div>

      <div class="unitsTableDiv">
        <table class="upgradeDisplayTable">
          <tbody *ngFor="let unit of getStarportUnits()">
            <tr>
              <td class="unitPictureTd" (click)="toggleUnitScreen(unit, true)">
                <img [src]="unit.pictureSrc" class="unitPicture" *ngIf="unit.pictureSrc" loading="lazy" decoding="asynchronous" />
              </td>
              <td class="unitPictureTd capitalize smallFont usernameProfileLink">
                {{ unit.unitType.replace('_', ' ') }}
              </td>
              <td class="unitSliderTd">
                <input type="range" class="unitSliderTd" [value]="unit.purchasedValue ?? 0" [min]="0" [max]="maxSliderValue(unit)" [step]="1" (input)="onSliderChange($event, unit)" />
              </td>
              <td>
                <input [value]="unit.purchasedValue ? unit.purchasedValue : '0'" (keyup)="onSliderChange($event, unit)" class="unitInput" />
              </td>
              <td class="unitPictureTd xxSmallFont invertedHighlights cursorPointer centeredText" (click)="unit.purchasedValue = maxSliderValue(unit)">
                {{maxSliderValue(unit)}}
              </td>
              <td class="unitPictureTd">
                <button [disabled]="!unit.purchasedValue || isLoading || (nexusBase && nexusBase.gold < unit.cost)" (click)="purchaseUnit(unit.unitId)">‚úîÔ∏è</button>
              </td>
            </tr>
            <tr>
              <td></td>
              <td class="smallFont" colspan="3">
                <span class="goldText">üìÄ{{ ((unit.purchasedValue ? unit.purchasedValue : 1) * unit.cost) }}</span>
                ‚è±Ô∏è{{ formatTimer(unit.duration * (unit.purchasedValue ? unit.purchasedValue : 1))}}
                <span [class]="((unit.purchasedValue ? unit.purchasedValue : 1) * unit.supply) > supplyCapacity ? 'redText' : ''">ü•©{{ unit.supply ? (unit.purchasedValue ? unit.purchasedValue : 1) * unit.supply : ''}}</span>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
      <div><button (click)="closeStarport()">Back</button></div>
    </div>


    <img [src]="currentWarehouseSrc"
         class="warehouseBackground"
         *ngIf="whlvl1Src && whlvl2Src && whlvl3Src && nexusBase && isWarehouseOpen" loading="lazy" decoding="asynchronous" />
    <div *ngIf="isWarehouseOpen" class="warehouseScreen">
      <div>
        üìÄ Current gold capacity : <span class="goldText">{{goldCapacity}}üìÄ</span>
      </div>
      <div class="showMoreInfoWarehouseDiv">
        <div (click)="showMoreWarehouseInfo = !showMoreWarehouseInfo" class="cursorPointer">{{showMoreWarehouseInfo ? 'Hide' : 'More'}} info</div>
        <div class="warehouseLevelsDiv" *ngIf="showMoreWarehouseInfo">
          <table class="mainTable">
            <thead>
              <tr>
                <th>Warehouse Level</th>
                <th>Capacity</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let i of warehouseUpgradeLevels" [class]="i == nexusBase?.warehouseLevel ? 'highlightBg' : ''">
                <td>Level {{i}}</td>
                <td>{{5000 * (i + 1)}}üìÄ</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
      <div *ngIf="nexusBase && nexusBase.engineeringBayLevel > 6">
        Mint Gold Coins!
      </div>
      <div><button (click)="closeWarehouse()">Back</button></div>
    </div>


    <img [src]="currentEngineeringBaySrc"
         class="engineeringBayBackground"
         *ngIf="eblvl1Src && eblvl2Src && eblvl3Src && nexusBase && isEngineeringBayOpen"
         loading="lazy" decoding="asynchronous" />
    <div *ngIf="isEngineeringBayOpen" class="engineeringBayScreen">
      <div class="researchDisplayP">
        Current upgrade limit: {{getEngineerBayUpgradeLimit()}}
        <span (click)="showMoreEngineeringBayInfo = !showMoreEngineeringBayInfo" class="cursorPointer xxSmallFont ebMoreInfoSpan">
          {{showMoreEngineeringBayInfo ? 'Hide' : 'More'}} info
        </span>
      </div>
      <div *ngIf="showMoreEngineeringBayInfo">
        <div class="notification">Upgrade the engineering bay to get access to more simultaneous unit researches.</div>
        <div class="notification" *ngIf="glitcherStats && nexusBase && (nexusBase.factoryLevel >= glitcherStats.factoryLevel) && (nexusBase.starportLevel >= glitcherStats.starportLevel) && (nexusBase.engineeringBayLevel >= glitcherStats.engineeringBayLevel)">
          Purchase Glitchers and send them with you in battle to expand and conquer territories!
        </div>
        <div class="notification">Every research upgrade is a damage multiplier applied to units when attacking and defending.</div>
        <div *ngFor="let stat of unitUpgradeStats">
          <table class="unitsTableDiv">
            <tbody>
              <tr>
                <td>Level: {{stat.unitLevel}}</td>
                <td>Damage Multiplier: {{stat.damageMultiplier}}</td>
                <td>Duration: {{stat.duration}}</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
      <div class="unitsUpgradesDiv" *ngIf="!showMoreEngineeringBayInfo">
        <div class="unitResearches">
          <div *ngFor="let unit of (unitsWithoutGlitcher ? unitsWithoutGlitcher : getUnitsWithoutGlitcher()); trackBy: trackByUnit" class="unitUpgradeDiv capitalize xxSmallFont gameNotification unitUpgradeDivContainer">
            <div class="portraitContainer" [title]="unit.unitLevel < 4 ? 'üìÄ'+getResearchCostPerUnit(unit) : ''">
              <img [src]="unit.pictureSrc" loading="lazy" class="unitPicture " decoding="asynchronous" />
              <div class="unitCountLabel">
                Level {{unit.unitLevel > 3 ? 3 : unit.unitLevel}}
              </div>
            </div>
            <button [disabled]="isLoading" (click)="research(unit)" *ngIf="unit.unitLevel < 3">
              {{ getResearchDisplay(unit) }}
            </button>
          </div>
        </div>

        <div class=""
             *ngIf="glitcherStats && nexusBase && (nexusBase.factoryLevel >= glitcherStats.factoryLevel) && (nexusBase.starportLevel >= glitcherStats.starportLevel) && (nexusBase.engineeringBayLevel >= glitcherStats.engineeringBayLevel)">
          <table class="upgradeDisplayTable">
            <tbody>
              <tr>
                <td class="unitPictureTd" (click)="toggleUnitScreen(glitcherStats, true)">
                  <img [src]="glitcherStats.pictureSrc" class="unitPicture" *ngIf="glitcherStats.pictureSrc" loading="lazy" decoding="asynchronous" />
                </td>
                <td class="unitPictureTd capitalize smallFont usernameProfileLink">
                  {{ glitcherStats.unitType }}
                </td>
                <td class="unitSliderTd">
                  <input type="range" class="unitSliderTd" [value]="glitcherStats.purchasedValue ?? 0" [min]="0" [max]="maxSliderValue(glitcherStats)" [step]="1" (input)="onSliderChange($event, glitcherStats)" />
                </td>
                <td>
                  <input [value]="glitcherStats.purchasedValue ? glitcherStats.purchasedValue : '0'" (keyup)="onSliderChange($event, glitcherStats)" class="unitInput" />
                </td>
                <td class="unitPictureTd xxSmallFont invertedHighlights cursorPointer centeredText" (click)="glitcherStats.purchasedValue = maxSliderValue(glitcherStats)">
                  {{maxSliderValue(glitcherStats)}}
                </td>
                <td class="unitPictureTd">
                  <button [disabled]="!glitcherStats.purchasedValue || isLoading || (nexusBase && nexusBase.gold < glitcherStats.cost)" (click)="purchaseUnit(glitcherStats.unitId)">‚úîÔ∏è</button>
                </td>
              </tr>
              <tr>
                <td></td>
                <td class="smallFont" colspan="3">
                  <span class="goldText">üìÄ{{ ((glitcherStats.purchasedValue ? glitcherStats.purchasedValue : 1) * glitcherStats.cost) }}</span>
                  ‚è±Ô∏è{{ formatTimer(glitcherStats.duration * (glitcherStats.purchasedValue ? glitcherStats.purchasedValue : 1))}}
                  <span [class]="((glitcherStats.purchasedValue ? glitcherStats.purchasedValue : 1) * glitcherStats.supply) > supplyCapacity ? 'redText' : ''">ü•©{{ glitcherStats.supply ? (glitcherStats.purchasedValue ? glitcherStats.purchasedValue : 1) * glitcherStats.supply : ''}}</span>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
      <div><button (click)="showMoreEngineeringBayInfo ? (showMoreEngineeringBayInfo = !showMoreEngineeringBayInfo) : closeEngineeringBay()">Back</button></div>
    </div>


    <img [src]="currentMinesSrc"
         class="minesBackground"
         *ngIf="mineslvl1Src && mineslvl2Src && mineslvl3Src && nexusBase && isMinesOpen"
         loading="lazy" decoding="asynchronous" />
    <div *ngIf="isMinesOpen" class="minesScreen">
      <div>
        <div>Upgrade the mines to increase mining efficiency.</div>
        <div>üìÄ Current mining speed: <span class="gameNotification"><span class="goldText">1 üìÄ</span> per {{miningSpeed}} second(s)</span>.</div>
      </div>
      <div><button (click)="closeMines()">Back</button></div>
    </div>
  </div>


  <div class="upgradesTableDiv" *ngIf="isCommandCenterOpen">
    <table class="mainTable">
      <thead>
        <tr>
          <th colspan="5">Upgrades Available</th>
        </tr>
      </thead>
      <tbody *ngIf="currentValidAvailableUpgrades && currentValidAvailableUpgrades.length > 0 ? currentValidAvailableUpgrades : getValidBuildingUpgrades().length > 0 ? currentValidAvailableUpgrades : false">
        <tr *ngFor="let upgrade of (currentValidAvailableUpgrades ? currentValidAvailableUpgrades : getValidBuildingUpgrades())">
          <td class="capitalize cursorPointer" (click)="goToBuilding(upgrade.building)">{{upgrade.building.replace('_', ' ')}}</td>
          <td>Level {{upgrade.nextLevel + 1}}</td>
          <td class="goldText">üìÄ{{upgrade.cost}}</td>
          <td>{{formatTimer(upgrade.duration)}}</td>
          <td>
            <button [disabled]="isLoading" (click)="upgradeBuilding(upgrade.building)" #upgradeButton class="upgradeButton">
              {{ getBuildingTimerForBuilding(upgrade.building) ? formatTimer(getBuildingTimerForBuilding(upgrade.building).endTime) : ((nexusBase && nexusBase.gold < upgrade.cost) || (this.nexusBase && this.getBuildingCountersLength() >= this.nexusBase.commandCenterLevel + 1)) ? '‚õî' :  'üîß' }}
            </button>
          </td>
        </tr>
      </tbody>
      <tbody *ngIf="!currentValidAvailableUpgrades || currentValidAvailableUpgrades.length == 0">
        <tr>
          <td colspan="5">All buildings are maxed out on upgrades.</td>
        </tr>
      </tbody>
    </table>
  </div>


  <div *ngIf="toggledUnitStat">
    <div class="toggledUnitStatScreen" *ngIf="toggledUnitStat">
      <div class="toggledUnitStatInfoDiv">
        <div class="usernameProfileLink capitalize unitStatUnitTitle">{{toggledUnitStat.unitType.replace('_', ' ')}}</div>
        <div class="gameNotification">üß¨Unit reasearch level: {{toggledUnitStat.unitLevel}}</div>
        <div class="gameNotification">‚öîÔ∏èGround damage : {{toggledUnitStat.groundDamage}}</div>
        <div class="gameNotification">üöÄAir damage : {{toggledUnitStat.airDamage}}</div>
        <div class="gameNotification">ü•©Supply cost: {{toggledUnitStat.supply}}</div>
        <div class="gameNotification">üìÄCost per unit: <span class="goldText">{{toggledUnitStat.cost}}</span></div>
        <div class="gameNotification">üìÄCarrying capacity: <span class="goldText">{{toggledUnitStat.goldCarryingCapacity}}</span></div>
        <div class="gameNotification">‚è±Ô∏èTraining duration time: {{formatTimer(toggledUnitStat.duration)}}</div>
        <div class="gameNotification">‚è±Ô∏èTravel speed: {{toggledUnitStat.speed}}</div>
        <div class="gameNotification">üè∞Factory level req.: {{toggledUnitStat.factoryLevel}}</div>
        <div class="gameNotification">üè∞Starport level req.: {{toggledUnitStat.starportLevel}}</div>
        <div class="gameNotification">üè∞Engineering Bay level req.: {{toggledUnitStat.engineeringBayLevel}}</div>
      </div>
      <div class="toggledUnitStatInfoPic">
        <img class="toggledUnitStatInfoPicImg"
             [src]="toggledUnitStat.pictureSrc"
             *ngIf="toggledUnitStat.pictureSrc"
             [style.display]="toggledUnitStat ? 'block' : 'none'" loading="lazy" decoding="asynchronous" />
        <button (click)="toggleUnitScreen(toggledUnitStat, false)">Close</button>
      </div>
    </div>
  </div>

  <div *ngIf="!isCommandCenterOpen && !toggledUnitStat && !isMapOpen && !isReportsOpen && !isBasesOpen && !isSupportOpen && !isUserNew && !isUserComponentOpen">
    <span *ngIf="activeAttackTimers().length > 0 || activeDefenceTimers().length > 0" class="mainInfoSection">Movement:</span>
    <div *ngIf="activeAttackTimers().length > 0 || activeDefenceTimers().length > 0">
      <div class="upgradeTimersTableDiv">
        <div *ngFor="let timer of activeAttackTimers()" [class]="'pointer ' + (timer.unit.includes('Support') ? 'defenceProgressDisplayP' : 'unitProgressDisplayP') + ' capitalize'" (click)="openMapAndScrollTo(timer.unit)">
          {{ formatBuildingTimer(timer.unit) }} {{ formatTimer(timer.endTime) }} <span *ngIf="canSendUnitsBack(timer.object)" (click)="sendBackAttack(timer.object)" class="cancelAttackSpan">[Cancel ‚Ü©]</span>
        </div>
        <div *ngFor="let timer of activeDefenceTimers()" [class]="'pointer ' + (timer.unit.includes('Support') ? 'defenceProgressDisplayP' : 'unitProgressDisplayP') + ' capitalize'" (click)="openMapAndScrollTo(timer.unit)">
          {{ formatBuildingTimer(timer.unit) }} {{ formatTimer(timer.endTime) }} <span *ngIf="canSendUnitsBack(timer.object)" (click)="sendBackDefence(timer.object)" class="cancelAttackSpan">[Cancel ‚Ü©]</span>
        </div>
      </div>
    </div>
    <div *ngIf="activeUnitTimers().length > 0 || activeResearchTimers().length > 0">
      <span *ngIf="activeUnitTimers().length > 0" class="mainInfoSection">Training:</span>
      <div *ngIf="activeUnitTimers().length > 0" class="unitPurchaseTableDiv upgradeTimersTableDiv">
        <div *ngFor="let timer of activeUnitTimers()" class="activeUnitTimerDiv capitalize">
          <div *ngIf="timer.unit.includes('marine')">
            <app-nexus-base-units [showOnlyMarine]="true"
                                  [marineTitle]="formatTimer(timer.endTime)"
                                  [nexusAvailableUnits]="reinitializeNexusUnitsByType('nexusAvailableUnits', 'marine', formatBuildingTimer(timer.unit).split(' ')[0], true)"
                                  [parentRef]="parentRef"
                                  [marinePictureSrc]="marinePictureSrc"
                                  (toggleUnitScreen)="toggleUnitScreenFromBaseUnits($event)"></app-nexus-base-units>
          </div>
          <div *ngIf="timer.unit.includes('goliath')">
            <app-nexus-base-units [showOnlyGoliath]="true"
                                  [goliathTitle]="formatTimer(timer.endTime)"
                                  [nexusAvailableUnits]="reinitializeNexusUnitsByType('nexusAvailableUnits', 'goliath', formatBuildingTimer(timer.unit).split(' ')[0], true)"
                                  [parentRef]="parentRef"
                                  [goliathPictureSrc]="goliathPictureSrc"
                                  (toggleUnitScreen)="toggleUnitScreenFromBaseUnits($event)"></app-nexus-base-units>
          </div>
          <div *ngIf="timer.unit.includes('siege_tank')">
            <app-nexus-base-units [showOnlySiegeTank]="true"
                                  [siegeTankTitle]="formatTimer(timer.endTime)"
                                  [nexusAvailableUnits]="reinitializeNexusUnitsByType('nexusAvailableUnits', 'siege_tank', formatBuildingTimer(timer.unit).split(' ')[0], true)"
                                  [parentRef]="parentRef"
                                  [siegeTankPictureSrc]="siegeTankPictureSrc"
                                  (toggleUnitScreen)="toggleUnitScreenFromBaseUnits($event)"></app-nexus-base-units>
          </div>
          <div *ngIf="timer.unit.includes('scout')">
            <app-nexus-base-units [showOnlyScout]="true"
                                  [scoutTitle]="formatTimer(timer.endTime)"
                                  [nexusAvailableUnits]="reinitializeNexusUnitsByType('nexusAvailableUnits', 'scout', formatBuildingTimer(timer.unit).split(' ')[0], true)"
                                  [parentRef]="parentRef"
                                  [scoutPictureSrc]="scoutPictureSrc"
                                  (toggleUnitScreen)="toggleUnitScreenFromBaseUnits($event)"></app-nexus-base-units>
          </div>
          <div *ngIf="timer.unit.includes('wraith')">
            <app-nexus-base-units [showOnlyWraith]="true"
                                  [wraithTitle]="formatTimer(timer.endTime)"
                                  [nexusAvailableUnits]="reinitializeNexusUnitsByType('nexusAvailableUnits', 'wraith', formatBuildingTimer(timer.unit).split(' ')[0], true)"
                                  [parentRef]="parentRef"
                                  [wraithPictureSrc]="wraithPictureSrc"
                                  (toggleUnitScreen)="toggleUnitScreenFromBaseUnits($event)"></app-nexus-base-units>
          </div>
          <div *ngIf="timer.unit.includes('battlecruiser')">
            <app-nexus-base-units [showOnlyBattlecruiser]="true"
                                  [battlecruiserTitle]="formatTimer(timer.endTime)"
                                  [nexusAvailableUnits]="reinitializeNexusUnitsByType('nexusAvailableUnits', 'battlecruiser', formatBuildingTimer(timer.unit).split(' ')[0], true)"
                                  [parentRef]="parentRef"
                                  [battlecruiserPictureSrc]="battlecruiserPictureSrc"
                                  (toggleUnitScreen)="toggleUnitScreenFromBaseUnits($event)"></app-nexus-base-units>
          </div>
          <div *ngIf="timer.unit.includes('glitcher')">
            <app-nexus-base-units [showOnlyGlitcher]="true"
                                  [glitcherTitle]="formatTimer(timer.endTime)"
                                  [nexusAvailableUnits]="reinitializeNexusUnitsByType('nexusAvailableUnits', 'glitcher', formatBuildingTimer(timer.unit).split(' ')[0], true)"
                                  [parentRef]="parentRef"
                                  [glitcherPictureSrc]="glitcherPictureSrc"
                                  (toggleUnitScreen)="toggleUnitScreenFromBaseUnits($event)"></app-nexus-base-units>
          </div>
          <!--{{ formatBuildingTimer(timer.unit) }} {{ formatTimer(timer.endTime) }}-->
        </div>
      </div>
      <div *ngIf="activeResearchTimers().length > 0">
        <span class="mainInfoSection">Research:</span>
        <div class="upgradeTimersTableDiv">
          <div *ngIf="activeResearchTimers().length > 0">
            <div *ngFor="let timer of activeResearchTimers()" class="researchDisplayP capitalize">
              {{formatBuildingTimer(timer.unit) }} {{ formatTimer(timer.endTime) }}
            </div>
          </div>
        </div>
      </div>
      <!--Building: <span class="xxSmallFont redText" *ngIf="!activeBuildingTimers() || activeBuildingTimers().length == 0">[No building.]</span>
      <div class="upgradeTimersTableDiv">
        <ng-container *ngIf="activeBuildingTimers().length > 0">
          <div *ngFor="let timer of activeBuildingTimers()">
            <p class="upgradeProgressDisplayP capitalize">
              {{ formatBuildingTimer(timer.building) }} {{ formatTimer(timer.endTime) }}
            </p>
          </div>
        </ng-container>
      </div>-->
    </div>
    <div class="unitslist" *ngIf="!isCommandCenterOpen && !isMapOpen && !isReportsOpen && !isBasesOpen && !isSupportOpen && !isUserNew && !isUserComponentOpen && !toggledUnitStat">
      <div *ngIf="nexusAvailableUnits">
        <span class="mainInfoSection">Available:</span>
        <app-nexus-base-units [parentRef]="parentRef"
                              [nexusAvailableUnits]="nexusAvailableUnits"
                              [marinePictureSrc]="marinePictureSrc"
                              [goliathPictureSrc]="goliathPictureSrc"
                              [siegeTankPictureSrc]="siegeTankPictureSrc"
                              [scoutPictureSrc]="scoutPictureSrc"
                              [wraithPictureSrc]="wraithPictureSrc"
                              [battlecruiserPictureSrc]="battlecruiserPictureSrc"
                              [glitcherPictureSrc]="glitcherPictureSrc"
                              (toggleUnitScreen)="toggleUnitScreenFromBaseUnits($event)">
        </app-nexus-base-units>
      </div>
      <div *ngIf="nexusExternalSupportUnits">
        <span class="mainInfoSection">Support from other bases:</span>
        <app-nexus-base-units [parentRef]="parentRef"
                              [nexusAvailableUnits]="nexusExternalSupportUnits"
                              [marinePictureSrc]="marinePictureSrc"
                              [goliathPictureSrc]="goliathPictureSrc"
                              [siegeTankPictureSrc]="siegeTankPictureSrc"
                              [scoutPictureSrc]="scoutPictureSrc"
                              [wraithPictureSrc]="wraithPictureSrc"
                              [battlecruiserPictureSrc]="battlecruiserPictureSrc"
                              [glitcherPictureSrc]="glitcherPictureSrc"
                              (toggleUnitScreen)="toggleUnitScreenFromBaseUnits($event)">
        </app-nexus-base-units>
      </div>
      <div *ngIf="nexusUnitsOutsideOfBase">
        <span class="mainInfoSection">Units outside of base:</span>
        <app-nexus-base-units [parentRef]="parentRef"
                              [nexusAvailableUnits]="nexusUnitsOutsideOfBase"
                              [marinePictureSrc]="marinePictureSrc"
                              [goliathPictureSrc]="goliathPictureSrc"
                              [siegeTankPictureSrc]="siegeTankPictureSrc"
                              [scoutPictureSrc]="scoutPictureSrc"
                              [wraithPictureSrc]="wraithPictureSrc"
                              [battlecruiserPictureSrc]="battlecruiserPictureSrc"
                              [glitcherPictureSrc]="glitcherPictureSrc"
                              (toggleUnitScreen)="toggleUnitScreenFromBaseUnits($event)">
        </app-nexus-base-units>
      </div>
    </div>
  </div>
  <div *ngIf="numberOfPersonalBases == 1 && nexusBase && !isMapOpen && !isReportsOpen && !isBasesOpen && !isSupportOpen">
    <div *ngIf="nexusBase.minesLevel == 0 && (!nexusBaseUpgrades || !nexusBaseUpgrades.minesUpgraded)">
      <span class="invertedHighlights">WELCOME TO THE BUG WARS, COMMANDER.</span>
      <div class="notification" [style.textDecoration]="isCommandCenterOpen ? 'line-through' : 'none'">Click on the Command Center to build or upgrade buildings.</div>
      <div class="notification">Click on the üîß button to start building a mine.</div>
    </div>
    <div *ngIf="nexusBase.minesLevel == 0 && nexusBaseUpgrades && nexusBaseUpgrades.minesUpgraded">
      <div class="invertedHighlights">Congrats! You built your first mines.</div>
      <div class="notification">This building generates gold every second.</div>
      <div class="notification">Lets wait until this building completes...</div>
    </div>
    <div *ngIf="nexusBase.minesLevel == 1 && (nexusBaseUpgrades && !nexusBaseUpgrades.minesUpgraded && !nexusBaseUpgrades.factoryUpgraded && !nexusBaseUpgrades.starportUpgraded && !nexusBaseUpgrades.commandCenterUpgraded && !nexusBaseUpgrades.engineeringBayUpgraded && !nexusBaseUpgrades.warehouseUpgraded) && (!(nexusBase.factoryLevel > 0) && !(nexusBase.starportLevel > 0) && !(nexusBase.commandCenterLevel > 1) && !(nexusBase.engineeringBayLevel > 0) && !(nexusBase.supplyDepotLevel > 0) && !(nexusBase.warehouseLevel > 0))">
      <div class="invertedHighlights">You now have a choice!</div>
      <div class="notification">Build a factory to train units or keep upgrading other buildings.</div>
      <div class="notification">It is recommended you take a look at the map (click on the button below) to get acquainted with your surroundings.</div>
    </div>
  </div>

  <div class="gameNotificationDiv">
    <div *ngFor="let notif of notifications" class="gameNotification capitalize" (click)="notifications = []">‚û´ <span>{{notif.replaceAll('_', ' ')}}</span></div>
  </div>
  <div class="shareMapButtonDiv">
    <button (click)="copyLink()" title="Share Link">Share üìã</button>
    <button (click)="toggleScreen('map', !isMapOpen)" title="View Map" *ngIf="!isUserNew && parentRef && parentRef.user" [disabled]="isLoading">{{isMapOpen ? 'Close ' : ''}}Map üó∫Ô∏è</button>
    <button (click)="toggleScreen('reports', !isReportsOpen)" title="View Reports" *ngIf="!isUserNew && parentRef && parentRef.user" [disabled]="isLoading">{{isReportsOpen ? 'Close ' : ''}}Data üìÉ</button>
    <button (click)="toggleScreen('bases', !isBasesOpen)" title="View Bases" *ngIf="!isUserNew && parentRef && parentRef.user" [disabled]="isLoading">{{isBasesOpen ? 'Close ' : ''}}Bases üè∞</button>
    <button (click)="toggleScreen('support', !isSupportOpen)" title="View Support" *ngIf="!isUserNew && parentRef && parentRef.user" [disabled]="isLoading">{{isSupportOpen ? 'Close ' : ''}}Support üõ°Ô∏è</button>
  </div>
  <div *ngIf="!isLoading && !nexusBase && !isUserNew">
    Server is down.
  </div>
</div>
