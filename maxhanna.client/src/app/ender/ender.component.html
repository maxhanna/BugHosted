<div class="componentMain" #componentMain>
  <div class="closeButton" (click)="remove_me('EnderComponent');"></div>
  <div class="menuButton" (click)="showMenuPanel()"></div>
  <div class="componentTitle">Ender</div>
  <div class="gameCanvasContainer">
    <canvas #gameCanvas id="gameCanvas" class="gameCanvas" width=320 height="220"></canvas>
  </div>
  <div class="chatArea">
    <div class="chatInputDiv">
      <input type="text" [placeholder]=" 'Chat'" #chatInput id="chatInput" class="chatInput" />
    </div>
  </div>

  <div class="inputArea">
    <div class="controls">
      <div class="controls">
        <div class="dpad">
          <div class="up-left" (mousedown)="mainScene.input.handleControl('UP_LEFT', 'press')"
            (mouseup)="mainScene.input.handleControl('UP_LEFT', 'release')"
            (touchstart)="mainScene.input.handleControl('UP_LEFT', 'press', $event)"
            (touchend)="mainScene.input.handleControl('UP_LEFT', 'release', $event)"
            (touchcancel)="mainScene.input.handleControl('UP_LEFT', 'release', $event)">
            <div class="up-left-triangle"></div>
          </div>
          <div class="up" (mousedown)="mainScene.input.handleControl('UP', 'press')"
            (mouseup)="mainScene.input.handleControl('UP', 'release')"
            (touchstart)="mainScene.input.handleControl('UP', 'press', $event)"
            (touchend)="mainScene.input.handleControl('UP', 'release', $event)"
            (touchcancel)="mainScene.input.handleControl('UP', 'release', $event)">
            <div class="up-triangle"></div>
          </div>
          <div class="up-right" (mousedown)="mainScene.input.handleControl('UP_RIGHT', 'press')"
            (mouseup)="mainScene.input.handleControl('UP_RIGHT', 'release')"
            (touchstart)="mainScene.input.handleControl('UP_RIGHT', 'press', $event)"
            (touchend)="mainScene.input.handleControl('UP_RIGHT', 'release', $event)"
            (touchcancel)="mainScene.input.handleControl('UP_RIGHT', 'release', $event)">
            <div class="up-right-triangle"></div>
          </div>
          <div class="right" (mousedown)="mainScene.input.handleControl('RIGHT', 'press')"
            (mouseup)="mainScene.input.handleControl('RIGHT', 'release')"
            (touchstart)="mainScene.input.handleControl('RIGHT', 'press', $event)"
            (touchend)="mainScene.input.handleControl('RIGHT', 'release', $event)"
            (touchcancel)="mainScene.input.handleControl('RIGHT', 'release', $event)">
            <div class="right-triangle"></div>
          </div>
          <div class="down" (mousedown)="mainScene.input.handleControl('DOWN', 'press')"
            (mouseup)="mainScene.input.handleControl('DOWN', 'release')"
            (touchstart)="mainScene.input.handleControl('DOWN', 'press', $event)"
            (touchend)="mainScene.input.handleControl('DOWN', 'release', $event)"
            (touchcancel)="mainScene.input.handleControl('DOWN', 'release', $event)">
            <div class="down-triangle"></div>
          </div>
          <div class="down-left" (mousedown)="mainScene.input.handleControl('DOWN_LEFT', 'press')"
            (mouseup)="mainScene.input.handleControl('DOWN_LEFT', 'release')"
            (touchstart)="mainScene.input.handleControl('DOWN_LEFT', 'press', $event)"
            (touchend)="mainScene.input.handleControl('DOWN_LEFT', 'release', $event)"
            (touchcancel)="mainScene.input.handleControl('DOWN_LEFT', 'release', $event)">
            <div class="down-left-triangle"></div>
          </div>
          <div class="left" (mousedown)="mainScene.input.handleControl('LEFT', 'press')"
            (mouseup)="mainScene.input.handleControl('LEFT', 'release')"
            (touchstart)="mainScene.input.handleControl('LEFT', 'press', $event)"
            (touchend)="mainScene.input.handleControl('LEFT', 'release', $event)"
            (touchcancel)="mainScene.input.handleControl('LEFT', 'release', $event)">
            <div class="left-triangle"></div>
          </div>
          <div class="down-right" (mousedown)="mainScene.input.handleControl('DOWN_RIGHT', 'press')"
            (mouseup)="mainScene.input.handleControl('DOWN_RIGHT', 'release')"
            (touchstart)="mainScene.input.handleControl('DOWN_RIGHT', 'press', $event)"
            (touchend)="mainScene.input.handleControl('DOWN_RIGHT', 'release', $event)"
            (touchcancel)="mainScene.input.handleControl('DOWN_RIGHT', 'release', $event)">
            <div class="down-right-triangle"></div>
          </div>
          <div class="middle">
          </div>
        </div>
      </div>
    </div>

    <div class="controls">
      <div class="a-b">
        <div class="b" (mouseup)='mainScene.input.pressB()'>B</div>
        <div class="a" (mouseup)='mainScene.input.pressA()'>A</div>
      </div>

      <div class="start" (mouseup)='mainScene.input.pressStart()'>START</div>
    </div>

    <!-- Live run HUD -->
    <div class="runHud" *ngIf="!isMenuPanelOpen && !showOtherHeroesPanel && !showDeathPanel"
      style="position:fixed; bottom: 200px; right: 20px; color:var(--secondary-font-color); text-shadow:0 -1px 0 #222;">
      <div><strong>Time:</strong> {{runElapsedSeconds}}s</div>
      <div><strong>Walls:</strong> {{wallsPlacedThisRun}}</div>
      <div><strong>Score:</strong> {{currentScore}}</div>
      <div><strong>Level:</strong> {{metaHero.level}}</div>
      <div><strong>Kills:</strong> {{metaHero.kills}}</div>
      <div class="cursorPointerUnderlined" (click)="openOtherHeroesPanel()" title="Show other heroes on this level">
        <strong>Enemies:</strong> {{enemiesOnSameLevelCount}}
      </div>
      <div *ngIf="metaHero && metaHero.position">
        <strong>
          {{ snapToGridFetch(metaHero.position.x) }},
          {{ snapToGridFetch(metaHero.position.y) }}
        </strong>
      </div>
      <div *ngIf="mainScene?.level?.name === 'CharacterCreate'">
        <input type="color" (change)='changeColor()' #colorInput class="colorInput" [value]="metaHero.color" />
      </div>
      <div *ngIf="serverDown" class="bold" style="color:red">
        Server Down
      </div>
    </div>
  </div>

  <div class="popupPanel" style="overflow: auto;" *ngIf="isMenuPanelOpen">
    <div class="popupPanelTitle mainPopupTitle">Ender</div>
    <div style="padding:6px 8px;">
      <button class="closeButton" (click)="toggleMuteSounds()" style="margin-bottom:6px;">
        {{ isMuted ? 'Unmute Sounds' : 'Mute Sounds' }}
      </button>
    </div>
    <app-ender-high-scores [mode]="'all'" [parentRef]="parentRef" [headersCollapsed]="true"></app-ender-high-scores>
    <app-share-button [inputtedParentRef]="parentRef" [link]="'Ender'"></app-share-button>
    <button id="closeOverlay" class="closeButton" (click)="closeMenuPanel()">Close</button>
  </div>
  <app-user class="popupPanel ucPopupPanel" *ngIf="isUserComponentOpen" [loginOnly]="true"
    [inputtedParentRef]="parentRef" [canClose]="false" (closeUserComponentEvent)="closeUserComponent($event)"
    [loginReasonMessage]="'You must log in to play Ender.'"></app-user>
</div>

<!-- Death overlay -->
<div class="popupPanel" *ngIf="showDeathPanel" style="max-width:320px; text-align:center;">
  <div class="popupPanelTitle mainPopupTitle">You Died</div>
  <div class="finalScoreWrapper">
    <div style="pointer-events:none; margin-bottom:8px;">
      Final Score: {{currentScore}}
    </div>
    <div style="pointer-events:none; margin-bottom:8px;">
      <div>Time: {{runElapsedSeconds}}s</div>
      <div>Walls: {{wallsPlacedAuthoritative || wallsPlacedThisRun}}</div>
      <div> Kills: {{metaHero.kills || 0}}</div>
    </div>
    <button class="closeButton" id="closeOverlay" (click)="restartGame()">Restart</button>
  </div>
</div>

<!-- Other heroes stats popup -->
<div class="popupPanel" *ngIf="showOtherHeroesPanel" style="max-width:360px; overflow:auto;">
  <div class="popupPanelTitle mainPopupTitle">
    Other Heroes
  </div>
  <div *ngIf="otherHeroes && otherHeroes.length === 0" style="padding:8px;">No other heroes detected.</div>
  <div class="otherHeroContainer">
    <div *ngFor="let h of otherHeroes" class="otherHeroRow" style="padding:6px 8px; border-bottom:1px solid #333;">
      <div><strong>{{h.name}}</strong> <span *ngIf="h.id === metaHero.id">(You)</span></div>
      <div class="xxSmallFont">Lvl {{h.level}} | Kills {{h.kills}} | Time {{getHeroTimeOnMap(h.id)}}s</div>
      <div *ngIf="h.color" class="xxSmallFont">Color: <span [style.background]="h.color"
          style="display:inline-block; width:12px; height:12px; border:1px solid #222; vertical-align:middle;"></span>
        {{h.color}}
      </div>
      <div class="xxSmallFont" *ngIf="h.position"><strong>Pos: {{snapToGridFetch(h.position.x)}} ,
        {{snapToGridFetch(h.position.y)}}</strong>
      </div>
    </div>
  </div>
  <div style="padding:8px; text-align: center;">
    <button class="closeButton" id="closeOverlay" (click)="closeOtherHeroesPanel()">
      Close
    </button>
  </div>
</div>