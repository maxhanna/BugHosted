<div class="componentMain {{ user ? 'componentMainFullHeight' : ''}}">
  <div class="closeButton" (click)="remove_me('UserComponent');" *ngIf="canClose || (!loginOnly && (parentRef?.user || user))"></div>
  <div class="refreshButton" (click)="ngOnInit();" *ngIf="!loginOnly"></div>
  <div class="componentTitle" *ngIf="!loginOnly">{{user ? user.username : 'Login'}}</div>

  <div *ngIf="parentRef?.user">
    <app-notifications [minimalInterface]="true"
                       [inputtedParentRef]="parentRef">
    </app-notifications>
  </div>

  <div class="userProfileContents">
    <div class="profileHeader">
      <div class="largeAvatar" *ngIf="!loginOnly && (user && this.parentRef && user.displayPictureFile) && (user?.displayPictureFile ?? this.parentRef?.user?.displayPictureFile)">
        <app-media-viewer #displayPictureViewer
                          [displayExpander]="false"
                          [displayExtraInfo]="false"
                          [showCommentSection]="false"
                          [file]="user.displayPictureFile"
                          [currentDirectory]="user.displayPictureFile.directory"
                          [user]="user">
        </app-media-viewer>
      </div>
      <div class="profileHeaderInfo" *ngIf="!loginOnly && (parentRef?.user || user)">
        <div class="profileHeaderUserDescription">
          {{user?.about?.description}}
        </div>
        <div class="seperatedUserHeader">
          <div class="invertedHighlights xxSmallFont">Location: </div>
          <div>{{weatherLocation || 'Unknown'}}</div>
        </div>
        <div class="seperatedUserHeader">
          <div class="invertedHighlights xxSmallFont">Joined: </div>
          <div>
            {{(user && user.created ? (user.created | date: 'y/MM/d') : 'Unknown')}}
            <span class="invertedHighlights xxSmallFont">({{user && user.created ? daysSince(user.created) : '0'}} days)</span>
          </div>
        </div>
        <div class="seperatedUserHeader">
          <div class="invertedHighlights xxSmallFont">Last Seen: </div>
          <div>
            {{(user && user.lastSeen ? (user.lastSeen | date: 'y/MM/d') : 'Unknown')}}
            <span class="invertedHighlights xxSmallFont">({{user && user.lastSeen ? daysSince(user.lastSeen) : '0'}} days)</span>
          </div>
        </div>
        <div class="profileControls" *ngIf="user || parentRef?.user">
          <select (change)="onProfileControlsChange()" #profileControls class="profileControlsSelector">
            <option selected disabled>Options</option>
            <option *ngIf="user || parentRef?.user" value="shareProfile">📋 Share Profile</option>
            <option *ngIf="user && user != parentRef?.user && (user && parentRef?.user?.username != user.username) && friendsIncludeMe() && !canAddFriend(user)" value="removeFriend">👤 Unfriend</option>
            <option *ngIf="user && user != parentRef?.user && (user && parentRef?.user?.username != user.username) && !friendsIncludeMe() && canAddFriend(user)" value="addFriend">👤 Follow {{isBeingFollowedByUser ? 'Back' : ''}}</option>
            <option *ngIf="user && user != parentRef?.user && (user && parentRef?.user?.username != user.username) && isFollowingUser()" value="unfollow">👤 Unfollow</option>
            <option *ngIf="user && parentRef && parentRef.user && user.id != parentRef.user.id && !contactsContains(user)" value="addContact">👤 Add Contact</option>
            <option value="showFriends">👤 Show Friends</option>
            <option *ngIf="user" value="chat">🗨️ Chat</option>
            <option *ngIf="user" value="userInfo">ℹ️ {{ isAboutPanelOpen ? 'Hide ' : '' }} User Info</option>
            <option *ngIf="user && user.id == parentRef?.user?.id" value="settings">⚙️ Settings</option>
            <option *ngIf="user && user.id == parentRef?.user?.id" value="logout">🔑 Logout</option>
          </select>
        </div>
      </div>
    </div>

    <!--LOGIN AREA-->
    <div *ngIf="(user && parentRef && parentRef.user && user.id == parentRef.user.id) || !user && !parentRef?.user">
      <div>
        <div *ngIf="!parentRef?.user">
          <div class="bughostedHeader">
            <div class="emptyUserTagLogo" *ngIf="!loginOnly">
              <app-user-tag [displayEmptyAvatar]="true"></app-user-tag>
            </div>
            <div class="bugHostedLogo" *ngIf="!loginOnly">
              BugH_sted
            </div>
            <div class="welcomeMessage" *ngIf="!loginOnly">
              <p class="welcomeTitle">Social... <small>and anti-social</small> Community🪲</p>
              <p class="welcomeTitle">{{ !usersCount && !isLoading ? '' : 'Total users: ' }}<span [class]="!usersCount && !isLoading ? 'redText' : ''">{{usersCount && !isLoading ? usersCount : !usersCount && !isLoading ? 'Server is down!' : 'Unknown Error'}}</span></p>
            </div>

            <div *ngIf="loginOnly" class="loginOnlyInstructionDiv">
              {{loginReasonMessage ? loginReasonMessage : "Remember to log in to save your progress!"}}
            </div>

            <div class="loginDiv">
              <input type="text" placeholder="Username" #loginUsername (keydown.enter)="login()" />
              <input type="password" placeholder="Password" #loginPassword (keydown.enter)="login()" />
              <div>
                <input type="submit" value="🔑 Login" (click)="login()" />
                <input type="submit" value="👤➕ Create User" (click)="createUser()" />
                <input type="submit" value="👤➕ Guest" (click)="createUser(true)" />
              </div>
            </div>
          </div>
          <div *ngIf="!usersCount && !isLoading">Server down</div>
          <p *ngIf="!loginOnly" class="moreInfoTitle welcomeTitle cursorPointerUnderlined" (click)="isAboutOpen = !isAboutOpen">{{ !isAboutOpen ? 'Click here for more' : 'Show less'}} information</p>
          <div *ngIf="isAboutOpen" class="aboutSiteDiv">
            <ul>
              <li>
                Play games together
                <app-media-viewer [fileId]="6373"
                                  [inputtedParentRef]="parentRef"
                                  [displayExtraInfo]="false"
                                  [showCommentSection]="false"
                                  [displayExpander]="false">
                </app-media-viewer>
              </li>
              <li>
                Interact with users
                <app-media-viewer [fileId]="6374"
                                  [inputtedParentRef]="parentRef"
                                  [displayExtraInfo]="false"
                                  [showCommentSection]="false"
                                  [displayExpander]="false">
                </app-media-viewer>
              </li>
              <li>
                Social Media platform
                <app-media-viewer [fileId]="6375"
                                  [inputtedParentRef]="parentRef"
                                  [displayExtraInfo]="false"
                                  [showCommentSection]="false"
                                  [displayExpander]="false">
                </app-media-viewer>
              </li>
              <li>
                Memes
                <app-media-viewer [fileId]="6376"
                                  [inputtedParentRef]="parentRef"
                                  [displayExtraInfo]="false"
                                  [showCommentSection]="false"
                                  [displayExpander]="false">
                </app-media-viewer>
              </li>
              <li>
                Shared Filesystem
                <app-media-viewer [fileId]="6380"
                                  [inputtedParentRef]="parentRef"
                                  [displayExtraInfo]="false"
                                  [showCommentSection]="false"
                                  [displayExpander]="false">
                </app-media-viewer>
              </li>
              <li>
                Cryptocurrency Tools
                <app-media-viewer [fileId]="6377"
                                  [inputtedParentRef]="parentRef"
                                  [displayExtraInfo]="false"
                                  [showCommentSection]="false"
                                  [displayExpander]="false">
                </app-media-viewer>
                <app-media-viewer [fileId]="6378"
                                  [inputtedParentRef]="parentRef"
                                  [displayExtraInfo]="false"
                                  [showCommentSection]="false"
                                  [displayExpander]="false">
                </app-media-viewer>
              </li>
              <li>
                Music and self organization tools
                <app-media-viewer [fileId]="6379"
                                  [inputtedParentRef]="parentRef"
                                  [displayExtraInfo]="false"
                                  [showCommentSection]="false"
                                  [displayExpander]="false">
                </app-media-viewer>
              </li>
              <li>
                Calendar
                <app-media-viewer [fileId]="6381"
                                  [inputtedParentRef]="parentRef"
                                  [displayExtraInfo]="false"
                                  [showCommentSection]="false"
                                  [displayExpander]="false">
                </app-media-viewer>
              </li>
              <li>
                Todo
                <app-media-viewer [fileId]="6382"
                                  [inputtedParentRef]="parentRef"
                                  [displayExtraInfo]="false"
                                  [showCommentSection]="false"
                                  [displayExpander]="false">
                </app-media-viewer>
              </li>
            </ul>
            And more! All available for free in our public <a href="https://github.com/maxhanna/BugHosted">GitHub repository</a>
          </div>
        </div>
      </div>
    </div>


    <!-- SOCIAL -->
    <div *ngIf="user || parentRef?.user">
      <app-social #socialComponent
                  [user]="user"
                  [parent]="parentRef"
                  [showTopicSelector]="false"
                  *ngIf="user && parentRef"></app-social>
    </div>

    <div *ngIf="user && user.id == parentRef?.user?.id && parentRef?.user?.username?.includes('Guest')" class="xxSmallFont">Note: <span class="italics">Guest accounts will be deleted after 10 days.</span></div>

  </div>
</div>

<!-- Friends Popup -->
<div class="popupPanel" *ngIf="isFriendsPanelOpen">
  <div class="popupPanelTitle">
    {{ isEditingFriends ? 'Deleting ' : ''}}Friends
    <span *ngIf="!userId || userId == parentRef?.user?.id"
          (click)="isEditingFriends = !isEditingFriends"
          class="smallFont cursorPointerUnderlined">
      [{{ isEditingFriends ? 'cancel' : 'edit' }}]
    </span>
  </div>
  <div *ngIf="!isEditingFriends" class="friendsPopupContainer mainFriendsPopupDiv">

    <div *ngIf="friends" class="friendsListWrapperDiv">
      <div *ngFor="let friend of friends" class="friendsListDiv">
        <div (click)="viewProfile(friend)" class="usernameProfileLink">
          <app-user-tag [user]="friend" [inputtedParentRef]="parentRef"></app-user-tag>
        </div>
      </div>

    </div>
    <div *ngIf="isLoading && (!friends || friends.length == 0)">Loading friends list...</div>
    <div *ngIf="!isLoading && (!friends || friends.length == 0)">Friends list is empty.</div>
  </div>

  <div *ngIf="!isEditingFriends && friendRequestsSent.length > 0">
    Following:
  </div>
  <div *ngIf="!isEditingFriends && friendRequestsSent.length > 0" class="friendsPopupContainer mainFriendsPopupDiv">
    <div *ngFor="let friendReq of friendRequestsSent" class="friendsListDiv friendsRequestReceivedList">
      <div class="usernameProfileLink">
        <app-user-tag [user]="friendReq.receiver" [inputtedParentRef]="parentRef" [displayMiniTag]="true"></app-user-tag>
      </div>
      <div class="friendshipRequestActionDiv" *ngIf="!userId || userId == parentRef?.user?.id">
        <span (click)="deleteFriendshipRequest(friendReq)" class="cursorPointer" title="Unfollow">❌</span>
      </div>
    </div>
  </div>

  <div *ngIf="!isEditingFriends && friendRequestsReceived.length > 0">
    Followers:
  </div>
  <div *ngIf="!isEditingFriends && friendRequestsReceived.length > 0" class="friendsPopupContainer mainFriendsPopupDiv">
    <div *ngFor="let friendReq of friendRequestsReceived" class="friendsListDiv friendsRequestReceivedList">
      <div class="usernameProfileLink">
        <app-user-tag [user]="friendReq.sender" [inputtedParentRef]="parentRef" [displayMiniTag]="true"></app-user-tag>
      </div>
      <div class="friendshipRequestActionDiv" *ngIf="!userId || userId == parentRef?.user?.id">
        <span (click)="acceptFriendshipRequest(friendReq)" class="cursorPointer" title="Follow Back">➕</span>
      </div>
    </div>
  </div>


  <div *ngIf="isEditingFriends" class="friendsPopupContainer">
    <div *ngIf="friends" class="friendsListWrapperDiv deletingFriendsListWrapper">

      <div *ngFor="let friend of friends" class="friendsListDiv deletingFriendsList">
        <div>
          <app-user-tag [user]="friend" [inputtedParentRef]="parentRef" [displayMiniTag]="true"></app-user-tag>
        </div>
        <div *ngIf="!userId || userId == parentRef?.user?.id">
          <span title="Remove Friend" (click)="removeFriend(friend)" class="cursorPointer">
            ❌
          </span>
        </div>
      </div>

    </div>
  </div>
  <div>
    <button id="closeOverlay" (click)="closeFriendsPanel()">Close</button>
  </div>
</div>

<!-- About User Popup -->
<div class="popupPanel aboutPopupPanel" *ngIf="isAboutPanelOpen">
  <div class="popupPanelTitle">
    About User
  </div>
  <div class="aboutPopupPanelContentContainer">
    <div class="topProfileContainer" id="aboutContainer">
      <div *ngIf="user || parentRef?.user" class="aboutContainer">
        <span class="cursorPointerUnderlined mainTable" (click)="expandDiv('aboutContainer');">
          {{isAboutExpanded ? '-' : '+'}}
          About
        </span>

        <div *ngIf="isAboutExpanded">
          <div class="optionsStatsWrapperDiv"> 
            <div class="optionsStatsDiv">
              <div class="optionsStatsHeader">
                Last Seen :
              </div>
              <div class="optionsStatsDescription">
                {{daysSince(user?.lastSeen)}} days ago.
              </div>
            </div>

            <div class="optionsStatsDiv" *ngIf="user?.about?.description">
              <div class="optionsStatsHeader">
                Description :
              </div>
              <div class="optionsStatsDescription">
                {{user?.about?.description}}
              </div>
            </div>

            <div class="optionsStatsDiv" *ngIf="user?.about?.email">
              <div class="optionsStatsHeader">
                Email :
              </div>
              <div class="optionsStatsDescription">
                {{user?.about?.email}}
              </div>
            </div>

            <div class="optionsStatsDiv" *ngIf="user?.about?.birthday">
              <div class="optionsStatsHeader">
                Birthday :
              </div>
              <div class="optionsStatsDescription">
                {{user?.about?.birthday}}
              </div>
            </div>

            <div class="optionsStatsDiv" *ngIf="user?.about?.phone">
              <div class="optionsStatsHeader">
                Phone Number :
              </div>
              <div class="optionsStatsDescription">
                {{user?.about?.phone}}
              </div>
            </div>

            <div class="optionsStatsDiv" *ngIf="user?.about?.currency">
              <div class="optionsStatsHeader">
                Currency :
              </div>
              <div class="optionsStatsDescription">
                {{user?.about?.currency}}
              </div>
            </div>

            <div class="optionsStatsDiv">
              <div class="optionsStatsHeader">
                Current Wordler streak:
              </div>
              <div class="optionsStatsDescription">
                {{wordlerStreak}} consecutive days.
              </div>
            </div>
          </div> 
        </div>
      </div>
    </div>
    <!-- MUSIC -->
    <div class="topProfileContainer" id="musicProfileContainer">
      <span class="cursorPointerUnderlined mainTable" (click)="expandDiv('musicProfileContainer');">
        {{isMusicContainerExpanded ? '-' : '+'}} 
        Music Playlist
        <span class="xxSmallFont">{{'('+(playListCount || songPlaylist.length)+')'}}</span>
      </span>

      <div *ngIf="isMusicContainerExpanded">
        <app-music *ngIf="isMusicContainerExpanded"
                   [user]="user"
                   [songPlaylist]="songPlaylist"
                   [smallPlayer]="true"
                   (gotPlaylistEvent)="gotPlaylistEvent($event)">
        </app-music>
      </div>
    </div>
  </div>
  <div>
    <button id="closeOverlay" (click)="closeAboutPanel()">Close</button>
  </div>
</div>

<!-- Friends Popup -->
<div class="popupPanel" *ngIf="isFriendsPanelOpen">
  <div class="popupPanelTitle friendsPopupPanelTitle">
    {{ isEditingFriends ? 'Deleting ' : ''}}Friends:
    <span *ngIf="!userId || userId == parentRef?.user?.id"
          (click)="isEditingFriends = !isEditingFriends"
          class="smallFont cursorPointer">
      [{{ isEditingFriends ? 'cancel' : 'edit' }}]
    </span>
  </div>
  <div *ngIf="!isEditingFriends" class="friendsPopupContainer mainFriendsPopupDiv">

    <div *ngIf="friends" class="friendsListWrapperDiv">
      <div *ngFor="let friend of friends" class="friendsListDiv">
        <div (click)="viewProfile(friend)" class="usernameProfileLink">
          <app-user-tag [user]="friend" [inputtedParentRef]="parentRef"></app-user-tag>
        </div>
      </div>

    </div>
    <div *ngIf="isLoading && (!friends || friends.length == 0)">Loading friends list...</div>
    <div *ngIf="!isLoading && (!friends || friends.length == 0)">Friends list is empty.</div>
  </div>

  <div *ngIf="!isEditingFriends && friendRequestsSent.length > 0" class="followingFriendsPanelTitle popupPanelTitle">
    Following:
  </div>
  <div *ngIf="!isEditingFriends && friendRequestsSent.length > 0" class="friendsPopupContainer mainFriendsPopupDiv">
    <div *ngFor="let friendReq of friendRequestsSent" class="friendsListDiv friendsRequestReceivedList">
      <div class="usernameProfileLink">
        <app-user-tag [user]="friendReq.receiver" [inputtedParentRef]="parentRef" [displayMiniTag]="true"></app-user-tag>
      </div>
      <div class="friendshipRequestActionDiv" *ngIf="!userId || userId == parentRef?.user?.id">
        <button (click)="deleteFriendshipRequest(friendReq)" class="cursorPointer" title="Cancel Friendship Request">❌Cancel</button>
      </div>
    </div>
  </div>

  <div *ngIf="!isEditingFriends && friendRequestsReceived.length > 0" class="followingFriendsPanelTitle popupPanelTitle">
    Followers:
  </div>
  <div *ngIf="!isEditingFriends && friendRequestsReceived.length > 0" class="friendsPopupContainer mainFriendsPopupDiv">
    <div *ngFor="let friendReq of friendRequestsReceived" class="friendsListDiv friendsRequestReceivedList">
      <div class="usernameProfileLink">
        <app-user-tag [user]="friendReq.sender" [inputtedParentRef]="parentRef" [displayMiniTag]="true"></app-user-tag>
      </div>
      <div class="friendshipRequestActionDiv" *ngIf="!userId || userId == parentRef?.user?.id">
        <button (click)="acceptFriendshipRequest(friendReq)" class="cursorPointer" title="Accept Friendship Request">➕Follow Back</button>
        <!--<button (click)="denyFriendshipRequest(friendReq)" class="cursorPointer" title="Deny Friendship Request">❌Deny</button>-->
      </div>
    </div>
  </div>


  <div *ngIf="isEditingFriends" class="friendsPopupContainer">
    <div *ngIf="friends" class="friendsListWrapperDiv deletingFriendsListWrapper">

      <div *ngFor="let friend of friends" class="friendsListDiv deletingFriendsList">
        <div>
          <app-user-tag [user]="friend" [inputtedParentRef]="parentRef" [displayMiniTag]="true"></app-user-tag>
        </div>
        <div *ngIf="!userId || userId == parentRef?.user?.id">
          <span title="Remove Friend" (click)="removeFriend(friend)" class="cursorPointer">
            ❌
          </span>
        </div>
      </div>

    </div>
  </div>
  <div>
    <button id="closeOverlay" (click)="closeFriendsPanel()">Close</button>
  </div>
</div>
