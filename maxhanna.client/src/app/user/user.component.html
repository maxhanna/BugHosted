<div class="componentMain {{ user ? 'componentMainFullHeight' : ''}}" [style.paddingTop]="loginOnly ? '15px' : ''">
  <div class="closeButton" (click)="remove_me('UserComponent');"
    *ngIf="canClose || (!loginOnly && (parentRef?.user || user))"></div>
  <div class="menuButton" (click)="showMenuPanel();" *ngIf="parentRef?.user || user"></div>
  <div *ngIf="previousComponent" [class]="'menuBackButton ' + (parentRef?.user ? 'menuBackButtonSpecial' : '')"
    (click)="backButtonPressed();"></div>
  <!-- If the social panel is rendered, show a search button here that opens the social component's search popup -->
  <div *ngIf="user?.id && !loginOnly && socialComponent" class="topSearchButtonDiv"
    (click)="socialComponent.showSearchSocialsPanel()">
    üîç
  </div>
  <div class="componentTitle" *ngIf="!loginOnly">{{user ? user.username : 'Login'}}</div>

  <div *ngIf="parentRef?.user">
    <app-notifications [minimalInterface]="true" [inputtedParentRef]="parentRef" [previousComponent]="'User'">
    </app-notifications>
  </div>

  <div class="profileBackgroundContainer" *ngIf="user?.profileBackgroundPictureFile">
    <app-media-viewer [displayExpander]="false" [displayExtraInfo]="false" [showCommentSection]="false"
      [showTopics]="false" [inputtedParentRef]="inputtedParentRef ?? parentRef"
      [file]="user?.profileBackgroundPictureFile" [previousComponent]="previousComponent ?? 'User'">
    </app-media-viewer>
  </div>

  <div class="userProfileContents">
    <div class="profileHeader">
      <div class="profileHeaderContents">
        <div
          *ngIf="!loginOnly && (user && parentRef && user.displayPictureFile) && (user?.displayPictureFile ?? this.parentRef?.user?.displayPictureFile)">
          <app-media-viewer #displayPictureViewer (click)="openDisplayPicturePanel()" [displayExpander]="false"
            [displayExtraInfo]="false" [showTopics]="false" [showCommentSection]="false"
            [inputtedParentRef]="inputtedParentRef ?? parentRef" [file]="user.displayPictureFile"
            [blockExpand]="user && user.id == parentRef.user?.id" [currentDirectory]="user.displayPictureFile.directory"
            [user]="user" [previousComponent]="previousComponent ?? 'User'">
          </app-media-viewer>
          <div [class]="'profileHeaderInfo blackFontColor linkHighlights' + (onMobile() ? ' smallFont' : '')"
            [title]="user.username">{{user.username}}</div>
        </div>
        <div class="largeAvatar emptyAvatarContainer" *ngIf="!loginOnly && user && !user.displayPictureFile">
          <app-user-tag (click)="openDisplayPicturePanel()"></app-user-tag>
          <div [class]="'blackFontColor linkHighlights profileHeaderInfo' + (onMobile() ? ' smallFont' : '')"
            [title]="user.username ?? 'Anonymous'">{{user.username ?? "Anonymous"}}</div>
        </div>
        <div class="profileHeaderInfo profileHeaderBubble blackFontColor linkHighlights"
          *ngIf="!loginOnly && (parentRef?.user || user)">
          <div class="profileHeaderUserDescription" *ngIf="user?.about?.description">
            {{user?.about?.description}}
          </div>
          <div class="profileHeaderUserDescription" *ngIf="user?.about?.birthday && isBirthdayToday(user?.about?.birthday)">
            üéÇ Birthday: {{ user?.about?.birthday | date: 'y/MM/d' }}
          </div>
          <div class="profileHeaderUserDescription" *ngIf="user?.about?.website">
            <a [href]="user?.about?.website" (click)="visitLink(user?.about?.website)">{{user?.about?.website}}</a>
          </div>
          <div class="seperatedUserHeader blackFontColor linkHighlights"
            *ngIf="weatherLocation?.city || user?.about?.currency">
            <div class="xxSmallFont" title="Location">Location: </div>
            <div>{{weatherLocation?.city}} {{ (weatherLocation?.country ?? user?.about?.currency ?? '') | currencyFlag
              }}</div>
          </div>
          <div class="seperatedUserHeader blackFontColor linkHighlights">
            <div class="xxSmallFont" title="Joined">Joined: </div>
            <div [title]="(user && user.created ? (user.created | date: 'y/MM/d') : 'Unknown')" class="smallFont">
              {{user && user.created ? getUtcTimeSince(user.created, 'day') : '0 days'}}
            </div>
          </div>
          <div class="seperatedUserHeader blackFontColor linkHighlights">
            <div class="xxSmallFont" title="Last Seen">Last Seen: </div>
            <div>
              <span *ngIf="user && user.lastSeen && isUserOnline(user.lastSeen | timeSince:'minute':true)" class="cursorPointer"
                [title]="user.lastSeen | timeSince:'minute':true">
                <span class="onlineButton" title="Online"></span> Online
              </span>
              <span *ngIf="user && user.lastSeen && !isUserOnline(user.lastSeen | timeSince:'minute':true)" class="smallFont"
                [title]="user.lastSeen">
                {{ user.lastSeen | timeSince:'minute':true }}
              </span>
              <span *ngIf="!user?.lastSeen">
                Unknown <span class="xxSmallFont">(0 days)</span>
              </span>
            </div>
          </div>
          <!-- Relationship row: show friend/following status under Last Seen -->
          <div class="seperatedUserHeader blackFontColor linkHighlights"
            *ngIf="user && parentRef?.user?.id != null && user.id != parentRef?.user?.id">
            <div class="xxSmallFont" title="Relationship">Relationship: </div>
            <div>
              <span *ngIf="friendsIncludeMe()" class="smallFont">Friend</span>
              <span *ngIf="!friendsIncludeMe() && isFollowingUser()" class="smallFont">Following</span>
              <span *ngIf="!friendsIncludeMe() && !isFollowingUser() && isBeingFollowedByUser" class="smallFont">Follows
                you</span>
              <span *ngIf="!friendsIncludeMe() && !isFollowingUser() && !isBeingFollowedByUser" class="smallFont">No
                relationship</span>
            </div>
          </div>
          <div class="seperatedUserHeader blackFontColor linkHighlights"
            *ngIf="(userLoginStreakCurrent || userLoginStreakLongest) && !loginOnly">
            <div class="xxSmallFont" title="Login Streak">Streak: </div>
            <div class="smallFont loginStreakWrapper">
              <div *ngIf="userLoginStreakCurrent">Current: {{userLoginStreakCurrent}} day{{userLoginStreakCurrent > 1 ?
                's' : ''}}</div>
              <div *ngIf="userLoginStreakLongest">Best: {{userLoginStreakLongest}} day{{userLoginStreakLongest > 1 ?
                's' : ''}}</div>
            </div>
          </div>

          <div class="profileControls" *ngIf="user || parentRef?.user">
            <select (change)="onProfileControlsChange()" #profileControls class="profileControlsSelector">
              <option selected disabled>Options</option>
              <option *ngIf="user || parentRef?.user" value="shareProfile">üìã Share Profile</option>
              <option
                *ngIf="user && user != parentRef?.user && (user && parentRef?.user?.username != user.username) && friendsIncludeMe() && !canAddFriend(user)"
                value="removeFriend">üë§ Unfriend</option>
              <option
                *ngIf="user && user != parentRef?.user && (user && parentRef?.user?.username != user.username) && !friendsIncludeMe() && canAddFriend(user)"
                value="addFriend">üë§ Follow {{isBeingFollowedByUser ? 'Back' : ''}}</option>
              <option
                *ngIf="user && user != parentRef?.user && (user && parentRef?.user?.username != user.username) && isFollowingUser()"
                value="unfollow">üë§ Unfollow</option>
              <option
                *ngIf="user && parentRef && parentRef.user && user.id != parentRef.user.id && !contactsContains(user)"
                value="addContact">üìá Add Contact</option>
              <option *ngIf="user && parentRef && parentRef.user && user.id != parentRef.user.id"
                value="{{isUserBlocked ? 'unblockContact' : 'blockContact'}}">{{isUserBlocked ? 'üë§ Unblock' : '‚õî
                Block'}} User
              </option>
              <option value="showFriends">üë§ Show Friends</option>
              <option *ngIf="user" value="chat">üó®Ô∏è Chat</option>
              <option *ngIf="user" value="userInfo">üìù {{ isAboutPanelOpen ? 'Hide ' : '' }} User Info</option>
              <option *ngIf="user && user.id == parentRef?.user?.id" value="settings">‚öôÔ∏è Settings</option>
              <option *ngIf="user && user.id == parentRef?.user?.id" value="logout">üîë Logout</option>
            </select>
          </div>
          <div class="userOptionsDiv">
            <div class="profileLink" *ngIf="trophies && trophies.length > 0 && user && user.id != parentRef?.user?.id"
              (click)="showTrophies()">
              <app-media-viewer [displayExpander]="false" [displayExtraInfo]="false" [showCommentSection]="false"
                [showTopics]="false" [blockExpand]="true" [file]="trophies[0].file"
                [inputtedParentRef]="inputtedParentRef ?? parentRef" [previousComponent]="previousComponent ?? 'User'">
              </app-media-viewer>
            </div>
            <div class="profileLink" (click)="openAboutPanel()" *ngIf="user && user.id != parentRef?.user?.id"
              title="Open 'About' Panel">
              üìù
            </div>
            <div class="profileLink" (click)="openChat()" *ngIf="user && user.id != parentRef?.user?.id"
              title="Open Chat">
              üó®Ô∏è
            </div>
            <div class="profileLink" (click)="openFriendsPanel()" *ngIf="user && user.id == parentRef?.user?.id"
              title="Open 'Friends' Panel">
              üë§
            </div>
            <div class="profileLink" (click)="openSettingsPanel()" *ngIf="user && user.id == parentRef?.user?.id"
              title="Open Settings">
              ‚öôÔ∏è
            </div>
            <div class="profileLink" (click)="logout()" *ngIf="user && user.id == parentRef?.user?.id" title="Log Out">
              üîë
            </div>
          </div>
        </div>
      </div>

    </div>

    <!--LOGIN AREA-->
    <div *ngIf="(user && parentRef && parentRef.user && user.id == parentRef.user.id) || !user && !parentRef?.user">
      <div>
        <div *ngIf="!parentRef?.user">
          <div class="bughostedHeader">
            <div class="emptyUserTagLogo" *ngIf="!loginOnly">
              <app-user-tag [displayEmptyAvatar]="true" [previousComponent]="previousComponent ?? 'User'"
                [hideName]="true"></app-user-tag>
            </div>
            <div class="bugHostedLogo" *ngIf="!loginOnly">
              BugH_sted
            </div>
            <div class="welcomeMessage" *ngIf="!loginOnly">
              <p class="welcomeTitle">Social... <small>and anti-social</small> Communityü™≤</p>
              <p class="welcomeTitle">{{ !usersCount && !isLoading ? '' : 'Total users: ' }}<span
                  [class]="!usersCount && !isLoading ? 'redText' : ''">{{usersCount ? usersCount :
                  !usersCount && !isLoading ? 'Server is down!' : !isLoading ? 'Unknown' : 'Loading...' }}</span></p>
            </div>

            <div *ngIf="loginOnly" class="loginOnlyInstructionDiv">
              {{loginReasonMessage ? loginReasonMessage : "Remember to log in to save your progress!"}}
            </div>

            <div class="loginDiv">
              <input type="text" 
                id="loginInput" 
                placeholder="Username" 
                #loginUsername 
                (keydown.enter)="login()"
                [disabled]="isLoading" />
              <input type="password" 
                id="passwordInput" 
                placeholder="Password" 
                #loginPassword
                (keydown.enter)="login()" 
                [disabled]="isLoading"/>
              <div>
                <input type="submit" value="üîë Login" (click)="login()" [disabled]="isLoading" />
                <input type="submit" value="üë§‚ûï Create User" (click)="createUser()" [disabled]="isLoading" />
                <input type="submit" value="üë§‚ûï Guest" (click)="createUser(true)" [disabled]="isLoading" />
              </div>
            </div>
          </div>
          <div *ngIf="!usersCount && !isLoading">Server down</div>
        </div>
      </div>
    </div>
    <!-- LATEST MEME -->
    <div *ngIf="!user?.id && !loginOnly && !isLoading" class="memeAndWordlerWrapper" [class]="onMobile() ? 'gradientBackground':''">
      <div *ngIf="latestMemeId">
        <div class="popupPanelTitle" style="margin-top: 15px;">
          <app-menu-item [type]="'Meme'" [parentRef]="parentRef" [label]="'Latest Meme:'"></app-menu-item>
        </div>
        <app-media-viewer [fileId]="latestMemeId" [inputtedParentRef]="parentRef"
          [canScroll]="false"></app-media-viewer>
      </div>
      <div style="margin-top:20px;">
        <app-profile-widgets [parentRef]="parentRef"></app-profile-widgets>
      </div>
    </div>

    <!-- SOCIAL -->
    <div *ngIf="(this.latestSocialStoryId || storyId || user?.id) && !loginOnly && !isLoading">
      <div *ngIf="this.latestSocialStoryId && (!user || !parentRef?.user)" class="popupPanelTitle"
        style="margin-top: 15px;">
        <app-menu-item [type]="'Social'" [parentRef]="parentRef" [label]="'Latest Post:'"></app-menu-item>
      </div>
      <app-social #socialComponent [showOnlyPost]="true" [user]="user" [storyId]="storyId ?? this.latestSocialStoryId"
        [commentId]="commentId" [parent]="parentRef" [showTopicSelector]="false" [canScroll]="false"></app-social>
    </div>

    <div *ngIf="user && user.id == parentRef?.user?.id && parentRef?.user?.username?.includes('Guest')"
      class="xxSmallFont">Note: <span class="italics">Guest accounts will be deleted after 10 days.</span></div>
    <p *ngIf="!loginOnly && !user" class="moreInfoTitle welcomeTitle cursorPointerUnderlined"
      (click)="isAboutOpen = !isAboutOpen">{{ !isAboutOpen ? 'Click here for more' : 'Show less'}} information</p>
    <div *ngIf="isAboutOpen" class="aboutSiteDiv">
      <ul>
        <li>
          Play games together
        </li>
        <li>
          Interact with users
        </li>
        <li>
          Social Media platform
        </li>
        <li>
          Memes
        </li>
        <li>
          Shared Filesystem
        </li>
        <li>
          Cryptocurrency Tools
        </li>
        <li>
          Music and self organization tools
        </li>
        <li>
          Calendar
        </li>
        <li>
          Todo
        </li>
      </ul>
      <div>
        <div>And more!</div>
        <div>We are comitted to an open and free internet.</div>
        <div>Visit our public <a href="https://github.com/maxhanna/BugHosted">GitHub repository</a>.</div>
      </div>

      <div class="aboutPictureContainer">
        <app-media-viewer [fileId]="6373" [inputtedParentRef]="parentRef" [displayExtraInfo]="false"
          [showCommentSection]="false" [displayExpander]="false" [previousComponent]="previousComponent ?? 'User'">
        </app-media-viewer>
        <app-media-viewer [fileId]="6374" [inputtedParentRef]="parentRef" [displayExtraInfo]="false"
          [showCommentSection]="false" [displayExpander]="false" [previousComponent]="previousComponent ?? 'User'">
        </app-media-viewer>
        <app-media-viewer [fileId]="6375" [inputtedParentRef]="parentRef" [displayExtraInfo]="false"
          [showCommentSection]="false" [displayExpander]="false" [previousComponent]="previousComponent ?? 'User'">
        </app-media-viewer>
        <app-media-viewer [fileId]="6376" [inputtedParentRef]="parentRef" [displayExtraInfo]="false"
          [showCommentSection]="false" [displayExpander]="false" [previousComponent]="previousComponent ?? 'User'">
        </app-media-viewer>
        <app-media-viewer [fileId]="6380" [inputtedParentRef]="parentRef" [displayExtraInfo]="false"
          [showCommentSection]="false" [displayExpander]="false">
        </app-media-viewer>
        <app-media-viewer [fileId]="6377" [inputtedParentRef]="parentRef" [displayExtraInfo]="false"
          [showCommentSection]="false" [displayExpander]="false">
        </app-media-viewer>
        <app-media-viewer [fileId]="6378" [inputtedParentRef]="parentRef" [displayExtraInfo]="false"
          [showCommentSection]="false" [displayExpander]="false">
        </app-media-viewer>
        <app-media-viewer [fileId]="6379" [inputtedParentRef]="parentRef" [displayExtraInfo]="false"
          [showCommentSection]="false" [displayExpander]="false">
        </app-media-viewer>
        <app-media-viewer [fileId]="6381" [inputtedParentRef]="parentRef" [displayExtraInfo]="false"
          [showCommentSection]="false" [displayExpander]="false">
        </app-media-viewer>
        <app-media-viewer [fileId]="6382" [inputtedParentRef]="parentRef" [displayExtraInfo]="false"
          [showCommentSection]="false" [displayExpander]="false">
        </app-media-viewer>
      </div>
    </div>
  </div>
</div>

<!-- User Info Popup -->
<div class="aboutPopupPanel aboutPopupPanel" *ngIf="isAboutPanelOpen">
  <div class="popupPanelTitle">
    üìù User Info
  </div>
  <div class="aboutPopupPanelContentContainer">
    <div class="topProfileContainer" id="aboutContainer">
      <div *ngIf="user || parentRef?.user" class="aboutContainer">
        <label style="display:flex; gap: 10px;">
          <button (click)="expandDiv('aboutContainer');">{{isAboutExpanded ? '-' : '+'}}</button>
          <span class="cursorPointerUnderlined">About</span>
        </label>
        <div *ngIf="isAboutExpanded">
          <div class="optionsStatsWrapperDiv">
            <div class="optionsStatsDiv">
              <div class="optionsStatsHeader">
                ID :
              </div>
              <div class="optionsStatsDescription">
                {{user ? user.id : parentRef ? parentRef.user?.id : ''}}
              </div>
            </div>
            <div class="optionsStatsDiv">
              <div class="optionsStatsHeader">
                Last Seen :
              </div>
              <div class="optionsStatsDescription">
                {{getUtcTimeSince(user?.lastSeen)}}.
              </div>
            </div>
            <div class="optionsStatsDiv" *ngIf="user?.about?.description">
              <div class="optionsStatsHeader">
                Description :
              </div>
              <div class="optionsStatsDescription">
                {{user?.about?.description}}
              </div>
            </div>

            <div class="optionsStatsDiv" *ngIf="user?.about?.email && user?.about?.isEmailPublic">
              <div class="optionsStatsHeader">
                Email :
              </div>
              <div class="optionsStatsDescription">
                {{user?.about?.email}}
              </div>
            </div>

            <div class="optionsStatsDiv" *ngIf="user?.about?.birthday">
              <div class="optionsStatsHeader">
                Birthday :
              </div>
              <div class="optionsStatsDescription">
                {{ user?.about?.birthday | date: 'y/MM/d' : 'UTC' }}
              </div>
            </div>

            <div class="optionsStatsDiv" *ngIf="user?.about?.phone">
              <div class="optionsStatsHeader">
                Phone Number :
              </div>
              <div class="optionsStatsDescription">
                {{user?.about?.phone}}
              </div>
            </div>

            <div class="optionsStatsDiv" *ngIf="user?.about?.currency">
              <div class="optionsStatsHeader">
                Currency :
              </div>
              <div class="optionsStatsDescription">
                {{ user?.about?.currency }} {{ user?.about?.currency || '' | currencyFlag }}
              </div>
            </div>

            <div class="optionsStatsDiv" *ngIf="bestWordlerStreak > 0">
              <div class="optionsStatsHeader">
                <app-menu-item [type]="'Wordler'" [parentRef]="parentRef"
                  [label]="'Wordler Best streak:'"></app-menu-item>
              </div>
              <div class="optionsStatsDescription">
                {{bestWordlerStreak}} consecutive days.
              </div>
            </div>

            <div class="optionsStatsDiv" *ngIf="wordlerStreak > 0">
              <div class="optionsStatsHeader">
                <app-menu-item [type]="'Wordler'" [parentRef]="parentRef"
                  [label]="'Wordler Current streak:'"></app-menu-item>
              </div>
              <div class="optionsStatsDescription">
                {{wordlerStreak}} consecutive days.
              </div>
            </div>

            <div class="optionsStatsDiv" *ngIf="emulationTotalTimeSeconds && emulationTotalTimeSeconds > 0">
              <div class="optionsStatsHeader">
                <app-menu-item [type]="'Emulation'" [parentRef]="parentRef"
                  [label]="'Emulation total time played:'"></app-menu-item>
              </div>
              <div class="optionsStatsDescription cursorPointerUnderlined linkColor" (click)="toggleEmulationBreakdown()">
                {{ emulationTotalTimeSeconds/3600 }} hours
              </div>
            </div>

            <div class="optionsStatsDiv" *ngIf="topEmulationGameName">
              <div class="optionsStatsHeader">
                <app-menu-item [type]="'Emulation'" [parentRef]="parentRef"
                  [label]="'Top game played:'"></app-menu-item>
              </div>
              <div class="optionsStatsDescription cursorPointerUnderlined linkColor" (click)="toggleEmulationBreakdown()">
                <span class="clickableLink" title="Click to view all games">
                  {{ topEmulationGameName.replace('.sav', '') }}
                </span>
                <span *ngIf="topEmulationGamePlays">‚Ä¢ Plays: {{ topEmulationGamePlays }}</span>
              </div>

              <!-- Breakdown list (shows per-game total hours) - moved to popup panel -->
            </div>

            <div class="optionsStatsDiv">
              <div class="optionsStatsHeader">
                <app-menu-item [type]="'Emulation'" [parentRef]="parentRef" [label]="'ROMs uploaded:'"></app-menu-item>
              </div>
              <div class="optionsStatsDescription">{{numberOfRomsUploaded ?? '‚Äî'}} roms</div>
            </div>

            <div class="optionsStatsDiv" *ngIf="metaBotLevelsSum > 0">
              <div class="optionsStatsHeader">
                <app-menu-item [type]="'Meta-Bots'" [parentRef]="parentRef" [label]="'Metabot levels:'"></app-menu-item>
              </div>
              <div class="optionsStatsDescription">
                {{metaBotLevelsSum}} total levels.
              </div>
            </div>

            <div class="optionsStatsDiv" *ngIf="bestEnderScore && bestEnderScore.score">
              <div class="optionsStatsHeader">
                <app-menu-item [type]="'Ender'" [parentRef]="parentRef" [label]="'Best Ender Score:'"></app-menu-item>
              </div>
              <div class="optionsStatsDescription">
                {{ bestEnderScore.score | countShorten }} points
              </div>
            </div>
            <div class="optionsStatsDiv" *ngIf="bestEnderScore && bestEnderScore.time_on_level_seconds">
              <div class="optionsStatsHeader">
                <app-menu-item [type]="'Ender'" [parentRef]="parentRef" [label]="'Best Ender Time:'"></app-menu-item>
              </div>
              <div class="optionsStatsDescription">
                {{ bestEnderScore.time_on_level_seconds | countShorten }}s
              </div>
            </div>

            <div class="optionsStatsDiv" *ngIf="numberOfNexusBases > 0">
              <div class="optionsStatsHeader">
                <app-menu-item [type]="'Bug-Wars'" [parentRef]="parentRef" [label]="'BugWars Bases:'"></app-menu-item>
              </div>
              <div class="optionsStatsDescription">
                {{numberOfNexusBases}} bases.
              </div>
            </div>

            <div class="optionsStatsDiv" *ngIf="numberOfTrades > 0">
              <div class="optionsStatsHeader">
                <app-menu-item [type]="'Crypto-Hub'" [parentRef]="parentRef"
                  [label]="'Crypto-Hub Trades:'"></app-menu-item>
              </div>
              <div class="optionsStatsDescription">
                {{numberOfTrades}} Trades.
              </div>
            </div>
            <div class="optionsStatsDiv">
              <div class="optionsStatsHeader">
                <app-menu-item [type]="'Mastermind'" [parentRef]="parentRef" [label]="'Mastermind'"></app-menu-item>
              </div>
              <div class="optionsStatsDescription">{{numberOfMastermindGames ?? '‚Äî'}} games</div>
            </div>
            <div class="optionsStatsDiv">
              <div class="optionsStatsHeader">
                <app-menu-item [type]="'Top100'" [parentRef]="parentRef" [label]="'Top Entries'"></app-menu-item>
              </div>
              <div class="optionsStatsDescription">{{numberOfTopEntriesCreated ?? '‚Äî'}} entries</div>
            </div>
            <div class="optionsStatsDiv">
              <div class="optionsStatsHeader">
                <app-menu-item [type]="'Files'" [parentRef]="parentRef" [label]="'Files'"></app-menu-item>
              </div>
              <div class="optionsStatsDescription">{{numberOfFilesUploaded ?? '‚Äî'}} files</div>
            </div>
            <div class="optionsStatsDiv">
              <div class="optionsStatsHeader">
                <app-menu-item [type]="'Meme'" [parentRef]="parentRef" [label]="'Memes'"></app-menu-item>
              </div>
              <div class="optionsStatsDescription">{{numberOfMemesUploaded ?? '‚Äî'}} memes</div>
            </div>
            <div class="optionsStatsDiv">
              <div class="optionsStatsHeader">
                <app-menu-item [type]="'Art'" [parentRef]="parentRef" [label]="'Art'"></app-menu-item>
              </div>
              <div class="optionsStatsDescription">{{numberOfArtUploaded ?? '‚Äî'}} art</div>
            </div>
            <div class="optionsStatsDiv">
              <div class="optionsStatsHeader">
                <app-menu-item [type]="'Favourites'" [parentRef]="parentRef" [label]="'Favourites'"></app-menu-item>
              </div>
              <div class="optionsStatsDescription">{{numberOfFavouritesCreated ?? '‚Äî'}} favourites</div>
            </div>
            <div class="optionsStatsDiv">
              <div class="optionsStatsHeader">
                <app-menu-item [type]="'Reactions'" [parentRef]="parentRef" [label]="'Reactions'"></app-menu-item>
              </div>
              <div class="optionsStatsDescription">{{numberOfReactions ?? '‚Äî'}} reactions</div>
            </div>
            <div class="optionsStatsDiv">
              <div class="optionsStatsHeader">
                Share Profile :
              </div>
              <div class="optionsStatsDescription">
                <button (click)="copyLink()">üìãShare</button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    <!-- TROPHIES -->
    <div class="topProfileContainer" id="trophyContainer">
      <div *ngIf="user || parentRef?.user" class="aboutContainer">
        <label style="display:flex; gap: 10px;">
          <button (click)="expandDiv('trophyContainer');">{{isTrophyExpanded ? '-' : '+'}}</button>
          <span class="cursorPointerUnderlined">Trophies ({{trophies?.length ?? 0}})</span>
        </label>
        <div *ngIf="isTrophyExpanded">
          <app-user-trophies [inputtedParentRef]="inputtedParentRef ?? parentRef" [trophies]="trophies"
            [previousComponent]="previousComponent">
          </app-user-trophies>
        </div>
      </div>
    </div>
    <!-- MUSIC -->
    <div class="topProfileContainer" id="musicProfileContainer" *ngIf="songPlaylist && songPlaylist.length > 0">
      <label style="display:flex; gap: 10px;">
        <button (click)="expandDiv('musicProfileContainer');">{{isMusicContainerExpanded ? '-' : '+'}}</button>
        <span class="cursorPointerUnderlined">Music ({{songPlaylist.length}})</span>
      </label>
      <div *ngIf="isMusicContainerExpanded">
        <app-music *ngIf="isMusicContainerExpanded" [user]="user" [inputtedParentRef]="inputtedParentRef ?? parentRef"
          [smallPlayer]="true" (gotPlaylistEvent)="gotPlaylistEvent($event)">
        </app-music>
      </div>
    </div>
  </div>
  <div>
    <button id="closeOverlay" (click)="closeAboutPanel()" class="closeButton">Close</button>
  </div>
</div>

<!-- Friends Popup -->
<div class="popupPanel" *ngIf="isFriendsPanelOpen">
  <div class="popupPanelTitle friendsPopupPanelTitle">
    <span (click)="showingFriendsList = !showingFriendsList" class="cursorPointer">
      Friends{{ showingFriendsList ? ":" : ` [${friends.length}]`}}
    </span>
    <span *ngIf="showingFriendsList && (!userId || userId == parentRef?.user?.id)"
      (click)="isEditingFriends = !isEditingFriends" class="smallFont cursorPointer">
      [{{ isEditingFriends ? 'cancel' : 'edit' }}]
    </span>
  </div>
  <div *ngIf="!isEditingFriends && showingFriendsList" class="friendsPopupContainer mainFriendsPopupDiv">

    <div *ngIf="friends" class="friendsListWrapperDiv">
      <div *ngFor="let friend of friends" class="friendsListDiv">
        <div (click)="viewProfile(friend, 'User')" class="usernameProfileLink">
          <app-user-tag [user]="friend" [inputtedParentRef]="parentRef" [displayHoverPicture]="true"
            [previousComponent]="previousComponent ?? 'User'"></app-user-tag>
        </div>
      </div>

    </div>
    <div *ngIf="isLoading && (!friends || friends.length == 0)">Loading friends ...</div>
    <div *ngIf="!isLoading && (!friends || friends.length == 0)">Friends list is empty.</div>
  </div>

  <div *ngIf="!isEditingFriends && friendRequestsSent.length > 0"
    class="followingFriendsPanelTitle popupPanelTitle cursorPointer"
    (click)="showingFollowingList = !showingFollowingList">
    Following{{ showingFollowingList ? ":" : ` [${friendRequestsSent.length}]`}}
  </div>
  <div *ngIf="!isEditingFriends && friendRequestsSent.length > 0 && showingFollowingList"
    class="friendsPopupContainer mainFriendsPopupDiv">
    <div *ngFor="let friendReq of friendRequestsSent" class="friendsListDiv friendsRequestReceivedList">
      <div class="usernameProfileLink">
        <app-user-tag [user]="friendReq.receiver" [inputtedParentRef]="parentRef" [displayMiniTag]="true"
          [displayHoverPicture]="true" [previousComponent]="previousComponent ?? 'User'"></app-user-tag>
      </div>
      <div class="friendshipRequestActionDiv" *ngIf="!userId || userId == parentRef?.user?.id">
        <button (click)="preventNotifications(friendReq)" class="cursorPointer" title="Prevent Notifications"
          *ngIf="!stoppedNotifications.includes(friendReq.receiver.id ?? 0)">üîî</button>
        <button (click)="allowNotifications(friendReq)" class="cursorPointer" title="Allow Notifications"
          *ngIf="stoppedNotifications.includes(friendReq.receiver.id ?? 0)">‚ùåüîî</button>
        <button (click)="deleteFriendshipRequest(friendReq)" class="cursorPointer" title="Unfollow">‚ùå</button>
      </div>
    </div>
  </div>

  <div *ngIf="!isEditingFriends && friendRequestsReceived.length > 0"
    class="followingFriendsPanelTitle popupPanelTitle cursorPointer"
    (click)="showingFollowersList = !showingFollowersList">
    Followers{{ showingFollowersList ? ":" : ` [${friendRequestsReceived.length}]`}}
  </div>
  <div *ngIf="!isEditingFriends && friendRequestsReceived.length > 0 && showingFollowersList"
    class="friendsPopupContainer mainFriendsPopupDiv">
    <div *ngFor="let friendReq of friendRequestsReceived" class="friendsListDiv friendsRequestReceivedList">
      <div class="usernameProfileLink">
        <app-user-tag [user]="friendReq.sender" [inputtedParentRef]="parentRef" [displayMiniTag]="true"
          [displayHoverPicture]="true" [previousComponent]="previousComponent ?? 'User'"></app-user-tag>
      </div>
      <div class="friendshipRequestActionDiv" *ngIf="!userId || userId == parentRef?.user?.id">
        <button (click)="acceptFriendshipRequest(friendReq)" class="cursorPointer" title="Follow Back User">‚ûï</button>
        <!--<button (click)="denyFriendshipRequest(friendReq)" class="cursorPointer" title="Deny Friendship Request">‚ùåDeny</button>-->
      </div>
    </div>
  </div>


  <div *ngIf="isEditingFriends" class="friendsPopupContainer">
    <div *ngIf="friends" class="friendsListWrapperDiv deletingFriendsListWrapper">

      <div *ngFor="let friend of friends" class="friendsListDiv deletingFriendsList">
        <div>
          <app-user-tag [user]="friend" [inputtedParentRef]="parentRef" [displayMiniTag]="true"
            [displayHoverPicture]="true" [previousComponent]="previousComponent ?? 'User'"></app-user-tag>
        </div>
        <div *ngIf="!userId || userId == parentRef?.user?.id">
          <span title="Remove Friend" (click)="removeFriend(friend)" class="cursorPointer">
            ‚ùå
          </span>
        </div>
      </div>

    </div>
  </div>
  <button id="closeOverlay" (click)="closeFriendsPanel()" class="closeButton">Close</button>
</div>


<!-- Menu Popup -->
<div class="popupPanel" style="overflow: auto;" *ngIf="isMenuPanelOpen">
  <div class="popupPanelTitle popupPanelContents" style="margin-bottom:15px;">
    User Menu
  </div>
  <div>
    <div *ngIf="parentRef?.user?.id">
      Display NSFW?: <input type="checkbox" #nsfwCheckmark [checked]="isDisplayingNSFW" (click)="updateNSFW($event)" />
    </div>
    <div>
      <label>
        Show Hidden Posts?:
        <select (change)="setFilterHidden($event)">
          <option value="yes" [selected]="filter.hidden === 'yes'">Yes</option>
          <option value="no" [selected]="filter.hidden === 'no'">No</option>
        </select>
      </label>
    </div>
  </div>
  <button id="closeOverlay" (click)="closeMenuPanel()" class="closeButton" style="margin-top: 10px">Close</button>
</div>

<!-- Change Display Picture Popup -->
<div class="popupPanel userPersonalizationPopupPanel" style="overflow: auto;" *ngIf="isDisplayPicturePanelOpen">
  <div class="userPersonalizationPopupPanelSection">
    <div class="popupPanelTitle popupPanelContents" style="margin-bottom:15px;">
      Display Picture
    </div>
    <div class="displayPicturePopupDisplayDiv">
      <span *ngIf="!user?.displayPictureFile">
        <app-user-tag [hideName]="true" [displayHoverPicture]="false"></app-user-tag>
      </span>
      <span *ngIf="user?.displayPictureFile">
        <app-user-tag [user]="user" [inputtedParentRef]="parentRef" [displayHoverPicture]="false"
          [hideName]="true"></app-user-tag>
      </span>
      <button (click)="changeDisplayPic()">Change Display Picture</button>
    </div>
  </div>
  <div class="userPersonalizationPopupPanelSection">
    <div class="popupPanelTitle popupPanelContents" style="margin-bottom:15px;">
      Background Picture
    </div>
    <div class="displayPicturePopupDisplayDiv">
      <span *ngIf="parentRef?.user?.profileBackgroundPictureFile">
        <app-media-viewer #backgroundPictureViewer [displayExpander]="false" [displayExtraInfo]="false"
          [showTopics]="false" [showCommentSection]="false" [file]="parentRef?.user?.profileBackgroundPictureFile"
          [user]="parentRef?.user" [inputtedParentRef]="parentRef" [previousComponent]="'User'">
        </app-media-viewer>
      </span>
      <span *ngIf="!parentRef?.user?.profileBackgroundPictureFile" class="smallFont cursorPointerUnderlined"
        (click)="bgPicChanger.click()">
        Currently no profile background picture selected.
      </span>
      <button (click)="changeBackgroundPic()" #bgPicChanger>Change Background Picture</button>
    </div>
  </div>

  <button id="closeOverlay" (click)="closeDisplayPicturePanel()">Close</button>
</div>

<div class="popupPanel" *ngIf="isEmulationBreakdownOpen" style="overflow: auto; max-height: 65vh;">
  <div class="popupPanelTitle">üéÆ Emulation Breakdown</div>
  <div class="optionsStatsBreakdown">
    <div *ngIf="!emulationGameBreakdown || emulationGameBreakdown.length === 0" class="xxSmallFont">No games found.</div>
    <table *ngIf="emulationGameBreakdown && emulationGameBreakdown.length > 0" class="mainTable" id="emulationBreakdownTable">
      <thead>
        <tr>
          <th (click)="sortTable($event)">Game</th>
          <th (click)="sortTable($event)">Hours</th>
          <th (click)="sortTable($event)">Plays</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let item of emulationGameBreakdown">
          <td class="optionsStatsBreakdownName">{{ item.romFileName.replace('.sav','') }}</td>
          <td class="optionsStatsBreakdownValue">{{ (item.totalSeconds/3600) | number:'1.2-2' }}</td>
          <td class="optionsStatsBreakdownValue">{{ item.plays || 0 }}</td>
        </tr>
      </tbody>
    </table>
  </div>
  <button id="closeOverlay" (click)="closeEmulationBreakdownPopup()" class="closeButton">Close</button>
</div>

 <div class="media-selector-container" *ngIf="showDisplayPictureSelector">
  <app-media-selector #displayPictureSelector [maxSelectedFiles]="1" [inputtedParentRef]="parentRef"
    [user]="parentRef?.user" [currentDirectory]="'Users/'+parentRef?.user?.username"
    (selectFileEvent)="avatarSelected($event)">
  </app-media-selector>
</div>

<div class="media-selector-container" *ngIf="showBackgroundPictureSelector">
  <app-media-selector #backgroundPictureSelector [maxSelectedFiles]="1" [inputtedParentRef]="parentRef"
    [user]="parentRef?.user" [currentDirectory]="'Users/'+parentRef?.user?.username"
    (selectFileEvent)="profileBackgroundSelected($event)">
  </app-media-selector>
</div>