<!-- Comments Section -->
<div *ngIf="showCommentsHeader && !comment_id" [id]="'commentsHeader'+component.id"
  class="commentsHeader {{showComments && !comment_id ? '' : 'commentsHeaderGradient'}}"
  [style.cursor]="commentList && commentList.length <= 0 ? 'default' : 'pointer'" (click)="commentHeaderClicked()">
  <span class="smallExpander commentHeaderSmallExpander">
    🗨️Comments (
    <span class="{{commentList && commentList.length > 0 ? 'highlightedCommentCounter' : ''}}"
      [style.opacity]="commentList.length ? '1' : '0.3'">
      {{ getTotalCommentCount() }}
    </span>
    ) {{showComments ? '-' : '+'}}
  </span>
</div>

<!-- Breadcrumb Navigation (only shown when viewing subcomments) -->
<div *ngIf="breadcrumbComments.length > 0" class="breadcrumb-nav gradientBackground">
  <span class="breadcrumb-item linkedComponent" (click)="navigateToComment(null)">All Comments</span>
  <span *ngFor="let breadcrumb of breadcrumbComments; let i = index" class="breadcrumb-item">
    <span class="breadcrumb-separator">›</span>
    <span *ngIf="i < breadcrumbComments.length - 1" class="linkedComponent" (click)="navigateToComment(breadcrumb.id)">
      {{ breadcrumb.user.username }}
    </span>
    <span *ngIf="i === breadcrumbComments.length - 1" class="breadcrumb-current">
      {{ breadcrumb.user.username }}
    </span>
  </span>
</div>

<div class="comments-section"
  *ngIf="commentList && commentList.length > 0 && (showComments || (comment_id && automaticallyShowSubComments))"
  [style.maxHeight]="comment_id ? '' : '300px'">

  <div *ngFor="let comment of commentList!" class="commentListDiv borderPaddedComment"
    [style.paddingLeft]="comment_id ? '40px' : '20px'">
    <div class="commentContentAndAvatarContainerDiv" [attr.data-timestamp]="comment.date">
      <div class="commentAvatar usernameProfileLink">
        <app-user-tag [user]="comment.user" [inputtedParentRef]="inputtedParentRef" [displayMiniTag]="true"
          [displayHoverPicture]="true" [previousComponent]="previousComponent"></app-user-tag>
      </div>
      <div class="commentDate" [title]="(comment.date?.toString() ?? '').replace('T',' ')">
        <ng-container *ngIf="onMobile(); else fullTime">
          {{ (comment.date | timeSince).split(' ')[0] }}
        </ng-container>
        <ng-template #fullTime>
          {{ comment.date | timeSince }}
        </ng-template>
      </div>
      <div class="commentActions">
        <div class="commentReaction">
          <app-reaction [commentId]="comment.id" [component]="comment" [fileId]="comment.fileId"
            [storyId]="comment.storyId" [userProfileId]="userProfile?.id" [user]="inputtedParentRef?.user"
            [inputtedParentRef]="inputtedParentRef" [currentReactions]="comment.reactions"
            [previousComponent]="previousComponent">
          </app-reaction>
        </div>
        <button class="commentOptionButton coloredBgButton" (click)="showOptionsPanel(comment)">
          ⚙️
        </button>
        <div class="cursorPointer smallFont commentCountWrapper">
          <button (click)="showSubComments(comment.id)" title="Reply to this comment" class="coloredBgButton"
            [style.display]="replyingToCommentId && replyingToCommentId !== comment.id ? 'none' : 'inline-block'">
            {{replyingToCommentId == comment.id ? 'Cancel' : 'Reply'}}
          </button>
          <button *ngIf="comment.comments?.length" (click)="expandComment(comment)"
            class="toggle-subcomments coloredBgButton" title="View subcomments">
            {{!minimizedComments.has(comment.id) ? '▼' : '▶'}}
            ({{getTotalCommentCount(comment)}})
          </button>
        </div>
      </div>
    </div>
    <div>
      <div class="commentContent">
  <div [innerHTML]="createClickableUrls(comment.commentText, comment.id)" [id]="'commentText'+comment.id"
          class="commentTextDiv" [style.display]="editingComments.includes(comment.id) ? 'none': 'block'"></div>
        <div *ngFor="let file of comment.commentFiles" class="commentMediaFile">
          <app-media-viewer [file]="file" [user]="comment.user" [currentDirectory]="file.directory"
            [inputtedParentRef]="inputtedParentRef" [displayExtraInfo]="false" [autoplay]="false" [autoload]="true"
            [showCommentSection]="false" [showMediaInformation]="true"
            [previousComponent]="previousComponent"></app-media-viewer>
        </div>
        <div class="commentInputArea">
          <div class="borderPaddedComment" *ngIf="editingComments.includes(comment.id) && !replyingToCommentId">
            <textarea class="commentTextArea" [id]="'commentTextTextarea'+comment.id">{{comment.commentText}}</textarea>
          </div>

          <div class="commentInputArea borderPaddedComment" *ngIf="replyingToCommentId == comment.id">
            <app-text-input [inputtedParentRef]="inputtedParentRef" [type]="'Comment'" [commentParent]="comment"
              [quoteMessage]="quoteMessage" [profileUser]="userProfile" [storyId]="storyId" [commentId]="comment.id"
              (contentPosted)="commentPosted($event, comment)"></app-text-input>
          </div>
          <button [id]="'commentTextEditConfirmButton' + comment.id" (click)="confirmEditComment(comment)"
            *ngIf="editingComments.includes(comment.id)">
            <span class="commentEditSpans commentAcceptEdit"
              [style.display]="editingComments.includes(comment.id) ? 'block' : 'none'"
              [id]="'commentAcceptButtonSpan' + comment.id">✔️</span>
            ✏️Edit
          </button>
        </div>

        <div
          *ngIf="!minimizedComments.has(comment.id) && (!activeBreadcrumbCommentId || activeBreadcrumbCommentId === comment.id)"
          class="subcomments-container">

          <div *ngFor="let subComment of comment.comments" class="subComment" [id]="'subComment' + subComment.id">
            <app-comments [inputtedParentRef]="inputtedParentRef ?? parentRef" [type]="'Comment'"
              [showCommentsHeader]="false" [storyId]="storyId" [comment_id]="subComment.id"
              [automaticallyShowSubComments]="true" [commentList]="[subComment]" [depth]="depth + 1"
              [quoteMessage]="quoteMessage" [replyingToCommentId]="replyingToCommentId"
              (replyingToCommentEvent)="replyingToCommentId = $event; replyingToCommentEvent.emit($event)"
              (quoteMessageEvent)="depth == 0 ? setQuoteMessage($event) : quoteMessageEvent.emit($event)"
              (commentAddedEvent)="commentAddedEvent.emit($event)"
              (commentRemovedEvent)="commentRemovedEvent.emit($event)"
              (togglingSubComments)="clearSubCommentsToggled($event)"></app-comments>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<div *ngIf="(showComments || (comment_id && automaticallyShowSubComments))"
  class="{{comment_id ? 'replyInputArea' : 'commentsInputArea'}}" [id]="'commentInputAreaDiv' + component_id">
  <div *ngIf="showCommentLoadingOverlay" class="loadingCommentOverlay">
    Loading comments...
  </div>
  <div *ngIf="!depth && !showCommentLoadingOverlay && !editingComments.length && !replyingToCommentId"
    class="addCommentInputDiv">

    <app-text-input [inputtedParentRef]="inputtedParentRef" [type]="'Comment'" [commentParent]="component"
      [quoteMessage]="quoteMessage" [profileUser]="userProfile" 
      [storyId]="storyId"
      (contentPosted)="commentPosted($event)"></app-text-input>
  </div>
  <div *ngIf="selectedFiles.length > 0">{{selectedFiles.length}} file{{selectedFiles.length > 1 ? 's' : ''}} attached.
  </div>
</div>
<!-- End Comments Section -->
<!-- Options Popup -->
<div class="popupPanel" *ngIf="isOptionsPanelOpen && optionsComment">
  <div class="popupPanelTitle">
    Comment Options
  </div>
  <div class="commentOptionsPanelButtons">
    <button (click)="deleteComment(optionsComment)" title="Delete Comment"
      *ngIf="inputtedParentRef?.user?.id == optionsComment.user.id && optionsComment.id">❌ Delete</button>
    <button (click)="editComment(optionsComment)" title="Edit Comment"
      *ngIf="inputtedParentRef?.user?.id == optionsComment.user.id && optionsComment.id">
      <span class="commentEditSpans commentCancelEdit"
        [style.display]="editingComments.includes(optionsComment.id) ? 'block' : 'none'"
        [id]="'commentEditButtonSpan' + optionsComment.id">❌</span>
      ✏️ {{editingComments.includes(optionsComment.id) ? 'Cancel ': ''}}Edit
    </button>
    <button class="commentOptionButton" (click)="quote(optionsComment)">
      🗨️Quote
    </button>
    <button (click)="copyAllText(optionsComment)" title="Copy all text">
      📋Copy Text
    </button>
    <button (click)="speakMessage(optionsComment.commentText)" *ngIf="!isTextToSpeechSpeaking()">
      🔊Read Outloud
    </button>
    <button (click)="stopSpeaking()" *ngIf="isTextToSpeechSpeaking()">
      🤐Stop Reading Outloud
    </button>
  </div>
  <div class="optionsStatsWrapperDiv">
    <div class="optionsStatsDiv">
      <div class="optionsStatsHeader">
        Comment Id:
      </div>
      <div class="optionsStatsDescription">
        {{optionsComment.id}}
      </div>
    </div>
    <div class="optionsStatsDiv">
      <div class="optionsStatsHeader">
        Date:
      </div>
      <div class="optionsStatsDescription">
        {{inputtedParentRef?.convertUtcToLocalTime(optionsComment.date)}}
      </div>
    </div>
    <div class="optionsStatsDiv" *ngIf="optionsComment.country">
      <div class="optionsStatsHeader">
        Country:
      </div>
      <div class="optionsStatsDescription">
        {{optionsComment.country}} {{optionsComment.country | currencyFlag}}
      </div>
    </div>
    <div class="optionsStatsDiv" *ngIf="optionsComment.city">
      <div class="optionsStatsHeader">
        City:
      </div>
      <div class="optionsStatsDescription">
        {{optionsComment.city}}
      </div>
    </div>
  </div>
  <div class="xxSmallFont thirdFontColor" style="margin-top:12px;"> We take your privacy seriously. Every message you
    send is
    encrypted before it leaves your device or our servers and remains encrypted until it reaches its intended recipient,
    ensuring your data stays private and secure.
  </div>
  <button title="Close the options panel" id="closeOverlay" (click)="closeOptionsPanel()" class="closeButton"
    style="margin-top:8px;">Close</button>
</div>