<div class="mainInputDiv">
    <input type="text" 
      #postInput 
      id="postInput"
      *ngIf="!showPostInput" 
      placeholder="What‚Äôs crawling your mind?" 
      [disabled]="isLoading || _isPosting"
      [draggable]="!isFocused"
      (focus)="type == 'Chat' ? prepPostTextArea() : ''"
      (click)="prepPostTextArea()"
      (focus)="onTextFocus()" 
      (blur)="onTextBlur()" 
      (dragstart)="onDragStart($event)" />
    <textarea #postTextArea 
      *ngIf="showPostInput"
      placeholder="What‚Äôs crawling your mind?" 
      class="foodForThought" 
      id="postTextArea" 
      [disabled]="isLoading || _isPosting"
      [draggable]="!isFocused" 
      (keydown)="onKeyDown($event)" 
      (focus)="onTextFocus()" 
      (blur)="onTextBlur()" 
      (dragstart)="onDragStart($event)">{{initialContent}}</textarea>
</div>
<div class="mainFileUploaderAndTopicSelectorDiv">
    <button *ngIf="initialContent == undefined" (click)="post()" title="Post" [disabled]="_isPosting">üó®Ô∏èPost</button>
    <button *ngIf="initialContent != undefined" (click)="update(textarea.value)" title="Update" [disabled]="_isPosting">‚úÖ</button>
    <button *ngIf="initialContent != undefined" (click)="cancelEdit.emit()" title="Cancel" [disabled]="_isPosting">‚ùå</button>
    <app-media-selector *ngIf="inputtedParentRef" #mediaSelector [selectedFiles]="attachedFiles" [maxSelectedFiles]="30"
        [currentDirectory]="inputtedParentRef.user?.username ? 'Users/' + inputtedParentRef!.user!.username! : 'Users/Anonymous'"
        [user]="inputtedParentRef.user" [inputtedParentRef]="inputtedParentRef"
        [uploadButtonText]="initialContent != undefined ? '' : ((!showPostInput && (!onMobile() || (mediaSelector && !mediaSelector.selectedFiles.length)) && (!onMobile() || !attachedTopics.length)) ? 'Upload' : onMobile() ? '' : 'Upload')"
        (selectFileEvent)="selectFile($event)"></app-media-selector>
    <button (click)="showPostOptionsPanel()" *ngIf="showPostInput">
        ‚öôÔ∏è{{ (!showPostInput && (!onMobile() || (mediaSelector && !mediaSelector.selectedFiles.length)) && (!onMobile()
        || !attachedTopics.length)) ? 'Options' : (onMobile() || messageId) ? '' : 'Options'}}
        <span class="xxSmallFont" *ngIf="getOptionsCount() > 0">
            ({{getOptionsCount()}})
        </span>
    </button>
    <button class="mainTopicSelectionsHeaderButton" [class.highlight]="highlightTopicsButton"
        (click)="showTopicsPanel(); highlightTopicsButton = false" *ngIf="type == 'Social'">
        üóÇÔ∏è{{ (!showPostInput && (!onMobile() || (mediaSelector && !mediaSelector.selectedFiles.length)) && (!onMobile()
        || !attachedTopics.length)) ? 'Topics' : (onMobile() || messageId) ? '' : 'Topics'}}
        <span class="matchingTopicsInsideButtonWrapper" *ngIf="attachedTopics && attachedTopics.length > 0">
            (
            <span *ngFor="let topic of attachedTopics; let i = index" class="matchingTopic"
                title="{{topic.topicText}} : Click to remove topic" style="padding:0">
                {{topic.topicText}}
            </span>
            )
        </span>
    </button>
</div>


<!-- Post Options Popup -->
<div [class]="(isAppFormattingOptionsOpen || isComponentPanelOpen) ? '' : 'popupPanel'"
    *ngIf="isPostOptionsPanelOpen || isAppFormattingOptionsOpen || isComponentPanelOpen">
    <div class="popupPanelTitle">
        <span>Post Options</span>
    </div>
    <div class="mobileOptionsTitle">Uploads</div>
    <div class="postOptionsCheckboxes">
        <label title="Creates a post for every file attachment attached."
            *ngIf="(mediaSelector && mediaSelector.selectedFiles.length > 1)">
            <input type="checkbox" (change)="eachAttachmentSeperatePost = !eachAttachmentSeperatePost"
                [checked]="eachAttachmentSeperatePost" />
            Each Attachment In A Seperate Post.
        </label>
        <span *ngIf="mediaSelector && mediaSelector.selectedFiles.length <= 1">Attach more files to see upload
            options</span>
    </div>
    <div class="mobileOptionsTitle" style="margin-top: 20px;">Text
        Formatting</div>
    <div class="mobilePostButtonOptions">
        <app-text-formatting-toolbar style="display:flex; height: 25px;" [inputtedParentRef]="inputtedParentRef"
            [parent]="textarea" (isExpandingEmojiPanel)="onExpandingEmojiPanel($event)"
            (isExpandingComponentPanel)="onExpandingComponentPanel($event)"
            (isExpandingCrawlerPanel)="onExpandingCrawlerPanel($event)"></app-text-formatting-toolbar>
    </div>
    <div *ngIf="type == 'Social'" class="mobileOptionsTitle" style="margin-top: 20px;">Visibility</div>
    <div *ngIf="type == 'Social'"
        title="Public = anyone, Following = only users following you, Self = only you">
        <select [value]="visibility" (change)="onVisibilityChange($event)">
            <option value="public">Public</option>
            <option value="following">Following</option>
            <option value="self">Self</option>
        </select>
    </div>
    <div style="display: flex; justify-content: center; align-items: center; gap: 10px;">
        <button id="helpButton" (click)="showHelp()" style="margin-top:10px">‚ÑπÔ∏è Help</button>
        <button id="closeOverlay" (click)="closePostOptionsPanel()" class="closeButton">Close</button>
    </div>
</div>

<!-- Post Topics Popup -->
<div class="popupPanel" *ngIf="isTopicsPanelOpen">
    <div class="popupPanelTitle">Topics üóÇÔ∏è</div>
    <div style="margin-bottom:15px;">
        <app-topics #topicSelector [isDropdown]="true" [user]="inputtedParentRef?.user" [parent]="inputtedParentRef"
            [attachedTopics]="attachedTopics" (topicAdded)="onTopicAdded($event)"
            (topicClicked)="onTopicClicked($event)">
        </app-topics>
    </div>
    <div class="popupSectionContainer gradientBackground">
        <div class="topTopicsSection">
            <div class="topTopicTitle" *ngIf="showTopicSelector">
                Favourite Topics:
            </div>
            <div *ngFor="let topic of favTopics" (click)="clickedTopic([topic])" class="topicsGrid">
                <span class="matchingTopic">
                    {{topic.topicText}}
                    <span class="coloredBgButton" (click)="removeFavTopic(topic); $event.stopPropagation();">‚ùå</span>
                </span>
            </div>
            <div *ngIf="favTopics?.length == 0">No favourites yet.</div>
            <div *ngIf="attachedTopics.length > 0">
                <ng-container *ngIf="getNonFavoriteTopics().length > 0">
                    <button (click)="addFavouriteTopic()">
                        Add
                        <span *ngFor="let aTopic of getNonFavoriteTopics(); let last = last">
                            <span class="matchingTopic">{{aTopic.topicText}}</span>
                            {{last ? '' : ', '}}
                        </span>
                        to favourites
                    </button>
                </ng-container>
            </div>
        </div>

        <div class="topTopicsSection">
            <div class="topTopicTitle" *ngIf="showTopicSelector">
                Ignored Topics: <span *ngIf="ignoredTopics?.length == 0" class="thirdFontColor">No ignored topics.</span>
            </div>
            <div *ngFor="let topic of ignoredTopics" (click)="clickedTopic([topic])" class="topicsGrid">
                <span class="matchingTopic">
                    {{topic.topicText}}
                    <span class="coloredBgButton"
                        (click)="removeIgnoredTopic(topic); $event.stopPropagation();">‚ùå</span>
                </span>
            </div>
        </div>
        <div class="topTopicsSection">
            <div class="topTopicTitle" *ngIf="showTopicSelector">
                Top Topics:
            </div>
            <div *ngFor="let topic of topTopics | slice:0:15" (click)="clickedTopicRank(topic)" class="topicsGrid">
                <span class="matchingTopic">
                    {{topic.topicName}}
                    <span class="topicStoryCount">({{topic.storyCount}})</span>
                </span>
            </div>
        </div>
    </div>
    <button id="closeOverlay" (click)="closeTopicsPanel()" class="closeButton">Close</button>
</div>
<!-- Help Popup -->
<div class="popupPanel" *ngIf="showHelpPopup">
    <div class="popupPanelTitle">Help: Options & Formatting</div>
    <div class="helpContent">
        <p><strong>Post Options Panel Help:</strong></p>
        <ol>
            <li>
                <strong>Uploads Section:</strong>
                <ul>
                    <li><strong>"Each Attachment In A Separate Post" Checkbox:</strong> When checked, each attached file
                        will be posted as a separate post instead of combining them into one post. This option is
                        visible only when multiple files are attached via the "Upload" button.</li>
                    <li><strong>Attaching Files:</strong> Click the "Upload" button in the main interface to select
                        files from your device. Supported file types depend on the platform configuration.</li>
                </ul>
            </li>
            <li>
                <strong>Text Formatting Section:</strong> (Available on mobile or when the formatting toolbar is
                expanded)
                <ul>
                    <li><strong>Purpose:</strong> The text formatting toolbar enhances your post with styling and
                        additional elements.</li>
                    <li><strong>Features:</strong>
                        <ul>
                            <li><strong>Bold, Italic, Underline:</strong> Highlight or emphasize text by selecting it
                                and clicking the respective buttons.</li>
                            <li><strong>Emojis:</strong> Insert emojis by opening the emoji panel and selecting one to
                                add to your post.</li>
                            <li><strong>Other Components:</strong> Insert links, images, or other supported elements (if
                                enabled) to enrich your content.</li>
                        </ul>
                    </li>
                    <li><strong>Usage:</strong> Select text in the textarea, then click a formatting button to apply the
                        style or insert an element.</li>
                </ul>
            </li>
            <li>
                <strong>General Usage:</strong>
                <ul>
                    <li><strong>Textarea:</strong> Type your post or comment content in the textarea that appears after
                        clicking the input field.</li>
                    <li><strong>Topics:</strong> Categorize your post by selecting topics from the Topics panel
                        (accessible via the üóÇÔ∏è button).</li>
                    <li><strong>Posting:</strong> Click the "Post" button to submit your content.</li>
                    <li><strong>Options:</strong> Use the ‚öôÔ∏è Options button to access this panel for upload settings or
                        text formatting.</li>
                </ul>
            </li>
            <li>
                <strong>Closing the Panel:</strong>
                <ul>
                    <li>Click the "Close" button to return to the main interface.</li>
                </ul>
            </li>
        </ol>
        <p style="margin-top:12px;">Visibility: When creating a Social post you can set its visibility from the Post
            Options panel ‚Äî <strong>Public</strong> (anyone), <strong>Following</strong> (only users following you), or
            <strong>Self</strong> (only you).</p>
        <div style="text-align: center;">
            For further assistance, contact:{{" "}}
            <div style="display: inline-block">
                <app-user-tag [userId]="1" [inputtedParentRef]="inputtedParentRef" [displayMiniTag]="true"
                    [displayHoverPicture]="true">
                </app-user-tag>
            </div>
            {{" "}}or refer to the application documentation.
        </div>
    </div>
    <button id="closeOverlay" (click)="closeHelp()" class="closeButton">Close</button>
</div>