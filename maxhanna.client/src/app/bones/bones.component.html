<div class="componentMain" #componentMain>
  <div class="closeButton" (click)="remove_me('BonesComponent');"></div>
  <!--<div class="refreshButton" (click)="ngOnInit();"></div>-->
  <div class="componentTitle">Bones</div>
  <div class="menuButton" (click)="showMenuPanel()"></div>

  <div [style.display]="isLoading ? 'block' : 'none'" class="loadingModal">The game is loading...</div>
  <div [style.display]="serverDown ? 'block' : 'none'" class="serverDownMessage">We are sorry, server is currently down.
    Please be patient while we bring it back online.</div>
  <div class="gameCanvasContainer">
    <canvas #gameCanvas id="gameCanvas" class="gameCanvas" width=320 height="220"></canvas>
  </div>
  <div class="chatArea">
    <div class="chatInputDiv">
      <input type="text" [placeholder]=" 'Chat'" #chatInput id="chatInput" class="chatInput"
        (keydown)="lockMovementForChat()" (change)="lockMovementForChat()" />
    </div>
  </div>

  <div class="inputArea"
    [style.display]="(!isMenuPanelOpen && !isChangeCharacterOpen && !isPartyPanelOpen && !isStartMenuOpened) ? 'flex' : 'none'">
    <div class="controls">
      <div class="controls">
        <div class="dpad">
          <div class="up-left" (mousedown)="mainScene.input.handleControl('UP_LEFT', 'press')"
            (mouseup)="mainScene.input.handleControl('UP_LEFT', 'release')"
            (touchstart)="mainScene.input.handleControl('UP_LEFT', 'press', $event)"
            (touchend)="mainScene.input.handleControl('UP_LEFT', 'release', $event)"
            (touchcancel)="mainScene.input.handleControl('UP_LEFT', 'release', $event)">
            <div class="up-left-triangle"></div>
          </div>
          <div class="up" (mousedown)="mainScene.input.handleControl('UP', 'press')"
            (mouseup)="mainScene.input.handleControl('UP', 'release')"
            (touchstart)="mainScene.input.handleControl('UP', 'press', $event)"
            (touchend)="mainScene.input.handleControl('UP', 'release', $event)"
            (touchcancel)="mainScene.input.handleControl('UP', 'release', $event)">
            <div class="up-triangle"></div>
          </div>
          <div class="up-right" (mousedown)="mainScene.input.handleControl('UP_RIGHT', 'press')"
            (mouseup)="mainScene.input.handleControl('UP_RIGHT', 'release')"
            (touchstart)="mainScene.input.handleControl('UP_RIGHT', 'press', $event)"
            (touchend)="mainScene.input.handleControl('UP_RIGHT', 'release', $event)"
            (touchcancel)="mainScene.input.handleControl('UP_RIGHT', 'release', $event)">
            <div class="up-right-triangle"></div>
          </div>
          <div class="right" (mousedown)="mainScene.input.handleControl('RIGHT', 'press')"
            (mouseup)="mainScene.input.handleControl('RIGHT', 'release')"
            (touchstart)="mainScene.input.handleControl('RIGHT', 'press', $event)"
            (touchend)="mainScene.input.handleControl('RIGHT', 'release', $event)"
            (touchcancel)="mainScene.input.handleControl('RIGHT', 'release', $event)">
            <div class="right-triangle"></div>
          </div>
          <div class="down" (mousedown)="mainScene.input.handleControl('DOWN', 'press')"
            (mouseup)="mainScene.input.handleControl('DOWN', 'release')"
            (touchstart)="mainScene.input.handleControl('DOWN', 'press', $event)"
            (touchend)="mainScene.input.handleControl('DOWN', 'release', $event)"
            (touchcancel)="mainScene.input.handleControl('DOWN', 'release', $event)">
            <div class="down-triangle"></div>
          </div>
          <div class="down-left" (mousedown)="mainScene.input.handleControl('DOWN_LEFT', 'press')"
            (mouseup)="mainScene.input.handleControl('DOWN_LEFT', 'release')"
            (touchstart)="mainScene.input.handleControl('DOWN_LEFT', 'press', $event)"
            (touchend)="mainScene.input.handleControl('DOWN_LEFT', 'release', $event)"
            (touchcancel)="mainScene.input.handleControl('DOWN_LEFT', 'release', $event)">
            <div class="down-left-triangle"></div>
          </div>
          <div class="left" (mousedown)="mainScene.input.handleControl('LEFT', 'press')"
            (mouseup)="mainScene.input.handleControl('LEFT', 'release')"
            (touchstart)="mainScene.input.handleControl('LEFT', 'press', $event)"
            (touchend)="mainScene.input.handleControl('LEFT', 'release', $event)"
            (touchcancel)="mainScene.input.handleControl('LEFT', 'release', $event)">
            <div class="left-triangle"></div>
          </div>
          <div class="down-right" (mousedown)="mainScene.input.handleControl('DOWN_RIGHT', 'press')"
            (mouseup)="mainScene.input.handleControl('DOWN_RIGHT', 'release')"
            (touchstart)="mainScene.input.handleControl('DOWN_RIGHT', 'press', $event)"
            (touchend)="mainScene.input.handleControl('DOWN_RIGHT', 'release', $event)"
            (touchcancel)="mainScene.input.handleControl('DOWN_RIGHT', 'release', $event)">
            <div class="down-right-triangle"></div>
          </div>
          <div class="middle">
          </div>
        </div>
      </div>
    </div>

    <div class="controls">
      <div class="a-b">
        <div class="b" (mouseup)='mainScene.input.pressB()'>B</div>
        <div class="a" (mousedown)='mainScene.input.pressAStart()' (mouseup)='mainScene.input.pressAEnd()'
          (touchstart)='mainScene.input.pressAStart()' (touchend)='mainScene.input.pressAEnd()'>A</div>
      </div>

      <div class="start" (mouseup)='openStartMenu()'>START</div>
    </div>

    <input *ngIf="mainScene?.level?.name === 'CharacterCreate'" type="color" (change)='changeColor()' #colorInput
      class="colorInput" [value]="cachedDefaultColor ?? metaHero.color" />

  </div>
  <app-user class="popupPanel ucPopupPanel" *ngIf="isUserComponentOpen" [loginOnly]="true"
    [inputtedParentRef]="parentRef" [canClose]="false" (closeUserComponentEvent)="closeUserComponent($event)"
    [loginReasonMessage]="'You must log in to play Bones.'"></app-user>
</div>

<!-- Menu Popup -->
<div class="popupPanel menuPopupPanel" style="overflow: auto;" *ngIf="isMenuPanelOpen">
  <div class="popupPanelTitle mainPopupTitle">Menu</div>
  <div class="musicOptionsContainer" style="padding: 6px 8px;">
    <div style="display: flex; align-items: baseline;">
      <button class="musicButton" (click)="toggleSfx()" style="margin-bottom:6px;"
        [title]="isSfxMuted ? 'Unmute SFX' : 'Mute SFX'" aria-label="SFX toggle">
        {{ isSfxMuted ? 'Unmute SFX' : 'Mute SFX' }}
      </button>
      <button class="musicButton" (click)="toggleMusic()" [title]="isMusicMuted ? 'Unmute Music' : 'Mute Music'"
        aria-label="Music toggle">
        {{ isMusicMuted ? 'Unmute Music' : 'Mute Music' }}
      </button>
      <button class="musicButton" (click)="openChangeCharacter()" aria-label="Change Character">Change
        Character</button>
    </div>
    <div style="margin-top:10px;">
      <label style="display:block; font-size:12px; margin-bottom:6px;">Volume: {{ volumePercent() }}%</label>
      <input type="range" min="0" max="100" step="1" style="width:100%" [value]="volumePercent()"
        (input)="onVolumeSliderInput($event)" (change)="onVolumeChange($event)" aria-label="Volume Slider" />
    </div>
  </div>

  <div class="metaHighscoresSection">
    <app-bones-high-scores [inputtedParentRef]="parentRef"></app-bones-high-scores>
  </div>

  <button id="closeOverlay" (click)="closeMenuPanel()">Close</button>
</div>

<!-- Change Character Popup -->
<div class="popupPanel changeCharacterPanel" *ngIf="isChangeCharacterOpen">
  <div class="popupPanelTitle mainPopupTitle">Change Character</div>
  <div style="padding:8px;">
    <button (click)="createNewCharacterSelection()">New Character (save current)</button>
  </div>
  <div style="padding:8px;">
    <!-- Only show selections that do not share the current hero's name -->
    <div *ngIf="filteredHeroSelections && filteredHeroSelections.length > 0">
      <ng-container *ngFor="let s of filteredHeroSelections">
        <div
          style="display:flex; align-items:center; justify-content:space-between; padding:6px; border-bottom:1px solid #222;">
          <div>
            <div style="font-weight:600;" class="popupPanelTitle">{{s.name ?? ('Selection #' + s.id)}}</div>
            <div style="font-size:12px; color:#aaa;">Created: {{s.created | date:'short'}}</div>
          </div>
          <div>
            <button (click)="promoteSelection(s.id)">Promote</button>
            <button (click)="deleteSelection(s.id)">Delete</button>
          </div>
        </div>
      </ng-container>
    </div>
    <div *ngIf="!filteredHeroSelections || filteredHeroSelections.length === 0">No saved characters.</div>
  </div>
  <button id="closeOverlay" (click)="closeChangeCharacter()">Close</button>
</div>

<!-- Death overlay -->
<div class="popupPanel deathPanel" *ngIf="showDeathPanel">
  <div class="finalScoreWrapper">
    <div style="pointer-events:none; margin-bottom:8px; font-weight:bold">
      You were killed by:
    </div>
    <div class="killerAndStatsWrapper">
      <div *ngIf="deathKillerUserId || deathKillerName" class="deathKillerInfo">
        <div *ngIf="deathKillerUserId" class="deathKillerAvatarContainer">
          <app-user-tag [user]="cachedUsers.get(deathKillerUserId)" [userId]="deathKillerUserId"
            [inputtedParentRef]="parentRef" [displayOnlyAvatar]="false" [openInNewTab]="true"
            (userLoaded)="onUserTagLoaded($event)"></app-user-tag>
        </div>
        <div *ngIf="!deathKillerUserId && deathKillerName" class="deathKillerName">
          {{ deathKillerName | pascalCase }}
        </div>
      </div> 
    </div>
    <button id="closeOverlay" (click)="returnFromDeath()">Resurrect</button>
  </div>
</div>


<!-- Start Menu Popup -->
<div class="popupPanel startPopupPanel" *ngIf="isStartMenuOpened" style="max-width:360px; text-align:center;">
  <div style="display:flex; align-items:center; justify-content:center; position:relative;">
    <div class="popupPanelTitle mainPopupTitle">
      {{isChangeStatsOpen ? 'Change Stats' 
        : isPartyPanelOpen ? 'Nearby Heroes / Party'
        : 'Menu'}}
    </div>
    <button id="closeOverlay" (click)="closeStartMenu()" class="buttonDisplayNone"></button>
  </div>
  <div *ngIf="!isPartyPanelOpen && !isChangeStatsOpen" class="startGrid">
    <button class="bigActionButton" (click)="openPartyPanel()" aria-label="Party">Party</button>
    <button class="bigActionButton" (click)="openChangeCharacter()" aria-label="Change Hero">Change Hero</button>
    <button class="bigActionButton" (click)="openChangeStats()" aria-label="Change Stats">Change Stats</button>
    <button class="bigActionButton" (click)="openTownPortal()" aria-label="Town Portal">Town Portal</button>
    <button class="bigActionButton" (click)="closeStartMenu()" aria-label="Close">Close</button>
    <div></div>
  </div>

  <!-- Party subpanel -->
  <div *ngIf="isPartyPanelOpen" class="partyPanel">
    <div style="display:flex; gap:6px; margin-bottom:8px;">
      <button [disabled]="partyFilter==='all'" (click)="partyFilter='all'">All</button>
      <button [disabled]="partyFilter==='party'" (click)="partyFilter='party'">Party</button>
      <button [disabled]="partyFilter==='nearby'" (click)="partyFilter='nearby'">Nearby</button>
      <button (click)="isPartyPanelOpen = false">Close</button>
    </div>
    <div *ngIf="otherHeroes && otherHeroes.length > 0">
      <!-- Show a Leave Party button for the current player -->
      <div *ngIf="partyMembers && partyMembers.length > 1"
        style="display:flex; justify-content:center; margin-bottom:8px;">
        <button (click)="confirmLeaveParty()">Leave Party</button>
      </div>
      <div *ngFor="let p of getSortedHeroes()"
        style="display:flex; align-items:center; justify-content:space-between; padding:6px; border-bottom:1px solid #222;">
        <div style="display:flex; align-items:center; gap:8px;">
          <div style="width:28px; height:28px; background:#333; border-radius:50%;"></div>
          <div style="display:flex; flex-direction:column;">
            <div style="display:flex; align-items:center; gap:8px;">
              <div *ngIf="parentRef?.isUserOnline(p.updated | timeSince)" class="onlineButton" title="Online"></div>
              <div *ngIf="!parentRef?.isUserOnline(p.updated | timeSince)" style="width:10px; height:10px; border-radius:50%; background:#666; display:inline-block;" title="Offline"></div>
              <div>{{p.name}}</div>
            </div>
            <div class="xxSmallFont thirdFontColor" *ngIf="p.updated" [title]="p.updated">Updated: {{ p.updated | timeSince }}</div>
          </div>
        </div>
        <div>
          <button *ngIf="!isInParty(p.id) && !isAlreadyInPartyStatus(p.id)" [disabled]="isInvitePending(p.id)"
            (click)="inviteToParty(p.id)">Invite</button>
          <span *ngIf="isInvitePending(p.id)" class="pendingBadgeWrapper" [class.clearing]="isPendingClearing(p.id)">
            <span class="pendingBadge" aria-hidden="true">
              Pending
              <span style="font-weight:600; margin-left:8px; font-size:11px; opacity:0.95;">· {{ getPendingSeconds(p.id)
                ?? '' }}s</span>
            </span>
          </span>
          <span *ngIf="isAlreadyInPartyStatus(p.id)" class="pendingBadgeWrapper alreadyInParty">
            <span class="pendingBadge" aria-hidden="true">
              Already in a party
              <span style="font-weight:600; margin-left:8px; font-size:11px; opacity:0.95;">· {{ getAlreadyInPartySeconds(p.id) ?? '' }}s</span>
            </span>
          </span>
          <span *ngIf="isInParty(p.id) && !isInvitePending(p.id)" class="pendingBadgeWrapper inPartyPill">
            <span class="badge" aria-hidden="true" style="background:#8f8; color:#063; font-weight:700;">
              In Party
            </span>
          </span>
        </div>
      </div>
    </div>
    <div *ngIf="(!otherHeroes || otherHeroes.length === 0) && (!partyMembers || partyMembers.length === 0)">No nearby
      heroes found.</div>
  </div>

  <!-- Change Stats subpanel -->
  <div *ngIf="isChangeStatsOpen" class="changeStatsPanel"> 
    <!-- When statsUpdatedVisible is true, show a transient message and hide normal form contents -->
    <div *ngIf="statsUpdatedVisible" style="padding:12px; font-weight:700; text-align:center;">Stats updated</div>
    <ng-container *ngIf="!statsUpdatedVisible">
      <div style="display:flex; gap:8px; align-items:center; margin-bottom:8px;">
        <div>Points:</div>
        <div style="font-weight:700;">{{editableStats.pointsAvailable}}</div>
      </div>
      <div style="display:flex; flex-direction:column; gap:8px;">
        <div style="display:flex; justify-content:space-between; align-items:center;">
          <div>STR</div>
          <div>
            <button (click)="adjustStat('str', -1)" [disabled]="editableStats.str <= 1">-</button>
            <span style="margin:0 8px">{{editableStats.str}}</span>
            <button (click)="adjustStat('str', 1)" [disabled]="editableStats.pointsAvailable <= 0">+</button>
          </div>
        </div>
        <div style="display:flex; justify-content:space-between; align-items:center;">
          <div>DEX</div>
          <div>
            <button (click)="adjustStat('dex', -1)" [disabled]="editableStats.dex <= 1">-</button>
            <span style="margin:0 8px">{{editableStats.dex}}</span>
            <button (click)="adjustStat('dex', 1)" [disabled]="editableStats.pointsAvailable <= 0">+</button>
          </div>
        </div>
        <div style="display:flex; justify-content:space-between; align-items:center;">
          <div>INT</div>
          <div>
            <button (click)="adjustStat('int', -1)" [disabled]="editableStats.int <= 1">-</button>
            <span style="margin:0 8px">{{editableStats.int}}</span>
            <button (click)="adjustStat('int', 1)" [disabled]="editableStats.pointsAvailable <= 0">+</button>
          </div>
        </div>
      </div>
      <div style="margin-top:10px; display:flex; gap:8px; justify-content:center;">
        <button *ngIf="statsChanged" (click)="applyStats()">Apply</button>
        <button (click)="closeStartMenu()">Cancel</button>
      </div>
    </ng-container>
  </div>

</div>
<!-- Leave confirmation modal -->
<div class="popupPanel" *ngIf="showLeaveConfirm"
  style="max-width:320px; text-align:center; position:fixed; left:50%; top:50%; transform:translate(-50%,-50%); z-index:2000;">
  <div class="popupPanelTitle">Confirm Leave Party</div>
  <div style="padding:12px;">Are you sure you want to leave the party?</div>
  <div style="display:flex; gap:8px; justify-content:center; padding-bottom:12px;">
    <button (click)="leavePartyConfirmed()">Yes, Leave</button>
    <button (click)="cancelLeaveParty()">Cancel</button>
  </div>
</div>

<!-- Party invite popup -->
<div class="popupPanel" *ngIf="pendingInvitePopup"
  style="max-width:320px; text-align:center; position:fixed; left:50%; top:50%; transform:translate(-50%,-50%); z-index:2000;">
  <div class="popupPanelTitle">Party Invite</div>
  <div style="padding:12px;">{{ pendingInvitePopup.inviterName }} invited you to join a party.</div>
  <div style="padding-bottom:8px; font-size:12px; color:#ccc;">This invite will expire in <strong>{{
      pendingInviteSecondsLeft ?? 20 }}</strong> second{{ pendingInviteSecondsLeft && pendingInviteSecondsLeft !== 1 ?
    's' : '' }}.</div>
  <div style="display:flex; gap:8px; justify-content:center; padding-bottom:12px;">
    <button (click)="acceptInvite()">Accept</button>
    <button (click)="rejectInvite()">Reject</button>
  </div>
</div>