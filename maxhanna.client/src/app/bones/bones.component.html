<div class="componentMain" #componentMain>
  <div class="closeButton" (click)="remove_me('BonesComponent');"></div>
  <!--<div class="refreshButton" (click)="ngOnInit();"></div>-->
  <div class="componentTitle">Bones</div>
  <div class="menuButton" (click)="showMenuPanel()"></div>
 
  <div [style.display]="isLoading ? 'block' : 'none'" class="loadingModal">The game is loading...</div>
  <div [style.display]="serverDown ? 'block' : 'none'" class="serverDownMessage">We are sorry, server is currently down. Please be patient while we bring it back online.</div> 
  <div class="gameCanvasContainer">
    <canvas #gameCanvas id="gameCanvas" class="gameCanvas" width=320 height="220"></canvas>
  </div>
  <div class="chatArea">
    <div class="chatInputDiv">
      <input type="text" [placeholder]=" 'Chat'" #chatInput id="chatInput" class="chatInput"
        (keydown)="lockMovementForChat()" (change)="lockMovementForChat()" />
    </div>
  </div>

  <div class="inputArea"  [style.display]="!isMenuPanelOpen ? 'flex' : 'none'">
    <div class="controls">
      <div class="controls">
        <div class="dpad">
          <div class="up-left" (mousedown)="mainScene.input.handleControl('UP_LEFT', 'press')"
            (mouseup)="mainScene.input.handleControl('UP_LEFT', 'release')"
            (touchstart)="mainScene.input.handleControl('UP_LEFT', 'press', $event)"
            (touchend)="mainScene.input.handleControl('UP_LEFT', 'release', $event)"
            (touchcancel)="mainScene.input.handleControl('UP_LEFT', 'release', $event)">
            <div class="up-left-triangle"></div>
          </div>
          <div class="up" (mousedown)="mainScene.input.handleControl('UP', 'press')"
            (mouseup)="mainScene.input.handleControl('UP', 'release')"
            (touchstart)="mainScene.input.handleControl('UP', 'press', $event)"
            (touchend)="mainScene.input.handleControl('UP', 'release', $event)"
            (touchcancel)="mainScene.input.handleControl('UP', 'release', $event)">
            <div class="up-triangle"></div>
          </div>
          <div class="up-right" (mousedown)="mainScene.input.handleControl('UP_RIGHT', 'press')"
            (mouseup)="mainScene.input.handleControl('UP_RIGHT', 'release')"
            (touchstart)="mainScene.input.handleControl('UP_RIGHT', 'press', $event)"
            (touchend)="mainScene.input.handleControl('UP_RIGHT', 'release', $event)"
            (touchcancel)="mainScene.input.handleControl('UP_RIGHT', 'release', $event)">
            <div class="up-right-triangle"></div>
          </div>
          <div class="right" (mousedown)="mainScene.input.handleControl('RIGHT', 'press')"
            (mouseup)="mainScene.input.handleControl('RIGHT', 'release')"
            (touchstart)="mainScene.input.handleControl('RIGHT', 'press', $event)"
            (touchend)="mainScene.input.handleControl('RIGHT', 'release', $event)"
            (touchcancel)="mainScene.input.handleControl('RIGHT', 'release', $event)">
            <div class="right-triangle"></div>
          </div>
          <div class="down" (mousedown)="mainScene.input.handleControl('DOWN', 'press')"
            (mouseup)="mainScene.input.handleControl('DOWN', 'release')"
            (touchstart)="mainScene.input.handleControl('DOWN', 'press', $event)"
            (touchend)="mainScene.input.handleControl('DOWN', 'release', $event)"
            (touchcancel)="mainScene.input.handleControl('DOWN', 'release', $event)">
            <div class="down-triangle"></div>
          </div>
          <div class="down-left" (mousedown)="mainScene.input.handleControl('DOWN_LEFT', 'press')"
            (mouseup)="mainScene.input.handleControl('DOWN_LEFT', 'release')"
            (touchstart)="mainScene.input.handleControl('DOWN_LEFT', 'press', $event)"
            (touchend)="mainScene.input.handleControl('DOWN_LEFT', 'release', $event)"
            (touchcancel)="mainScene.input.handleControl('DOWN_LEFT', 'release', $event)">
            <div class="down-left-triangle"></div>
          </div>
          <div class="left" (mousedown)="mainScene.input.handleControl('LEFT', 'press')"
            (mouseup)="mainScene.input.handleControl('LEFT', 'release')"
            (touchstart)="mainScene.input.handleControl('LEFT', 'press', $event)"
            (touchend)="mainScene.input.handleControl('LEFT', 'release', $event)"
            (touchcancel)="mainScene.input.handleControl('LEFT', 'release', $event)">
            <div class="left-triangle"></div>
          </div>
          <div class="down-right" (mousedown)="mainScene.input.handleControl('DOWN_RIGHT', 'press')"
            (mouseup)="mainScene.input.handleControl('DOWN_RIGHT', 'release')"
            (touchstart)="mainScene.input.handleControl('DOWN_RIGHT', 'press', $event)"
            (touchend)="mainScene.input.handleControl('DOWN_RIGHT', 'release', $event)"
            (touchcancel)="mainScene.input.handleControl('DOWN_RIGHT', 'release', $event)">
            <div class="down-right-triangle"></div>
          </div>
          <div class="middle">
          </div>
        </div>
      </div>
    </div>

    <div class="controls">
      <div class="a-b">
        <div class="b" (mouseup)='mainScene.input.pressB()'>B</div>
        <div class="a" (mouseup)='mainScene.input.pressA()'>A</div>
      </div>

      <div class="start" (mouseup)='mainScene.input.pressStart()'>START</div>
    </div>

    <input *ngIf="mainScene?.level?.name === 'CharacterCreate'" type="color" (change)='changeColor()' #colorInput class="colorInput" [value]="cachedDefaultColor ?? metaHero.color" />
 
  </div>
  <app-user class="popupPanel ucPopupPanel" *ngIf="isUserComponentOpen" [loginOnly]="true"
    [inputtedParentRef]="parentRef" [canClose]="false" (closeUserComponentEvent)="closeUserComponent($event)"
    [loginReasonMessage]="'You must log in to play Meta-Bots.'"></app-user>
</div>

<!-- Menu Popup -->
<div class="popupPanel menuPopupPanel" style="overflow: auto;" *ngIf="isMenuPanelOpen">
  <div class="popupPanelTitle mainPopupTitle">Menu</div>
  <div class="musicOptionsContainer" style="padding: 6px 8px;">
    <div style="display: flex; align-items: baseline;">
      <button class="musicButton" (click)="toggleSfx()" style="margin-bottom:6px;" [title]="isSfxMuted ? 'Unmute SFX' : 'Mute SFX'" aria-label="SFX toggle">
        {{ isSfxMuted ? 'Unmute SFX' : 'Mute SFX' }} 
      </button>
      <button class="musicButton" (click)="toggleMusic()" [title]="isMusicMuted ? 'Unmute Music' : 'Mute Music'" aria-label="Music toggle">
        {{ isMusicMuted ? 'Unmute Music' : 'Mute Music' }} 
      </button>
      <button class="musicButton" (click)="openChangeCharacter()" aria-label="Change Character">Change Character</button>
    </div> 
    <div style="margin-top:10px;">
      <label style="display:block; font-size:12px; margin-bottom:6px;">Volume: {{ volumePercent() }}%</label>
      <input type="range" min="0" max="100" step="1" style="width:100%"
      [value]="volumePercent()" (input)="onVolumeSliderInput($event)" 
      (change)="onVolumeChange($event)" aria-label="Volume Slider" />
    </div>
  </div> 

  <div class="metaHighscoresSection">
    <app-bones-high-scores [inputtedParentRef]="parentRef"></app-bones-high-scores>
  </div>

  <button id="closeOverlay" class="closeButton" (click)="closeMenuPanel()">Close</button>
</div>

<!-- Change Character Popup -->
<div class="popupPanel changeCharacterPanel" *ngIf="isChangeCharacterOpen">
  <div class="popupPanelTitle mainPopupTitle">Change Character</div>
  <div style="padding:8px;">
    <button (click)="createNewCharacterSelection()">New Character (save current)</button>
  </div>
  <div style="padding:8px;">
    <div *ngIf="selections && selections.length > 0">
      <div *ngFor="let s of selections" style="display:flex; align-items:center; justify-content:space-between; padding:6px; border-bottom:1px solid #222;">
        <div>
          <div style="font-weight:600;" class="popupPanelTitle">{{s.name ?? ('Selection #' + s.id)}}</div>
          <div style="font-size:12px; color:#aaa;">Created: {{s.created | date:'short'}}</div>
        </div>
        <div>
          <button (click)="promoteSelection(s.id)">Promote</button>
          <button (click)="deleteSelection(s.id)">Delete</button>
        </div>
      </div>
    </div>
    <div *ngIf="!selections || selections.length === 0">No saved characters.</div>
  </div>
  <button id="closeOverlay" class="closeButton" (click)="closeChangeCharacter()">Close</button>
</div>