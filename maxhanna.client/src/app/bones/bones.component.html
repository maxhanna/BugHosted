<div class="componentMain" #componentMain>
  <div class="closeButton" (click)="remove_me('BonesComponent');"></div>
  <!--<div class="refreshButton" (click)="ngOnInit();"></div>-->
  <div class="componentTitle">Bones</div>
  <div class="menuButton" (click)="showMenuPanel()"></div>

  <div [style.display]="isLoading ? 'block' : 'none'" class="loadingModal">The game is loading...</div>
  <div [style.display]="serverDown ? 'block' : 'none'" class="serverDownMessage">We are sorry, server is currently down.
    Please be patient while we bring it back online.</div>
  <div class="gameCanvasContainer">
    <canvas #gameCanvas id="gameCanvas" class="gameCanvas" width=320 height="220"></canvas>
  </div>
  <div class="chatArea">
    <div class="chatInputDiv">
      <input type="text" [placeholder]=" 'Chat'" #chatInput id="chatInput" class="chatInput"
        (keydown)="lockMovementForChat()" (change)="lockMovementForChat()" />
    </div>
  </div>

  <div class="inputArea"
    [style.display]="(!isMenuPanelOpen && !isChangeCharacterOpen && !isPartyPanelOpen && !isStartMenuOpened) ? 'flex' : 'none'">
    <div class="controls">
      <div class="controls">
        <div class="dpad">
          <div class="up-left" (mousedown)="mainScene.input.handleControl('UP_LEFT', 'press')"
            (mouseup)="mainScene.input.handleControl('UP_LEFT', 'release')"
            (touchstart)="mainScene.input.handleControl('UP_LEFT', 'press', $event)"
            (touchend)="mainScene.input.handleControl('UP_LEFT', 'release', $event)"
            (touchcancel)="mainScene.input.handleControl('UP_LEFT', 'release', $event)">
            <div class="up-left-triangle"></div>
          </div>
          <div class="up" (mousedown)="mainScene.input.handleControl('UP', 'press')"
            (mouseup)="mainScene.input.handleControl('UP', 'release')"
            (touchstart)="mainScene.input.handleControl('UP', 'press', $event)"
            (touchend)="mainScene.input.handleControl('UP', 'release', $event)"
            (touchcancel)="mainScene.input.handleControl('UP', 'release', $event)">
            <div class="up-triangle"></div>
          </div>
          <div class="up-right" (mousedown)="mainScene.input.handleControl('UP_RIGHT', 'press')"
            (mouseup)="mainScene.input.handleControl('UP_RIGHT', 'release')"
            (touchstart)="mainScene.input.handleControl('UP_RIGHT', 'press', $event)"
            (touchend)="mainScene.input.handleControl('UP_RIGHT', 'release', $event)"
            (touchcancel)="mainScene.input.handleControl('UP_RIGHT', 'release', $event)">
            <div class="up-right-triangle"></div>
          </div>
          <div class="right" (mousedown)="mainScene.input.handleControl('RIGHT', 'press')"
            (mouseup)="mainScene.input.handleControl('RIGHT', 'release')"
            (touchstart)="mainScene.input.handleControl('RIGHT', 'press', $event)"
            (touchend)="mainScene.input.handleControl('RIGHT', 'release', $event)"
            (touchcancel)="mainScene.input.handleControl('RIGHT', 'release', $event)">
            <div class="right-triangle"></div>
          </div>
          <div class="down" (mousedown)="mainScene.input.handleControl('DOWN', 'press')"
            (mouseup)="mainScene.input.handleControl('DOWN', 'release')"
            (touchstart)="mainScene.input.handleControl('DOWN', 'press', $event)"
            (touchend)="mainScene.input.handleControl('DOWN', 'release', $event)"
            (touchcancel)="mainScene.input.handleControl('DOWN', 'release', $event)">
            <div class="down-triangle"></div>
          </div>
          <div class="down-left" (mousedown)="mainScene.input.handleControl('DOWN_LEFT', 'press')"
            (mouseup)="mainScene.input.handleControl('DOWN_LEFT', 'release')"
            (touchstart)="mainScene.input.handleControl('DOWN_LEFT', 'press', $event)"
            (touchend)="mainScene.input.handleControl('DOWN_LEFT', 'release', $event)"
            (touchcancel)="mainScene.input.handleControl('DOWN_LEFT', 'release', $event)">
            <div class="down-left-triangle"></div>
          </div>
          <div class="left" (mousedown)="mainScene.input.handleControl('LEFT', 'press')"
            (mouseup)="mainScene.input.handleControl('LEFT', 'release')"
            (touchstart)="mainScene.input.handleControl('LEFT', 'press', $event)"
            (touchend)="mainScene.input.handleControl('LEFT', 'release', $event)"
            (touchcancel)="mainScene.input.handleControl('LEFT', 'release', $event)">
            <div class="left-triangle"></div>
          </div>
          <div class="down-right" (mousedown)="mainScene.input.handleControl('DOWN_RIGHT', 'press')"
            (mouseup)="mainScene.input.handleControl('DOWN_RIGHT', 'release')"
            (touchstart)="mainScene.input.handleControl('DOWN_RIGHT', 'press', $event)"
            (touchend)="mainScene.input.handleControl('DOWN_RIGHT', 'release', $event)"
            (touchcancel)="mainScene.input.handleControl('DOWN_RIGHT', 'release', $event)">
            <div class="down-right-triangle"></div>
          </div>
          <div class="middle">
          </div>
        </div>
      </div>
    </div>

    <div class="controls">
      <div class="a-b">
        <div class="b" (mouseup)='mainScene.input.pressB()'>B</div>
        <div class="a" (mousedown)='mainScene.input.pressAStart()' (mouseup)='mainScene.input.pressAEnd()'
          (touchstart)='mainScene.input.pressAStart()' (touchend)='mainScene.input.pressAEnd()'>A</div>
      </div>

      <div class="start" (mouseup)='openStartMenu()'>START</div>
    </div>

    <input *ngIf="mainScene?.level?.name === 'CharacterCreate'" type="color" (change)='changeColor()' #colorInput
      class="colorInput" [value]="cachedDefaultColor ?? metaHero.color" />

  </div>
  <app-user class="popupPanel ucPopupPanel" *ngIf="isUserComponentOpen" [loginOnly]="true"
    [inputtedParentRef]="parentRef" [canClose]="false" (closeUserComponentEvent)="closeUserComponent($event)"
    [loginReasonMessage]="'You must log in to play Bones.'"></app-user>
</div>

<!-- Menu Popup -->
<div class="popupPanel menuPopupPanel" style="overflow: auto;" *ngIf="isMenuPanelOpen">
  <div class="popupPanelTitle mainPopupTitle">Menu</div>
  <div class="musicOptionsContainer" style="padding: 6px 8px;">
    <div style="display: flex; align-items: baseline;">
      <button class="musicButton" (click)="toggleSfx()" style="margin-bottom:6px;"
        [title]="isSfxMuted ? 'Unmute SFX' : 'Mute SFX'" aria-label="SFX toggle">
        {{ isSfxMuted ? 'Unmute SFX' : 'Mute SFX' }}
      </button>
      <button class="musicButton" (click)="toggleMusic()" [title]="isMusicMuted ? 'Unmute Music' : 'Mute Music'"
        aria-label="Music toggle">
        {{ isMusicMuted ? 'Unmute Music' : 'Mute Music' }}
      </button>
      <button class="musicButton" (click)="openChangeCharacter()" aria-label="Change Character">Change
        Character</button>
    </div>
    <div style="margin-top:10px;">
      <label style="display:block; font-size:12px; margin-bottom:6px;">Volume: {{ volumePercent() }}%</label>
      <input type="range" min="0" max="100" step="1" style="width:100%" [value]="volumePercent()"
        (input)="onVolumeSliderInput($event)" (change)="onVolumeChange($event)" aria-label="Volume Slider" />
    </div>
  </div>

  <div class="metaHighscoresSection">
    <app-bones-high-scores [inputtedParentRef]="parentRef"></app-bones-high-scores>
  </div>

  <button id="closeOverlay" (click)="closeMenuPanel()">Close</button>
</div>

<!-- Change Character Popup -->
<div class="popupPanel changeCharacterPanel" *ngIf="isChangeCharacterOpen">
  <div class="popupPanelTitle mainPopupTitle">Change Character</div>
  <div style="padding:8px;">
    <button (click)="createNewCharacterSelection()">New Character (save current)</button>
  </div>
  <div style="padding:8px;">
    <!-- Only show selections that do not share the current hero's name -->
    <div *ngIf="filteredHeroSelections && filteredHeroSelections.length > 0">
      <ng-container *ngFor="let s of filteredHeroSelections">
        <div
          style="display:flex; align-items:center; justify-content:space-between; padding:6px; border-bottom:1px solid #222;">
          <div>
            <div style="font-weight:600;" class="popupPanelTitle">{{s.name ?? ('Selection #' + s.id)}}</div>
            <div style="font-size:12px; color:#aaa;">{{ getSelectionType(s) ?? 'Unknown' }} · {{ getSelectionLevel(s) ??
              '—' }}</div>
            <div style="font-size:12px; color:#aaa;">Map: {{ getSelectionMap(s) ?? 'Unknown' }}</div>
            <div style="font-size:12px; color:#aaa;">Created: {{s.created | date:'short'}}</div>
          </div>
          <div>
            <button (click)="promoteSelection(s.id)">Promote</button>
            <button (click)="deleteSelection(s.id)">Delete</button>
          </div>
        </div>
      </ng-container>
    </div>
    <div *ngIf="!filteredHeroSelections || filteredHeroSelections.length === 0">No saved characters.</div>
  </div>
  <button id="closeOverlay" (click)="closeChangeCharacter()">Close</button>
</div>

<!-- Death overlay -->
<div class="popupPanel deathPanel" *ngIf="showDeathPanel">
  <div class="finalScoreWrapper">
    <div style="pointer-events:none; margin-bottom:8px; font-weight:bold">
      You were killed by:
    </div>
    <div class="killerAndStatsWrapper">
      <div *ngIf="deathKillerUserId || deathKillerName" class="deathKillerInfo">
        <div *ngIf="deathKillerUserId" class="deathKillerAvatarContainer">
          <app-user-tag [user]="cachedUsers.get(deathKillerUserId)" [userId]="deathKillerUserId"
            [inputtedParentRef]="parentRef" [displayOnlyAvatar]="false" [openInNewTab]="true"
            (userLoaded)="onUserTagLoaded($event)"></app-user-tag>
        </div>
        <div *ngIf="!deathKillerUserId && deathKillerName" class="deathKillerName">
          {{ deathKillerName | pascalCase }}
        </div>
      </div>
    </div>
    <button id="closeOverlay" (click)="returnFromDeath()">Resurrect</button>
  </div>
</div>


<!-- Start Menu Popup -->
<div [class]="'popupPanel startPopupPanel' + ((isChangeStatsOpen && !statsUpdatedVisible) ? ' changeStatPanel' : '')"
  *ngIf="isStartMenuOpened"
  [style.maxWidth]="!isPartyPanelOpen && !isChangeStatsOpen && !isChangeSkillsOpen ? '360px' : ''"
  style="text-align:center;">
  <div style="display:flex; align-items:center; justify-content:center; position:relative;">
    <div class="popupPanelTitle mainPopupTitle">
      {{isChangeStatsOpen ? 'Change Stats'
      : isChangeSkillsOpen ? 'Change Skills'
      : isPartyPanelOpen ? 'Nearby Heroes / Party'
      : hero?.name ?? 'Menu' }}
    </div>
    <button id="closeOverlay" (click)="closeStartMenu()" class="buttonDisplayNone"></button>
  </div>
  <div *ngIf="!isPartyPanelOpen && !isChangeStatsOpen && !isChangeSkillsOpen" class="startGrid">
    <button class="bigActionButton" (click)="openChangeCharacter()" aria-label="Change Hero">Change Hero</button>
    <button class="bigActionButton" (click)="openChangeStats()" aria-label="Change Stats">Change Stats</button>
    <button class="bigActionButton" (click)="openChangeSkills()" aria-label="Change Skills">Change Skills</button>
    <button class="bigActionButton" (click)="openPartyPanel()" aria-label="Party">Party</button>
    <button class="bigActionButton" (click)="openTownPortal()" aria-label="Town Portal">Town Portal</button>
    <button class="bigActionButton" (click)="closeStartMenu()" aria-label="Close">❌</button>
  </div>

  <!-- Party subpanel -->
  <div *ngIf="isPartyPanelOpen" class="partyPanel">
    <div class="filterButtons">
      <button [disabled]="partyFilter==='all'" (click)="partyFilter='all'">All</button>
      <button [disabled]="partyFilter==='party'" (click)="partyFilter='party'">Party</button>
      <button [disabled]="partyFilter==='nearby'" (click)="partyFilter='nearby'">Nearby</button>
      <button (click)="isPartyPanelOpen = false">Close</button>
    </div>
    <div *ngIf="(otherHeroes && otherHeroes.length > 0) || (partyMembers && partyMembers.length > 0)">
      <div *ngFor="let p of getSortedHeroes()" class="heroRow">
        <div class="heroLeft">
          <div class="heroInfo">
            <div class="heroNameRow">
              <div *ngIf="parentRef?.isUserOnline(p.updated | timeSince)" class="onlineButton" title="Online"></div>
              <div *ngIf="!parentRef?.isUserOnline(p.updated | timeSince)" class="offlineIndicator" title="Offline">
              </div>
              <div>
                {{p.name}}
              </div>
            </div>
            <div *ngIf="p.type || p.level" class="heroTypeLevel">
              <span *ngIf="p.type">{{ p.type | titlecase }}</span>
              <span *ngIf="p.type && p.level"> · </span>
              <span *ngIf="p.level">Lv {{ p.level }}</span>
            </div>
            <!-- Remote map indicator: show map if party member is on a different map than local hero -->
            <div *ngIf="p.map && metaHero?.map && p.map.toLowerCase() !== metaHero.map.toLowerCase()"
              class="heroRemoteMap">
              Map: {{ p.map }}
            </div>
            <div class="xxSmallFont thirdFontColor" *ngIf="p.updated" [title]="p.updated">Updated: {{ p.updated |
              timeSince }}</div>
          </div>
        </div>
        <div>
          <button *ngIf="!isInParty(p.id) && !isAlreadyInPartyStatus(p.id)" [disabled]="isInvitePending(p.id)"
            (click)="inviteToParty(p.id)">Invite</button>
          <span *ngIf="isInvitePending(p.id)" class="pendingBadgeWrapper" [class.clearing]="isPendingClearing(p.id)">
            <span class="pendingBadge badge-nowrap" aria-hidden="true">
              Pending · <span class="badge-timer">{{ getPendingSeconds(p.id) ?? '' }}s</span>
            </span>
          </span>
          <span *ngIf="isAlreadyInPartyStatus(p.id)" class="pendingBadgeWrapper alreadyInParty">
            <span class="pendingBadge badge-nowrap" aria-hidden="true">
              Already in a party · <span class="badge-timer">{{ getAlreadyInPartySeconds(p.id) ?? '' }}s</span>
            </span>
          </span>
          <span *ngIf="isInParty(p.id) && !isInvitePending(p.id)" class="pendingBadgeWrapper inPartyPill">
            <span class="badge badge-nowrap" aria-hidden="true">
              In Party
            </span>
          </span>
        </div>
      </div>
      <!-- Show a Leave Party button for the current player -->
      <div *ngIf="partyMembers && partyMembers.length > 1" class="leavePartyContainer">
        <button (click)="confirmLeaveParty()">Leave Party</button>
      </div>
    </div>
    <div *ngIf="(!otherHeroes || otherHeroes.length === 0) && (!partyMembers || partyMembers.length === 0)">No nearby
      heroes found.</div>
  </div>

  <!-- Change Stats subpanel -->
  <div *ngIf="isChangeStatsOpen" class="changeStatsPanel">
    <!-- When statsUpdatedVisible is true, show a transient message and hide normal form contents -->
    <div *ngIf="statsUpdatedVisible" style="padding:12px; font-weight:700; text-align:center;">Stats updated</div>
    <ng-container *ngIf="!statsUpdatedVisible">
      <div class="stat-points">
        <div class="stat-points-label">Points: {{editableStats.pointsAvailable}}</div>
      </div>
      <div class="stat-list">
        <div class="stat-row">
          <div class="stat-label">Attack DMG</div>
          <div class="stat-controls">
            <button class="stat-btn" (click)="adjustStat('attackDmg', -1)" [disabled]="editableStats.attackDmg <= 0"
              aria-label="Decrease Attack DMG">-</button>
            <input class="stat-input" type="number" aria-label="Attack DMG" [min]="0"
              [max]="(statsOriginal?.attackDmg ?? 0) + editableStats.pointsAvailable" [value]="editableStats.attackDmg"
              (input)="onStatInputChange('attackDmg', $any($event.target).value)" />
            <button class="stat-btn" (click)="adjustStat('attackDmg', 1)"
              [disabled]="editableStats.pointsAvailable <= 0" aria-label="Increase Attack DMG">+</button>
          </div>
        </div>
        <div class="stat-row">
          <div class="stat-label">Atk Speed (ms)</div>
          <div class="stat-controls">
            <button class="stat-btn" (click)="adjustStat('attackSpeed', -1)" [disabled]="editableStats.attackSpeed <= 0"
              aria-label="Decrease Attack Speed Points">-</button>
            <input class="stat-input" type="number" aria-label="Attack Speed Points" [min]="0"
              [max]="(statsOriginal?.attackSpeed ?? 0) + editableStats.pointsAvailable"
              [value]="editableStats.attackSpeed"
              (input)="onStatInputChange('attackSpeed', $any($event.target).value)" />
            <button class="stat-btn" (click)="adjustStat('attackSpeed', 1)"
              [disabled]="editableStats.pointsAvailable <= 0" aria-label="Increase Attack Speed Points">+</button>
          </div>
        </div>
        <div class="stat-row">
          <div class="stat-label">Crit Rate (%)</div>
          <div class="stat-controls">
            <button class="stat-btn" (click)="adjustStat('critRate', -1)" [disabled]="editableStats.critRate <= 0"
              aria-label="Decrease Crit Rate">-</button>
            <input class="stat-input" type="number" aria-label="Crit Rate" [min]="0"
              [max]="(statsOriginal?.critRate ?? 0) + editableStats.pointsAvailable" [value]="editableStats.critRate"
              (input)="onStatInputChange('critRate', $any($event.target).value)" />
            <button class="stat-btn" (click)="adjustStat('critRate', 1)" [disabled]="editableStats.pointsAvailable <= 0"
              aria-label="Increase Crit Rate">+</button>
          </div>
        </div>
        <div class="stat-row">
          <div class="stat-label">Crit DMG (mult)</div>
          <div class="stat-controls">
            <button class="stat-btn" (click)="adjustStat('critDmg', -1)" [disabled]="editableStats.critDmg <= 1"
              aria-label="Decrease Crit DMG">-</button>
            <input class="stat-input" type="number" aria-label="Crit DMG" [min]="1"
              [max]="(statsOriginal?.critDmg ?? 1) + editableStats.pointsAvailable" [value]="editableStats.critDmg"
              (input)="onStatInputChange('critDmg', $any($event.target).value)" />
            <button class="stat-btn" (click)="adjustStat('critDmg', 1)" [disabled]="editableStats.pointsAvailable <= 0"
              aria-label="Increase Crit DMG">+</button>
          </div>
        </div>
        <div class="stat-row">
          <div class="stat-label">Health</div>
          <div class="stat-controls">
            <button class="stat-btn" (click)="adjustStat('health', -1)" [disabled]="editableStats.health <= 0"
              aria-label="Decrease Health">-</button>
            <input class="stat-input" type="number" aria-label="Health points" [min]="0"
              [max]="(statsOriginal?.health ?? 0) + editableStats.pointsAvailable" [value]="editableStats.health"
              (input)="onStatInputChange('health', $any($event.target).value)" />
            <button class="stat-btn" (click)="adjustStat('health', 1)" [disabled]="editableStats.pointsAvailable <= 0"
              aria-label="Increase Health">+</button>
          </div>
        </div>
        <div class="stat-row">
          <div class="stat-label">Mana</div>
          <div class="stat-controls">
            <button class="stat-btn" (click)="adjustStat('mana', -1)" [disabled]="editableStats.mana <= 0"
              aria-label="Decrease Mana">-</button>
            <input class="stat-input" type="number" aria-label="Mana points" [min]="0"
              [max]="(statsOriginal?.mana ?? 0) + editableStats.pointsAvailable" [value]="editableStats.mana"
              (input)="onStatInputChange('mana', $any($event.target).value)" />
            <button class="stat-btn" (click)="adjustStat('mana', 1)" [disabled]="editableStats.pointsAvailable <= 0"
              aria-label="Increase Mana">+</button>
          </div>
        </div>
        <div class="stat-row">
          <div class="stat-label">Mana Regen</div>
          <div class="stat-controls">
            <button class="stat-btn" (click)="adjustStat('manaRegen', -1)" [disabled]="editableStats.manaRegen <= 0"
              aria-label="Decrease Mana Regen">-</button>
            <input class="stat-input" type="number" aria-label="Mana Regen" [min]="0" step="1"
              [max]="(statsOriginal?.manaRegen ?? 0) + editableStats.pointsAvailable" [value]="editableStats.manaRegen"
              (input)="onStatInputChange('manaRegen', $any($event.target).value)" />
            <button class="stat-btn" (click)="adjustStat('manaRegen', 1)"
              [disabled]="editableStats.pointsAvailable <= 0" aria-label="Increase Mana Regen">+</button>
          </div>
        </div>
        <div class="stat-row">
          <div class="stat-label">Regen</div>
          <div class="stat-controls">
            <button class="stat-btn" (click)="adjustStat('regen', -1)" [disabled]="editableStats.regen <= 0"
              aria-label="Decrease Regen">-</button>
            <input class="stat-input" type="number" aria-label="Regen" [min]="0" step="1"
              [max]="(statsOriginal?.regen ?? 0) + editableStats.pointsAvailable" [value]="editableStats.regen"
              (input)="onStatInputChange('regen', $any($event.target).value)" />
            <button class="stat-btn" (click)="adjustStat('regen', 1)" [disabled]="editableStats.pointsAvailable <= 0"
              aria-label="Increase Regen">+</button>
          </div>
        </div>
      </div>
      <div style="margin-top:10px; display:flex; gap:8px; justify-content:center;">
        <button *ngIf="statsChanged" (click)="applyStats()">Apply</button>
        <button (click)="closeStartMenu()">Cancel</button>
      </div>
    </ng-container>

    <button (click)="closeStartMenu()" *ngIf="statsUpdatedVisible">Close</button>
  </div>

  <!-- Change Skills subpanel: 3-box layout (large center box + two stacked to the right) -->
  <div *ngIf="isChangeSkillsOpen" class="changeStatsPanel">
    <div *ngIf="skillsUpdatedVisible" style="padding:12px; font-weight:700; text-align:center;">Skills updated</div>
    <ng-container *ngIf="!skillsUpdatedVisible">
      <div style="display:flex; gap:8px; align-items:center; margin-bottom:8px;">
        <div>Points:</div>
        <div style="font-weight:700;">{{editableSkills.pointsAvailable}}</div>
      </div>

      <!-- Skills row (wrapable) -->
      <div style="display:flex; gap:12px; align-items:center; justify-content:center; flex-wrap:wrap;">
        <!-- Large center skill box (Skill A) -->
        <div class="editableSkillsLargeBox">
          <div class="editableSkillsInputWrapper">
            <button (click)="adjustSkill('skillA', -1)" [disabled]="editableSkills.skillA <= 0"
              aria-label="Decrease Skill A">-</button>
            <div class="editableSkillsPanelIconWrapper">
              <div class="editableSkillsPanelIcon"></div>
            </div>
            <button (click)="adjustSkill('skillA', 1)" [disabled]="editableSkills.pointsAvailable <= 0"
              aria-label="Increase Skill A">+</button>
          </div>
          <div class="editableSkillPanelSkillName">Skill A</div>
          <div class="editableSkillsLevel">{{editableSkills.skillA}}</div>
        </div>

        <!-- Right column: Skill B and C inline/wrap -->
        <div style="display:flex; gap:8px; flex-wrap:wrap; align-items:center; justify-content:center;">
          <!-- Skill B large box (match Skill A appearance) -->
          <div class="editableSkillsLargeBox">
            <div class="editableSkillsInputWrapper">
              <button (click)="adjustSkill('skillB', -1)" [disabled]="editableSkills.skillB <= 0"
                aria-label="Decrease Skill B">-</button>
              <div class="editableSkillsPanelIconWrapper">
                <div class="editableSkillsPanelIcon"></div>
              </div>
              <button (click)="adjustSkill('skillB', 1)" [disabled]="editableSkills.pointsAvailable <= 0"
                aria-label="Increase Skill B">+</button>
            </div>
            <div class="editableSkillPanelSkillName">Skill B</div>
            <div class="editableSkillsLevel">{{editableSkills.skillB}}</div>
          </div>

          <!-- Skill C large box (match Skill A appearance) -->
          <div class="editableSkillsLargeBox">
            <div class="editableSkillsInputWrapper">
              <button (click)="adjustSkill('skillC', -1)" [disabled]="editableSkills.skillC <= 0"
                aria-label="Decrease Skill C">-</button>
              <div class="editableSkillsPanelIconWrapper">
                <div class="editableSkillsPanelIcon"></div>
              </div>
              <button (click)="adjustSkill('skillC', 1)" [disabled]="editableSkills.pointsAvailable <= 0"
                aria-label="Increase Skill C">+</button>
            </div>
            <div class="editableSkillPanelSkillName">Skill C</div>
            <div class="editableSkillsLevel">{{editableSkills.skillC}}</div>
          </div>
        </div>
      </div>

      <div style="margin-top:10px; display:flex; gap:8px; justify-content:center;">
        <button *ngIf="skillsChanged" (click)="applySkills()">Apply</button>
        <button (click)="closeStartMenu()">Cancel</button>
      </div>
    </ng-container>
    <button (click)="closeStartMenu()" *ngIf="skillsUpdatedVisible">Close</button>
  </div>

</div>
<!-- Leave confirmation modal -->
<div class="popupPanel" *ngIf="showLeaveConfirm"
  style="max-width:320px; text-align:center; position:fixed; left:50%; top:50%; transform:translate(-50%,-50%); z-index:2000;">
  <div class="popupPanelTitle">Confirm Leave Party</div>
  <div style="padding:12px;">Are you sure you want to leave the party?</div>
  <div style="display:flex; gap:8px; justify-content:center; padding-bottom:12px;">
    <button (click)="leavePartyConfirmed()">Yes, Leave</button>
    <button (click)="cancelLeaveParty()">Cancel</button>
  </div>
</div>

<!-- Party invite popup -->
<div class="popupPanel" *ngIf="pendingInvitePopup"
  style="max-width:320px; text-align:center; position:fixed; left:50%; top:50%; transform:translate(-50%,-50%); z-index:2000;">
  <div class="popupPanelTitle">Party Invite</div>
  <div style="padding:12px;">{{ pendingInvitePopup.inviterName }} invited you to join a party.</div>
  <div style="padding-bottom:8px; font-size:12px; color:#ccc;">This invite will expire in <strong>{{
      pendingInviteSecondsLeft ?? 20 }}</strong> second{{ pendingInviteSecondsLeft && pendingInviteSecondsLeft !== 1 ?
    's' : '' }}.</div>
  <div style="display:flex; gap:8px; justify-content:center; padding-bottom:12px;">
    <button (click)="acceptInvite()">Accept</button>
    <button (click)="rejectInvite()">Reject</button>
  </div>
</div>