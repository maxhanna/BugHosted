<div class="componentMain">
  <div class="closeButton" (click)="isTradePanelOpen ? closeTradeFullscreen() : remove_me('CryptoHubComponent');"></div>
  <div class="menuButton" (click)="showMenuPanel();" *ngIf="!isTradePanelOpen"></div>
  <div class="componentTitle">{{!isTradePanelOpen ? 'Crypto Hub' : 'Trade Bots'}}</div>
  <div [class]="noMining ? 'noMiningHubSection' : !isTradePanelOpen ? 'hubSection' : ''"
    [style.display]="isTradePanelOpen ? 'none' : 'block'">
    <div class="cryptoHubConverterAndCoinWatchWrapper" [style.display]="isTradePanelOpen ? 'none' : 'flex'">
      <div class="marquee-container">
        <div class="marquee-scroll" (mousedown)="onMouseDown($event)" (mouseup)="onMarqueeMouseUp()"
          (mousemove)="onMouseMove($event)" (mouseleave)="onMarqueeMouseUp()" (touchstart)="onTouchStart($event)"
          (touchend)="onTouchEnd()" (touchmove)="onTouchMove($event)" #scrollContainer>
          <div class="marquee-content">
            <a *ngFor="let item of loopedData" (click)="selectCoin(item.name)" class="marquee-item">
              <div>{{ item.name }} <span *ngIf="item.symbol">({{ item.symbol }})</span></div>
              <div>{{ item.valueCAD ? formatToCanadianCurrency(getConvertedCurrencyValue(item.valueCAD)) : '-' }}</div>
            </a>
          </div>
        </div>
      </div>

      <div class="BTCtoCADConversionWrapperDiv">
        <div class="BTCtoCADConversionDiv" *ngIf="coinNames">
          <label for="convertBTCInput">
            <select #btcConvertCoinSelect (change)="coinConvertSelectChange()" [title]="selectedCoinConversionName">
              <option *ngFor="let name of coinNames" [selected]="selectedCoinConversionName == name" [value]="name">
                {{name}}
              </option>
            </select>
          </label>
          <input id="convertBTCInput" type="text" value="1" #convertBTCInput (input)="handleConversion('BTC')"
            placeholder="BTC amount" />
        </div>

        <div class="BTCtoCADConversionDiv">
          <label for="convertCurrencyInput">{{selectedCurrency}}:</label>
          <input id="convertCurrencyInput" type="text" #convertCurrencyInput (input)="handleConversion('CURRENCY')"
            [placeholder]="selectedCurrency + ' amount'" />
        </div>

        <div class="BTCtoCADConversionDiv" *ngIf="!isLoading && btcConvertCoinSelect?.nativeElement?.value == 'BTC'">
          <label for="convertSATInput">SAT:</label>
          <input id="convertSATInput" type="text" #convertSATInput (input)="handleConversion('SAT')"
            placeholder="Satoshi amount" />
        </div>

        <div class="BTCtoCADConversionDiv" *ngIf="fiatNames && selectedFiatConversionName">
          <label for="convertFIATInput">
            <select #btcConvertFIATSelect (change)="fiatConvertSelectChange()">
              <option *ngFor="let name of fiatNames" [selected]="selectedFiatConversionName == name" [value]="name">
                {{name}}
              </option>
            </select>
          </label>
          <input id="convertFIATInput" type="text" #convertFIATInput (input)="handleConversion('FIAT')"
            placeholder="Enter Fiat amount" />
        </div>
      </div>
    </div>
    <div class="graphContainerDiv sectionContainer" [style.display]="isTradePanelOpen ? 'none' : 'block'" *ngIf="parentRef && selectedCurrency && currentSelectedCoin && latestCurrencyPriceRespectToCAD"> 
      <app-crypto-coin-graph-viewer 
        #coinGraphViewer
        [inputtedParentRef]="parentRef" 
        [currentSelectedCoin]="currentSelectedCoin"
        [selectedCurrency]="selectedCurrency"
        [latestCurrencyPriceRespectToCAD]="latestCurrencyPriceRespectToCAD"></app-crypto-coin-graph-viewer> 
    </div>
    <div class="graphContainerDiv sectionContainer" [style.display]="isTradePanelOpen ? 'none' : 'block'">
      <app-crypto-coin-volume-graph-viewer></app-crypto-coin-volume-graph-viewer>
    </div>
    <div class="sectionContainer" [style.display]="isTradePanelOpen ? 'none' : 'block'" *ngIf="volumeDisplayData">
      <div class="sectionName gradientBackground" style="padding:10px;">Volume Comparison</div>
      <div class="volume-depth-indicator">
        <div class="volume-bars">
          <div class="btc-bar" [style.width.%]="volumeDisplayData.btcPercentage || 0">
            <span class="volume-value">
              {{ volumeDisplayData.btc | number:'1.4-4' }} BTC
            </span>
          </div>
          <div class="usdc-bar" [style.width.%]="volumeDisplayData.usdcPercentage || 0">
            <span class="volume-value">
              {{ volumeDisplayData.usdc | number:'1.0-0' }} USDC
            </span>
          </div>
        </div>
        <div class="volume-stats">
          <div>
            {{ volumeDisplayData.btc | number:'1.4-4' }} BTC ≈
            {{ volumeDisplayData.btcInUSDC | number:'1.0-0' }}$
          </div> 
          <div *ngIf="volumeDisplayData.btcPrice">
            <strong>BTC Price:</strong>
            {{ volumeDisplayData.btcPrice | number:'1.0-0' }}$
          </div>
          <div *ngIf="volumeDisplayData.ratio">
            <strong>{{ volumeDisplayData.dominanceDescription }}:</strong>
            1 BTC volume ≈ {{ volumeDisplayData.ratio }}x USDC volume
          </div>

          <!-- Warning displays - can show both if needed -->
          <div *ngIf="volumeDisplayData.warnings.usdc.level !== 'none'"
            [class.usdc-mild-warning]="volumeDisplayData.warnings.usdc.level === 'mild'"
            [class.usdc-severe-warning]="volumeDisplayData.warnings.usdc.level === 'severe'">
            ⚠️ {{ volumeDisplayData.warnings.usdc.description }}
          </div>

          <div *ngIf="volumeDisplayData.warnings.btc.level !== 'none'"
            [class.btc-mild-warning]="volumeDisplayData.warnings.btc.level === 'mild'"
            [class.btc-severe-warning]="volumeDisplayData.warnings.btc.level === 'severe'">
            ⚠️ {{ volumeDisplayData.warnings.btc.description }}
          </div>
        </div>
      </div>

    </div>
    <div *ngIf="allHistoricalExchangeRateDataForGraph && allHistoricalExchangeRateDataForGraph.length > 0"
      class="graphContainerDiv sectionContainer" [style.display]="isTradePanelOpen ? 'none' : 'block'"> 
      <app-line-graph [type]="'Currency'" [selectedCoin]="selectedCurrency ?? 'CAD'" [displayCoinSwitcher]="false"
        [selectedCurrency]="selectedFiatConversionName" [showAverage]="true"
        [selectedPeriod]="exchangeRateGraphSelectedPeriod" [data]="allHistoricalExchangeRateDataForGraph!"
        #currencyExchangeLineGraph (changeTimePeriodEvent)="changeTimePeriodEventOnCurrencyExchangeGraph($event)">
      </app-line-graph>
    </div>
    <div *ngIf="!isTradePanelOpen && tradeIndicators" class="sectionContainer indicators-container">
      <div class="sectionName gradientBackground" style="margin-bottom: 15px; padding: 10px;">Trade Indicators for
        <select #tradeIndicatorSelect (change)="onIndicatorPairChange()" class="pair-selector">
          <option *ngFor="let pair of availableIndicatorPairs" [value]="pair.value"
            [selected]="pair.value === selectedIndicatorPair">
            {{ pair.display }}
          </option>
        </select>
      </div>

      <div class="indicators-grid">
        <!-- 200-Day MA -->
        <div class="indicator-card">
          <span class="indicator-label"
            title="Measures long-term price trend. 'Yes' means price is above the 200-day average.">
            200-Day Moving Average
          </span>
          <span class="indicator-value" [class.positive]="tradeIndicators.twoHundredDayMA">
            {{ tradeIndicators.twoHundredDayMA ? 'Yes' : 'No' }}
            <div class="indicator-value" [class]="tradeIndicators.twoHundredDayMA ? 'positive' : 'vwap-value'">
              {{ getConvertedCurrencyValueRespectToFiat(tradeIndicators.twoHundredDayMAValue) |
              currencySymbol:(selectedCurrency):true }}
            </div>
          </span>
        </div>

        <!-- 14-Day MA -->
        <div class="indicator-card">
          <span class="indicator-label"
            title="Measures long-term price trend. 'Yes' means price is above the 14-day average.">
            14-Day Moving Average
          </span>
          <span class="indicator-value" [class.positive]="tradeIndicators.fourteenDayMA">
            {{ tradeIndicators.fourteenDayMA ? 'Yes' : 'No' }}
            <div class="indicator-value" [class]="tradeIndicators.fourteenDayMA ? 'positive' : 'vwap-value'">
              {{ getConvertedCurrencyValueRespectToFiat(tradeIndicators.fourteenDayMAValue) |
              currencySymbol:(selectedCurrency):true }}
            </div>
          </span>
        </div>

        <!-- 21-Day MA -->
        <div class="indicator-card">
          <span class="indicator-label"
            title="Measures long-term price trend. 'Yes' means price is above the 21-day average.">
            21-Day Moving Average
          </span>
          <span class="indicator-value" [class.positive]="tradeIndicators.twentyOneDayMA">
            {{ tradeIndicators.twentyOneDayMA ? 'Yes' : 'No' }}
            <div class="indicator-value" [class]="tradeIndicators.twentyOneDayMA ? 'positive' : 'vwap-value'">
              {{ getConvertedCurrencyValueRespectToFiat(tradeIndicators.twentyOneDayMAValue) |
              currencySymbol:(selectedCurrency):true }}
            </div>
          </span>
        </div>

        <!-- RSI -->
        <div class="indicator-card">
          <span class="indicator-label" title="Relative Strength Index. Over 70 = overbought, under 30 = oversold.">
            14-Day RSI
          </span>
          <span class="indicator-value"
            [class]="(tradeIndicators.rsI14Day < 30 || (tradeIndicators.rsI14Day >= 50 && tradeIndicators.rsI14Day <= 70)) ? 'positive' : 'negative'">
            {{ tradeIndicators.rsI14Day | number:'1.2-2' }}
            <div class="rsi-label">({{ getRSIStatus(tradeIndicators.rsI14Day).label || 'Unknown' }})</div>
          </span>
        </div>

        <!-- VWAP Boolean -->
        <div class="indicator-card">
          <div class="indicator-label"
            title="Volume-Weighted Average Price over the past 24 hours. 'Yes' means price is currently above VWAP.">
            Above 24-Hour VWAP
          </div>
          <div class="indicator-value" [class.positive]="tradeIndicators.vwaP24Hour">
            {{ tradeIndicators.vwaP24Hour ? 'Yes' : 'No' }}
          </div>
          <div class="indicator-value" [class]="tradeIndicators.vwaP24Hour ? 'positive' : 'vwap-value'">
            {{ getConvertedCurrencyValueRespectToFiat(tradeIndicators.vwaP24HourValue) |
            currencySymbol:(selectedCurrency):true }}
          </div>
        </div>

        <!-- Volume Above 20 Day Average -->
        <div class="indicator-card">
          <div class="indicator-label" title="Volume is currently above its 20 day average value.">
            Volume Above 20-Day Average
          </div>
          <div class="indicator-value" [class.positive]="tradeIndicators.volumeAbove20DayAverage">
            {{ tradeIndicators.volumeAbove20DayAverage ? 'Yes' : 'No' }}
          </div>
          <div class="bold smallFont" [class]="tradeIndicators.volumeAbove20DayAverage ? 'positive' : 'negative'">
            {{ getConvertedCurrencyValueRespectToFiat(tradeIndicators.volume20DayAverageValue) |
            currencySymbol:(selectedCurrency):false }}
            / {{ getConvertedCurrencyValueRespectToFiat(tradeIndicators.currentVolumeValue) |
            currencySymbol:(selectedCurrency):false }}
          </div>
        </div>

        <!-- Retracement From High Boolean -->
        <div class="indicator-card">
          <div class="indicator-label"
            title="Shows how much the price has dropped from its 1-year high. Values below 15% indicate strength, while larger drops may suggest weakness.">
            Retracement From High
          </div>
          <div class="indicator-value" [class]="tradeIndicators.retracementFromHighValue > 0 ? 'positive' : 'negative'">
            {{ tradeIndicators.retracementFromHighValue > 0 ? 'Retracement' : 'New All-Time High' }}
          </div>
          <div class="bold smallFont"
            [class]="tradeIndicators.retracementFromHighValue > 0.05  ? 'positive' : 'negative'">
            {{ tradeIndicators.retracementFromHighValue * 100 | number:'1.2-2' }}% /
            <span>{{ getConvertedCurrencyValueRespectToFiat(tradeIndicators.highPriceValue) | currencySymbol:(selectedCurrency):true}}</span>
          </div>
        </div>

        <!-- MACD Histogram Boolean -->
        <div class="indicator-card" (click)="openMacdPopup()">
          <div class="indicator-label"
            title="MACD Histogram > 0 indicates bullish momentum (MACD line above signal line). Values show the distance between MACD and signal lines.">
            MACD Histogram
          </div>
          <div class="indicator-value"
            [class]="(tradeIndicators.macdLineValue - tradeIndicators.macdSignalValue) > 0 ? 'positive' : 'negative'">
            {{ (tradeIndicators.macdLineValue - tradeIndicators.macdSignalValue) > 0 ? 'Bullish' : 'Bearish' }}
          </div>
          <div class="indicator-value cursorPointerUnderlined"
            [class]="(tradeIndicators.macdLineValue - tradeIndicators.macdSignalValue) > 0 ? 'positive' : 'negative'">
            {{ (tradeIndicators.macdLineValue - tradeIndicators.macdSignalValue) | number:'1.4-4' }}
          </div>
        </div>

        <!-- Sentiment Analysis Score -->
        <div [class]="'indicator-card' + (isMarketSentimentMaximized ? ' popupPanel' : '')"
          *ngIf="marketSentimentData != undefined"
          (click)="(isMarketSentimentMaximized ? '' : openMarketSentimentPopup())">
          <div [class]="isMarketSentimentMaximized ? 'popupPanelTitle' : 'indicator-label'"
            title="How much the price has dropped from its recent high. Small values suggest strength.">
            {{(!onMobile() || !isMarketSentimentMaximized) ? 'Sentiment ' : ''}}Analysis
          </div>
          <div class="indicator-value" [class]="marketSentimentData[0].sentimentScore > 50 ? 'positive' : 'negative'"
            *ngIf="!isMarketSentimentMaximized">
            {{ marketSentimentData[0].sentimentScore }}%
          </div>
          <div
            [class]="(marketSentimentData[0].sentimentScore > 50 ? 'positive' : 'negative') + ' indicator-value' + (isMarketSentimentMaximized ? '' : ' marketSentimentAnalysis')"
            *ngIf="!isMarketSentimentMaximized">
            {{ marketSentimentData[0].analysis }}
          </div>


          <div *ngIf="isMarketSentimentMaximized">
            <!-- TABLE -->
            <div class="sentiment-table-wrapper">
              <table class="sentiment-table">
                <thead>
                  <tr>
                    <th class="smallColumn">Score</th>
                    <th>Analysis</th>
                    <th class="smallColumn">Created</th>
                  </tr>
                </thead>
                <tbody>
                  <tr *ngFor="let item of sentimentPageData" (click)="toggleSentiment(item)"
                    [class.clickable]="!isLatestSentiment(item)">
                    <!-- Score -->
                    <td class="smallColumn" [class.positive]="item.sentimentScore > 50"
                      [class.negative]="item.sentimentScore <= 50">
                      {{ item.sentimentScore }}%
                    </td>

                    <!-- Analysis -->
                    <td style="width: auto;" [class]="onMobile() ? 'smallFont' : ''"
                      [class.ellipsis]="!isLatestSentiment(item) && !item.expanded">
                      {{ item.analysis }}
                    </td>
                    <td class="smallColumn" [class.ellipsis]="!isLatestSentiment(item) && !item.expanded"
                      [title]="item.createdUtc">
                      {{ item.createdUtc | timeSince }}
                    </td>
                  </tr>
                </tbody>
              </table>
            </div> 
 
            <div class="pager">
              <button (click)="prevSentimentPage()" [disabled]="currentSentimentPage === 1">Prev</button>
              <span>Page {{ currentSentimentPage }} / {{ totalSentimentPages }}</span>
              <button (click)="nextSentimentPage()"
                [disabled]="currentSentimentPage === totalSentimentPages">Next</button>
            </div>
 
            <div style="text-align:right;margin-top:12px;">
              <button id="closeOverlay" (click)="closeMarketSentimentPopup()" class="closeButton">OK</button>
            </div>
          </div>
        </div>

        <!-- Retracement From High Boolean -->
        <div class="indicator-card" *ngIf="bullishCoins.length > 0"
          title="Bullish indicator signals detected for these coins. Trade with caution!">
          <div class="bullish-warning">
            ⚠️ Bullish coin(s) detected:
          </div>
          <div *ngFor="let pair of bullishCoins">
            {{ pair.replace("XBT", "BTC") }}
          </div>
        </div>
      </div>
    </div>
    <div *ngIf="!isTradePanelOpen" class="sectionContainer">
      <div class="sectionName gradientBackground" style="padding: 10px;">Fear And Greed Index</div>
      <app-crypto-fear-and-greed [inputtedParentRef]="parentRef"></app-crypto-fear-and-greed>
    </div>
    <div *ngIf="!isTradePanelOpen" class="sectionContainer">
      <app-crypto-market-caps #cryptoMarketCapsComponent [selectedCurrency]="selectedCurrency"
        [inputtedParentRef]="parentRef" [conversionRate]="latestCurrencyPriceRespectToCAD"
        (selectCoin)="selectCoin($event)"></app-crypto-market-caps>
    </div>
    <div *ngIf="!isTradePanelOpen && latestCurrencyPriceRespectToCAD && selectedCurrency" class="sectionContainer">
      <app-crypto-bitcoin-performance [inputtedParentRef]="parentRef" [selectedCurrency]="selectedCurrency" [selectedCoin]="currentSelectedCoin"></app-crypto-bitcoin-performance>
    </div>
  </div>
  <div [class]="isTradePanelOpen ? 'fullScreenTradePanelDiv' : 'hubSection miningHubSection'"
    *ngIf="latestCurrencyPriceRespectToCAD && latestCurrencyPriceRespectToCAD != 0 && selectedCurrency">
    <div class="sectionContainer" [style.display]="isTradePanelOpen ? 'none' : 'block'">
      <app-mining-rigs #miningRigComponent [isDiscreete]="isDiscreete" [inputtedParentRef]="parentRef"
        [conversionRate]="latestCurrencyPriceRespectToCAD" [currency]="selectedCurrency"
        (closeMiningEvent)="closeMiningEvent()"></app-mining-rigs>
    </div>
    <div class="sectionContainer" *ngIf="selectedCurrency" [style.display]="isTradePanelOpen ? 'none' : 'block'">
      <app-crypto-wallets 
      [inputtedParentRef]="parentRef" 
      [selectedCurrency]="selectedCurrency"
      [latestCoinValueData]="latestCoinValueData"
      [isDiscreete]="isDiscreete"
      (gotWallet)="wallet = $event"></app-crypto-wallets>
    </div>

    <div class="{{isTradePanelOpen ? 'maximizedTradePanel' : 'sectionContainer'}}"
      [style]="showingTradeSettings ? 'display: flex; flex-direction: column; align-items: center;' : ''">
      <div class="titleFont">
        <div style="width:100%;">
          <div class="sectionName gradientBackground" *ngIf="!isTradePanelOpen">
            Active Trade Bots
            <div>
              <button class="cursorPointer" (click)="openTradeFullscreen()" *ngIf="!isTradePanelOpen"
                title="We take no responsibility in how you use this trade bot nor what you do with any of this information.">
                Maximize View
              </button>
            </div>
          </div>
          <div *ngIf="tradeBotStartedSince">
            <div *ngIf="getActiveTradeBots().length > 0">
              <ng-container *ngIf="groupedBotsDisplay() as botGroups">
                <ul *ngIf="!isTradePanelOpen">
                  <li *ngFor="let group of botGroups">
                    {{ group.strategy }}:
                    <span class="thirdFontColor smallFont">
                      {{ group.currencies.join(', ') }} (Runtime: {{ group.startedSince | timeSince }})
                    </span>
                  </li>
                </ul>

                <div *ngIf="isTradePanelOpen">
                  <div *ngFor="let group of botGroups">
                    {{ group.strategy }}:
                    <span class="thirdFontColor smallFont">
                      {{ group.currencies.join(', ') }} (Runtime: {{ group.startedSince | timeSince }})
                    </span>
                  </div>
                </div>
              </ng-container>
            </div>
            <div *ngIf="getActiveTradeBots().length === 0">
              <p>No active trade bots.</p>
            </div>
          </div>
          <div>
            <!-- <div *ngIf="hasKrakenApi">Average Buy Price: <span class="thirdFontColor smallFont">{{formatToCanadianCurrency(weightedAveragePrices[0])}}</span></div>
              <div *ngIf="hasKrakenApi">Average Sell Price: <span class="thirdFontColor smallFont">{{formatToCanadianCurrency(weightedAveragePrices[1])}}</span></div> -->
            <div>
              <span class="sectionName">Last:&nbsp;</span>
              <span>
                <span *ngIf="lastTradebotTrade" class="smallFont">
                  <span [class]="onMobile() ? 'xxSmallFont' : ''" [title]="lastTradebotTrade['timestamp']">[{{
                    lastTradebotTrade['timestamp'] }}]</span>
                  <span [class]="lastTradebotTrade['buyOrSell'] === 'Sell' ? 'negative' : 'positive'">
                    {{ lastTradebotTrade['buyOrSell'] === 'Buy' ?
                    'Buy ' + lastTradebotTrade['value'] + ' ' + lastTradebotTrade['toCoin'] :
                    'Sold ' + lastTradebotTrade['value'] + ' ' + lastTradebotTrade['fromCoin'] }}
                  </span>|
                  <span [class]="lastTradebotTrade['buyOrSell'] === 'Buy' ? 'negative' : 'positive'">
                    {{ lastTradebotTrade['buyOrSell'] === 'Buy' ?
                    'Cost: ' + lastTradebotTrade['valuePrice'] + ' ' + lastTradebotTrade['fromCoin'] :
                    'Received: ' + lastTradebotTrade['valuePrice'] + ' ' + lastTradebotTrade['toCoin'] }}
                  </span>
                  <span class="smallFont thirdFontColor">
                    &#64; {{ lastTradebotTrade['tradePrice'] }}/{{ lastTradebotTrade['buyOrSell'] === 'Buy' ?
                    lastTradebotTrade['toCoin'] : lastTradebotTrade['fromCoin'] }}
                    ({{ lastTradebotTrade['strategy'] }})
                  </span>
                  <span *ngIf="lastTradePercentage !== null"
                    [title]="lastTradePercentage >= 0 ? 'Price has increased by ' + lastTradePercentage.toFixed(2) + '% since last trade.' : 'Price has decreased by ' + lastTradePercentage.toFixed(2) + '% since last trade.'"
                    class="cursorPointer xxSmallFont" [class.positive-percent]="lastTradePercentage >= 0"
                    [class.negative-percent]="lastTradePercentage < 0">
                    ({{ lastTradePercentage.toFixed(2) }}%)
                  </span>
                </span>
                <span *ngIf="!lastTradebotTrade" class="smallFont">No trades.</span>
              </span>
            </div>
            <div *ngIf="lastLogEntry && canShowTradePanelInfo()" [ngClass]="{'logScreen': !showingTradeLogs, 'bold': true}">
              <span class="sectionName">Log:&nbsp;</span> <span [ngClass]="{
                'thirdFontColor': true,
                'italics': true,
                'smallFont': true,
                'cursorPointerUnderlined': !showingTradeLogs
              }" (click)="onSmallLogClick()">{{lastLogEntry}}</span>
            </div>
            <div *ngIf="isTradePanelOpen && selectedCurrency">
              <span class="sectionName">Current Prices:&nbsp;</span>
              <span class="smallFont">
                <span *ngFor="let coin of getActiveTradebotCoins(); let last = last">
                  <span class="thirdFontColor">{{ coin }}:</span>
                  &nbsp;{{ getTradebotCoinPrice(coin) | currencySymbol:(selectedCurrency):true }}
                  <span *ngIf="!last"> | </span>
                </span>
              </span>
            </div>

            <div *ngIf="isTradePanelOpen && numberOfTrades && canShowTradePanelInfo()">
              <span class="sectionName">Number of Trades:&nbsp;</span>
              <span class="smallFont thirdFontColor">
                {{ numberOfTrades }}
              </span>
            </div>

          </div>
          <span class="cursorPointerUnderlined" (click)="createUpdateUserComponent();"
            *ngIf="!hasKrakenApi && parentRef?.user?.id"> Set Up Kraken API Keys </span>
          <span class="cursorPointerUnderlined" (click)="createUserComponent();"
            *ngIf="!hasKrakenApi && !parentRef?.user?.id"> Log in to use the bot.</span>
        </div>
        <div *ngIf="isTradePanelOpen" [class.trade-panel-controls]="canShowTradePanelInfo()">

          <div class="button-wrapper" *ngIf="canShowTradePanelInfo()">
            <select class="currency-select" #selectedTradebotCurrency (change)="currencySelectTradebotEngage()">
              <option value="BTC">Bitcoin/USDC</option>
              <option value="ETH">Ethereum/USDC</option>
              <option value="XRP">XRP/USDC</option>
              <option value="SOL">Solana/USDC</option>
              <option value="XDG">Dogecoin/USDC</option>
            </select>

            <select class="currency-select" #selectedTradebotStrategy (change)="currencySelectTradebotEngage()">
              <option value="DCA">DCA</option>
              <option value="HFT">High-Frequency</option>
              <option value="IND">Indicator</option>
            </select>

            <button class="cursorPointer"
              [disabled]="isTradeBotStarted(selectedTradebotCurrency?.value, selectedTradebotStrategy.value) || !hasKrakenApi"
              (click)="startTradeBot(selectedTradebotCurrency?.value, selectedTradebotStrategy.value)"
              title="Start the tradebot.">
              Start {{selectedTradebotCurrency?.value}} {{selectedTradebotStrategy.value}}
            </button>

            <button class="cursorPointer"
              (click)="stopTradeBot(selectedTradebotCurrency?.value, selectedTradebotStrategy.value)"
              title="Stop the tradebot."
              [disabled]="!isTradeBotStarted(selectedTradebotCurrency?.value, selectedTradebotStrategy.value) || !hasKrakenApi">
              Stop {{selectedTradebotCurrency?.value}} {{selectedTradebotStrategy.value}}
            </button>

            <p class="button-description" id="trades-desc" *ngIf="!isTradebotBalanceShowing && selectedTradebotCurrency?.value">
              {{isTradeBotStarted(selectedTradebotCurrency?.value) ? 'Stop' : 'Start'}} trading USDC and
              {{selectedTradebotCurrency?.value}} pair with {{selectedTradebotStrategy.value}} strategy.
            </p>
          </div>


          <div class="button-wrapper" *ngIf="(canShowTradePanelInfo() || showingTradeSettings)">
            <button class="cursorPointer" (click)="showTradeSettings()" id="config-button"
              aria-describedby="config-desc">
              {{showingTradeSettings ? 'Hide' : 'Show'}} Configuration
            </button>
            <p class="button-description" id="config-desc" *ngIf="!showingTradeSettings">
              Opens the settings panel to configure trading parameters like trade thresholds and reserve amounts.
            </p>
          </div>
          <div class="button-wrapper" *ngIf="canShowTradePanelInfo() || isTradebotBalanceShowing">
            <button class="cursorPointer" (click)="isTradebotBalanceShowing ? hideBalance() : checkBalance()"
              [disabled]="isLoading" id="trades-button" aria-describedby="trades-desc">
              {{isTradebotBalanceShowing ? 'Hide' : 'Show'}} Trades
            </button>
            <p class="button-description" id="trades-desc" *ngIf="!isTradebotBalanceShowing">
              Displays a table of recent trades, including BTC/USDC transactions, prices, and fees.
            </p>
          </div>

          <div class="button-wrapper" *ngIf="canShowTradePanelInfo() || showingTradeLogs">
            <button class="cursorPointer" (click)="showTradeLogs()" id="logs-button" aria-describedby="logs-desc" [style.marginBottom]="onMobile() ? '10px' : ''">
              {{showingTradeLogs ? 'Hide' : 'Show'}} Logs
            </button>
            <p class="button-description" id="logs-desc" *ngIf="!showingTradeLogs">
              Shows detailed logs of bot actions, such as trade decisions and errors, with pagination.
            </p>
          </div>

          <div class="button-wrapper" *ngIf="canShowTradePanelInfo() || isTradeLiveViewShowing">
            <button class="cursorPointer" (click)="!isTradeLiveViewShowing ? showTradeLiveView() : hideTradeLiveView()" [disabled]="isLoading">
              {{isTradeLiveViewShowing ? 'Hide' : 'Show'}} Live Trade View
            </button>
            <p class="button-description" id="trades-desc" *ngIf="!isTradeLiveViewShowing">
              Displays a live trading view.
            </p>
          </div>

          <div class="button-wrapper"
            [title]="isTradeBotStarted(selectedTradebotCurrency?.nativeElement?.value, selectedTradebotStrategy?.nativeElement?.value) ? 'Disabled: Tradebot is running.' : ''"
            *ngIf="canShowTradePanelInfo()">
            <button class="cursorPointer" (click)="enterPosition()"
              [title]="'Buy '+selectedTradebotCurrency?.nativeElement?.value+' On dip by splitting funds with _InitialMinimumFromAmountToStart (set in configuration).'+ hasKrakenApi ? '' : 'Disabled: No Kraken API keys found.'"
              id="enter-button" aria-describedby="enter-desc" [disabled]="!hasKrakenApi">
              Enter {{selectedTradebotCurrency?.nativeElement?.value}} Position
            </button>
            <p class="button-description" id="enter-desc">
              Buys {{selectedTradebotCurrency?.nativeElement?.value}} using configured funds, starting a new trading
              position and starting the bot. See configuration
              under: _InitialMinimumFromAmountToStart.
            </p>
          </div>

          <div class="button-wrapper" [title]="!tradeBotStatus['BTC'] ? 'Disabled: Tradebot is not running.' : ''"
            *ngIf="canShowTradePanelInfo()">
            <button class="cursorPointer" (click)="exitPosition()"
              [title]="'Sell all '+selectedTradebotCurrency?.nativeElement?.value+' at current price and exit '+selectedTradebotCurrency?.nativeElement?.value+' position. ' + hasKrakenApi ? '' : 'Disabled: No Kraken API keys found.' + tradeBotStatus['BTC'] ? '' : 'Disabled: Tradebot not started.'"
              id="exit-button" aria-describedby="exit-desc" [disabled]="!hasKrakenApi || !tradeBotStatus['BTC']">
              Exit {{selectedTradebotCurrency?.nativeElement?.value}} Position
            </button>
            <p class="button-description" id="exit-desc">
              Sells all {{selectedTradebotCurrency?.nativeElement?.value}} at market price, closing the current trading
              position and stopping the bot.
            </p>
          </div>

          <div class="button-wrapper"
            *ngIf="(isShowingTradeProfit || isShowingTradeValueGraph || isShowingTradeSimulator)">
            <button class="cursorPointer" (click)="closeTradeDivs()">
              Hide {{ isShowingTradeProfit ? 'Profit' : isShowingTradeValueGraph ? 'Graph' : isShowingTradeSimulator ?
              'Sim' : '' }}
            </button>
          </div>

          <div class="button-wrapper" *ngIf="canShowTradePanelInfo()">
            <button class="cursorPointer" (click)="showTradeInformationPanel()" id="info-button"
              aria-describedby="info-desc">
              Information
            </button>
            <p class="button-description" id="info-desc">
              Opens a panel with details about the bot’s features, logic, and best practices.
            </p>
          </div>
        </div>
        <div *ngIf="isTradebotBalanceShowing && parentRef && selectedCurrency && !isLoading">
          <app-crypto-trade-history [inputtedParentRef]="parentRef" [selectedCurrency]="selectedCurrency"
            [defaultCoin]="selectedTradebotCurrency?.nativeElement?.value ?? 'BTC'"
            [defaultStrategy]="selectedTradebotStrategy?.nativeElement?.value ?? 'DCA'"></app-crypto-trade-history>
        </div> 
        <div *ngIf="isTradeLiveViewShowing && parentRef && selectedCurrency && latestCurrencyPriceRespectToCAD">
          <app-crypto-live-trade-view 
          [activeTradeBots]="getActiveTradeBots()"
          [inputtedParentRef]="parentRef" 
          [selectedCurrency]="selectedCurrency" 
          [latestCurrencyPriceRespectToCAD]="latestCurrencyPriceRespectToCAD"
          [hasKrakenApi]="hasKrakenApi"></app-crypto-live-trade-view>
        </div>
      </div>
      <div
        *ngIf="showingTradeSettings && cadToSelectedCurrencyRate && btcToCadPrice && solToCadPrice && xrpToCadPrice && xdgToCadPrice && ethToCadPrice"
        [style.opacity]="isLoading ? '25%' : ''">
        <app-crypto-bot-configuration #configurationComponent [inputtedParentRef]="parentRef"
          [btcToCadPrice]="btcToCadPrice * cadToSelectedCurrencyRate"
          [solToCadPrice]="solToCadPrice * cadToSelectedCurrencyRate"
          [xrpToCadPrice]="xrpToCadPrice * cadToSelectedCurrencyRate"
          [xdgToCadPrice]="xdgToCadPrice * cadToSelectedCurrencyRate"
          [ethToCadPrice]="ethToCadPrice * cadToSelectedCurrencyRate" 
          [selectedCurrency]="selectedCurrency"
          (updatedTradeConfig)="updatedTradeConfigEvent($event)"
          (closeEventEmitter)="closeCryptoBotConfigEmitter()"></app-crypto-bot-configuration>
      </div>
      <div *ngIf="isShowingTradeValueGraph">
        <app-line-graph [type]="'Crypto'" [graphTitle]="'Trade Value'" [data]="tradebotValuesForGraph"
          [selectedPeriod]="'5y'" [showAverage]="true" (fullscreenSelectedEvent)="fullscreenSelectedInPopup($event)">
        </app-line-graph>
      </div>


      <div *ngIf="isShowingTradeProfit && profitData?.length" class="profit-container tradeDataTable">
        <div *ngFor="let type of periodTypes" class="period-type-section">
          <div class="section-header" (click)="toggleProfitSection(type.key)">
            <div class="popupPanelTitle">{{ type.label }} <span class="toggle-icon">{{ isProfitSectionOpen(type.key) ?
                '−' :
                '+' }}</span></div>
          </div>
          <div class="profit-periods" *ngIf="isProfitSectionOpen(type.key)">
            <div *ngFor="let period of getProfitPeriodsByType(type.periodKey)" class="period-card">
              <div class="period-header">
                <span class="period-type">{{ period.periodType | titlecase }}</span>
                <span class="period-dates">
                  {{ period.periodStart | date:'MMM d, y' }} -
                  {{ (period.periodEnd | date:'MMM d, y') || 'Present' }}
                </span>
              </div>

              <div class="profit-values">
                <div class="value-row">
                  <span>Starting Balance:</span>
                  <span>{{ period.startUsdc | currency }} + {{ period.startBtc }} BTC</span>
                </div>

                <div class="value-row">
                  <span>Starting Net Worth:</span>
                  <span>{{ (period.startUsdc ?? 0) + ((period.startBtc ?? 0) * (period.startBtcPriceUsdc ?? 0)) |
                    currency }}
                    USD</span>
                </div>

                <div class="value-row">
                  <span>BTC Price:</span>
                  <span>{{ period.startBtcPriceUsdc | currency }}</span>
                </div>

                <div class="value-row">
                  <span>Ending Balance:</span>
                  <span>{{ period.endUsdc | currency }} + {{ period.endBtc }} BTC</span>
                </div>

                <div class="value-row" *ngIf="period.endBtcPriceUsdc">
                  <span>Ending BTC Price:</span>
                  <span>{{ period.endBtcPriceUsdc | currency }}</span>
                </div>

                <div class="value-row" *ngIf="period.endUsdc && period.endBtc && period.endBtcPriceUsdc">
                  <span>Ending Net Worth:</span>
                  <span>{{ period.endUsdc + (period.endBtc * period.endBtcPriceUsdc) | currency }} USD</span>
                </div>

                <div class="value-row profit-row" [class.positive]="period.profitUsdc && period.profitUsdc > 0"
                  [class.negative]="period.profitUsdc && period.profitUsdc < 0">
                  <span>Profit:</span>
                  <span>{{ period.profitUsdc | currency:'USD':'symbol':'1.2-10' }}</span>
                </div>

                <div class="value-row profit-row"
                  [class.positive]="period.absoluteProfitUsdc && period.absoluteProfitUsdc > 0"
                  [class.negative]="period.absoluteProfitUsdc && period.absoluteProfitUsdc < 0">
                  <span>Absolute Profit:</span>
                  <span>{{ period.absoluteProfitUsdc | currency }}</span>
                </div>

                <div class="value-row profit-row"
                  [class.positive]="period.cumulativeProfitUsdc && period.cumulativeProfitUsdc > 0"
                  [class.negative]="period.cumulativeProfitUsdc && period.cumulativeProfitUsdc < 0">
                  <span>Cumulative Profit:</span>
                  <span>{{ period.cumulativeProfitUsdc | currency }}</span>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div> 
      
      <div *ngIf="showingTradeLogs && parentRef && !isLoading" [style.opacity]="isLoading ? '25%' : ''">
        <app-crypto-trade-logs [inputtedParentRef]="parentRef" [hasKrakenApi]="hasKrakenApi"
            [defaultCoin]="selectedTradebotCurrency?.nativeElement?.value ?? 'BTC'"
            [defaultStrategy]="selectedTradebotStrategy?.nativeElement?.value ?? 'DCA'"></app-crypto-trade-logs>
      </div> 
      
      <div *ngIf="isShowingTradeSimulator && tradebotSimulationGraphData && tradebotSimulationGraphData.length > 0" class="tradeDataTable">
        <app-line-graph #simLineGraph [selectedPeriod]="'1d'" [data]="tradebotSimulationGraphData"
          [data2]="tradebotSimulationGraphData2" [graphTitle]="'Simulated Price Variation'" [skipFiltering]="true"
          [selectedCoin]="'Bitcoin'" [chartTypeInputted]="'line'" [chartTypeInputtedData2]="'line'"
          [isDotModeData2]="true" [type]="'Crypto'"></app-line-graph>
        <button (click)="randomizeTradingSimGraph()">Randomize</button>
        <button (click)="randomizeTradingSimGraphWithRandomDayThisWeek()">Random Day This Week</button>
        <button (click)="randomizeTradingSimGraphWithRandomWeekData()">Random Week</button>
        <button (click)="randomizeTradingSimGraphWithRandomMonthData()">Random Month</button>
        <button (click)="downloadSimTradeDataCSV()">Download CSV</button>
        <div
          style="display: flex; justify-content: space-around; align-content: center; flex-direction: row; flex-wrap: nowrap; align-items: center;">
          <div
            style="display: flex; flex-direction: column; flex-wrap: nowrap; align-content: center; justify-content: center; align-items: center; text-align: center;">
            <div>
              <label>Initial BTC (USD)</label>
              <input [value]="tradeSimParams.initialBtc" (change)="updateSimTradeVars()" type="number" min="100"
                max="100000" required #initialBtcUsd>
            </div>
            <div>
              <label>Initial USDC</label>
              <input [value]="tradeSimParams.initialUsd" (change)="updateSimTradeVars()" type="number" min="100"
                max="100000" required #initialUsdc>
            </div>
            <div>
              <label>Trade Spread (%)</label>
              <input [value]="tradeSimParams.tradeThreshold" (change)="updateSimTradeVars()" type="number" min="0.001"
                max="0.05" step="0.001" required #tradeSpreadPct>
            </div>
            <div>
              <label>Trade Fee (%)</label>
              <input [value]="tradeSimParams.fee" (change)="updateSimTradeVars()" type="number" min="0.001" max="0.01"
                step="0.001" required #tradeFeePct>
            </div>
            <div>
              <label>Trade Amount (%)</label>
              <input [value]="tradeSimParams.tradePercentage" (change)="updateSimTradeVars()" type="number" min="0.05"
                max="0.5" step="0.05" required #tradeAmountPct>
            </div>
          </div>
          <div class="tradeBotSimDebugDivWrapper" #tradeBotSimDebugDivContainer id="tradeBotSimDebugDivContainer"
            *ngIf="tradeBotSimDebug && tradeBotSimDebug.length > 0">
            <button (click)="scrollToBottomOfTradebotSimDebug()">Scroll to bottom</button>
            <div *ngFor="let string of tradeBotSimDebug">
              <div *ngIf="string && (string.includes('[SELL]') || string.includes('[BUY]'))" style="height:25px;"></div>
              <div>{{ string }}</div>
            </div>
            <button (click)="scrollToTopOfTradebotSimDebug()">Scroll to top</button>
          </div>
        </div>
      </div>
      <div *ngIf="isTradePanelOpen" [style.marginTop]="isTradePanelOpen ? '15px' : ''"
        class="tradePanelCloseButtonSection">
        <div *ngIf="isTradePanelOpen && canShowTradePanelInfo()">
          <div class="smallFont thirdFontColor">Consider buying me a coffee!</div>
          <div class="smallFont thirdFontColor"><span class="secondaryFontColor">BTC Address:</span>
            bc1qz8xl5f3r40pzy3ypldp9q9vrhct8hz53vysrd4</div>
        </div>
        <button class="cursorPointer" (click)="openTradeFullscreen()">{{isTradePanelOpen ? 'Minimize' : 'Maximize'}}
          View</button>
      </div>

    </div>

    <div class="sectionContainer" [style.display]="isTradePanelOpen ? 'none' : 'block'">
      <div class="titleFont cursorPointer" style="display: flex; justify-content: space-between;"
        (click)="hideHostAiMessage = !hideHostAiMessage">
        <span class="warning-text"
          title="This is not actual financial advice. This is based off AI and the data presented to it from your wallet. We take no responsibility in what you do with this information.">⚠️
          HostAI: </span>
        <button class="cursorPointer" (click)="generateGeneralAiMessage(); hideHostAiMessage = !hideHostAiMessage;"
          *ngIf="!finishedGeneratingAiMessage" [disabled]="isLoading">
          <span *ngIf="!finishedGeneratingAiMessage && !isLoading">Generate Analysis</span>
          <span *ngIf="!finishedGeneratingAiMessage && isLoading">Generating...</span>
        </button>
      </div>
      <div class="aiMessage" *ngIf="finishedGeneratingAiMessage && !hideHostAiMessage">
        <span [innerHTML]="getAiMessage('1')"></span>
      </div>
    </div>

    <div *ngIf="!latestCoinValueData && isLoading">
      Loading data, please wait...
    </div>
    <div *ngIf="!latestCoinValueData && !isLoading">
      Something went wrong, please refresh this component after a while.
    </div>

    <div *ngIf="!isTradePanelOpen && globalCryptoStats && selectedCurrency" class="sectionContainer">
      <app-crypto-global-stats [selectedCurrency]="selectedCurrency"
        [latestCurrencyPriceRespectToFIAT]="latestCurrencyPriceRespectToFIAT"
        [metrics]="globalCryptoStats"></app-crypto-global-stats>
    </div>
    <div *ngIf="!isTradePanelOpen" class="sectionContainer">
      <app-crypto-calendar [inputtedParentRef]="parentRef"></app-crypto-calendar>
    </div>
  </div>


  <div *ngIf="isMenuPanelOpen" class="popupPanel">
    <div class="popupPanelTitle">
      Menu
    </div>
    <div class="optionsStatsWrapperDiv menuPanelOptionsDiv">
      <div *ngIf="fiatNames" class="optionsStatsDiv">
        <div class="optionsStatsHeader">
          Selected Currency :
        </div>
        <div class="optionsStatsDescription">
          <select #selectedCurrencyDropdown (change)="changeDefaultCurrency()">
            <option *ngFor="let currency of fiatNames" [selected]="selectedCurrency === currency">
              {{ currency }}
            </option>
          </select>
        </div>
      </div>
      <div class="optionsStatsDiv">
        <div class="optionsStatsHeader">
          Discreete mode :
        </div>
        <div class="optionsStatsDescription discreeteModeSelectorDiv" title="Enable/Disable discreete mode">
          <input type="checkbox" (click)="discreete()" [checked]="isDiscreete" />
          <span (click)="discreete()" class="discreeteModeSpan">{{ isDiscreete ? '🙈' : '🙉' }}</span>
        </div>
      </div>
    </div>
    <div>
      <button id="closeOverlay" (click)="closeMenuPanel()" class="closeButton">Close</button>
    </div>
  </div> 

  <div *ngIf="isTradeInformationOpen" class="popupPanel">
    <div class="button-wrapper">
      <select #toolSelect class="data-tool-select" (change)="tradePanelToolSelectChange()">
        <option value="about">About the Tradebot</option>
        <!-- <option value="profit">Profit and Loss</option>
        <option value="graph">Trade Value Graph</option>
        <option value="sim">Tradebot Simulation</option> -->
      </select>
      <button class="cursorPointer" (click)="toggleSelectedDataTool(toolSelect?.value)"
        *ngIf="toolSelect.value != 'about'">
        {{ getToolVisibility(toolSelect?.value) ? 'Hide' : 'Show' }}
        {{ getToolLabel(toolSelect?.value) }}
      </button>
      <!-- Conditional content -->
      <div *ngIf="!isShowingTradeProfit && !isShowingTradeValueGraph && !isShowingTradeSimulator">
        <div *ngIf="toolSelect?.value == 'profit'" class="button-wrapper">
          <p class="button-description">
            Shows all profit and loss from the tradebot, including fees and other costs.
          </p>
        </div>

        <div *ngIf="toolSelect?.value == 'graph'" class="button-wrapper">
          <p class="button-description">
            Plots trade values over time to visualize bot performance and profitability.
          </p>
        </div>

        <div *ngIf="toolSelect?.value == 'sim'" class="button-wrapper">
          <p class="button-description">
            Runs a simulation of trading strategies with historical or random data to test performance.
          </p>
        </div>
      </div>
    </div>

    <div class="aboutTable" *ngIf="toolSelect.value == 'about'">
      <app-crypto-tradebot-information></app-crypto-tradebot-information>
    </div>
    <button id="closeOverlay" class="closeButton" (click)="closeTradeInformationPanel()">Close</button>
  </div>

  <div *ngIf="isMacdPopupOpen" class="popupPanel macd-popup">
    <div class="popupPanelTitle"
      title="MACD is a popular trend-following momentum indicator used in technical analysis to identify potential buy/sell signals. It consists of two lines: the MACD line (difference between 12-day and 26-day exponential moving averages) and the Signal line (9-day EMA of the MACD line). The histogram shows the difference between these two lines, indicating momentum strength.">
      MACD Visualization <span [class]="onMobile() ? 'smallFont' : ''">({{selectedIndicatorPair}})</span>
    </div>

    <div class="macd-graph-container" *ngIf="!showMacdHelp">
      <app-line-graph [type]="'MACD'" [selectedCoin]="selectedIndicatorPair.split('/')[0]" [data]="macdGraphData"
        [showHistogram]="true" [showSignalLine]="true" [showMacdLine]="true" [selectedPeriod]="'2w'">
      </app-line-graph>
    </div>

    <div class="macd-legend" *ngIf="!showMacdHelp">
      <div class="legend-item">
        <span class="legend-color macd-line"></span>
        <span>MACD Line (12,26)</span>
      </div>
      <div class="legend-item">
        <span class="legend-color signal-line"></span>
        <span>Signal Line (9)</span>
      </div>
      <div class="legend-item">
        <span class="legend-color histogram-positive"></span>
        <span>Bullish Histogram</span>
      </div>
      <div class="legend-item">
        <span class="legend-color histogram-negative"></span>
        <span>Bearish Histogram</span>
      </div>
    </div>

    <div class="macd-description gradientBackground" *ngIf="showMacdHelp">
      <div class="popupPanelTitle">MACD Interpretation</div>
      <ul class="smallFont">
        <li><strong>Bullish Signal:</strong> When MACD (blue) crosses above Signal (orange)</li>
        <li><strong>Bearish Signal:</strong> When MACD crosses below Signal</li>
        <li><strong>Histogram:</strong> Shows distance between MACD and Signal lines</li>
        <li><strong>Divergence:</strong> Price makes new highs/lows but MACD doesn't - potential reversal signal</li>
      </ul>
    </div>
    <div style="display: flex; justify-content: center; align-items: center; gap: 5px;">
      <button (click)="showMacdHelp = !showMacdHelp">Help</button>
      <button class="closeButton" id="closeOverlay" (click)="closeMacdPopup()">Close</button>
    </div>
  </div>