<div class="componentMain">
  <div class="closeButton" (click)="isTradePanelOpen ? closeTradeFullscreen() : remove_me('CryptoHubComponent');"></div>
  <div class="menuButton" (click)="showMenuPanel();"></div>
  <div class="componentTitle">Crypto Hub</div>
  <div [class]="noMining ? 'noMiningHubSection' : !isTradePanelOpen ? 'hubSection' : ''"
    [style.display]="isTradePanelOpen ? 'none' : 'block'">
    <div class="cryptoHubConverterAndCoinWatchWrapper" [style.display]="isTradePanelOpen ? 'none' : 'block'">
      <div class="marquee-container">
        <div class="marquee-scroll" (mousedown)="onMouseDown($event)" (mouseup)="onMarqueeMouseUp()"
          (mousemove)="onMouseMove($event)" (mouseleave)="onMarqueeMouseUp()" (touchstart)="onTouchStart($event)"
          (touchend)="onTouchEnd()" (touchmove)="onTouchMove($event)" #scrollContainer>
          <div class="marquee-content">
            <a *ngFor="let item of loopedData" (click)="selectCoin(item.name)" class="marquee-item">
              <div>{{ item.name }} <span *ngIf="item.symbol">({{ item.symbol }})</span></div>
              <div>{{ item.valueCAD ? formatToCanadianCurrency(getConvertedCurrencyValue(item.valueCAD)) : '-' }}</div>
            </a>
          </div>
        </div>
      </div>

      <div class="BTCtoCADConversionWrapperDiv">
        <div class="BTCtoCADConversionDiv" *ngIf="coinNames">
          <label for="convertBTCInput">
            <select #btcConvertCoinSelect (change)="coinConvertSelectChange()" [title]="selectedCoinConversionName">
              <option *ngFor="let name of coinNames" [selected]="selectedCoinConversionName == name" [value]="name">
                {{name}}
              </option>
            </select>
          </label>
          <input id="convertBTCInput" type="text" value="1" #convertBTCInput (input)="handleConversion('BTC')"
            placeholder="BTC amount" />
        </div>

        <div class="BTCtoCADConversionDiv">
          <label for="convertCurrencyInput">{{selectedCurrency}}:</label>
          <input id="convertCurrencyInput" type="text" #convertCurrencyInput (input)="handleConversion('CURRENCY')"
            [placeholder]="selectedCurrency + ' amount'" />
        </div>

        <div class="BTCtoCADConversionDiv" *ngIf="btcConvertCoinSelect?.nativeElement?.value == 'BTC'">
          <label for="convertSATInput">SAT:</label>
          <input id="convertSATInput" type="text" #convertSATInput (input)="handleConversion('SAT')"
            placeholder="Satoshi amount" />
        </div>

        <div class="BTCtoCADConversionDiv" *ngIf="fiatNames && selectedFiatConversionName">
          <label for="convertFIATInput">
            <select #btcConvertFIATSelect (change)="fiatConvertSelectChange()">
              <option *ngFor="let name of fiatNames" [selected]="selectedFiatConversionName == name" [value]="name">
                {{name}}
              </option>
            </select>
          </label>
          <input id="convertFIATInput" type="text" #convertFIATInput (input)="handleConversion('FIAT')"
            placeholder="Enter Fiat amount" />
        </div>
      </div>
    </div>
    <div class="graphContainerDiv sectionContainer" [style.display]="isTradePanelOpen ? 'none' : 'block'">
      <ng-container *ngIf="allHistoricalData && selectedCurrency">
        <app-line-graph #lineGraphComponent [type]="'Crypto'" [selectedCurrency]="selectedCurrency" [selectedCurrencyDisplay]="getCurrencySymbol(selectedCurrency)"
          [selectedPeriod]="lineGraphInitialPeriod" [data]="allHistoricalData" [data2]="tradebotTradeValuesForMainGraph"
          [chartTypeInputtedData2]="'line'" [isDotModeData2]="true" [selectedCoin]="currentSelectedCoin"
          [secondaryDataLabel]="'Tradebot Action (Red:Sell/Green:Buy)'" [displayCoinSwitcher]="false"
          (changeTimePeriodEvent)="changeTimePeriodEventOnBTCHistoricalGraph($event)">
        </app-line-graph>
      </ng-container>
      <ng-container *ngIf="volumeData">
        <app-line-graph [selectedCurrency]="'Volume'" [type]="'Volume'" [chartTypeInputted]="'bar'" [showAverage]="true"
          [displayCoinSwitcher]="false" [selectedPeriod]="'6h'" [data]="volumeData"
          (changeTimePeriodEvent)="changeTimePeriodEventOnVolumeGraph($event)">
        </app-line-graph>
      </ng-container>
    </div>
    <div class="sectionContainer volume-depth-indicator" [style.display]="isTradePanelOpen ? 'none' : 'block'"
      *ngIf="volumeData">
      <div class="sectionName">Volume Comparison</div>
      <div class="volume-bars">
        <div class="btc-bar" [style.width.%]="volumeDisplayData?.btcPercentage || 0">
          <span class="volume-value">
            {{ volumeDisplayData?.btc | number:'1.4-4' }} BTC
          </span>
        </div>
        <div class="usdc-bar" [style.width.%]="volumeDisplayData?.usdcPercentage || 0">
          <span class="volume-value">
            {{ volumeDisplayData?.usdc | number:'1.0-0' }} USDC
          </span>
        </div>
      </div>
      <div class="volume-stats">
        <div>
          <strong>BTC:</strong>
          {{ volumeDisplayData?.btc | number:'1.4-4' }} BTC ≈
          {{ volumeDisplayData?.btcInUSDC | number:'1.0-0' }} USDC
        </div>
        <div>
          <strong>USDC:</strong>
          {{ volumeDisplayData?.usdc | number:'1.0-0' }} USDC
        </div>
        <div *ngIf="volumeDisplayData?.btcPrice">
          <strong>BTC Price:</strong>
          {{ volumeDisplayData?.btcPrice | number:'1.0-0' }} USDC
        </div>
        <div *ngIf="volumeDisplayData?.ratio">
          <strong>{{ volumeDisplayData?.dominanceDescription }}:</strong>
          1 BTC volume ≈ {{ volumeDisplayData?.ratio }}x USDC volume
        </div>

        <!-- Warning displays - can show both if needed -->
        <div *ngIf="volumeDisplayData?.warnings?.usdc?.level !== 'none'"
          [class.usdc-mild-warning]="volumeDisplayData?.warnings?.usdc?.level === 'mild'"
          [class.usdc-severe-warning]="volumeDisplayData?.warnings?.usdc?.level === 'severe'">
          ⚠️ {{ volumeDisplayData?.warnings?.usdc?.description }}
        </div>

        <div *ngIf="volumeDisplayData?.warnings?.btc?.level !== 'none'"
          [class.btc-mild-warning]="volumeDisplayData?.warnings?.btc?.level === 'mild'"
          [class.btc-severe-warning]="volumeDisplayData?.warnings?.btc?.level === 'severe'">
          ⚠️ {{ volumeDisplayData?.warnings?.btc?.description }}
        </div>
      </div>
    </div>
    <div *ngIf="allHistoricalExchangeRateDataForGraph && allHistoricalExchangeRateDataForGraph.length > 0"
      class="graphContainerDiv sectionContainer" [style.display]="isTradePanelOpen ? 'none' : 'block'">

      <app-line-graph [type]="'Currency'" [selectedCoin]="selectedCurrency ?? 'CAD'" [displayCoinSwitcher]="false"
        [selectedCurrency]="selectedFiatConversionName" [showAverage]="true"
        [selectedPeriod]="exchangeRateGraphSelectedPeriod" [data]="allHistoricalExchangeRateDataForGraph!"
        #currencyExchangeLineGraph (changeTimePeriodEvent)="changeTimePeriodEventOnCurrencyExchangeGraph($event)">
      </app-line-graph>
    </div>
    <div *ngIf="!isTradePanelOpen && tradeIndicators" class="sectionContainer indicators-container">
      <div class="sectionName" style="margin-bottom: 15px;">Trade Indicators for
        <select #tradeIndicatorSelect (change)="onIndicatorPairChange()" class="pair-selector">
          <option *ngFor="let pair of availableIndicatorPairs" [value]="pair.value"
            [selected]="pair.value === selectedIndicatorPair">
            {{ pair.display }}
          </option>
        </select>
      </div>

      <div class="indicators-grid">
        <!-- 200-Day MA -->
        <div class="indicator-card">
          <span class="indicator-label"
            title="Measures long-term price trend. 'Yes' means price is above the 200-day average.">
            200-Day Moving Average
          </span>
          <span class="indicator-value" [class.positive]="tradeIndicators.twoHundredDayMA">
            {{ tradeIndicators.twoHundredDayMA ? 'Yes' : 'No' }}
            <div class="indicator-value" [class]="tradeIndicators.twoHundredDayMA ? 'positive' : 'vwap-value'">
              {{ getConvertedCurrencyValueRespectToFiat(tradeIndicators.twoHundredDayMAValue) |
              currencySymbol:(selectedCurrency):true }}
            </div>
          </span>
        </div>

        <!-- 14-Day MA -->
        <div class="indicator-card">
          <span class="indicator-label"
            title="Measures long-term price trend. 'Yes' means price is above the 14-day average.">
            14-Day Moving Average
          </span>
          <span class="indicator-value" [class.positive]="tradeIndicators.fourteenDayMA">
            {{ tradeIndicators.fourteenDayMA ? 'Yes' : 'No' }}
            <div class="indicator-value" [class]="tradeIndicators.fourteenDayMA ? 'positive' : 'vwap-value'">
              {{ getConvertedCurrencyValueRespectToFiat(tradeIndicators.fourteenDayMAValue) |
              currencySymbol:(selectedCurrency):true }}
            </div>
          </span>
        </div>

        <!-- 21-Day MA -->
        <div class="indicator-card">
          <span class="indicator-label"
            title="Measures long-term price trend. 'Yes' means price is above the 21-day average.">
            21-Day Moving Average
          </span>
          <span class="indicator-value" [class.positive]="tradeIndicators.twentyOneDayMA">
            {{ tradeIndicators.twentyOneDayMA ? 'Yes' : 'No' }}
            <div class="indicator-value" [class]="tradeIndicators.twentyOneDayMA ? 'positive' : 'vwap-value'">
              {{ getConvertedCurrencyValueRespectToFiat(tradeIndicators.twentyOneDayMAValue) |
              currencySymbol:(selectedCurrency):true }}
            </div>
          </span>
        </div>

        <!-- RSI -->
        <div class="indicator-card">
          <span class="indicator-label" title="Relative Strength Index. Over 70 = overbought, under 30 = oversold.">
            14-Day RSI
          </span>
          <span class="indicator-value"
            [class]="(tradeIndicators.rsI14Day < 30 || (tradeIndicators.rsI14Day >= 50 && tradeIndicators.rsI14Day <= 70)) ? 'positive' : 'negative'">
            {{ tradeIndicators.rsI14Day | number:'1.2-2' }}
            <div class="rsi-label">({{ getRSIStatus(tradeIndicators.rsI14Day).label || 'Unknown' }})</div>
          </span>
        </div>

        <!-- VWAP Boolean -->
        <div class="indicator-card">
          <div class="indicator-label"
            title="Volume-Weighted Average Price over the past 24 hours. 'Yes' means price is currently above VWAP.">
            Above 24-Hour VWAP
          </div>
          <div class="indicator-value" [class.positive]="tradeIndicators.vwaP24Hour">
            {{ tradeIndicators.vwaP24Hour ? 'Yes' : 'No' }}
          </div>
          <div class="indicator-value" [class]="tradeIndicators.vwaP24Hour ? 'positive' : 'vwap-value'">
            {{ getConvertedCurrencyValueRespectToFiat(tradeIndicators.vwaP24HourValue) |
            currencySymbol:(selectedCurrency):true }}
          </div>
        </div>

        <!-- Volume Above 20 Day Average -->
        <div class="indicator-card">
          <div class="indicator-label" title="Volume is currently above its 20 day average value.">
            Volume Above 20-Day Average
          </div>
          <div class="indicator-value" [class.positive]="tradeIndicators.volumeAbove20DayAverage">
            {{ tradeIndicators.volumeAbove20DayAverage ? 'Yes' : 'No' }}
          </div>
          <div class="bold smallFont" [class]="tradeIndicators.volumeAbove20DayAverage ? 'positive' : 'negative'">
            {{ getConvertedCurrencyValueRespectToFiat(tradeIndicators.volume20DayAverageValue) |
            currencySymbol:(selectedCurrency):false }}
            / {{ getConvertedCurrencyValueRespectToFiat(tradeIndicators.currentVolumeValue) |
            currencySymbol:(selectedCurrency):false }}
          </div>
        </div>

        <!-- Retracement From High Boolean -->
        <div class="indicator-card">
          <div class="indicator-label"
            title="Shows how much the price has dropped from its 1-year high. Values below 15% indicate strength, while larger drops may suggest weakness.">
            Retracement From High
          </div>
          <div class="indicator-value" [class]="tradeIndicators.retracementFromHighValue > 0 ? 'positive' : 'negative'">
            {{ tradeIndicators.retracementFromHighValue > 0 ? 'Retracement' : 'New All-Time High' }}
          </div>
          <div class="indicator-value"
            [class]="tradeIndicators.retracementFromHighValue > 0  ? 'positive' : 'negative'">
            {{ tradeIndicators.retracementFromHighValue * 100 | number:'1.2-2' }}%
            <span class="threshold-indicator" *ngIf="tradeIndicators.retracementFromHighValue > 0.15">
              (Above 15% threshold)
            </span>
          </div>
        </div>

        <!-- MACD Histogram Boolean -->
        <div class="indicator-card" (click)="openMacdPopup()">
          <div class="indicator-label"
            title="MACD Histogram > 0 indicates bullish momentum (MACD line above signal line). Values show the distance between MACD and signal lines.">
            MACD Histogram
          </div>
          <div class="indicator-value"
            [class]="(tradeIndicators.macdLineValue - tradeIndicators.macdSignalValue) > 0 ? 'positive' : 'negative'">
            {{ (tradeIndicators.macdLineValue - tradeIndicators.macdSignalValue) > 0 ? 'Bullish' : 'Bearish' }}
          </div>
          <div class="indicator-value cursorPointerUnderlined"
            [class]="(tradeIndicators.macdLineValue - tradeIndicators.macdSignalValue) > 0 ? 'positive' : 'negative'">
            {{ (tradeIndicators.macdLineValue - tradeIndicators.macdSignalValue) | number:'1.4-4' }}
          </div>
        </div>

        <!-- Sentiment Analysis Score -->
        <div [class]="'indicator-card' + (isMarketSentimentMaximized ? ' popupPanel' : '')"
          *ngIf="marketSentimentData != undefined"
          (click)="(isMarketSentimentMaximized ? '' : openMarketSentimentPopup())">
          <div class="indicator-label"
            title="How much the price has dropped from its recent high. Small values suggest strength.">
            Sentiment Analysis Score
          </div>
          <div class="indicator-value" [class]="marketSentimentData[0].sentimentScore > 50 ? 'positive' : 'negative'"
            *ngIf="!isMarketSentimentMaximized">
            {{ marketSentimentData[0].sentimentScore }}%
          </div>
          <div
            [class]="(marketSentimentData[0].sentimentScore > 50 ? 'positive' : 'negative') + ' indicator-value' + (isMarketSentimentMaximized ? '' : ' marketSentimentAnalysis')"
            *ngIf="!isMarketSentimentMaximized">
            {{ marketSentimentData[0].analysis }}
          </div>


          <div *ngIf="isMarketSentimentMaximized">
            <!-- TABLE -->
            <div class="sentiment-table-wrapper">
              <table class="sentiment-table">
                <thead>
                  <tr>
                    <th class="smallColumn">Score</th>
                    <th>Analysis</th>
                    <th class="smallColumn">Created</th>
                  </tr>
                </thead>
                <tbody>
                  <tr *ngFor="let item of sentimentPageData" (click)="toggleSentiment(item)"
                    [class.clickable]="!isLatestSentiment(item)">
                    <!-- Score -->
                    <td class="smallColumn" [class.positive]="item.sentimentScore > 50"
                      [class.negative]="item.sentimentScore <= 50">
                      {{ item.sentimentScore }}%
                    </td>

                    <!-- Analysis -->
                    <td style="width: auto;" [class.ellipsis]="!isLatestSentiment(item) && !item.expanded">
                      {{ item.analysis }}
                    </td>
                    <td class="smallColumn" [class.ellipsis]="!isLatestSentiment(item) && !item.expanded"
                      [title]="item.createdUtc">
                      {{ item.createdUtc | timeSince }}
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>


            <!-- PAGINATION -->
            <div class="pager">
              <button (click)="prevSentimentPage()" [disabled]="currentSentimentPage === 1">Prev</button>
              <span>Page {{ currentSentimentPage }} / {{ totalSentimentPages }}</span>
              <button (click)="nextSentimentPage()"
                [disabled]="currentSentimentPage === totalSentimentPages">Next</button>
            </div>

            <!-- CLOSE BUTTON -->
            <div style="text-align:right;margin-top:12px;">
              <button id="closeOverlay" (click)="closeMarketSentimentPopup()">OK</button>
            </div>
          </div>
        </div>

        <!-- Retracement From High Boolean -->
        <div class="indicator-card" *ngIf="bullishCoins.length > 0"
          title="Bullish indicator signals detected for these coins. Trade with caution!">
          <div class="bullish-warning">
            ⚠️ Bullish coin(s) detected:
          </div>
          <div *ngFor="let pair of bullishCoins">
            {{ pair.replace("XBT", "BTC") }}
          </div>
        </div>
      </div>
    </div>
    <div *ngIf="!isTradePanelOpen" class="sectionContainer">
      <app-crypto-fear-and-greed [inputtedParentRef]="parentRef"></app-crypto-fear-and-greed>
    </div>
    <div *ngIf="!isTradePanelOpen" class="sectionContainer">
      <div class="sectionName" style="margin-bottom: 15px; margin-top: 8px;">Top 30 Coin Market Caps</div>
      <app-crypto-market-caps #cryptoMarketCapsComponent [selectedCurrency]="selectedCurrency"
        [conversionRate]="latestCurrencyPriceRespectToCAD" (selectCoin)="selectCoin($event)"></app-crypto-market-caps>
    </div>
  </div>
  <div [class]="isTradePanelOpen ? 'fullScreenTradePanelDiv' : 'hubSection miningHubSection'"
    *ngIf="latestCurrencyPriceRespectToCAD && latestCurrencyPriceRespectToCAD != 0 && selectedCurrency">
    <app-mining-rigs [style.display]="isTradePanelOpen ? 'none' : 'block'" #miningRigComponent
      [isDiscreete]="isDiscreete" [inputtedParentRef]="parentRef" [conversionRate]="latestCurrencyPriceRespectToCAD"
      [currency]="selectedCurrency" (closeMiningEvent)="closeMiningEvent()"></app-mining-rigs>

    <div class="wallet sectionContainer" *ngIf="wallet" [style.display]="isTradePanelOpen ? 'none' : 'block'">
      <div class="sectionName cryptoWalletSectionHeader" *ngIf="latestCurrencyPriceRespectToCAD && wallet"
        style="margin-bottom:10px;">Crypto Wallet Balance(s):
      </div>
      <table *ngIf="latestCurrencyPriceRespectToCAD && wallet && selectedCurrency" id="walletTable" class="mainTable">
        <thead *ngIf="wallet?.length">
          <tr>
            <th (click)="areWalletAddressesHidden = !areWalletAddressesHidden"
              class="cursorPointerUnderlined normalBtcAddress">Address</th>
            <th (click)="sortTable(1, 'walletTable')">Currency</th>
            <th (click)="sortTable(2, 'walletTable')">Total Balance</th>
            <th (click)="sortTable(3, 'walletTable')" title="Fiat rate">{{ null | currencySymbol:(selectedCurrency)
              }}{{selectedCurrency}}</th>
            <th (click)="sortTable(4, 'walletTable')" title="Wallet data"></th>
          </tr>
        </thead>
        <tbody *ngFor="let subWallet of wallet">
          <ng-container>
            <tr (click)="selectCoin(subWallet.total?.currency)" class="walletTotalHeaderRow">
              <!--<tr (click)="selectCoin(wallet.total?.currency)">-->
              <td></td>
              <td>{{ subWallet.total?.currency }}</td>
              <td>{{ isDiscreete ? '***' : subWallet.total?.totalBalance }}</td>
              <td>{{ (isDiscreete ? '***' : getTotalCurrencyDisplayValue(subWallet.total)) |
                currencySymbol:selectedCurrency:true }}</td>
              <td></td>
            </tr>
          </ng-container>
          <ng-container *ngFor="let currency of subWallet?.currencies">
            <tr (click)="selectCoin(currency.currency)">
              <td (click)="areWalletAddressesHidden = !areWalletAddressesHidden"
                [class]="'cursorPointerUnderlined ' + (areWalletAddressesHidden ? 'hiddenBtcAddress' : 'normalBtcAddress')">
                {{ isDiscreete && currency.address ? currency.address.substring(0,3) + '***' +
                currency.address.substring(currency.address.length - 3, currency.address.length) : currency.address }}
              </td>
              <td>{{ currency.currency }}</td>
              <td>{{ isDiscreete ? '***' : currency.totalBalance }}</td>
              <td>{{ (isDiscreete ? '***' : getCurrencyValue(currency.currency, currency)) |
                currencySymbol:selectedCurrency:true }}</td>
              <td title="Wallet data" class="cursorPointer" (click)="showWalletData(currency)">ℹ️</td>
            </tr>
          </ng-container>
        </tbody>
      </table>
      <div style="margin-top: 10px;">
        <span class="cursorPointerUnderlined" (click)="isAddCryptoDivVisible = !isAddCryptoDivVisible">✚ Add a crypto
          wallet</span>
        <div *ngIf="isAddCryptoDivVisible">
          <input type="text" #newWalletInput (keyup.enter)="saveNewCryptoWallet()" />
          <select>
            <option>BTC</option>
          </select>
          <button (click)="saveNewCryptoWallet()">💾Save</button>
        </div>
      </div>
    </div>

    <div class="{{isTradePanelOpen ? 'maximizedTradePanel' : 'sectionContainer'}}"
      [style]="showingTradeSettings ? 'display: flex; flex-direction: column; align-items: center;' : ''">
      <div class="titleFont">
        <div style="width:100%;">
          <div>
            <span class="sectionName">
              <span class="cursorPointer warning-text"
                title="We take no responsibility in how you use this trade bot nor what you do with any of this information.">⚠️</span>
              Trade Bot
            </span>
            <button class="cursorPointer" (click)="openTradeFullscreen()" *ngIf="!isTradePanelOpen">
              Maximize View
            </button>
          </div>

          <div *ngIf="tradeBotStartedSince">
            <div *ngIf="getActiveTradeBots().length > 0">
              <div class="sectionName" *ngIf="!isTradePanelOpen">Active Trade Bots</div>

              <ng-container *ngIf="groupedBotsDisplay() as botGroups">
                <ul *ngIf="!isTradePanelOpen">
                  <li *ngFor="let group of botGroups">
                    {{ group.strategy }}:
                    <span class="thirdFontColor smallFont">
                      {{ group.currencies.join(', ') }} (Runtime: {{ group.startedSince | timeSince }})
                    </span>
                  </li>
                </ul>

                <div *ngIf="isTradePanelOpen">
                  <div *ngFor="let group of botGroups">
                    {{ group.strategy }}:
                    <span class="thirdFontColor smallFont">
                      {{ group.currencies.join(', ') }} (Runtime: {{ group.startedSince | timeSince }})
                    </span>
                  </div>
                </div>
              </ng-container>
            </div>
            <div *ngIf="getActiveTradeBots().length === 0">
              <p>No active trade bots.</p>
            </div>
          </div>
          <div>
            <!-- <div *ngIf="hasKrakenApi">Average Buy Price: <span class="thirdFontColor smallFont">{{formatToCanadianCurrency(weightedAveragePrices[0])}}</span></div>
              <div *ngIf="hasKrakenApi">Average Sell Price: <span class="thirdFontColor smallFont">{{formatToCanadianCurrency(weightedAveragePrices[1])}}</span></div> -->
            <div
              *ngIf="tradebotBalances && tradebotBalances.length > 0 && tradebotBalances[tradebotBalances.length - 1]">
              <span class="sectionName">Last:&nbsp;</span>
              <span>
                <span *ngIf="lastTradebotTrade">
                  <span [class]="onMobile() ? 'xxSmallFont' : ''" [title]="lastTradebotTrade['timestamp']">[{{
                    lastTradebotTrade['timestamp'] }}]</span>
                  <span [class]="lastTradebotTrade['buyOrSell'] === 'Sell' ? 'negative' : 'positive'">
                    {{ lastTradebotTrade['buyOrSell'] === 'Buy' ?
                    'Buy ' + lastTradebotTrade['value'] + ' ' + lastTradebotTrade['toCoin'] :
                    'Sold ' + lastTradebotTrade['value'] + ' ' + lastTradebotTrade['fromCoin'] }}
                  </span>|
                  <span [class]="lastTradebotTrade['buyOrSell'] === 'Buy' ? 'negative' : 'positive'">
                    {{ lastTradebotTrade['buyOrSell'] === 'Buy' ?
                    'Cost: ' + lastTradebotTrade['valuePrice'] + ' ' + lastTradebotTrade['fromCoin'] :
                    'Received: ' + lastTradebotTrade['valuePrice'] + ' ' + lastTradebotTrade['toCoin'] }}
                  </span>
                  <span class="smallFont thirdFontColor">
                    &#64; {{ lastTradebotTrade['tradePrice'] }} per {{ lastTradebotTrade['buyOrSell'] === 'Buy' ?
                    lastTradebotTrade['toCoin'] : lastTradebotTrade['fromCoin'] }}
                    ({{ lastTradebotTrade['strategy'] }})
                  </span>
                  <span *ngIf="lastTradePercentage !== null"
                    [title]="lastTradePercentage >= 0 ? 'Price has increased by ' + lastTradePercentage.toFixed(2) + '% since last trade.' : 'Price has decreased by ' + lastTradePercentage.toFixed(2) + '% since last trade.'"
                    class="cursorPointer xxSmallFont" [class.positive-percent]="lastTradePercentage >= 0"
                    [class.negative-percent]="lastTradePercentage < 0">
                    ({{ lastTradePercentage.toFixed(2) }}%)
                  </span>
                </span>
              </span>
            </div>
            <div *ngIf="lastLogEntry" [ngClass]="{'logScreen': !showingTradeLogs, 'bold': true}">
              <span class="sectionName">Log:&nbsp;</span> <span [ngClass]="{
                'thirdFontColor': true,
                'italics': true,
                'smallFont': true,
                'cursorPointerUnderlined': !showingTradeLogs
              }" (click)="onSmallLogClick()">{{lastLogEntry}}</span>
            </div>
            <div *ngIf="isTradePanelOpen && selectedCurrency">
              <span class="sectionName">Current Prices:&nbsp;</span>
              <span class="smallFont">
                <span *ngFor="let coin of getActiveTradebotCoins(); let last = last">
                  <span class="thirdFontColor">{{ coin }}:</span>
                  &nbsp;{{ getTradebotCoinPrice(coin) | currencySymbol:(selectedCurrency):true }}
                  <span *ngIf="!last"> | </span>
                </span>
              </span>
            </div>

            <div *ngIf="isTradePanelOpen && numberOfTrades">
              <span class="sectionName">Number of Trades:&nbsp;</span>
              <span class="smallFont thirdFontColor"> 
                  {{ numberOfTrades }}
              </span>
            </div>

          </div>
          <span class="cursorPointerUnderlined" (click)="createUpdateUserComponent();"
            *ngIf="!hasKrakenApi && parentRef?.user?.id"> Set Up Kraken API Keys </span>
          <span class="cursorPointerUnderlined" (click)="createUserComponent();"
            *ngIf="!hasKrakenApi && !parentRef?.user?.id"> Log in to use the bot.</span>
        </div>
        <div *ngIf="isTradePanelOpen" [class.trade-panel-controls]="canShowTradePanelInfo()">

          <div class="button-wrapper" *ngIf="canShowTradePanelInfo()">
            <select class="currency-select" #selectedTradebotCurrency (change)="currencySelectTradebotEngage()">
              <option value="BTC">Bitcoin/USDC</option>
              <option value="ETH">Ethereum/USDC</option>
              <option value="XRP">XRP/USDC</option>
              <option value="SOL">Solana/USDC</option>
              <option value="XDG">Dogecoin/USDC</option>
            </select>

            <select class="currency-select" #selectedTradebotStrategy (change)="currencySelectTradebotEngage()">
              <option value="DCA">DCA</option>
              <option value="IND">Indicator</option>
            </select>

            <button class="cursorPointer"
              [disabled]="isTradeBotStarted(selectedTradebotCurrency?.value, selectedTradebotStrategy.value) || !hasKrakenApi"
              (click)="startTradeBot(selectedTradebotCurrency?.value, selectedTradebotStrategy.value)"
              title="Start the tradebot.">
              Start {{selectedTradebotCurrency?.value}} {{selectedTradebotStrategy.value}}
            </button>

            <button class="cursorPointer"
              (click)="stopTradeBot(selectedTradebotCurrency?.value, selectedTradebotStrategy.value)"
              title="Stop the tradebot."
              [disabled]="!isTradeBotStarted(selectedTradebotCurrency?.value, selectedTradebotStrategy.value) || !hasKrakenApi">
              Stop {{selectedTradebotCurrency?.value}} {{selectedTradebotStrategy.value}}
            </button>

            <p class="button-description" id="trades-desc" *ngIf="!isTradebotBalanceShowing">
              {{isTradeBotStarted(selectedTradebotCurrency?.value) ? 'Stop' : 'Start'}} trading USDC and
              {{selectedTradebotCurrency?.value}} pair
              {{selectedTradebotCurrency?.value === 'BTC' ? 'with ' + selectedTradebotStrategy.value + ' strategy' :
              ''}}.
            </p>
          </div>


          <div class="button-wrapper" *ngIf="(canShowTradePanelInfo() || showingTradeSettings)">
            <button class="cursorPointer" (click)="showTradeSettings()" id="config-button"
              aria-describedby="config-desc">
              {{showingTradeSettings ? 'Hide' : 'Show'}} Configuration
            </button>
            <p class="button-description" id="config-desc" *ngIf="!showingTradeSettings">
              Opens the settings panel to configure trading parameters like trade thresholds and reserve amounts.
            </p>
          </div>
          <div class="button-wrapper" *ngIf="canShowTradePanelInfo() || isTradebotBalanceShowing">
            <button class="cursorPointer" (click)="checkBalance()" [disabled]="isLoading" id="trades-button"
              aria-describedby="trades-desc">
              {{isTradebotBalanceShowing ? 'Hide' : 'Show'}} Trades
            </button>
            <p class="button-description" id="trades-desc" *ngIf="!isTradebotBalanceShowing">
              Displays a table of recent trades, including BTC/USDC transactions, prices, and fees.
            </p>
          </div>
          <div class="button-wrapper" *ngIf="canShowTradePanelInfo() || showingTradeLogs">
            <button class="cursorPointer" (click)="showTradeLogs()" id="logs-button" aria-describedby="logs-desc">
              {{showingTradeLogs ? 'Hide' : 'Show'}} Logs
            </button>
            <p class="button-description" id="logs-desc" *ngIf="!showingTradeLogs">
              Shows detailed logs of bot actions, such as trade decisions and errors, with pagination.
            </p>
          </div>

          <div class="button-wrapper"
            [title]="isTradeBotStarted(selectedTradebotCurrency?.nativeElement?.value, selectedTradebotStrategy?.nativeElement?.value) ? 'Disabled: Tradebot is running.' : ''"
            *ngIf="canShowTradePanelInfo()">
            <button class="cursorPointer" (click)="enterPosition()"
              [title]="'Buy '+selectedTradebotCurrency?.nativeElement?.value+' On dip by splitting funds with _InitialMinimumFromAmountToStart (set in configuration).'+ hasKrakenApi ? '' : 'Disabled: No Kraken API keys found.'"
              id="enter-button" aria-describedby="enter-desc" [disabled]="!hasKrakenApi">
              Enter {{selectedTradebotCurrency?.nativeElement?.value}} Position
            </button>
            <p class="button-description" id="enter-desc">
              Buys {{selectedTradebotCurrency?.nativeElement?.value}} using configured funds, starting a new trading
              position and starting the bot. See configuration
              under: _InitialMinimumFromAmountToStart.
            </p>
          </div>

          <div class="button-wrapper" [title]="!tradeBotStatus['BTC'] ? 'Disabled: Tradebot is not running.' : ''"
            *ngIf="canShowTradePanelInfo()">
            <button class="cursorPointer" (click)="exitPosition()"
              [title]="'Sell all '+selectedTradebotCurrency?.nativeElement?.value+' at current price and exit '+selectedTradebotCurrency?.nativeElement?.value+' position. ' + hasKrakenApi ? '' : 'Disabled: No Kraken API keys found.' + tradeBotStatus['BTC'] ? '' : 'Disabled: Tradebot not started.'"
              id="exit-button" aria-describedby="exit-desc" [disabled]="!hasKrakenApi || !tradeBotStatus['BTC']">
              Exit {{selectedTradebotCurrency?.nativeElement?.value}} Position
            </button>
            <p class="button-description" id="exit-desc">
              Sells all {{selectedTradebotCurrency?.nativeElement?.value}} at market price, closing the current trading
              position and stopping the bot.
            </p>
          </div>

          <div class="button-wrapper"
            *ngIf="(isShowingTradeProfit || isShowingTradeValueGraph || isShowingTradeSimulator)">
            <button class="cursorPointer" (click)="closeTradeDivs()">
              Hide {{ isShowingTradeProfit ? 'Profit' : isShowingTradeValueGraph ? 'Graph' : isShowingTradeSimulator ?
              'Sim' : '' }}
            </button>
          </div>

          <div class="button-wrapper" *ngIf="canShowTradePanelInfo()">
            <button class="cursorPointer" (click)="showTradeInformationPanel()" id="info-button"
              aria-describedby="info-desc">
              Information
            </button>
            <p class="button-description" id="info-desc">
              Opens a panel with details about the bot’s features, logic, and best practices.
            </p>
          </div>
        </div>
        <div *ngIf="isTradebotBalanceShowing" style="display:flex; justify-content: space-between">
          <div>
            <select #tradeBalanceCoinSelector (change)="showTradeBalance(tradeBalanceCoinSelector.value)">
              <option value="XBT">BTC</option>
              <option value="ETH">ETH</option>
              <option value="XRP">XRP</option>
              <option value="SOL">SOL</option>
              <option value="XDG">XDG</option>
            </select>
            <select #tradeBalanceStrategySelector (change)="showTradeBalance(tradeBalanceCoinSelector.value)">
              <option value="DCA">DCA</option>
              <option value="IND">Indicator</option>
            </select>
          </div>

          <div class="xxSmallFont">
            Logs refresh every 30s.
          </div>
        </div>
        <div *ngIf="isTradebotBalanceShowing" class="mainTableContainer tradeDataTable">
          <table class="mainTable tradeBalanceTable">
            <thead>
              <tr>
                <th class="xxSmallFont">ID</th>
                <th class="xxSmallFont">Pair</th>
                <th class="xxSmallFont">Value (${{tradeBalanceCoinSelector?.nativeElement?.value}})/($USDC)</th>
                <th class="xxSmallFont">{{tradeBalanceCoinSelector?.nativeElement?.value}} Price</th>
                <th class="xxSmallFont">Fees</th>
                <th class="xxSmallFont">Timestamp</th>
                <th class="xxSmallFont">Matched Trade</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let trade of tradebotBalances" [id]="'tradeBalance'+trade.id"
                [class]="selectedTradeBalanceId == trade.id ? 'gradientBackground' : ''">
                <td class="xxSmallFont">
                  {{ trade.id }}
                </td>
                <td class="tradeBalanceCurrencyLabel">
                  <span class="tradeBalancePairLabelContainer">
                    <span class="xxSmallFont"
                      [style.color]="trade.from_currency == 'XBT' ? '#a17f1a' : trade.from_currency == 'USDC' ? 'blue' : ''">{{trade.from_currency}}</span>
                    /
                    <span class="xxSmallFont"
                      [style.color]="trade.to_currency == 'XBT' ? '#a17f1a' : trade.to_currency == 'USDC' ? 'blue' : ''">{{trade.to_currency}}</span>
                  </span>
                </td>
                <td class="smallFont" style="display:flex; justify-content: space-evenly; flex-wrap: wrap;">
                  <span style="margin-left:3px">
                    {{ trade.value }}
                  </span>
                  <span style="margin-right:3px" [class]="trade.to_currency == 'USDC' ? 'negative' : 'positive'">
                    {{ formatStringCanadianCurrency(trade.trade_value_usdc) }}
                  </span>
                </td>
                <td [class]="'secondaryFontColor' + (onMobile() ? ' xxSmallFont' : '')">{{
                  trade.coin_price_usdc | currencySymbol:(selectedCurrency):true }}</td>
                <td [class]="'negative' + (onMobile() ? ' xxSmallFont' : '')">{{ formatToCanadianCurrency(trade.fees) }}
                </td>
                <td [class]="'secondaryFontColor' + (onMobile() ? ' xxSmallFont' : '')"
                  [title]="parentRef?.convertUtcToLocalTime(trade.timestamp)">
                  <span *ngIf="!onMobile()">{{parentRef?.convertUtcToLocalTime(trade.timestamp)}}&nbsp;-&nbsp;</span>
                  {{ parentRef?.convertUtcToLocalTime(trade.timestamp) | timeSince }}
                </td>
                <td [class]="onMobile() ? 'xxSmallFont' : ''" [title]="trade.matching_trade_id"
                  (click)="goToTradeId('tradeBalance'+trade.matching_trade_id)">
                  {{ trade.matching_trade_id ?? (trade.is_reserved ? 'Reserved': '') }}
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
      <div
        *ngIf="showingTradeSettings && cadToSelectedCurrencyRate && btcToCadPrice && solToCadPrice && xrpToCadPrice && xdgToCadPrice && ethToCadPrice"
        [style.opacity]="isLoading ? '25%' : ''">
        <app-crypto-bot-configuration #configurationComponent [inputtedParentRef]="parentRef"
          [btcToCadPrice]="btcToCadPrice * cadToSelectedCurrencyRate" [solToCadPrice]="solToCadPrice * cadToSelectedCurrencyRate" [xrpToCadPrice]="xrpToCadPrice * cadToSelectedCurrencyRate"
          [xdgToCadPrice]="xdgToCadPrice * cadToSelectedCurrencyRate" [ethToCadPrice]="ethToCadPrice * cadToSelectedCurrencyRate"
          [selectedCurrency]="selectedCurrency" (updatedTradeConfig)="updatedTradeConfigEvent($event)" (closeEventEmitter)="closeCryptoBotConfigEmitter()"></app-crypto-bot-configuration>
      </div>
      <div *ngIf="isShowingTradeValueGraph">
        <app-line-graph [type]="'Crypto'" [graphTitle]="'Trade Value'" [data]="tradebotValuesForGraph"
          [selectedPeriod]="'5y'" [showAverage]="true" (fullscreenSelectedEvent)="fullscreenSelectedInPopup($event)">
        </app-line-graph>
      </div>


      <div *ngIf="isShowingTradeProfit && profitData?.length" class="profit-container tradeDataTable">
        <div *ngFor="let type of periodTypes" class="period-type-section">
          <div class="section-header" (click)="toggleProfitSection(type.key)">
            <div class="popupPanelTitle">{{ type.label }} <span class="toggle-icon">{{ isProfitSectionOpen(type.key) ?
                '−' :
                '+' }}</span></div>
          </div>
          <div class="profit-periods" *ngIf="isProfitSectionOpen(type.key)">
            <div *ngFor="let period of getProfitPeriodsByType(type.periodKey)" class="period-card">
              <div class="period-header">
                <span class="period-type">{{ period.periodType | titlecase }}</span>
                <span class="period-dates">
                  {{ period.periodStart | date:'MMM d, y' }} -
                  {{ (period.periodEnd | date:'MMM d, y') || 'Present' }}
                </span>
              </div>

              <div class="profit-values">
                <div class="value-row">
                  <span>Starting Balance:</span>
                  <span>{{ period.startUsdc | currency }} + {{ period.startBtc }} BTC</span>
                </div>

                <div class="value-row">
                  <span>Starting Net Worth:</span>
                  <span>{{ (period.startUsdc ?? 0) + ((period.startBtc ?? 0) * (period.startBtcPriceUsdc ?? 0)) |
                    currency }}
                    USD</span>
                </div>

                <div class="value-row">
                  <span>BTC Price:</span>
                  <span>{{ period.startBtcPriceUsdc | currency }}</span>
                </div>

                <div class="value-row">
                  <span>Ending Balance:</span>
                  <span>{{ period.endUsdc | currency }} + {{ period.endBtc }} BTC</span>
                </div>

                <div class="value-row" *ngIf="period.endBtcPriceUsdc">
                  <span>Ending BTC Price:</span>
                  <span>{{ period.endBtcPriceUsdc | currency }}</span>
                </div>

                <div class="value-row" *ngIf="period.endUsdc && period.endBtc && period.endBtcPriceUsdc">
                  <span>Ending Net Worth:</span>
                  <span>{{ period.endUsdc + (period.endBtc * period.endBtcPriceUsdc) | currency }} USD</span>
                </div>

                <div class="value-row profit-row" [class.positive]="period.profitUsdc && period.profitUsdc > 0"
                  [class.negative]="period.profitUsdc && period.profitUsdc < 0">
                  <span>Profit:</span>
                  <span>{{ period.profitUsdc | currency:'USD':'symbol':'1.2-10' }}</span>
                </div>

                <div class="value-row profit-row"
                  [class.positive]="period.absoluteProfitUsdc && period.absoluteProfitUsdc > 0"
                  [class.negative]="period.absoluteProfitUsdc && period.absoluteProfitUsdc < 0">
                  <span>Absolute Profit:</span>
                  <span>{{ period.absoluteProfitUsdc | currency }}</span>
                </div>

                <div class="value-row profit-row"
                  [class.positive]="period.cumulativeProfitUsdc && period.cumulativeProfitUsdc > 0"
                  [class.negative]="period.cumulativeProfitUsdc && period.cumulativeProfitUsdc < 0">
                  <span>Cumulative Profit:</span>
                  <span>{{ period.cumulativeProfitUsdc | currency }}</span>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>


      <div *ngIf="showingTradeLogs" [style.opacity]="isLoading ? '25%' : ''">
        <div class="secondaryFontColor" style="width:100%; display: flex; justify-content: space-between;">
          <div class="logTypeFiltersWrapper">
            <span class="xxSmallFont">Filter: </span>
            <select (change)="filterLogsFromEvent()" #tradeLogCoinFilter>
              <option value="XBT">BTC</option>
              <option value="XRP">XRP</option>
              <option value="ETH">Ethereum</option>
              <option value="SOL">Solana</option>
              <option value="XDG">Dogecoin</option>
            </select>
            <select (change)="filterLogsFromEvent()" #tradeLogStrategyFilter>
              <option value="DCA">DCA</option>
              <option value="IND">Indicator</option>
            </select>
          </div>
          <div class="xxSmallFont">
            Logs refresh every 30s.
          </div>
        </div>

        <div *ngIf="tradeLogs.length > 0; else noLogs" class="mainTableContainer tradeDataTable">
          <table class="smallFont mainTable">
            <thead>
              <tr>
                <th class="xxSmallFont">Comment</th>
                <th class="xxSmallFont">Time</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let log of paginatedLogs">
                <td>{{ log.comment }}</td>
                <td class="xxSmallFont" [title]="parentRef?.convertUtcToLocalTime(log.timestamp)">{{
                  parentRef?.convertUtcToLocalTime(log.timestamp) | timeSince }}</td>
              </tr>
            </tbody>
          </table>
        </div>
        <ng-template #noLogs>
          <p *ngIf="!isLoading">No logs found.</p>
          <p *ngIf="isLoading">Loading...</p>
        </ng-template>
      </div>
      <div style="text-align:center;" *ngIf="showingTradeLogs && tradeLogs && tradeLogs.length > 0">
        <button class="cursorPointer" (click)="prevLogPage()" [disabled]="currentLogPage === 1">Previous</button>

        <span *ngIf="totalLogPages <= 10">
          <button *ngFor="let page of getLogPagesArray()" class="cursorPointer" (click)="goToLogPage(page)"
            [disabled]="page === currentLogPage" [class.active]="page === currentLogPage">
            {{ page }}
          </button>
        </span>

        <span *ngIf="totalLogPages > 10">
          <select (change)="goToLogPageSelected($event)">
            <option *ngFor="let page of getLogPagesArray()" [value]="page" [selected]="page === currentLogPage">
              Page {{ page }}
            </option>
          </select>
        </span>

        <span> of {{ totalLogPages }}</span>
        <button class="cursorPointer" (click)="nextLogPage()" [disabled]="currentLogPage >= totalLogPages">Next</button>
      </div>
      <div *ngIf="isShowingTradeSimulator && tradebotSimulationGraphData && tradebotSimulationGraphData.length > 0"
        class="tradeDataTable">
        <app-line-graph #simLineGraph [selectedPeriod]="'1d'" [data]="tradebotSimulationGraphData"
          [data2]="tradebotSimulationGraphData2" [graphTitle]="'Simulated Price Variation'" [skipFiltering]="true"
          [selectedCoin]="'Bitcoin'" [chartTypeInputted]="'line'" [chartTypeInputtedData2]="'line'"
          [isDotModeData2]="true" [type]="'Crypto'"></app-line-graph>
        <button (click)="randomizeTradingSimGraph()">Randomize</button>
        <button (click)="randomizeTradingSimGraphWithRandomDayThisWeek()">Random Day This Week</button>
        <button (click)="randomizeTradingSimGraphWithRandomWeekData()">Random Week</button>
        <button (click)="randomizeTradingSimGraphWithRandomMonthData()">Random Month</button>
        <button (click)="downloadSimTradeDataCSV()">Download CSV</button>
        <div
          style="display: flex; justify-content: space-around; align-content: center; flex-direction: row; flex-wrap: nowrap; align-items: center;">
          <div
            style="display: flex; flex-direction: column; flex-wrap: nowrap; align-content: center; justify-content: center; align-items: center; text-align: center;">
            <div>
              <label>Initial BTC (USD)</label>
              <input [value]="tradeSimParams.initialBtc" (change)="updateSimTradeVars()" type="number" min="100"
                max="100000" required #initialBtcUsd>
            </div>
            <div>
              <label>Initial USDC</label>
              <input [value]="tradeSimParams.initialUsd" (change)="updateSimTradeVars()" type="number" min="100"
                max="100000" required #initialUsdc>
            </div>
            <div>
              <label>Trade Spread (%)</label>
              <input [value]="tradeSimParams.tradeThreshold" (change)="updateSimTradeVars()" type="number" min="0.001"
                max="0.05" step="0.001" required #tradeSpreadPct>
            </div>
            <div>
              <label>Trade Fee (%)</label>
              <input [value]="tradeSimParams.fee" (change)="updateSimTradeVars()" type="number" min="0.001" max="0.01"
                step="0.001" required #tradeFeePct>
            </div>
            <div>
              <label>Trade Amount (%)</label>
              <input [value]="tradeSimParams.tradePercentage" (change)="updateSimTradeVars()" type="number" min="0.05"
                max="0.5" step="0.05" required #tradeAmountPct>
            </div>
          </div>
          <div class="tradeBotSimDebugDivWrapper" #tradeBotSimDebugDivContainer id="tradeBotSimDebugDivContainer"
            *ngIf="tradeBotSimDebug && tradeBotSimDebug.length > 0">
            <button (click)="scrollToBottomOfTradebotSimDebug()">Scroll to bottom</button>
            <div *ngFor="let string of tradeBotSimDebug">
              <div *ngIf="string && (string.includes('[SELL]') || string.includes('[BUY]'))" style="height:25px;"></div>
              <div>{{ string }}</div>
            </div>
            <button (click)="scrollToTopOfTradebotSimDebug()">Scroll to top</button>
          </div>
        </div>
      </div>
      <div *ngIf="isTradePanelOpen" [style.marginTop]="isTradePanelOpen ? '15px' : ''"
        class="tradePanelCloseButtonSection">
        <div *ngIf="isTradePanelOpen && canShowTradePanelInfo()">
          <div class="smallFont thirdFontColor">Consider buying me a coffee!</div>
          <div class="smallFont thirdFontColor"><span class="secondaryFontColor">BTC Address:</span>
            bc1qz8xl5f3r40pzy3ypldp9q9vrhct8hz53vysrd4</div>
        </div>
        <button class="cursorPointer" (click)="openTradeFullscreen()">{{isTradePanelOpen ? 'Minimize' : 'Maximize'}}
          View</button>
      </div>

    </div>

    <div class="sectionContainer" [style.display]="isTradePanelOpen ? 'none' : 'block'">
      <div class="titleFont cursorPointer" style="display: flex; justify-content: space-between;"
        (click)="hideHostAiMessage = !hideHostAiMessage">
        <span class="warning-text"
          title="This is not actual financial advice. This is based off AI and the data presented to it from your wallet. We take no responsibility in what you do with this information.">⚠️
          HostAI: </span>
        <button class="cursorPointer" (click)="generateGeneralAiMessage(); hideHostAiMessage = !hideHostAiMessage;"
          *ngIf="!finishedGeneratingAiMessage" [disabled]="isLoading">
          <span *ngIf="!finishedGeneratingAiMessage && !isLoading">Generate Analysis</span>
          <span *ngIf="!finishedGeneratingAiMessage && isLoading">Generating...</span>
        </button>
      </div>
      <div class="aiMessage" *ngIf="finishedGeneratingAiMessage && !hideHostAiMessage">
        <span [innerHTML]="getAiMessage('1')"></span>
      </div>
    </div>

    <div *ngIf="!coinValueData && isLoading">
      Loading data, please wait...
    </div>
    <div *ngIf="!coinValueData && !isLoading">
      Something went wrong, please refresh this component after a while.
    </div>

    <div *ngIf="!isTradePanelOpen && globalCryptoStats && selectedCurrency" class="sectionContainer">
      <app-crypto-global-stats [selectedCurrency]="selectedCurrency"
        [latestCurrencyPriceRespectToFIAT]="latestCurrencyPriceRespectToFIAT"
        [metrics]="globalCryptoStats"></app-crypto-global-stats>
    </div>
    <div *ngIf="!isTradePanelOpen" class="sectionContainer">
      <app-crypto-calendar [inputtedParentRef]="parentRef"></app-crypto-calendar>
    </div>
  </div>


  <div *ngIf="isMenuPanelOpen" class="popupPanel">
    <div class="popupPanelTitle">
      Menu
    </div>
    <div class="optionsStatsWrapperDiv menuPanelOptionsDiv">
      <div *ngIf="fiatNames" class="optionsStatsDiv">
        <div class="optionsStatsHeader">
          Selected Currency :
        </div>
        <div class="optionsStatsDescription">
          <select #selectedCurrencyDropdown (change)="changeDefaultCurrency()">
            <option *ngFor="let currency of fiatNames" [selected]="selectedCurrency === currency">
              {{ currency }}
            </option>
          </select>
        </div>
      </div>
      <div class="optionsStatsDiv">
        <div class="optionsStatsHeader">
          Discreete mode :
        </div>
        <div class="optionsStatsDescription discreeteModeSelectorDiv" title="Enable/Disable discreete mode">
          <input type="checkbox" (click)="discreete()" [checked]="isDiscreete" />
          <span (click)="discreete()" class="discreeteModeSpan">{{ isDiscreete ? '🙈' : '🙉' }}</span>
        </div>
      </div>
    </div>
    <div>
      <button id="closeOverlay" (click)="closeMenuPanel()">Close</button>
    </div>
  </div>

  <div *ngIf="isWalletPanelOpen" class="popupPanel {{isWalletGraphFullscreened ? 'fullscreenPopupPanel' : ''}}">
    <div class="popupPanelTitle walletPopupTitle">
      Wallet ℹ️
      <div *ngIf="currentlySelectedCurrency">{{currentlySelectedCurrency.address}}</div>
    </div>

    <div class="optionsStatsWrapperDiv walletPopupWrapperDiv" *ngIf="currentlySelectedCurrency">
      <div class="optionsStatsDiv">
        <div class="optionsStatsHeader">Currency:</div>
        <div class="optionsStatsDescription">
          {{currentlySelectedCurrency.currency}}
        </div>
      </div>
      <div class="optionsStatsDiv">
        <div class="optionsStatsHeader">Total:</div>
        <div class="optionsStatsDescription">
          {{currentlySelectedCurrency.totalBalance}}
        </div>
      </div>
      <div class="optionsStatsDiv">
        <div class="optionsStatsHeader">Value:</div>
        <div class="optionsStatsDescription" *ngIf="currentlySelectedCurrency.currency == 'USDC'">
          {{ currentlySelectedCurrency.totalBalance | currency}}
        </div>
        <div class="optionsStatsDescription" *ngIf="currentlySelectedCurrency.currency != 'USDC'">
          {{formatToCanadianCurrency(getConvertedCurrencyValue(convertFromFIATToCryptoValue(currentlySelectedCurrency)))}}
        </div>
      </div>
    </div>

    <div
      *ngIf="allWalletBalanceData && allWalletBalanceData.length > 0 && currentlySelectedCurrency?.address != 'Nicehash Wallet'">
      <app-line-graph #walletDataLineGraphComponent [type]="'Crypto'" [selectedCurrency]="selectedCurrency"
        [selectedPeriod]="'5d'"
        [graphTitle]="!currentSelectedCoin.includes('->') ? '$Bitcoin Value' : ('$Bitcoin/' + (selectedCurrency) + ' Value')"
        [data]="allWalletBalanceData" (fullscreenSelectedEvent)="fullscreenSelectedInPopup($event)">
      </app-line-graph>
    </div>
    <div class="popupPanelTitle cursorPointer" (click)="hideHostAiMessageWallet = !hideHostAiMessageWallet">
      <span class="warning-text"
        title="This is not actual financial advice. This is based off AI and the data presented to it from your wallet. We take no responsibility in what you do with this information.">⚠️</span>
      HostAI: <button (click)="generateWalletAiMessage(); hideHostAiMessageWallet = !hideHostAiMessageWallet;"
        *ngIf="!finishedGeneratingAiWalletMessage && !getAiMessage(currentlySelectedCurrency?.address)"
        [disabled]="isLoading">Generate Analysis</button>
    </div>
    <div *ngIf="!finishedGeneratingAiWalletMessage && isLoading">Generating...</div>
    <div class="aiMessage"
      *ngIf="(finishedGeneratingAiWalletMessage && !hideHostAiMessageWallet) || getAiMessage(currentlySelectedCurrency?.address)">
      <span [innerHTML]="getAiMessage(currentlySelectedCurrency?.address)"></span>
    </div>

    <div class="walletPanelCloseDiv">
      <button id="closeOverlay" (click)="closeWalletPanel()">Close</button>
    </div>
  </div>

  <div *ngIf="isTradeInformationOpen" class="popupPanel">
    <div class="button-wrapper">
      <select #toolSelect class="data-tool-select" (change)="tradePanelToolSelectChange()">
        <option value="about">About the Tradebot</option>
        <option value="profit">Profit and Loss</option>
        <option value="graph">Trade Value Graph</option>
        <option value="sim">Tradebot Simulation</option>
      </select>
      <button class="cursorPointer" (click)="toggleSelectedDataTool(toolSelect?.value)"
        *ngIf="toolSelect.value != 'about'">
        {{ getToolVisibility(toolSelect?.value) ? 'Hide' : 'Show' }}
        {{ getToolLabel(toolSelect?.value) }}
      </button>
      <!-- Conditional content -->
      <div *ngIf="!isShowingTradeProfit && !isShowingTradeValueGraph && !isShowingTradeSimulator">
        <div *ngIf="toolSelect?.value == 'profit'" class="button-wrapper">
          <p class="button-description">
            Shows all profit and loss from the tradebot, including fees and other costs.
          </p>
        </div>

        <div *ngIf="toolSelect?.value == 'graph'" class="button-wrapper">
          <p class="button-description">
            Plots trade values over time to visualize bot performance and profitability.
          </p>
        </div>

        <div *ngIf="toolSelect?.value == 'sim'" class="button-wrapper">
          <p class="button-description">
            Runs a simulation of trading strategies with historical or random data to test performance.
          </p>
        </div>
      </div>
    </div>

    <div class="aboutTable" *ngIf="toolSelect.value == 'about'">
      <section>
        <h2>Overview</h2>
        <p>The Kraken TradeBot is an automated trading system designed to execute intelligent BTC/USDC trades on the
          Kraken exchange based on market conditions and user-defined parameters. It implements a dollar-cost averaging
          (DCA) strategy with premium trade detection during optimal market windows.</p>
      </section>

      <section>
        <h2>Key Features</h2>

        <div class="feature-box">
          <h3>1. Automated Trading Strategy</h3>
          <ul>
            <li><strong>Threshold-based trading</strong>: Executes trades when price movements exceed your configured
              threshold (default: 0.7%)</li>
            <li><strong>Spread calculation</strong>: Compares current price to last trade price to determine trade
              direction</li>
            <li><strong>Balanced portfolio</strong>: Maintains target allocations between BTC and USDC</li>
          </ul>
        </div>

        <div class="feature-box">
          <h3>2. Premium Trade Detection</h3>
          <p>The bot identifies optimal trading windows using:</p>
          <ul>
            <li><strong>Price peak analysis</strong>: Detects local maxima in BTC price</li>
            <li><strong>Volume trends</strong>: Identifies declining volume patterns after peaks</li>
            <li><strong>Timing windows</strong>: Only trades within 30-90 minutes after detected peaks</li>
            <li><strong>Premium bonuses</strong>: Increases trade sizes by 5% during premium windows</li>
          </ul>
        </div>

        <div class="feature-box">
          <h3>3. Safety Mechanisms</h3>
          <ul>
            <li><strong>Price discrepancy checks</strong>: Aborts trades if price differences exceed 10%</li>
            <li><strong>Cooldown periods</strong>: 15-minute minimum between trades</li>
            <li><strong>Reserve requirements</strong>: Maintains minimum balances (0.0004 BTC, 20 USDC)</li>
            <li><strong>Portfolio balance limits</strong>: Prevents >90% allocation to either asset</li>
          </ul>
        </div>

        <div class="feature-box">
          <h3>4. Customizable Configuration</h3>
          <p>Users can adjust:</p>
          <ul>
            <li>Trade thresholds and amounts</li>
            <li>Portfolio allocation ratios</li>
            <li>Minimum/maximum trade sizes</li>
            <li>Reserve requirements</li>
          </ul>
        </div>
      </section>

      <section>
        <h2>How It Works</h2>

        <h3>Trading Logic Flow</h3>
        <div class="flow-chart">
          <div class="flow-step"><strong>System Checks</strong> - Verifies tradebot is active, checks cooldown timer,
            validates system data is current</div>
          <div class="flow-step"><strong>Market Analysis</strong> - Gets latest BTC price and compares to last trade,
            calculates price spread percentage, checks for premium trading conditions</div>
          <div class="flow-step"><strong>Trade Execution</strong> - For positive spreads (price up): Sells BTC for USDC.
            For negative spreads (price down): Buys BTC with USDC. Adjusts trade sizes during premium windows.</div>
          <div class="flow-step"><strong>Post-Trade</strong> - Records trade in history, updates wallet balances, begins
            cooldown timer</div>
        </div>

        <h3>Premium Window Detection</h3>
        <p>The bot identifies premium trading opportunities when:</p>
        <ol>
          <li>BTC price is within 2% of a recent peak</li>
          <li>30-90 minutes have passed since the peak</li>
          <li>Trading volume shows consistent decline across time segments</li>
        </ol>
      </section>

      <section>
        <h2>User Configuration Options</h2>

        <h3>Trade Parameters</h3>
        <table class="mainTable">
          <thead>
            <tr>
              <th>Parameter</th>
              <th>Default</th>
              <th>Description</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td>Trade Threshold</td>
              <td>0.007 (0.7%)</td>
              <td>Minimum price movement to trigger trade</td>
            </tr>
            <tr>
              <td>Base Trade Percentage</td>
              <td>15%</td>
              <td>Percentage of balance to trade normally</td>
            </tr>
            <tr>
              <td>Premium Bonus</td>
              <td>5%</td>
              <td>Additional percentage during premium windows</td>
            </tr>
            <tr>
              <td>Max BTC Trade</td>
              <td>0.005 BTC</td>
              <td>Maximum BTC amount per trade</td>
            </tr>
            <tr>
              <td>Max USDC Trade</td>
              <td>$2000</td>
              <td>Maximum USDC amount per trade</td>
            </tr>
          </tbody>
        </table>

        <h3>Safety Parameters</h3>
        <table class="mainTable">
          <thead>
            <tr>
              <th>Parameter</th>
              <th>Default</th>
              <th>Description</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td>Price Discrepancy Limit</td>
              <td>10%</td>
              <td>Maximum allowed price difference</td>
            </tr>
            <tr>
              <td>Min BTC Reserve</td>
              <td>0.0004 BTC</td>
              <td>Minimum BTC balance to maintain</td>
            </tr>
            <tr>
              <td>Min USDC Reserve</td>
              <td>$20</td>
              <td>Minimum USDC balance to maintain</td>
            </tr>
            <tr>
              <td>Max Allocation Ratio</td>
              <td>90%</td>
              <td>Prevent >90% in either asset</td>
            </tr>
          </tbody>
        </table>
      </section>

      <section>
        <h2>Getting Started</h2>

        <ol>
          <li>
            <strong>API Setup</strong>
            <ul>
              <li>Provide your Kraken API keys with trading permissions</li>
              <li>Ensure proper permissions are set (query funds, create orders)</li>
            </ul>
          </li>
          <li>
            <strong>Initial Configuration</strong>
            <ul>
              <li>Set your preferred trade parameters</li>
              <li>Define safety limits appropriate for your portfolio size</li>
            </ul>
          </li>
          <li>
            <strong>First Run</strong>
            <ul>
              <li>Bot will equalize funds if starting from scratch</li>
              <li>Initial trades may be larger to establish position</li>
            </ul>
          </li>
          <li>
            <strong>Monitoring</strong>
            <ul>
              <li>Review trade history regularly</li>
              <li>Adjust parameters as needed based on performance</li>
            </ul>
          </li>
        </ol>
      </section>

      <section>
        <h2>Best Practices</h2>

        <div class="note">
          <h3>Start Small</h3>
          <ul>
            <li>Begin with smaller trade percentages to test the bot</li>
            <li>Gradually increase as you gain confidence</li>
          </ul>
        </div>

        <div class="note">
          <h3>Monitor Performance</h3>
          <ul>
            <li>Review weekly trade summaries</li>
            <li>Watch for consistent premium window detection</li>
          </ul>
        </div>

        <div class="note">
          <h3>Adjust for Volatility</h3>
          <ul>
            <li>Consider reducing trade sizes during high volatility</li>
            <li>Increase thresholds if getting too many trades</li>
          </ul>
        </div>

        <div class="note">
          <h3>Maintain Reserves</h3>
          <ul>
            <li>Ensure minimum reserves are adequate for your portfolio size</li>
            <li>Replenish funds if balances get too low</li>
          </ul>
        </div>
      </section>

      <section>
        <h2>Troubleshooting</h2>

        <div class="warning">
          <h3>Common Issues:</h3>
          <ul>
            <li><strong>API Errors</strong>: Verify key permissions and connectivity</li>
            <li><strong>No Trades</strong>: Check if price movements exceed your threshold</li>
            <li><strong>Small Balances</strong>: Ensure you have sufficient funds above minimums</li>
            <li><strong>Frequent Trades</strong>: Adjust cooldown timer or increase threshold</li>
          </ul>
          <p>For additional support, consult the trade logs which detail every decision the bot makes.</p>
        </div>
      </section>
    </div>
    <div>
      <button id="closeOverlay" (click)="closeTradeInformationPanel()">Close</button>
    </div>
  </div>

  <div *ngIf="isMacdPopupOpen" class="popupPanel macd-popup">
    <div class="popupPanelTitle"
      title="MACD is a popular trend-following momentum indicator used in technical analysis to identify potential buy/sell signals. It consists of two lines: the MACD line (difference between 12-day and 26-day exponential moving averages) and the Signal line (9-day EMA of the MACD line). The histogram shows the difference between these two lines, indicating momentum strength.">
      MACD Visualization ({{selectedIndicatorPair}})
      <button class="close-button macd-closeButton" (click)="closeMacdPopup()">×</button>
    </div>

    <div class="macd-graph-container">
      <app-line-graph [type]="'MACD'" [selectedCoin]="selectedIndicatorPair.split('/')[0]" [data]="macdGraphData"
        [showHistogram]="true" [showSignalLine]="true" [showMacdLine]="true" [selectedPeriod]="'2w'">
      </app-line-graph>
    </div>

    <div class="macd-legend">
      <div class="legend-item">
        <span class="legend-color macd-line"></span>
        <span>MACD Line (12,26)</span>
      </div>
      <div class="legend-item">
        <span class="legend-color signal-line"></span>
        <span>Signal Line (9)</span>
      </div>
      <div class="legend-item">
        <span class="legend-color histogram-positive"></span>
        <span>Bullish Histogram</span>
      </div>
      <div class="legend-item">
        <span class="legend-color histogram-negative"></span>
        <span>Bearish Histogram</span>
      </div>
    </div>

    <div class="macd-description gradientBackground">
      <div class="popupPanelTitle">MACD Interpretation</div>
      <ul class="smallFont">
        <li><strong>Bullish Signal:</strong> When MACD (blue) crosses above Signal (orange)</li>
        <li><strong>Bearish Signal:</strong> When MACD crosses below Signal</li>
        <li><strong>Histogram:</strong> Shows distance between MACD and Signal lines</li>
        <li><strong>Divergence:</strong> Price makes new highs/lows but MACD doesn't - potential reversal signal</li>
      </ul>
    </div>

    <button class="popup-close-button" id="closeOverlay" (click)="closeMacdPopup()">Close</button>
  </div>