<div class="componentMain">
  <div class="closeButton" (click)="remove_me('CoinWalletComponent');"></div>
  <div class="menuButton" (click)="showMenuPanel();"></div>
  <div class="componentTitle">Crypto Hub</div>
  <div [class]="noMining ? 'noMiningHubSection' : !isTradePanelOpen ? 'hubSection' : ''"
    [style.display]="isTradePanelOpen ? 'none' : 'block'">
    <div class="cryptoHubConverterAndCoinWatchWrapper" [style.display]="isTradePanelOpen ? 'none' : 'block'">
      <div class="marquee-container">
        <div class="marquee-scroll" (mousedown)="onMouseDown($event)" (mouseup)="onMarqueeMouseUp()"
          (mousemove)="onMouseMove($event)" (mouseleave)="onMarqueeMouseUp()" (touchstart)="onTouchStart($event)"
          (touchend)="onTouchEnd()" (touchmove)="onTouchMove($event)" #scrollContainer>
          <div class="marquee-content">
            <a *ngFor="let item of loopedData" (click)="selectCoin(item.name)" class="marquee-item">
              <div>{{ item.name }} <span *ngIf="item.symbol">({{ item.symbol }})</span></div>
              <div>{{ item.valueCAD ? formatToCanadianCurrency(getConvertedCurrencyValue(item.valueCAD)) : '-' }}</div>
            </a>
          </div>
        </div>
      </div>

      <div class="BTCtoCADConversionWrapperDiv">
        <div class="BTCtoCADConversionDiv" *ngIf="coinNames">
          <label for="convertBTCInput">
            <select #btcConvertCoinSelect (change)="coinConvertSelectChange()" [title]="selectedCoinConversionName">
              <option *ngFor="let name of coinNames" [selected]="selectedCoinConversionName == name" [value]="name">
                {{name}}</option>
            </select>
          </label>
          <input id="convertBTCInput" type="text" value="1" #convertBTCInput (input)="convertCoinInputted()"
            placeholder="BTC amount" />
        </div>

        <div class="BTCtoCADConversionDiv">
          <label for="convertCurrencyInput">{{selectedCurrency}}:</label>
          <input id="convertCurrencyInput" type="text" #convertCurrencyInput (input)="convertCurrencyInputted()"
            [placeholder]="selectedCurrency + ' amount'" />
        </div>

        <div class="BTCtoCADConversionDiv">
          <label for="convertSATInput">SAT:</label>
          <input id="convertSATInput" type="text" #convertSATInput (input)="convertSatoshiInputted()"
            placeholder="Satoshi amount" />
        </div>

        <div class="BTCtoCADConversionDiv" *ngIf="fiatNames && selectedFiatConversionName">
          <label for="convertFIATInput">
            <select #btcConvertFIATSelect (change)="fiatConvertSelectChange()">
              <option *ngFor="let name of fiatNames" [selected]="selectedFiatConversionName == name" [value]="name">
                {{name}}</option>
            </select>
          </label>
          <input id="convertFIATInput" type="text" #convertFIATInput (input)="convertFIATInputted()"
            placeholder="Enter Fiat amount" />
        </div>
      </div>
    </div>
    <div class="graphContainerDiv sectionContainer" [style.display]="isTradePanelOpen ? 'none' : 'block'">
      <ng-container *ngIf="allHistoricalData">
        <app-line-graph #lineGraphComponent [type]="'Crypto'" [selectedCurrency]="selectedCurrency"
          [selectedPeriod]="lineGraphInitialPeriod" [data]="allHistoricalData" [data2]="tradebotTradeValuesForMainGraph"
          [chartTypeInputtedData2]="'line'" [isDotModeData2]="true" [selectedCoin]="currentSelectedCoin"
          [secondaryDataLabel]="'Tradebot Action (Red:Sell/Green:Buy)'" [displayCoinSwitcher]="false"
          (changeTimePeriodEvent)="changeTimePeriodEventOnBTCHistoricalGraph($event)">
        </app-line-graph>
      </ng-container>
      <ng-container *ngIf="volumeData">
        <app-line-graph [selectedCurrency]="'Volume'" [type]="'Volume'" [chartTypeInputted]="'bar'" [showAverage]="true"
          [displayCoinSwitcher]="false" [selectedPeriod]="'6h'" [data]="volumeData"
          (changeTimePeriodEvent)="changeTimePeriodEventOnVolumeGraph($event)">
        </app-line-graph>
      </ng-container>
    </div>
    <div class="sectionContainer volume-depth-indicator" [style.display]="isTradePanelOpen ? 'none' : 'block'"
      *ngIf="volumeData">
      <div class="sectionName">Volume Comparison</div>
      <div class="volume-bars">
        <div class="btc-bar" [style.width.%]="volumeDisplayData?.btcPercentage || 0">
          <span class="volume-value">
            {{ volumeDisplayData?.btc | number:'1.4-4' }} BTC
          </span>
        </div>
        <div class="usdc-bar" [style.width.%]="volumeDisplayData?.usdcPercentage || 0">
          <span class="volume-value">
            {{ volumeDisplayData?.usdc | number:'1.0-0' }} USDC
          </span>
        </div>
      </div>
      <div class="volume-stats">
        <div>
          <strong>BTC:</strong>
          {{ volumeDisplayData?.btc | number:'1.4-4' }} BTC ≈
          {{ volumeDisplayData?.btcInUSDC | number:'1.0-0' }} USDC
        </div>
        <div>
          <strong>USDC:</strong>
          {{ volumeDisplayData?.usdc | number:'1.0-0' }} USDC
        </div>
        <div *ngIf="volumeDisplayData?.btcPrice">
          <strong>BTC Price:</strong>
          {{ volumeDisplayData?.btcPrice | number:'1.0-0' }} USDC
        </div>
        <div *ngIf="volumeDisplayData?.ratio">
          <strong>{{ volumeDisplayData?.dominanceDescription }}:</strong>
          1 BTC volume ≈ {{ volumeDisplayData?.ratio }}x USDC volume
        </div>

        <!-- Warning displays - can show both if needed -->
        <div *ngIf="volumeDisplayData?.warnings?.usdc?.level !== 'none'"
          [class.usdc-mild-warning]="volumeDisplayData?.warnings?.usdc?.level === 'mild'"
          [class.usdc-severe-warning]="volumeDisplayData?.warnings?.usdc?.level === 'severe'">
          ⚠️ {{ volumeDisplayData?.warnings?.usdc?.description }}
        </div>

        <div *ngIf="volumeDisplayData?.warnings?.btc?.level !== 'none'"
          [class.btc-mild-warning]="volumeDisplayData?.warnings?.btc?.level === 'mild'"
          [class.btc-severe-warning]="volumeDisplayData?.warnings?.btc?.level === 'severe'">
          ⚠️ {{ volumeDisplayData?.warnings?.btc?.description }}
        </div>
      </div>
    </div>
    <div *ngIf="allHistoricalExchangeRateDataForGraph && allHistoricalExchangeRateDataForGraph.length > 0"
      class="graphContainerDiv sectionContainer" [style.display]="isTradePanelOpen ? 'none' : 'block'">

      <app-line-graph [type]="'Currency'" [selectedCoin]="selectedCurrency ?? 'CAD'" [displayCoinSwitcher]="false"
        [selectedCurrency]="selectedFiatConversionName" [showAverage]="true"
        [selectedPeriod]="exchangeRateGraphSelectedPeriod" [data]="allHistoricalExchangeRateDataForGraph!"
        #currencyExchangeLineGraph (changeTimePeriodEvent)="changeTimePeriodEventOnCurrencyExchangeGraph($event)">
      </app-line-graph>
    </div>
    <div *ngIf="!isTradePanelOpen && tradeIndicators && !isLoading" class="sectionContainer indicators-container">
      <div class="sectionName" style="margin-bottom: 15px;">Trade Indicators for 
        <select #tradeIndicatorSelect (change)="onIndicatorPairChange()" class="pair-selector">
          <option *ngFor="let pair of availableIndicatorPairs" [value]="pair.value">
            {{ pair.display }}
          </option>
        </select>
      </div>
    
      <div class="indicators-grid">
        <!-- 200-Day MA -->
        <div class="indicator-card">
          <span class="indicator-label" title="Measures long-term price trend. 'Yes' means price is above the 200-day average.">
            200-Day Moving Average
          </span>
          <span class="indicator-value" [class.positive]="tradeIndicators.twoHundredDayMA">
            {{ tradeIndicators.twoHundredDayMA ? 'Yes' : 'No' }}
            <div class="indicator-value" [class]="tradeIndicators.twoHundredDayMA ? 'positive' : 'vwap-value'">
              {{ tradeIndicators.twoHundredDayMAValue | currency:'USD':'symbol':'1.2-2' }}
            </div>
          </span>
        </div>

        <!-- 14-Day MA -->
        <div class="indicator-card">
          <span class="indicator-label" title="Measures long-term price trend. 'Yes' means price is above the 14-day average.">
            14-Day Moving Average
          </span>
          <span class="indicator-value" [class.positive]="tradeIndicators.fourteenDayMA">
            {{ tradeIndicators.fourteenDayMA ? 'Yes' : 'No' }}
            <div class="indicator-value" [class]="tradeIndicators.fourteenDayMA ? 'positive' : 'vwap-value'">
              {{ tradeIndicators.fourteenDayMAValue | currency:'USD':'symbol':'1.2-2' }}
            </div>
          </span>
        </div>

        <!-- 21-Day MA -->
        <div class="indicator-card">
          <span class="indicator-label" title="Measures long-term price trend. 'Yes' means price is above the 21-day average.">
            21-Day Moving Average
          </span>
          <span class="indicator-value" [class.positive]="tradeIndicators.twentyOneDayMA">
            {{ tradeIndicators.twentyOneDayMA ? 'Yes' : 'No' }}
            <div class="indicator-value" [class]="tradeIndicators.twentyOneDayMA ? 'positive' : 'vwap-value'">
              {{ tradeIndicators.twentyOneDayMAValue | currency:'USD':'symbol':'1.2-2' }}
            </div>
          </span>
        </div>
    
        <!-- RSI -->
        <div class="indicator-card">
          <span class="indicator-label" title="Relative Strength Index. Over 70 = overbought, under 30 = oversold.">
            14-Day RSI
          </span>
          <span class="indicator-value"
            [class]="(tradeIndicators.rsI14Day < 30 || tradeIndicators.rsI14Day > 70) ? 'positive' : getRSIStatus(tradeIndicators.rsI14Day).class">
            {{ tradeIndicators.rsI14Day | number:'1.2-2' }}
            <span class="rsi-label">({{ getRSIStatus(tradeIndicators.rsI14Day).label || 'Unknown' }})</span>
          </span>
        </div>
    
        <!-- VWAP Boolean -->
        <div class="indicator-card">
          <div class="indicator-label"
            title="Volume-Weighted Average Price over the past 24 hours. 'Yes' means price is currently above VWAP.">
            Above 24-Hour VWAP
          </div>
          <div class="indicator-value" [class.positive]="tradeIndicators.vwaP24Hour">
            {{ tradeIndicators.vwaP24Hour ? 'Yes' : 'No' }}
          </div>
          <div class="indicator-value" [class]="tradeIndicators.vwaP24Hour ? 'positive' : 'vwap-value'">
            {{ tradeIndicators.vwaP24HourValue | currency:'USD':'symbol':'1.2-2' }}
          </div>
        </div>
    
        <!-- Retracement From High Boolean -->
        <div class="indicator-card">
          <div class="indicator-label"
            title="How much the price has dropped from its recent high. Small values suggest strength.">
            Retracement From High
          </div>
          <div class="indicator-value" [class.positive]="tradeIndicators.retracementFromHigh">
            {{ tradeIndicators.retracementFromHigh ? 'Yes' : 'No' }}
          </div>
          <div class="indicator-value" [class]="tradeIndicators.retracementFromHigh ? 'positive' : 'vwap-value'">
            {{ tradeIndicators.retracementFromHighValue * 100 | number:'1.2-2' }}%
          </div>
        </div>

        <!-- Retracement From High Boolean -->
        <div [class]="'indicator-card' + (isMarketSentimentMaximized ? ' popupPanel' : '')" *ngIf="marketSentimentData != undefined" (click)="(isMarketSentimentMaximized ? '' : openMarketSentimentPopup())">
          <div class="indicator-label"
            title="How much the price has dropped from its recent high. Small values suggest strength.">
            Sentiment Analysis Score
          </div>
          <div class="indicator-value" [class]="marketSentimentData[0].sentimentScore > 50 ? 'positive' : 'negative'" *ngIf="!isMarketSentimentMaximized">
            {{ marketSentimentData[0].sentimentScore }}%
          </div>
          <div [class]="'indicator-value' + (isMarketSentimentMaximized ? '' : ' marketSentimentAnalysis')" *ngIf="!isMarketSentimentMaximized">
            {{ marketSentimentData[0].analysis }}
          </div>
          

          <div *ngIf="isMarketSentimentMaximized">
          
            <!-- TABLE -->
            <table class="sentiment-table">
              <thead>
                <tr>
                  <th class="smallColumn">Score</th>
                  <th>Analysis</th>
                  <th class="smallColumn">Created</th>
                </tr>
              </thead>
              <tbody>
                <tr *ngFor="let item of sentimentPageData" (click)="toggleSentiment(item)" [class.clickable]="!isLatestSentiment(item)">
                  <!-- Score -->
                  <td class="smallColumn" [class.positive]="item.sentimentScore > 50" [class.negative]="item.sentimentScore <= 50">
                    {{ item.sentimentScore }}%
                  </td>
          
                  <!-- Analysis -->
                  <td style="width: auto;" [class.ellipsis]="!isLatestSentiment(item) && !item.expanded">
                    {{ item.analysis }}
                  </td>
                  <td class="smallColumn" [class.ellipsis]="!isLatestSentiment(item) && !item.expanded" [title]="item.createdUtc">
                    {{ item.createdUtc | timeSince }}
                  </td>
                </tr>
              </tbody>
            </table>
          
            <!-- PAGINATION -->
            <div class="pager">
              <button (click)="prevSentimentPage()" [disabled]="currentSentimentPage === 1">Prev</button>
              <span>Page {{ currentSentimentPage }} / {{ totalSentimentPages }}</span>
              <button (click)="nextSentimentPage()" [disabled]="currentSentimentPage === totalSentimentPages">Next</button>
            </div>
          
            <!-- CLOSE BUTTON -->
            <div style="text-align:right;margin-top:12px;">
              <button id="closeOverlay" (click)="closeMarketSentimentPopup()">OK</button>
            </div>
          
          </div>
          
          
        </div>
    
      </div>
    </div>
    <div *ngIf="!isTradePanelOpen" class="sectionContainer">
      <app-crypto-fear-and-greed [inputtedParentRef]="parentRef"></app-crypto-fear-and-greed>
    </div>
    <div *ngIf="!isTradePanelOpen && topMarketCaps?.length > 0; else loading" class="sectionContainer">
      <table class="mainTable">
        <thead>
          <tr>
            <th></th>
            <th>Price</th>
            <th>24h %</th>
            <th>Market Cap</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let coin of topMarketCaps" (click)="selectCoin(coin.name)">
            <td [class]="'cursorPointer' + onMobile() ? ' smallFont' : ''">
              <img [src]="coin.image" alt="{{coin.name}}" width="24" height="24" />
              <span>
                {{ coin.name }}
                <span *ngIf="coin.name.toLowerCase() != coin.symbol.toLowerCase()"
                  [class]="onMobile() ? 'xxSmallFont' : ''">
                  ({{ coin.symbol.toUpperCase() }})
                </span>
              </span>
            </td>
            <td [class]="onMobile() ? 'xxSmallFont' : ''">
              ${{ coin.current_price | number:'1.2-2' }}
            </td>
            <td [style.color]="coin.price_change_percentage_24h >= 0 ? 'green' : 'red'"
              [class]="onMobile() ? 'xxSmallFont' : ''">
              {{ coin.price_change_percentage_24h | number:'1.2-2' }}%
            </td>
            <td [class]="onMobile() ? 'xxSmallFont' : ''">
              {{ coin.market_cap | currencyShorten:onMobile() }}
            </td>
          </tr>
          <tr class="totalMarketCapTotalRow">
            <td colspan="3" [class]="onMobile() ? 'xxSmallFont' : ''"><strong>Total Market Capital:</strong></td>
            <td>{{ (globalCryptoStats?.latest?.totalMarketCap ?? totalMarketCap) | currencyShorten }}</td>
          </tr>
        </tbody>
      </table>
    </div>
    
    <ng-template #loading>
      <p *ngIf="!isTradePanelOpen">Loading coin market caps...</p>
    </ng-template>
  </div>
  <div [class]="isTradePanelOpen ? 'fullScreenTradePanelDiv' : 'hubSection miningHubSection'"
    *ngIf="latestCurrencyPriceRespectToCAD && latestCurrencyPriceRespectToCAD != 0">
    <app-mining-rigs [style.display]="isTradePanelOpen ? 'none' : 'block'" #miningRigComponent
      [isDiscreete]="isDiscreete" [inputtedParentRef]="parentRef" [conversionRate]="latestCurrencyPriceRespectToCAD"
      [currency]="selectedCurrency" (closeMiningEvent)="closeMiningEvent()"></app-mining-rigs>

    <div class="wallet sectionContainer" *ngIf="(wallet || btcWalletResponse)"
      [style.display]="isTradePanelOpen ? 'none' : 'block'">
      <div class="sectionName cryptoWalletSectionHeader"
        *ngIf="latestCurrencyPriceRespectToCAD && (wallet || btcWalletResponse)" style="margin-bottom:10px;">Crypto Wallet Balance(s):
      </div>
      <table *ngIf="latestCurrencyPriceRespectToCAD && (wallet || btcWalletResponse?.currencies)" id="walletTable"
        class="mainTable">
        <thead *ngIf="wallet?.length">
          <tr>
            <th (click)="areWalletAddressesHidden = !areWalletAddressesHidden"
              class="cursorPointerUnderlined normalBtcAddress">Address</th>
            <th (click)="sortTable(1, 'walletTable')">Currency</th>
            <th (click)="sortTable(2, 'walletTable')">Total Balance</th>
            <th (click)="sortTable(3, 'walletTable')" title="Fiat rate">${{selectedCurrency}}</th>
            <th (click)="sortTable(4, 'walletTable')" title="Wallet data"></th>
          </tr>
        </thead>
        <tbody *ngFor="let subWallet of wallet">
          <ng-container>
            <tr (click)="selectCoin(subWallet.total?.currency)" class="walletTotalHeaderRow">
              <!--<tr (click)="selectCoin(wallet.total?.currency)">-->
              <td></td>
              <td>{{ subWallet.total?.currency }}</td>
              <td>{{ isDiscreete ? '***' : subWallet.total?.totalBalance }}</td>
              <td>{{ isDiscreete ? '***' : getTotalCurrencyDisplayValue(subWallet.total) }}</td>
              <td></td>
            </tr>
          </ng-container>
          <ng-container *ngFor="let currency of subWallet?.currencies">
            <tr (click)="selectCoin(currency.currency)">
              <td (click)="areWalletAddressesHidden = !areWalletAddressesHidden"
                [class]="'cursorPointerUnderlined ' + (areWalletAddressesHidden ? 'hiddenBtcAddress' : 'normalBtcAddress')">
                {{ isDiscreete && currency.address ? currency.address.substring(0,3) + '***' +
                currency.address.substring(currency.address.length - 3, currency.address.length) : currency.address }}
              </td>
              <td>{{ currency.currency }}</td>
              <td>{{ isDiscreete ? '***' : currency.totalBalance }}</td>
              <td>{{ isDiscreete ? '***' : getCurrencyDisplayValue(currency.currency, currency) }}</td>
              <td title="Wallet data" class="cursorPointer" (click)="showWalletData(currency)">ℹ️</td>
            </tr>
          </ng-container>
        </tbody>
      </table>
      <div style="margin-top: 10px;">
        <span class="cursorPointerUnderlined" (click)="isAddCryptoDivVisible = !isAddCryptoDivVisible">✚ Add a crypto
          wallet</span>
        <div *ngIf="isAddCryptoDivVisible">
          <input type="text" #newWalletInput (keyup.enter)="saveNewCryptoWallet()" />
          <select>
            <option>BTC</option>
          </select>
          <button (click)="saveNewCryptoWallet()">💾Save</button>
        </div>
      </div>
    </div>

    <div class="{{isTradePanelOpen ? 'maximizedTradePanel' : 'sectionContainer'}}"
      [style]="showingTradeSettings ? 'display: flex; flex-direction: column; align-items: center;' : ''">
      <div class="titleFont">
        <div style="width:100%;">
          <div>
            <span>
              <span class="cursorPointer warning-text"
                title="We take no responsibility in how you use this trade bot nor what you do with any of this information.">⚠️</span>
              Trade Bot
            </span>
            <button class="cursorPointer" (click)="openTradeFullscreen()" *ngIf="!isTradePanelOpen">Maximize
              View</button>
          </div>

          <div *ngIf="tradeBotStartedSince">Running Since: <span
              class="thirdFontColor smallFont">{{tradeBotStartedSince}}</span></div>
          <div>
            <!-- <div *ngIf="hasKrakenApi">Average Buy Price: <span class="thirdFontColor smallFont">{{formatToCanadianCurrency(weightedAveragePrices[0])}}</span></div>
              <div *ngIf="hasKrakenApi">Average Sell Price: <span class="thirdFontColor smallFont">{{formatToCanadianCurrency(weightedAveragePrices[1])}}</span></div> -->
            <div
              *ngIf="tradebotBalances && tradebotBalances.length > 0 && tradebotBalances[tradebotBalances.length - 1]">
              Last:
              <span class="thirdFontColor smallFont">
                <span>
                  <span class="xxSmallFont">[{{lastTradebotTradeTimestamp}}]</span>
                  {{lastTradebotTradeBuyOrSell}}:{{lastTradebotTradeValue}}({{lastTradebotTradeValuePrice}}) &#64;
                  {{lastTradebotTradePrice}}
                </span>
                <span *ngIf="lastTradePercentage !== null"
                  [title]="lastTradePercentage >= 0 ? 'Price has increased by ' + lastTradePercentage.toFixed(2) + '% since last trade.' : 'Price has decreased by ' + lastTradePercentage.toFixed(2) + '% since last trade.'"
                  class="cursorPointer xxSmallFont" [class.positive-percent]="lastTradePercentage >= 0"
                  [class.negative-percent]="lastTradePercentage < 0">
                  ({{ lastTradePercentage.toFixed(2) }}%)
                </span>
              </span>
            </div>
            <div *ngIf="isTradePanelOpen">
              Current Price:
              <span class="thirdFontColor smallFont">
                <span>
                  {{ this.formatToCanadianCurrency(this.btcToCadPrice * (this.latestCurrencyPriceRespectToCAD)) }}
                </span>
              </span>
            </div>

          </div>
          <span class="cursorPointerUnderlined" (click)="createUpdateUserComponent();"
            *ngIf="!hasKrakenApi && parentRef?.user?.id"> Set Up Kraken API Keys </span>
          <span class="cursorPointerUnderlined" (click)="createUserComponent();"
            *ngIf="!hasKrakenApi && !parentRef?.user?.id"> Log in to use the bot.</span>
        </div>
        <div *ngIf="isTradePanelOpen" [class.trade-panel-controls]="canShowTradePanelInfo()">

          <div class="button-wrapper" *ngIf="canShowTradePanelInfo()">
            <select class="currency-select" #selectedTradebotCurrency (change)="currencySelectTradebotEngage()">
              <option value="BTC">Bitcoin/USDC</option>
              <option value="ETH">Ethereum/USDC</option>
              <option value="XRP">XRP/USDC</option>
              <option value="SOL">Solana/USDC</option>
              <option value="XDG">Dogecoin/USDC</option>
              <!-- Add more currency pairs as needed -->
            </select>
          
            <button class="cursorPointer" [disabled]="isTradeBotStarted(selectedTradebotCurrency.value) || !hasKrakenApi"
              (click)="startTradeBot(selectedTradebotCurrency.value)" title="Start the tradebot.">
              Start {{selectedTradebotCurrency.value}} DCA
            </button>
          
            <button class="cursorPointer" (click)="stopTradeBot(selectedTradebotCurrency.value)" title="Stop the tradebot."
              [disabled]="!isTradeBotStarted(selectedTradebotCurrency.value) || !hasKrakenApi">
              Stop {{selectedTradebotCurrency.value}} DCA
            </button>
          
            <p class="button-description" id="trades-desc" *ngIf="!isTradebotBalanceShowing">
              {{isTradeBotStarted(selectedTradebotCurrency.value) ? 'Stop' : 'Start'}} trading USDC and {{selectedTradebotCurrency.value}} pair
              {{selectedTradebotCurrency.value === 'BTC' ? 'with DCA strategy' : ''}}.
            </p>    
          </div>


          <div class="button-wrapper" *ngIf="hasKrakenApi && (canShowTradePanelInfo() || showingTradeSettings)">
            <button class="cursorPointer" (click)="showTradeSettings()" id="config-button"
              aria-describedby="config-desc">
              {{showingTradeSettings ? 'Hide' : 'Show'}} Configuration
            </button>
            <p class="button-description" id="config-desc" *ngIf="!showingTradeSettings">
              Opens the settings panel to configure trading parameters like trade thresholds and reserve amounts.
            </p>
          </div>
          <div class="button-wrapper" *ngIf="canShowTradePanelInfo() || isTradebotBalanceShowing">
            <button class="cursorPointer" (click)="checkBalance()" [disabled]="isLoading" id="trades-button"
              aria-describedby="trades-desc">
              {{isTradebotBalanceShowing ? 'Hide' : 'Show'}} Trades
            </button>
            <p class="button-description" id="trades-desc" *ngIf="!isTradebotBalanceShowing">
              Displays a table of recent trades, including BTC/USDC transactions, prices, and fees.
            </p>
          </div>
          <div class="button-wrapper" *ngIf="canShowTradePanelInfo() || showingTradeLogs">
            <button class="cursorPointer" (click)="showTradeLogs()" id="logs-button" aria-describedby="logs-desc">
              {{showingTradeLogs ? 'Hide' : 'Show'}} Logs
            </button>
            <p class="button-description" id="logs-desc" *ngIf="!showingTradeLogs">
              Shows detailed logs of bot actions, such as trade decisions and errors, with pagination.
            </p>
          </div>
          <div class="button-wrapper" *ngIf="canShowTradePanelInfo() || isShowingTradeValueGraph">
            <button class="cursorPointer" (click)="showTradeValueGraph()" id="graph-button"
              aria-describedby="graph-desc">
              {{isShowingTradeValueGraph ? 'Hide' : 'Show'}} Trade Value Graph
            </button>
            <p class="button-description" id="graph-desc" *ngIf="!isShowingTradeValueGraph">
              Plots trade values over time to visualize bot performance and profitability.
            </p>
          </div>
          <div class="button-wrapper" *ngIf="canShowTradePanelInfo() || isShowingTradeSimulator">
            <button class="cursorPointer" (click)="showTradeSimulationPanel()" id="sim-button"
              aria-describedby="sim-desc">
              {{isShowingTradeSimulator ? 'Hide' : 'Show'}} Tradebot Simulation
            </button>
            <p class="button-description" id="sim-desc" *ngIf="!isShowingTradeSimulator">
              Runs a simulation of trading strategies with historical or random data to test performance.
            </p>
          </div>
          <div class="button-wrapper" [title]="tradeBotStatus['BTC'] == true ? 'Disabled: Tradebot is running.' : ''"
            *ngIf="canShowTradePanelInfo()">
            <button class="cursorPointer" (click)="enterPosition()"
              [title]="'Buy BTC On dip by splitting funds with _InitialMinimumFromAmountToStart (set in configuration).'+ hasKrakenApi ? '' : 'Disabled: No Kraken API keys found.'"
              id="enter-button" aria-describedby="enter-desc" [disabled]="!hasKrakenApi">
              Enter BTC Position
            </button>
            <p class="button-description" id="enter-desc">  
              Buys BTC using configured funds, starting a new trading position and starting the bot. See configuration
              under: _InitialMinimumFromAmountToStart.
            </p>
          </div>
          <div class="button-wrapper" [title]="!tradeBotStatus['BTC'] ? 'Disabled: Tradebot is not running.' : ''"
            *ngIf="canShowTradePanelInfo()">
            <button class="cursorPointer" (click)="exitPosition()"
              [title]="'Sell all BTC at current price and exit BTC position. ' + hasKrakenApi ? '' : 'Disabled: No Kraken API keys found.' + tradeBotStatus['BTC'] ? '' : 'Disabled: Tradebot not started.'"
              id="exit-button" aria-describedby="exit-desc" [disabled]="!hasKrakenApi || !tradeBotStatus['BTC']">
              Exit BTC Position
            </button>
            <p class="button-description" id="exit-desc">
              Sells all BTC at market price, closing the current trading position and stopping the bot.
            </p>
          </div>
          <div class="button-wrapper" *ngIf="canShowTradePanelInfo() || isShowingTradeProfit">
            <button class="cursorPointer" (click)="!isShowingTradeProfit ? showProfit() : hideProfit()"
              [title]="'Show Tradebot Profit.'" id="profit-button" aria-describedby="profit-desc">
              {{isShowingTradeProfit ? 'Hide' : 'Show'}} Profit And Loss
            </button>
            <p class="button-description" id="profit-desc" *ngIf="!isShowingTradeProfit">
              Shows all profit and loss from the tradebot, including fees and other costs.
            </p>
          </div>
          <div class="button-wrapper" *ngIf="canShowTradePanelInfo()">
            <button class="cursorPointer" (click)="showTradeInformationPanel()" id="info-button"
              aria-describedby="info-desc">
              Information
            </button>
            <p class="button-description" id="info-desc">
              Opens a panel with details about the bot’s features, logic, and best practices.
            </p>
          </div>
        </div>
        <div *ngIf="isTradebotBalanceShowing">
          <select #tradeBalanceCoinSelector (change)="showTradeBalance(tradeBalanceCoinSelector.value)">
            <option value="XBT">BTC</option>
            <option value="ETH">ETH</option>
            <option value="XRP">XRP</option>
            <option value="SOL">SOL</option>
            <option value="XDG">XDG</option>
          </select>
        </div>
        <div *ngIf="isTradebotBalanceShowing" class="mainTableContainer tradeDataTable"> 
          <table class="mainTable tradeBalanceTable">
            <thead>
              <tr>
                <th class="xxSmallFont">From</th>
                <th class="xxSmallFont">To</th>
                <th class="xxSmallFont">Value ($BTC)/($USDC)</th>
                <th class="xxSmallFont">BTC Price</th>
                <th class="xxSmallFont">Fees</th>
                <th class="xxSmallFont">Timestamp</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let trade of tradebotBalances">
                <td class="xxSmallFont tradeBalanceCurrencyLabel"
                  [style.color]="trade.from_currency == 'XBT' ? '#a17f1a' : trade.from_currency == 'USDC' ? 'blue' : ''">
                  {{ trade.from_currency }}</td>
                <td class="xxSmallFont tradeBalanceCurrencyLabel"
                  [style.color]="trade.to_currency == 'XBT' ? '#a17f1a' : trade.to_currency == 'USDC' ? 'blue' : ''">{{
                  trade.to_currency }}</td>
                <td class="smallFont" style="display:flex; justify-content: space-evenly; flex-wrap: wrap;"><span
                    style="margin-left:3px">{{ trade.value }}</span><span style="margin-right:3px"
                    class="thirdFontColor">{{ formatStringCanadianCurrency(trade.trade_value_usdc) }}</span></td>
                <td class="xxSmallFont">{{ formatStringCanadianCurrency(trade.coin_price_usdc) }}</td>
                <td class="xxSmallFont">{{ formatToCanadianCurrency(trade.fees) }}</td>
                <td class="xxSmallFont" [title]="parentRef?.convertUtcToLocalTime(trade.timestamp)">{{
                  parentRef?.convertUtcToLocalTime(trade.timestamp) | timeSince }}</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
      <div *ngIf="showingTradeSettings" class="optionsStatsWrapperDiv tradeDataTable"
        [style.opacity]="isLoading ? '25%' : ''" [style.maxWidth]="'500px'">

        <div class="optionsStatsDiv">
          <div class="optionsStatsHeader" title="Select the strategy to configure">
            Strategy:
          </div>
          <div class="optionsStatsDescription">
            <select #tradeStrategySelect title="Select the strategy" (change)="tradeStrategySelectChange()">
              <option value="DCA">DCA</option>
              <option value="Indicator">Indicator</option>
            </select>
          </div>
        </div>

        <div class="optionsStatsDiv">
          <div class="optionsStatsHeader" title="Coin you're trading from">From Coin</div>
          <div class="optionsStatsDescription">
            <select #tradeFromCoinSelect title="Select the coin you want to sell"
              (change)="tradeFromCoinSelectChange()">
              <option value="XBT">BTC</option>
              <option value="ETH" *ngIf="tradeStrategySelect.value == 'DCA'">ETH</option>
              <option value="XRP" *ngIf="tradeStrategySelect.value == 'DCA'">XRP</option>
              <option value="SOL" *ngIf="tradeStrategySelect.value == 'DCA'">SOL</option>
              <option value="XDG" *ngIf="tradeStrategySelect.value == 'DCA'">XDG</option>
            </select>
          </div>
        </div>

        <div class="optionsStatsDiv">
          <div class="optionsStatsHeader" title="Coin you're trading to">To Coin</div>
          <div class="optionsStatsDescription">
            <select #tradeToCoinSelect title="Select the coin you want to receive">
              <option value="USDC">USDC</option>
            </select>
          </div>
        </div>

        <div class="optionsStatsDiv" *ngIf="tradeStrategySelect.value == 'DCA'">
          <div class="optionsStatsHeader" title="Upper limit of the amount you can trade FROM">_MaximumFromTradeAmount
          </div>
          <div class="optionsStatsDescription">
            <input type="number" #tradeMaximumFromTradeAmount title="Max amount of source coin per trade" />
          </div>
        </div>

        <div class="optionsStatsDiv" *ngIf="tradeStrategySelect.value == 'DCA'">
          <div class="optionsStatsHeader" title="Lower limit of the amount you can trade FROM">_MinimumFromTradeAmount
          </div>
          <div class="optionsStatsDescription">
            <input type="number" #tradeMinimumFromTradeAmount title="Min amount of source coin per trade." />
          </div>
        </div>

        <div class="optionsStatsDiv" *ngIf="tradeStrategySelect.value == 'DCA'">
          <div class="optionsStatsHeader" title="Upper limit of the amount you can buy in USDC.">_MaximumUSDCTradeAmount
          </div>
          <div class="optionsStatsDescription">
            <input type="number" #tradeMaximumToTradeAmount title="Max amount of USDC per trade." />
          </div>
        </div>

        <div class="optionsStatsDiv" *ngIf="tradeStrategySelect.value == 'DCA'">
          <div class="optionsStatsHeader" title="Only trade if spread exceeds this %">_TradeThreshold</div>
          <div class="optionsStatsDescription">
            <input type="number" #tradeTradeThreshold title="Minimum required spread (%) to trigger trade" />
          </div>
        </div>

        <div class="optionsStatsDiv" *ngIf="tradeStrategySelect.value == 'DCA'">
          <div class="optionsStatsHeader" title="Avoid trading too much of your total balance">_MaximumTradeBalanceRatio
          </div>
          <div class="optionsStatsDescription">
            <input type="number" #tradeMaximumTradeBalanceRatio title="Max % of balance allowed to be traded" />
          </div>
        </div>

        <div class="optionsStatsDiv" *ngIf="tradeStrategySelect.value == 'DCA'">
          <div class="optionsStatsHeader" title="Trade only a fraction of available funds">_ValueTradePercentage</div>
          <div class="optionsStatsDescription">
            <input type="number" #tradeValueTradePercentage title="Percentage of balance used in each trade" />
          </div>
        </div>

        <div class="optionsStatsDiv" *ngIf="tradeStrategySelect.value == 'DCA'">
          <div class="optionsStatsHeader" title="Sell only a fraction of available funds">_ValueSellPercentage</div>
          <div class="optionsStatsDescription">
            <input type="number" #tradeValueSellPercentage title="Percentage of balance used in each trade" />
          </div>
        </div>

        <div class="optionsStatsDiv" *ngIf="tradeStrategySelect.value == 'DCA'">
          <div class="optionsStatsHeader" title="Don't start trade unless this minimum BTC amount is available">
            _InitialMinimumFromAmountToStart</div>
          <div class="optionsStatsDescription">
            <input type="number" #tradeInitialMinimumFromAmountToStart
              title="Minimum amount of FROM coin to start trading" />
          </div>
        </div>
        <div class="optionsStatsDiv" *ngIf="tradeStrategySelect.value == 'DCA'">
          <div class="optionsStatsHeader" title="Don't start trade unless this minimum USDC amount is available">
            _InitialMinimumUSDCAmountToStart</div>
          <div class="optionsStatsDescription">
            <input type="number" #tradeInitialMinimumUSDCAmountToStart
              title="Minimum amount of USDC coin to start trading" />
          </div>
        </div>
        <div class="optionsStatsDiv" *ngIf="tradeStrategySelect.value == 'DCA'">
          <div class="optionsStatsHeader"
            title="The maximum initial USDC amount invested in a new coin to start trading. Set this to zero (0) to intially convert 50% of USDC to target coin or set this to a dollar value to convert the Mininimum between (50% of usdcBalance OR this maximum amount).">
            _InitialMaximumUSDCAmountToStart</div>
          <div class="optionsStatsDescription">
            <input type="number" #tradeInitialMaximumUSDCAmountToStart
              title="Maximum amount of USDC to spend to start trading. This is the math set for initial trade value: _InitialMaximumUSDCAmountToStart > 0 ? Math.Min(usdcBalance * 50%, _InitialMaximumUSDCAmountToStart) : (usdcBalance * 50%)" />
          </div>
        </div>
        <div class="optionsStatsDiv" *ngIf="tradeStrategySelect.value == 'DCA'">
          <div class="optionsStatsHeader" title="Always keep at least this much of the FROM coin">_MinimumFromReserves
          </div>
          <div class="optionsStatsDescription">
            <input type="number" #tradeMinimumFromReserves title="Minimum reserve of source coin to keep" />
          </div>
        </div>

        <div class="optionsStatsDiv" *ngIf="tradeStrategySelect.value == 'DCA'">
          <div class="optionsStatsHeader" title="Always keep at least this much of the TO coin">_MinimumToReserves</div>
          <div class="optionsStatsDescription">
            <input type="number" #tradeMinimumToReserves title="Minimum reserve of target coin to keep" />
          </div>
        </div>

        <div class="optionsStatsDiv" *ngIf="tradeStrategySelect.value == 'DCA'">
          <div class="optionsStatsHeader"
            title="The maximum times a trade type (buy/sell) can happen. Applies both per day, and per consecutive trade. *note: This number will be diminished during above average volume period to create openings to buy high or sell low.">
            _MaximumTradeTypeOccurance
          </div>
          <div class="optionsStatsDescription">
            <input type="number" #tradeTradeMaximumTypeOccurances title="Maximum occurance of either buy or sell." />
          </div>
        </div>

        <div class="optionsStatsDiv" *ngIf="tradeStrategySelect.value == 'DCA'">
          <div class="optionsStatsHeader" title="Maximum trade occurances during a volume spike.">
            _VolumeSpikeMaxTradeOccurance
          </div>
          <div class="optionsStatsDescription">
            <input type="number" #tradeVolumeSpikeMaxTradeOccurance
              title="Maximum trade occurances during volume spike." />
          </div>
        </div>

        <div class="optionsStatsDiv">
          <div class="optionsStatsHeader"
            title="Input a price point to liquidate your BTC (trade 100% BTC to USDC) at your defined price. Put the value in USDC.">
            _StopLossExitPosition
          </div>
          <div class="optionsStatsDescription">
            <input type="number" #tradeStopLoss title="Minimum USDC value per {{tradeFromCoinSelect.value}} before liquidating {{tradeFromCoinSelect.value}} reserves." />
          </div>
        </div>



        <div class="optionsStatsDiv">
          <div class="optionsStatsHeader" title="Last time this configuration was updated">Updated</div>
          <div class="optionsStatsDescription">
            <span *ngIf="tradeConfigLastUpdated" title="Time of last save">{{tradeConfigLastUpdated}}</span>
            <span *ngIf="!tradeConfigLastUpdated" title="No configuration has been saved yet">Never</span>
          </div>
        </div>

        <div class="optionsStatsDiv">
          <div class="optionsStatsHeader" title="Save current trade parameters">Save Configuration</div>
          <button (click)="updateCoinConfiguration()" [disabled]="isLoading"
            title="Click to save current configuration">💾Save</button>
        </div>
      </div>
      <div *ngIf="isShowingTradeValueGraph">
        <app-line-graph [type]="'Crypto'" [graphTitle]="'Trade Value'" [data]="tradebotValuesForGraph"
          [selectedPeriod]="'5y'" [showAverage]="true" (fullscreenSelectedEvent)="fullscreenSelectedInPopup($event)">
        </app-line-graph>
      </div>


      <div *ngIf="isShowingTradeProfit && profitData?.length" class="profit-container tradeDataTable">
        <div *ngFor="let type of periodTypes" class="period-type-section">
          <div class="section-header" (click)="toggleProfitSection(type.key)">
            <div class="popupPanelTitle">{{ type.label }} <span class="toggle-icon">{{ isProfitSectionOpen(type.key) ?
                '−' :
                '+' }}</span></div>
          </div>
          <div class="profit-periods" *ngIf="isProfitSectionOpen(type.key)">
            <div *ngFor="let period of getProfitPeriodsByType(type.periodKey)" class="period-card">
              <div class="period-header">
                <span class="period-type">{{ period.periodType | titlecase }}</span>
                <span class="period-dates">
                  {{ period.periodStart | date:'MMM d, y' }} -
                  {{ (period.periodEnd | date:'MMM d, y') || 'Present' }}
                </span>
              </div>

              <div class="profit-values">
                <div class="value-row">
                  <span>Starting Balance:</span>
                  <span>{{ period.startUsdc | currency }} + {{ period.startBtc }} BTC</span>
                </div>

                <div class="value-row">
                  <span>Starting Net Worth:</span>
                  <span>{{ (period.startUsdc ?? 0) + ((period.startBtc ?? 0) * (period.startBtcPriceUsdc ?? 0)) |
                    currency }}
                    USD</span>
                </div>

                <div class="value-row">
                  <span>BTC Price:</span>
                  <span>{{ period.startBtcPriceUsdc | currency }}</span>
                </div>

                <div class="value-row">
                  <span>Ending Balance:</span>
                  <span>{{ period.endUsdc | currency }} + {{ period.endBtc }} BTC</span>
                </div>

                <div class="value-row" *ngIf="period.endBtcPriceUsdc">
                  <span>Ending BTC Price:</span>
                  <span>{{ period.endBtcPriceUsdc | currency }}</span>
                </div>

                <div class="value-row" *ngIf="period.endUsdc && period.endBtc && period.endBtcPriceUsdc">
                  <span>Ending Net Worth:</span>
                  <span>{{ period.endUsdc + (period.endBtc * period.endBtcPriceUsdc) | currency }} USD</span>
                </div>

                <div class="value-row profit-row" [class.positive]="period.profitUsdc && period.profitUsdc > 0"
                  [class.negative]="period.profitUsdc && period.profitUsdc < 0">
                  <span>Profit:</span>
                  <span>{{ period.profitUsdc | currency:'USD':'symbol':'1.2-10' }}</span>
                </div>

                <div class="value-row profit-row"
                  [class.positive]="period.absoluteProfitUsdc && period.absoluteProfitUsdc > 0"
                  [class.negative]="period.absoluteProfitUsdc && period.absoluteProfitUsdc < 0">
                  <span>Absolute Profit:</span>
                  <span>{{ period.absoluteProfitUsdc | currency }}</span>
                </div>

                <div class="value-row profit-row"
                  [class.positive]="period.cumulativeProfitUsdc && period.cumulativeProfitUsdc > 0"
                  [class.negative]="period.cumulativeProfitUsdc && period.cumulativeProfitUsdc < 0">
                  <span>Cumulative Profit:</span>
                  <span>{{ period.cumulativeProfitUsdc | currency }}</span>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
 

      <div *ngIf="showingTradeLogs" [style.opacity]="isLoading ? '25%' : ''">
        <div class="secondaryFontColor" style="width:100%; display: flex; justify-content: space-between;">
          <div class="logTypeFiltersWrapper">
            <span class="xxSmallFont">Filter: </span>
            <select (change)="filterLogsFromEvent($event)">
              <option value="">None</option>
              <option value="XBT">BTC</option>
              <option value="XRP">XRP</option>
              <option value="SOL">Solana</option>
              <option value="XDG">Dogecoin</option>   
            </select>    
          </div>
          <div class="xxSmallFont">
            Logs refresh every 30s.
          </div>
        </div>

        <div *ngIf="tradeLogs.length > 0; else noLogs" class="mainTableContainer tradeDataTable">
          <table class="smallFont mainTable">
            <thead>
              <tr>
                <th class="xxSmallFont">Comment</th>
                <th class="xxSmallFont">Time</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let log of paginatedLogs">
                <td>{{ log.comment }}</td>
                <td class="xxSmallFont" [title]="parentRef?.convertUtcToLocalTime(log.timestamp)">{{ parentRef?.convertUtcToLocalTime(log.timestamp) | timeSince }}</td>
              </tr>
            </tbody>
          </table>
        </div>
        <ng-template #noLogs>
          <p *ngIf="!isLoading">No logs found.</p>
          <p *ngIf="isLoading">Loading...</p>
        </ng-template>
      </div>
      <div style="text-align:center;" *ngIf="showingTradeLogs && tradeLogs && tradeLogs.length > 0">
        <button class="cursorPointer" (click)="prevLogPage()" [disabled]="currentLogPage === 1">Previous</button>
      
        <span *ngIf="totalLogPages <= 10">
          <button *ngFor="let page of getLogPagesArray()" class="cursorPointer" (click)="goToLogPage(page)"
            [disabled]="page === currentLogPage" [class.active]="page === currentLogPage">
            {{ page }}
          </button>
        </span>
      
        <span *ngIf="totalLogPages > 10">
          <select (change)="goToLogPageSelected($event)">
            <option *ngFor="let page of getLogPagesArray()" [value]="page" [selected]="page === currentLogPage">
              Page {{ page }}
            </option>
          </select>
        </span>
      
        <span> of {{ totalLogPages }}</span>
        <button class="cursorPointer" (click)="nextLogPage()" [disabled]="currentLogPage >= totalLogPages">Next</button></div>
      <div *ngIf="isShowingTradeSimulator && tradebotSimulationGraphData && tradebotSimulationGraphData.length > 0"
        class="tradeDataTable">
        <app-line-graph #simLineGraph [selectedPeriod]="'1d'" [data]="tradebotSimulationGraphData"
          [data2]="tradebotSimulationGraphData2" [graphTitle]="'Simulated Price Variation'" [skipFiltering]="true"
          [selectedCoin]="'Bitcoin'" [chartTypeInputted]="'line'" [chartTypeInputtedData2]="'line'"
          [isDotModeData2]="true" [type]="'Crypto'"></app-line-graph>
        <button (click)="randomizeTradingSimGraph()">Randomize</button>
        <button (click)="randomizeTradingSimGraphWithRandomDayThisWeek()">Random Day This Week</button>
        <button (click)="randomizeTradingSimGraphWithRandomWeekData()">Random Week</button>
        <button (click)="randomizeTradingSimGraphWithRandomMonthData()">Random Month</button>
        <button (click)="downloadSimTradeDataCSV()">Download CSV</button>
        <div
          style="display: flex; justify-content: space-around; align-content: center; flex-direction: row; flex-wrap: nowrap; align-items: center;">
          <div
            style="display: flex; flex-direction: column; flex-wrap: nowrap; align-content: center; justify-content: center; align-items: center; text-align: center;">
            <div>
              <label>Initial BTC (USD)</label>
              <input [value]="tradeSimParams.initialBtc" (change)="updateSimTradeVars()" type="number" min="100"
                max="100000" required #initialBtcUsd>
            </div>
            <div>
              <label>Initial USDC</label>
              <input [value]="tradeSimParams.initialUsd" (change)="updateSimTradeVars()" type="number" min="100"
                max="100000" required #initialUsdc>
            </div>
            <div>
              <label>Trade Spread (%)</label>
              <input [value]="tradeSimParams.tradeThreshold" (change)="updateSimTradeVars()" type="number" min="0.001"
                max="0.05" step="0.001" required #tradeSpreadPct>
            </div>
            <div>
              <label>Trade Fee (%)</label>
              <input [value]="tradeSimParams.fee" (change)="updateSimTradeVars()" type="number" min="0.001" max="0.01"
                step="0.001" required #tradeFeePct>
            </div>
            <div>
              <label>Trade Amount (%)</label>
              <input [value]="tradeSimParams.tradePercentage" (change)="updateSimTradeVars()" type="number" min="0.05"
                max="0.5" step="0.05" required #tradeAmountPct>
            </div>
          </div>
          <div class="tradeBotSimDebugDivWrapper" #tradeBotSimDebugDivContainer id="tradeBotSimDebugDivContainer"
            *ngIf="tradeBotSimDebug && tradeBotSimDebug.length > 0">
            <button (click)="scrollToBottomOfTradebotSimDebug()">Scroll to bottom</button>
            <div *ngFor="let string of tradeBotSimDebug">
              <div *ngIf="string && (string.includes('[SELL]') || string.includes('[BUY]'))" style="height:25px;"></div>
              <div>{{ string }}</div>
            </div>
            <button (click)="scrollToTopOfTradebotSimDebug()">Scroll to top</button>
          </div>
        </div>
      </div>
      <div *ngIf="isTradePanelOpen" [style.marginTop]="isTradePanelOpen ? '15px' : ''"
        style="display: flex; justify-content: space-between; width: 100%;">
        <div *ngIf="isTradePanelOpen && canShowTradePanelInfo()">
          <div class="smallFont thirdFontColor">Consider buying me a coffee!</div>
          <div class="smallFont thirdFontColor"><span class="secondaryFontColor">BTC Address:</span>
            bc1qz8xl5f3r40pzy3ypldp9q9vrhct8hz53vysrd4</div>
        </div>
        <button class="cursorPointer" (click)="openTradeFullscreen()">{{isTradePanelOpen ? 'Minimize' : 'Maximize'}}
          View</button>
      </div>

    </div>

    <div class="sectionContainer" [style.display]="isTradePanelOpen ? 'none' : 'block'">
      <div class="titleFont cursorPointer" style="display: flex; justify-content: space-between;"
        (click)="hideHostAiMessage = !hideHostAiMessage">
        <span class="warning-text"
          title="This is not actual financial advice. This is based off AI and the data presented to it from your wallet. We take no responsibility in what you do with this information.">⚠️
          HostAI: </span>
        <button class="cursorPointer" (click)="generateGeneralAiMessage(); hideHostAiMessage = !hideHostAiMessage;"
          *ngIf="!finishedGeneratingAiMessage" [disabled]="isLoading">
          <span *ngIf="!finishedGeneratingAiMessage && !isLoading">Generate Analysis</span>
          <span *ngIf="!finishedGeneratingAiMessage && isLoading">Generating...</span>
        </button>
      </div>
      <div class="aiMessage" *ngIf="finishedGeneratingAiMessage && !hideHostAiMessage">
        <span [innerHTML]="getAiMessage('1')"></span>
      </div>
    </div>

    <div *ngIf="!coinValueData && isLoading">
      Loading data, please wait...
    </div>
    <div *ngIf="!coinValueData && !isLoading">
      Something went wrong, please refresh this component after a while.
    </div>

    <div *ngIf="!isTradePanelOpen && globalCryptoStats" class="sectionContainer">
      <app-crypto-global-stats [metrics]="globalCryptoStats"></app-crypto-global-stats> 
    </div> 
    <div *ngIf="!isTradePanelOpen" class="sectionContainer">
      <app-crypto-calendar [inputtedParentRef]="parentRef"></app-crypto-calendar>
    </div> 
  </div>


  <div *ngIf="isMenuPanelOpen" class="popupPanel">
    <div class="popupPanelTitle">
      Menu
    </div>
    <div class="optionsStatsWrapperDiv menuPanelOptionsDiv">
      <div *ngIf="fiatNames" class="optionsStatsDiv">
        <div class="optionsStatsHeader">
          Selected Currency :
        </div>
        <div class="optionsStatsDescription">
          <select #selectedCurrencyDropdown (change)="changeDefaultCurrency()">
            <option *ngFor="let currency of fiatNames" [selected]="selectedCurrency === currency">
              {{ currency }}
            </option>
          </select>
        </div>
      </div>
      <div class="optionsStatsDiv">
        <div class="optionsStatsHeader">
          Discreete mode :
        </div>
        <div class="optionsStatsDescription discreeteModeSelectorDiv" title="Enable/Disable discreete mode">
          <input type="checkbox" (click)="discreete()" [checked]="isDiscreete" />
          <span (click)="discreete()" class="discreeteModeSpan">{{ isDiscreete ? '🙈' : '🙉' }}</span>
        </div>
      </div>
    </div>
    <div>
      <button id="closeOverlay" (click)="closeMenuPanel()">Close</button>
    </div>
  </div>

  <div *ngIf="isWalletPanelOpen" class="popupPanel {{isWalletGraphFullscreened ? 'fullscreenPopupPanel' : ''}}">
    <div class="popupPanelTitle walletPopupTitle">
      Wallet ℹ️
      <div *ngIf="currentlySelectedCurrency">{{currentlySelectedCurrency.address}}</div>
    </div>

    <div class="optionsStatsWrapperDiv walletPopupWrapperDiv" *ngIf="currentlySelectedCurrency">
      <div class="optionsStatsDiv">
        <div class="optionsStatsHeader">Currency:</div>
        <div class="optionsStatsDescription">
          {{currentlySelectedCurrency.currency}}
        </div>
      </div>
      <div class="optionsStatsDiv">
        <div class="optionsStatsHeader">Total:</div>
        <div class="optionsStatsDescription">
          {{currentlySelectedCurrency.totalBalance}}
        </div>
      </div>
      <div class="optionsStatsDiv">
        <div class="optionsStatsHeader">Value:</div>
        <div class="optionsStatsDescription" *ngIf="currentlySelectedCurrency.currency == 'USDC'">
          {{ currentlySelectedCurrency.totalBalance | currency}}
        </div>
        <div class="optionsStatsDescription" *ngIf="currentlySelectedCurrency.currency != 'USDC'">
          {{formatToCanadianCurrency(getConvertedCurrencyValue(convertFromFIATToCryptoValue(currentlySelectedCurrency)))}}
        </div>
      </div>
    </div>

    <div
      *ngIf="allWalletBalanceData && allWalletBalanceData.length > 0 && currentlySelectedCurrency?.address != 'Nicehash Wallet'">
      <app-line-graph #walletDataLineGraphComponent [type]="'Crypto'" [selectedCurrency]="selectedCurrency"
        [selectedPeriod]="'5d'"
        [graphTitle]="!currentSelectedCoin.includes('->') ? '$Bitcoin Value' : ('$Bitcoin/' + (selectedCurrency) + ' Value')"
        [data]="allWalletBalanceData" (fullscreenSelectedEvent)="fullscreenSelectedInPopup($event)">
      </app-line-graph>
    </div>
    <div class="popupPanelTitle cursorPointer" (click)="hideHostAiMessageWallet = !hideHostAiMessageWallet">
      <span class="warning-text"
        title="This is not actual financial advice. This is based off AI and the data presented to it from your wallet. We take no responsibility in what you do with this information.">⚠️</span>
      HostAI: <button (click)="generateWalletAiMessage(); hideHostAiMessageWallet = !hideHostAiMessageWallet;"
        *ngIf="!finishedGeneratingAiWalletMessage && !getAiMessage(currentlySelectedCurrency?.address)"
        [disabled]="isLoading">Generate Analysis</button>
    </div>
    <div *ngIf="!finishedGeneratingAiWalletMessage && isLoading">Generating...</div>
    <div class="aiMessage"
      *ngIf="(finishedGeneratingAiWalletMessage && !hideHostAiMessageWallet) || getAiMessage(currentlySelectedCurrency?.address)">
      <span [innerHTML]="getAiMessage(currentlySelectedCurrency?.address)"></span>
    </div>

    <div class="walletPanelCloseDiv">
      <button id="closeOverlay" (click)="closeWalletPanel()">Close</button>
    </div>
  </div>

  <div *ngIf="isTradeInformationOpen" class="popupPanel">
    <div class="popupPanelTitle">
      <h1>About the Tradebot</h1>
    </div>
    <div class="tradeDataTable">
      <section>
        <h2>Overview</h2>
        <p>The Kraken TradeBot is an automated trading system designed to execute intelligent BTC/USDC trades on the
          Kraken exchange based on market conditions and user-defined parameters. It implements a dollar-cost averaging
          (DCA) strategy with premium trade detection during optimal market windows.</p>
      </section>

      <section>
        <h2>Key Features</h2>

        <div class="feature-box">
          <h3>1. Automated Trading Strategy</h3>
          <ul>
            <li><strong>Threshold-based trading</strong>: Executes trades when price movements exceed your configured
              threshold (default: 0.7%)</li>
            <li><strong>Spread calculation</strong>: Compares current price to last trade price to determine trade
              direction</li>
            <li><strong>Balanced portfolio</strong>: Maintains target allocations between BTC and USDC</li>
          </ul>
        </div>

        <div class="feature-box">
          <h3>2. Premium Trade Detection</h3>
          <p>The bot identifies optimal trading windows using:</p>
          <ul>
            <li><strong>Price peak analysis</strong>: Detects local maxima in BTC price</li>
            <li><strong>Volume trends</strong>: Identifies declining volume patterns after peaks</li>
            <li><strong>Timing windows</strong>: Only trades within 30-90 minutes after detected peaks</li>
            <li><strong>Premium bonuses</strong>: Increases trade sizes by 5% during premium windows</li>
          </ul>
        </div>

        <div class="feature-box">
          <h3>3. Safety Mechanisms</h3>
          <ul>
            <li><strong>Price discrepancy checks</strong>: Aborts trades if price differences exceed 10%</li>
            <li><strong>Cooldown periods</strong>: 15-minute minimum between trades</li>
            <li><strong>Reserve requirements</strong>: Maintains minimum balances (0.0004 BTC, 20 USDC)</li>
            <li><strong>Portfolio balance limits</strong>: Prevents >90% allocation to either asset</li>
          </ul>
        </div>

        <div class="feature-box">
          <h3>4. Customizable Configuration</h3>
          <p>Users can adjust:</p>
          <ul>
            <li>Trade thresholds and amounts</li>
            <li>Portfolio allocation ratios</li>
            <li>Minimum/maximum trade sizes</li>
            <li>Reserve requirements</li>
          </ul>
        </div>
      </section>

      <section>
        <h2>How It Works</h2>

        <h3>Trading Logic Flow</h3>
        <div class="flow-chart">
          <div class="flow-step"><strong>System Checks</strong> - Verifies tradebot is active, checks cooldown timer,
            validates system data is current</div>
          <div class="flow-step"><strong>Market Analysis</strong> - Gets latest BTC price and compares to last trade,
            calculates price spread percentage, checks for premium trading conditions</div>
          <div class="flow-step"><strong>Trade Execution</strong> - For positive spreads (price up): Sells BTC for USDC.
            For negative spreads (price down): Buys BTC with USDC. Adjusts trade sizes during premium windows.</div>
          <div class="flow-step"><strong>Post-Trade</strong> - Records trade in history, updates wallet balances, begins
            cooldown timer</div>
        </div>

        <h3>Premium Window Detection</h3>
        <p>The bot identifies premium trading opportunities when:</p>
        <ol>
          <li>BTC price is within 2% of a recent peak</li>
          <li>30-90 minutes have passed since the peak</li>
          <li>Trading volume shows consistent decline across time segments</li>
        </ol>
      </section>

      <section>
        <h2>User Configuration Options</h2>

        <h3>Trade Parameters</h3>
        <table class="mainTable">
          <thead>
            <tr>
              <th>Parameter</th>
              <th>Default</th>
              <th>Description</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td>Trade Threshold</td>
              <td>0.007 (0.7%)</td>
              <td>Minimum price movement to trigger trade</td>
            </tr>
            <tr>
              <td>Base Trade Percentage</td>
              <td>15%</td>
              <td>Percentage of balance to trade normally</td>
            </tr>
            <tr>
              <td>Premium Bonus</td>
              <td>5%</td>
              <td>Additional percentage during premium windows</td>
            </tr>
            <tr>
              <td>Max BTC Trade</td>
              <td>0.005 BTC</td>
              <td>Maximum BTC amount per trade</td>
            </tr>
            <tr>
              <td>Max USDC Trade</td>
              <td>$2000</td>
              <td>Maximum USDC amount per trade</td>
            </tr>
          </tbody>
        </table>

        <h3>Safety Parameters</h3>
        <table class="mainTable">
          <thead>
            <tr>
              <th>Parameter</th>
              <th>Default</th>
              <th>Description</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td>Price Discrepancy Limit</td>
              <td>10%</td>
              <td>Maximum allowed price difference</td>
            </tr>
            <tr>
              <td>Min BTC Reserve</td>
              <td>0.0004 BTC</td>
              <td>Minimum BTC balance to maintain</td>
            </tr>
            <tr>
              <td>Min USDC Reserve</td>
              <td>$20</td>
              <td>Minimum USDC balance to maintain</td>
            </tr>
            <tr>
              <td>Max Allocation Ratio</td>
              <td>90%</td>
              <td>Prevent >90% in either asset</td>
            </tr>
          </tbody>
        </table>
      </section>

      <section>
        <h2>Getting Started</h2>

        <ol>
          <li>
            <strong>API Setup</strong>
            <ul>
              <li>Provide your Kraken API keys with trading permissions</li>
              <li>Ensure proper permissions are set (query funds, create orders)</li>
            </ul>
          </li>
          <li>
            <strong>Initial Configuration</strong>
            <ul>
              <li>Set your preferred trade parameters</li>
              <li>Define safety limits appropriate for your portfolio size</li>
            </ul>
          </li>
          <li>
            <strong>First Run</strong>
            <ul>
              <li>Bot will equalize funds if starting from scratch</li>
              <li>Initial trades may be larger to establish position</li>
            </ul>
          </li>
          <li>
            <strong>Monitoring</strong>
            <ul>
              <li>Review trade history regularly</li>
              <li>Adjust parameters as needed based on performance</li>
            </ul>
          </li>
        </ol>
      </section>

      <section>
        <h2>Best Practices</h2>

        <div class="note">
          <h3>Start Small</h3>
          <ul>
            <li>Begin with smaller trade percentages to test the bot</li>
            <li>Gradually increase as you gain confidence</li>
          </ul>
        </div>

        <div class="note">
          <h3>Monitor Performance</h3>
          <ul>
            <li>Review weekly trade summaries</li>
            <li>Watch for consistent premium window detection</li>
          </ul>
        </div>

        <div class="note">
          <h3>Adjust for Volatility</h3>
          <ul>
            <li>Consider reducing trade sizes during high volatility</li>
            <li>Increase thresholds if getting too many trades</li>
          </ul>
        </div>

        <div class="note">
          <h3>Maintain Reserves</h3>
          <ul>
            <li>Ensure minimum reserves are adequate for your portfolio size</li>
            <li>Replenish funds if balances get too low</li>
          </ul>
        </div>
      </section>

      <section>
        <h2>Troubleshooting</h2>

        <div class="warning">
          <h3>Common Issues:</h3>
          <ul>
            <li><strong>API Errors</strong>: Verify key permissions and connectivity</li>
            <li><strong>No Trades</strong>: Check if price movements exceed your threshold</li>
            <li><strong>Small Balances</strong>: Ensure you have sufficient funds above minimums</li>
            <li><strong>Frequent Trades</strong>: Adjust cooldown timer or increase threshold</li>
          </ul>
          <p>For additional support, consult the trade logs which detail every decision the bot makes.</p>
        </div>
      </section>
    </div>
    <div>
      <button id="closeOverlay" (click)="closeTradeInformationPanel()">Close</button>
    </div>
  </div>