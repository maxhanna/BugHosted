<div class="componentMain">
  <div class="closeButton" (click)="remove_me('MiningRigsComponent');"></div>
  <div class="refreshButton" (click)="ngOnInit();"></div>
  <div class="componentTitle">Mining Rigs</div>

  <div *ngFor="let notif of notifications" class="notification" (click)="notifications = []">{{notif}}</div>

  <div *ngIf="miningRigs.length > 0" class="miningStatusTable">
    <div class="currentProfitabilityDiv">
      <label *ngIf="showLocal" (click)="showLocal = !showLocal">Local Profitability: <span class="currentProfitabilitySpan">{{ rate != 1 ? (rate * localProfitability).toFixed(2) + " CAD" : localProfitability + " BTC"}}</span></label>
      <label *ngIf="!showLocal" (click)="showLocal = !showLocal">Actual Profitability: <span class="currentProfitabilitySpan">{{ rate != 1 ? (rate * actualProfitability).toFixed(2) + " CAD" : actualProfitability + " BTC"}}</span></label>
    </div>
    <div (click)="toggleShowAllData()" class="totalDailyEarningsDiv">
      {{ dailyEarnings[0] ? dailyEarnings[0].date.toString().split("T")[0] : '' }} Total Earnings: {{ dailyEarnings[0] ? (rate != 1 ? (rate * dailyEarnings[0].totalEarnings!).toFixed(2) + " CAD" : dailyEarnings[0].totalEarnings + " BTC") : '' }}
      <div>
        Total Weekly Earnings: {{ calculateWeeklyEarnings() }} | Daily Average: {{ calculateAverageDailyEarnings() }} 
      </div>

      <div *ngIf="showAllData">
        <table class="mainTable">
          <thead>
            <tr>
              <th>Date</th>
              <th>Total Earnings</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let earnings of dailyEarnings">
              <td>{{ earnings.date | date }}</td>
              <td>{{ rate != 1 ? (rate * earnings.totalEarnings).toFixed(2) + 'CAD' : earnings.totalEarnings + 'BTC'  }}</td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>


    <table class="mainTable miningStatusTable" id="miningRigTable">
      <thead>
        <tr>
          <th (click)="sortTable(0, 'miningRigTable')">Rig</th>
          <th title="Hottest Device Temperature">°C</th>
          <th (click)="sortTable(1, 'miningRigTable')">State</th>
          <th (click)="sortTable(3, 'miningRigTable')" title="Local Profitability" *ngIf="showLocal">{{rate != 1 ? "CAD$" : "BTC"}}</th>
          <th (click)="sortTable(3, 'miningRigTable')" title="Actual Profitability" *ngIf="!showLocal">{{rate != 1 ? "CAD$" : "BTC"}}</th>
          <th (click)="sortTable(2, 'miningRigTable')" title="Unpaid Amount">Unpaid</th>
          <th (click)="sortTable(3, 'miningRigTable')" title="Speed Rejected">Rejected</th>
          <th (click)="sortTable(4, 'miningRigTable')" title="Devices">Devices</th>
          <th></th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let rig of miningRigs">
          <td (click)="toggleDeviceDataVisibility(rig)">{{ rig.rigName }}</td>
          <td (click)="toggleDeviceDataVisibility(rig)" [style]="computeMaxDeviceTemperature(rig) >= 70 ? 'color:red;' : computeMaxDeviceTemperature(rig) >= 68 ? 'color:yellow;' : ''">{{ computeMaxDeviceTemperature(rig) }}</td>
          <td (click)="toggleDeviceDataVisibility(rig)" [style]="rig.minerStatus != 'MINING' ? 'color:red;' : ''">{{ rig.minerStatus != 'MINING' ? '🛑' : '✅' }}</td>
          <td (click)="toggleDeviceDataVisibility(rig)" *ngIf="showLocal">{{ rate != 1 ? ((rig.localProfitability ?? 0 )* rate!).toFixed(2) + '$' : rig.localProfitability }}</td>
          <td (click)="toggleDeviceDataVisibility(rig)" *ngIf="!showLocal">{{ rate != 1 ? ((rig.actualProfitability ?? 0)* rate!).toFixed(2) + '$' : rig.actualProfitability }}</td>
          <td (click)="toggleDeviceDataVisibility(rig)">{{ rig.unpaidAmount! == 0 ? 0 : rate != 1 ? ((rig.unpaidAmount ?? 0 )* rate!).toFixed(2) + '$' : (rig.unpaidAmount ?? 0).toFixed(8) }}</td>
          <td (click)="toggleDeviceDataVisibility(rig)">{{ rig.speedRejected! == 0 ? 0 : (rig.speedRejected ?? 0).toFixed(8) }}</td>
          <td (click)="toggleDeviceDataVisibility(rig)" [style]="computeDeviceCounts(rig).split(' ')[0] == '0' ? 'color:red;' : ''">{{ computeDeviceCounts(rig) }}</td>
          <td (click)="requestRigStateChange(rig)">
            <div [title]="isStopped(rig.minerStatus!) ? 'Start' : isOffline(rig.minerStatus!) ? 'Start' : 'Stop'" class="{{ isStopped(rig.minerStatus!) ? 'stopped' : isOffline(rig.minerStatus!) ? 'offline' : 'started' }}"></div>
          </td>
        </tr>
      </tbody>
    </table>
  </div>
  <div *ngIf="miningRigDevices" class="deviceListDiv miningStatusTable">
    <table class="mainTable miningStatusTable" id="deviceRigTable">
      <thead>
        <tr>
          <th (click)="sortTable(0, 'deviceRigTable')" title="Sort by Rig Name">Rig</th>
          <th (click)="sortTable(1, 'deviceRigTable')" title="Sort by Device Name">Device</th>
          <th (click)="sortTable(2, 'deviceRigTable')" title="Sort by Temperature">°C</th>
          <th (click)="sortTable(3, 'deviceRigTable')" title="Sort by State">State</th>
          <th (click)="sortTable(4, 'deviceRigTable')" title="Sort by Speed">Speed</th>
          <th (click)="sortTable(5, 'deviceRigTable')" title="Sort by Fan Speed">Fan</th>
          <th (click)="sortTable(6, 'deviceRigTable')" title="Sort by Power">Power</th>
          <th (click)="sortTable(7, 'deviceRigTable')" title="Sort by Core Clock">Core-C</th>
          <th (click)="sortTable(8, 'deviceRigTable')" title="Sort by Memory Clock">Mem-C</th>
          <th (click)="sortTable(9, 'deviceRigTable')" title="Sort by Core Voltage">C-Volt</th>
          <th (click)="sortTable(10, 'deviceRigTable')" title="Sort by Power Limit %">P%</th>
          <th (click)="sortTable(11, 'deviceRigTable')" title="Sort by Power Limit W">PW</th>
          <th (click)="sortTable(12, 'deviceRigTable')" title="Sort by Miner">Miner</th>
          <th><input type="submit" value="❌" (click)="miningRigDevices = undefined;" /></th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let device of miningRigDevices">
          <td>{{ device.rigName }}</td>
          <td>{{ device.deviceName }}</td>
          <td [style]="device.temperature! >= 70 ? 'color:red;' : device.temperature! >= 68 ? 'color:yellow;' : ''">{{ device.temperature }}</td>
          <td [style]="device.state == 1 || device.state == -1 ? 'color:red;' : device.state == 4 ? 'color:gray;' : ''">{{ device.state == 1 || device.state == -1 ? 'Offline' : device.state == 2 ? "Mining" : device.state == 3 ? "Benchmarking" : device.state == 4 ? 'Disabled' : device.state}}</td>
          <td>{{ device.speed }}</td>
          <td>{{ device.fanSpeed }}</td>
          <td>{{ device.power }}</td>
          <td>{{ device.coreClock }}</td>
          <td>{{ device.memoryClock }}</td>
          <td>{{ device.coreVoltage }}</td>
          <td>{{ device.powerLimitPercentage }}</td>
          <td>{{ device.powerLimitWatts }}</td>
          <td>{{ device.miner }}</td>
          <td (click)="requestDeviceStateChange(device)">
            <div [title]="isDeviceOffline(device.state!) ? 'Start' : isDeviceDisabled(device.state!) ? 'Start' : 'Stop'" class="{{ isDeviceOffline(device.state!) ? 'stopped' : isDeviceDisabled(device.state!) ? 'disabled' : 'started' }}"></div>
          </td>
        </tr>
      </tbody>
    </table>
  </div>
 <div *ngIf="miningRigs.length == 0">No mining rigs detected, go to your user settings and enter your nicehash API settings.</div>
</div> 
