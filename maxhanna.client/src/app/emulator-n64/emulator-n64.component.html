<div class="componentMain" [style.paddingTop]="isFullScreen ? '0px' : null">
  <div class="closeButton" (click)="remove_me('EmulatorN64Component');" *ngIf="!isFullScreen"></div>
  <div class="menuButton" (click)="showMenuPanel();" *ngIf="!isFullScreen"></div>
  <div class="componentTitle" *ngIf="!isFullScreen">N64 Emulator</div>
  <div class="gamesContainer {{ !romName ? 'expanded' : '' }}" *ngIf="!romName">
    <app-file-search [user]="parentRef?.user" [inputtedParentRef]="parentRef" [currentDirectory]="'Roms/'"
      [clearAfterSelectFile]="true" [showPrivatePublicOption]="false" [showFileSearchOptions]="false"
      [canChangeDirectory]="false" [canDragMove]="false" [displayFileActions]="true" [displayComments]="false"
      [displayFileSize]="false" [displayReactions]="false" [allowedFileTypes]="getAllowedRomFileTypes()"
      (selectFileEvent)="onFileSearchSelected($event)">
    </app-file-search>
  </div>

  <div #fullscreenContainer [style.visibility]="romName ? 'visible' : 'hidden'"
    [style.height]="romName ? (isFullScreen ? '100vh' : '') : '0px'">

    <div class="screen-area" [style.height]="!onMobile() ? '100%' : ''">
      <canvas id="canvas" #canvas slot="lcd" [attr.tabindex]="'-1'"></canvas>
    </div>
  </div>
</div>

<div class="n64-emulator-root popupPanel" *ngIf="isMenuPanelVisible">
  <div class="popupPanelTitle">N64 Emulation Menu</div>
  <div>
    <app-file-upload [currentDirectory]="'Roms'" [user]="parentRef?.user!" [inputtedParentRef]="parentRef"
      [uploadButtonText]="'Upload Rom(s)'" [maxSelectedFiles]="100" [allowedFileTypes]="getAllowedRomFileTypesString()">
    </app-file-upload>
    <button (click)="exportInGameSaveRam()" [disabled]="status !== 'running' || loading" *ngIf="romName">
      Download Save State
    </button>
    
    <input
      #saveInput
      type="file"
      (change)="importInGameSaveRam(saveInput.files)"
      accept=".eep,.sra,.fla"
      multiple
    />
    
    <button (click)="dumpSiteStorage(0)" [disabled]="status !== 'running' || loading" *ngIf="romName">
      Dump Site Storage
    </button>
  </div>
  <div class="optionsStatsWrapperDiv">
    <div class="optionsStatsDiv">
      <div class="optionsStatsHeader">Fullscreen:</div>
      <div class="optionsStatsDescription">
        <div class="uploadRomSpan upload-label" id="fullscreenBtn" (click)="toggleFullscreen()" title="Fullscreen mode">
          ◻️</div>
      </div>
    </div>
    <div class="controls">
      <div class="gamepad-controls">
        <div *ngIf="!showKeyMappings">
          <label>Controller:
            <select (change)="onSelectGamepad($any($event.target).value)" [value]="selectedGamepadIndex ?? ''">
              <option value="" disabled *ngIf="!gamepads.length">-- No controllers --</option>
              <option *ngFor="let gp of gamepads" [value]="gp.index">{{gp.index}} — {{gp.id}} {{gp.mapping ? '(' +
                gp.mapping + ')' : ''}}</option>
            </select>
          </label>
          <button (click)="refreshGamepads()">Refresh</button>
          <button (click)="startGamepadLogging()">Start Log</button>
          <button (click)="stopGamepadLogging()">Stop Log</button>
        </div>

        <!-- Mappings dropdown and save controls (applies on select) -->
        <div *ngIf="!showKeyMappings && gamepads.length">
          <label style="margin-left:8px">Mappings:
            <select (change)="onMappingSelect($any($event.target).value)">
              <option value="" disabled *ngIf="!savedMappingsNames.length">-- No mappings --</option>
              <option value="" *ngIf="savedMappingsNames.length" selected>Default</option>
              <option *ngFor="let n of savedMappingsNames" [value]="n">{{n}}</option>
            </select>
          </label>

          <div>
            <button (click)="saveMappingAs()">Save Mapping...</button>
            <button *ngIf="selectedMappingName" (click)="deleteSelectedMapping()">Delete</button>
            <button (click)="showKeyMappings = !showKeyMappings">Re-Map Controls</button>
          </div>
        </div>
      </div>

      <div class="mapping-controls" *ngIf="showKeyMappings">
        <h4>Controller Mapping</h4>
        <div *ngFor="let ctrl of n64Controls">
          <label>{{ctrl}}:
            <span *ngIf="mapping[ctrl]">{{formatMapping(mapping[ctrl])}}</span>
            <button (click)="startRecording(ctrl)">Record</button>
          </label>
        </div>
        <div class="map-actions">
          <button (click)="saveMappingAs()">Save Mapping...</button>
          <button (click)="loadMappingsList()">Refresh Mappings</button>
          <button (click)="applyMappingToEmulator()">Apply Mapping</button>
          <button (click)="showKeyMappings = false">Cancel</button>
          <button (click)="clearSelection()">Clear</button>
        </div>
        <div *ngIf="exportText">
          <h5>Export</h5>
          <textarea rows="8" cols="60" readonly>{{exportText}}</textarea>
        </div>
      </div>
    </div>

    <div class="status">Emulator Status: {{ status }} <span *ngIf="romName">— {{ romName }}</span></div>
    <div style="width:100%; text-align: center;">
      <button class="closeButton" id="closeOverlay" (click)="closeMenuPanel();">Close</button>
    </div>
  </div>