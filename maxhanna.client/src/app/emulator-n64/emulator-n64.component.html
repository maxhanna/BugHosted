<div class="n64-emulator-root">
  <div class="controls">
    <label class="file-label">
      ROM file:
      <input #romInput type="file" accept=".z64,.n64,.v64,.rom" (change)="onFileSelected($event)" />
    </label>

    <div class="gamepad-controls">
      <label>Controller:
        <select (change)="onSelectGamepad($any($event.target).value)" [value]="selectedGamepadIndex ?? ''">
          <option value="" disabled *ngIf="!gamepads.length">-- No controllers --</option>
          <option *ngFor="let gp of gamepads" [value]="gp.index">{{gp.index}} — {{gp.id}} {{gp.mapping ? '(' + gp.mapping + ')' : ''}}</option>
        </select>
      </label>
      <button (click)="refreshGamepads()">Refresh</button>
      <button (click)="startGamepadLogging()">Start Log</button>
      <button (click)="stopGamepadLogging()">Stop Log</button>
      <button (click)="directInjectMode = !directInjectMode">Direct Inject Mode {{directInjectMode ? 'ON' : 'OFF'}}</button>
    </div>

    <div class="file-search-toggle">
      <button (click)="showFileSearch = !showFileSearch">{{ showFileSearch ? 'Hide ROM Search' : 'Search ROMs' }}</button>
    </div>
    <div *ngIf="showFileSearch" class="file-search-panel">
      <app-file-search 
        [allowedFileTypes]="getAllowedRomFileTypes()" 
        (selectFileEvent)="onFileSearchSelected($event)" 
        [fileSearchMode]="true"
        [user]="parentRef?.user" 
        [inputtedParentRef]="parentRef" 
        [currentDirectory]="'Roms/'"
        [clearAfterSelectFile]="true" 
        [showPrivatePublicOption]="false"
        [showFileSearchOptions]="false" 
        [canChangeDirectory]="false" 
        [canDragMove]="false" 
        [displayFileActions]="true"
        [displayComments]="false" 
        [displayFileSize]="false" 
        [displayReactions]="false"
        ></app-file-search>
    </div>

    <div class="mapping-controls">
      <h4>Controller Mapping</h4>
      <div *ngFor="let ctrl of n64Controls">
        <label>{{ctrl}}:
          <span *ngIf="mapping[ctrl]">{{formatMapping(mapping[ctrl])}}</span>
          <button (click)="startRecording(ctrl)">Record</button>
        </label>
      </div>
      <div class="map-actions">
        <button (click)="saveMapping()">Save Mapping</button>
        <button (click)="loadMapping()">Load Mapping</button>
        <button (click)="exportMapping()">Export Mapping</button>
        <button (click)="applyMappingToEmulator()">Apply Mapping</button>
      </div>
      <div *ngIf="exportText">
        <h5>Export</h5>
        <textarea rows="8" cols="60" readonly>{{exportText}}</textarea>
      </div>
    </div>

    <div class="btns"> 
      <button (click)="clearSelection()">Clear</button>
    </div>
  </div>

  <div class="status">Status: {{ status }} <span *ngIf="romName">— {{ romName }}</span></div>

  <div class="screen-wrap">
    <canvas #canvas id="canvas" width="640" height="480" class="n64-canvas"></canvas>
  </div>
</div>
