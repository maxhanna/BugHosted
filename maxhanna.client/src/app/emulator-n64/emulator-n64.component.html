
<div class="componentMain" [style.paddingTop]="isFullScreen ? '0px' : null">
  <div class="closeButton" (click)="remove_me('EmulatorN64Component');" *ngIf="!isFullScreen"></div>
  <div class="menuButton" (click)="showMenuPanel();" *ngIf="!isFullScreen"></div>
  <div class="componentTitle" *ngIf="!isFullScreen">N64 Emulator</div>

  <div class="gamesContainer{{ !romName ? ' expanded' : '' }}{{isLoading ? ' is-disabled' : ''}}" *ngIf="!romName">
    <app-file-search
      [user]="parentRef?.user"
      [inputtedParentRef]="parentRef"
      [currentDirectory]="'Roms/'"
      [clearAfterSelectFile]="true"
      [showPrivatePublicOption]="false"
      [showFileSearchOptions]="false"
      [canChangeDirectory]="false"
      [canDragMove]="false"
      [displayFileActions]="true"
      [displayComments]="false"
      [displayFileSize]="false"
      [displayReactions]="false"
      [allowedFileTypes]="getAllowedRomFileTypes()"
      [disabled]="isLoading"
      (selectFileEvent)="onFileSearchSelected($event)">
    </app-file-search>
  </div>

  <div #fullscreenContainer [style.visibility]="romName ? 'visible' : 'hidden'"
       [style.height]="romName ? (isFullScreen ? '100vh' : '') : '0px'">
    <div class="screen-area" [style.height]="!onMobile() ? '100%' : ''">
      <canvas id="canvas" #canvas slot="lcd" [attr.tabindex]="'-1'"></canvas>
    </div>
  </div>
</div>

<div class="n64-emulator-root popupPanel" *ngIf="isMenuPanelVisible">
  <div class="popupPanelTitle">N64 Emulation Menu</div>

  <div *ngIf="!showKeyMappings">
    <app-file-upload
      [currentDirectory]="'Roms'"
      [user]="parentRef?.user!"
      [inputtedParentRef]="parentRef"
      [uploadButtonText]="'Upload Rom(s)'"
      [maxSelectedFiles]="100"
      [allowedFileTypes]="getAllowedRomFileTypesString()">
    </app-file-upload>

    <div style="text-align: center;">
      <div class="optionsStatsWrapperDiv">
        <div class="optionsStatsDiv">
          <div class="optionsStatsHeader">Autosave:</div>
          <div class="optionsStatsDescription">
            <label>
              <input type="checkbox" [checked]="autosave" (change)="autosave = !autosave">
              <span class="toggle-label" (click)="autosave = !autosave">{{ autosave ? 'On' : 'Off' }}</span>
            </label>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="optionsStatsWrapperDiv">
    <div class="optionsStatsDiv" *ngIf="romName && !showKeyMappings">
      <div class="optionsStatsHeader">Fullscreen:</div>
      <div class="optionsStatsDescription">
        <div class="uploadRomSpan upload-label" id="fullscreenBtn" (click)="toggleFullscreen()" title="Fullscreen mode">◻️</div>
      </div>
    </div>

    <div class="controls">
      <div class="gamepad-controls">
        <div *ngIf="!showKeyMappings">
          <label>Controller:
            <select (change)="onSelectGamepad($any($event.target).value)" [value]="selectedGamepadIndex ?? ''">
              <option value="" disabled *ngIf="!gamepads.length">-- No controllers --</option>
              <option *ngFor="let gp of gamepads" [value]="gp.index">
                {{gp.index}} — {{gp.id}} {{gp.mapping ? '(' + gp.mapping + ')' : ''}}
              </option>
            </select>
          </label>
          <button (click)="refreshGamepads()">Refresh</button>
        </div>

        <!-- Mappings dropdown and save controls -->
        <div *ngIf="!showKeyMappings && gamepads.length">
          <label style="margin-left:8px">Mappings:
            <select (change)="onMappingSelect($any($event.target).value)" [value]="selectedMappingName ?? ''">
              <option value="" *ngIf="savedMappingsNames.length">Default</option>
              <option value="" disabled *ngIf="!savedMappingsNames.length">-- No mappings --</option>
              <option *ngFor="let n of savedMappingsNames" [value]="n" [selected]="n === selectedMappingName">{{n}}</option>
            </select>
          </label>

          <div>
            <button (click)="saveMappingAs()">Save Mapping...</button>
            <button *ngIf="selectedMappingName" (click)="deleteSelectedMapping()">Delete</button>
            <button (click)="showKeyMappings = !showKeyMappings">Re-Map Controls</button>
            <button (click)="_gpPoller ? stopGamepadLogging() : startGamepadLogging();">
              {{_gpPoller ? 'Stop' : 'Start'}} Gamepad Logging
            </button>
          </div>
        </div>
      </div>

      <!-- Visual N64 Controller Mapper -->
      <div class="mapping-controls" *ngIf="showKeyMappings">
        <h4>Controller Mapping</h4>
        <div class="mapper-wrap">
          <div class="mapper-toolbar">
            <button (click)="regenDefaultForSelectedPad()">Generate Default (standard)</button>
            <button (click)="clearAllMappings()">Clear All</button>
            <label><input type="checkbox" [(ngModel)]="liveTest"> Live test</label>
          </div>

          <!-- SVG N64 pad -->
          <svg class="n64-pad-svg" viewBox="0 0 600 360" role="img" aria-label="N64 controller">
            <!-- Body silhouette -->
            <path d="M70,220 C70,120 140,60 300,60 C460,60 530,120 530,220 C530,300 490,330 420,340 C380,346 220,346 180,340 C110,330 70,300 70,220 Z"
                  fill="#2a2a2a" stroke="#555" stroke-width="2"></path>

            <!-- Analog stick (center-left) -->
            <circle class="hit analog"
                    [class.active]="isBoundPressed('Analog')"
                    (click)="onControlBubbleClick('Analog')"
                    cx="220" cy="170" r="28"></circle>
            <text x="220" y="170" class="bubble-label" text-anchor="middle" dominant-baseline="central">
              LS {{bindingLabel('Analog')}}
            </text>

            <!-- A / B -->
            <circle class="hit aBtn" (click)="onControlBubbleClick('A Button')" cx="410" cy="190" r="20"
                    [class.bound]="!!mapping['A Button']" [class.active]="isBoundPressed('A Button')"></circle>
            <text x="410" y="190" class="bubble-label">A {{bindingLabel('A Button')}}</text>

            <circle class="hit bBtn" (click)="onControlBubbleClick('B Button')" cx="370" cy="220" r="18"
                    [class.bound]="!!mapping['B Button']" [class.active]="isBoundPressed('B Button')"></circle>
            <text x="370" y="220" class="bubble-label">B {{bindingLabel('B Button')}}</text>

            <!-- Z / L / R / Start -->
            <rect class="hit zBtn" (click)="onControlBubbleClick('Z Trig')" x="285" y="240" width="30" height="22" rx="6"
                  [class.bound]="!!mapping['Z Trig']" [class.active]="isBoundPressed('Z Trig')"></rect>
            <text x="300" y="252" class="bubble-label" text-anchor="middle">Z {{bindingLabel('Z Trig')}}</text>

            <rect class="hit lBtn" (click)="onControlBubbleClick('L Trig')" x="200" y="95" width="36" height="22" rx="6"
                  [class.bound]="!!mapping['L Trig']" [class.active]="isBoundPressed('L Trig')"></rect>
            <text x="218" y="107" class="bubble-label" text-anchor="middle">L {{bindingLabel('L Trig')}}</text>

            <rect class="hit rBtn" (click)="onControlBubbleClick('R Trig')" x="364" y="95" width="36" height="22" rx="6"
                  [class.bound]="!!mapping['R Trig']" [class.active]="isBoundPressed('R Trig')"></rect>
            <text x="382" y="107" class="bubble-label" text-anchor="middle">R {{bindingLabel('R Trig')}}</text>

            <rect class="hit startBtn" (click)="onControlBubbleClick('Start')" x="290" y="190" width="20" height="20" rx="6"
                  [class.bound]="!!mapping['Start']" [class.active]="isBoundPressed('Start')"></rect>
            <text x="300" y="200" class="bubble-label" text-anchor="middle">★ {{bindingLabel('Start')}}</text>

            <!-- D-Pad (left) -->
            <g class="dpad">
              <rect class="hit dpad" (click)="onControlBubbleClick('DPad U')" x="120" y="150" width="24" height="24"
                    [class.bound]="!!mapping['DPad U']" [class.active]="isBoundPressed('DPad U')"></rect>
              <rect class="hit dpad" (click)="onControlBubbleClick('DPad D')" x="120" y="198" width="24" height="24"
                    [class.bound]="!!mapping['DPad D']" [class.active]="isBoundPressed('DPad D')"></rect>
              <rect class="hit dpad" (click)="onControlBubbleClick('DPad L')" x="96" y="174" width="24" height="24"
                    [class.bound]="!!mapping['DPad L']" [class.active]="isBoundPressed('DPad L')"></rect>
              <rect class="hit dpad" (click)="onControlBubbleClick('DPad R')" x="144" y="174" width="24" height="24"
                    [class.bound]="!!mapping['DPad R']" [class.active]="isBoundPressed('DPad R')"></rect>

              <text x="132" y="145" class="bubble-label" text-anchor="middle">D {{bindingLabel('DPad')}}</text>
            </g>

            <!-- C-Buttons cluster (upper-right) -->
            <g class="ccluster">
              <rect class="hit c" (click)="onControlBubbleClick('C Button U')" x="480" y="150" width="22" height="22"
                    [class.bound]="!!mapping['C Button U']" [class.active]="isBoundPressed('C Button U')"></rect>
              <rect class="hit c" (click)="onControlBubbleClick('C Button D')" x="480" y="198" width="22" height="22"
                    [class.bound]="!!mapping['C Button D']" [class.active]="isBoundPressed('C Button D')"></rect>
              <rect class="hit c" (click)="onControlBubbleClick('C Button L')" x="458" y="174" width="22" height="22"
                    [class.bound]="!!mapping['C Button L']" [class.active]="isBoundPressed('C Button L')"></rect>
              <rect class="hit c" (click)="onControlBubbleClick('C Button R')" x="502" y="174" width="22" height="22"
                    [class.bound]="!!mapping['C Button R']" [class.active]="isBoundPressed('C Button R')"></rect>
              <text x="492" y="145" class="bubble-label" text-anchor="middle">C {{bindingLabel('C')}}</text>
            </g>
          </svg>

          <!-- Selected control + actions -->
          <div class="mapper-actions">
            <div *ngIf="selectedControl" class="sel-row">
              <span class="sel-label">Selected:</span>
              <strong>{{selectedControl}}</strong>
              <span class="sel-binding">{{formatMapping(mapping[selectedControl])}}</span>
            </div>
            <div class="buttons-row">
              <button (click)="recordSelected()">Record</button>
              <button (click)="clearSelected()">Clear</button>
              <button (click)="saveMappingAs()">Save Mapping...</button>
              <button (click)="applyMappingToEmulator()">Apply Mapping</button>
              <button (click)="showKeyMappings = false">Close</button>
            </div>
          </div>
        </div>

        <!-- (Optional) JSON export preview -->
        <div *ngIf="exportText">
          <h5>Export</h5>
          <textarea rows="8" cols="60" readonly>{{exportText}}</textarea>
        </div>
      </div>
    </div>
  </div>

  <div class="status">Emulator Status: {{ status }} <span *ngIf="romName">— {{ romName }}</span></div>
  <div style="width:100%; text-align: center;">
    <button class="closeButton" id="closeOverlay" (click)="closeMenuPanel();">Close</button>
  </div>
</div>
