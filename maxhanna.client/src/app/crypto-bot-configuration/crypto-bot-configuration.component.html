<div>
    <!-- Bulk mode toggle -->
    <div style="display:flex; align-items:center; gap:12px; margin-bottom:12px;">
        <label><input type="checkbox" [checked]="bulkEditMode"
                (change)="bulkEditMode = $any($event.target).checked; onBulkModeToggled()" /> Bulk edit per-coin</label>
    </div>

    <!-- Strategy selector: always visible so user can change strategy while in bulk mode -->
    <div class="config-box" style="margin-bottom:12px;">
        <div class="config-header">
            <span>Strategy</span>
            <span class="info-icon" (click)="toggleExplanation($event)">i</span>
        </div>
        <select #tradeStrategySelect
            title="Choose the trading strategy you want to configure: DCA (Dollar Cost Averaging) for regular, timed investments to reduce volatility impact, or IND (Indicator-based) for trades triggered by market indicators."
            (change)="tradeStrategySelectChange()">
            <option value="DCA">DCA</option>
            <option value="IND">Indicator</option>
            <option value="HFT">High Frequency</option>
        </select>
    </div>

    <!-- To Coin and MaximumToTradeAmount were previously here but are moved into the non-bulk UI so strategy rules apply consistently -->

    <!-- Bulk table: one row per coin -->
    <div *ngIf="bulkEditMode">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px;">
            <div style="font-weight:600">Strategy: {{selectedStrategy}}</div>
            <div style="display:flex; gap:8px;">
                <button (click)="saveAllBulkModels()" [disabled]="savingAll">Save All</button>
                <button (click)="populateAllCoinsBulkModel()" [disabled]="savingAll">Reload</button>
            </div>
        </div>

        <div class="config-box">
            <div style="overflow:auto;">
                <table class="bulk-table" style="width:100%; border-collapse:collapse;">
                            <thead>
                                    <tr>
                                        <th style="text-align:left; padding:8px;">Coin</th>
                                        <th style="padding:8px;">Max From Balance</th>
                                        <th style="padding:8px;">Min Per Trade</th>
                                        <th style="padding:8px;">Max USDC per Buy</th>
                                        <th style="padding:8px;">Trade Threshold</th>
                                        <th *ngIf="!(selectedStrategy == 'IND' || selectedStrategy == 'HFT')" style="padding:8px;">Reserve Sell %</th>
                                        <th *ngIf="!(selectedStrategy == 'IND' || selectedStrategy == 'HFT')" style="padding:8px;">Coin Reserve ({{tradeToCoinValue}})</th>
                                        <th *ngIf="selectedStrategy != 'HFT'" style="padding:8px;">Max Trades</th>
                                        <th *ngIf="selectedStrategy == 'DCA'" style="padding:8px;">Stop Loss</th>
                                        <th *ngIf="selectedStrategy == 'IND'" style="padding:8px;">Stop Loss %</th>
                                        <th *ngIf="selectedStrategy == 'DCA'" style="padding:8px;">Max Trades Spike</th>
                                        <th style="padding:8px;">Actions</th>
                                    </tr>
                                </thead>
                    <tbody>
                        <tr *ngFor="let c of coins">
                            <td style="padding:8px; font-weight:600">{{c}}</td>
                            <td style="padding:8px; vertical-align:top;">
                                <input style="width:100%" [value]="bulkModel['coin:' + c]?.MaximumFromBalance"
                                    (input)="bulkModel['coin:' + c].MaximumFromBalance = $any($event.target).value; detectChange()" />
                                <div style="font-size:11px; color:var(--secondary-font-color);">{{ ((bulkModel['coin:' + c]?.MaximumFromBalance || 0) * getCoinPrice(c)) | number:'1.2-2' }} {{selectedCurrency}}</div>
                            </td>
                            <td style="padding:8px; vertical-align:top;">
                                <input style="width:100%" [value]="bulkModel['coin:' + c]?.MinimumFromTradeAmount"
                                    (input)="bulkModel['coin:' + c].MinimumFromTradeAmount = $any($event.target).value; detectChange()" />
                                <div style="font-size:11px; color:var(--secondary-font-color);">{{ ((bulkModel['coin:' + c]?.MinimumFromTradeAmount || 0) * getCoinPrice(c)) | number:'1.2-6' }} {{selectedCurrency}}</div>
                            </td>
                            <td style="padding:8px; vertical-align:top;">
                                <input style="width:100%" [value]="bulkModel['coin:' + c]?.MaximumToTradeAmount"
                                    (input)="bulkModel['coin:' + c].MaximumToTradeAmount = $any($event.target).value; detectChange()" />
                                <div style="font-size:11px; color:var(--secondary-font-color);">{{ bulkModel['coin:' + c]?.MaximumToTradeAmount || 0 }} {{tradeToCoinValue}}</div>
                            </td>
                            <td style="padding:8px;"><input style="width:100%" [value]="bulkModel['coin:' + c]?.TradeThreshold" (input)="bulkModel['coin:' + c].TradeThreshold = $any($event.target).value; detectChange()" /></td>
                            <td *ngIf="!(selectedStrategy == 'IND' || selectedStrategy == 'HFT')" style="padding:8px;"><input style="width:100%" [value]="bulkModel['coin:' + c]?.ReserveSellPercentage" (input)="bulkModel['coin:' + c].ReserveSellPercentage = $any($event.target).value; detectChange()" /></td>
                            <td *ngIf="!(selectedStrategy == 'IND' || selectedStrategy == 'HFT')" style="padding:8px; vertical-align:top;"><input style="width:100%" [value]="bulkModel['coin:' + c]?.CoinReserveUSDCValue" (input)="bulkModel['coin:' + c].CoinReserveUSDCValue = $any($event.target).value; detectChange()" />
                                <div style="font-size:11px; color:var(--secondary-font-color);">{{ bulkModel['coin:' + c]?.CoinReserveUSDCValue || 0 }} {{tradeToCoinValue}}</div>
                            </td>
                            <td *ngIf="selectedStrategy != 'HFT'" style="padding:8px;"><input style="width:100%" [value]="bulkModel['coin:' + c]?.MaxTradeTypeOccurances" (input)="bulkModel['coin:' + c].MaxTradeTypeOccurances = $any($event.target).value; detectChange()" /></td>
                            <td *ngIf="selectedStrategy == 'DCA'" style="padding:8px;"><input style="width:100%" [value]="bulkModel['coin:' + c]?.TradeStopLoss" (input)="bulkModel['coin:' + c].TradeStopLoss = $any($event.target).value; detectChange()" />
                                <div style="font-size:11px; color:var(--secondary-font-color);">{{ bulkModel['coin:' + c]?.TradeStopLoss ? (bulkModel['coin:' + c]?.TradeStopLoss | number:'1.2-2') + ' ' + tradeToCoinValue : '' }}</div>
                            </td>
                            <td *ngIf="selectedStrategy == 'IND'" style="padding:8px;"><input style="width:100%" [value]="bulkModel['coin:' + c]?.TradeStopLossPercentage" (input)="bulkModel['coin:' + c].TradeStopLossPercentage = $any($event.target).value; detectChange()" /></td>
                            <td *ngIf="selectedStrategy == 'DCA'" style="padding:8px;"><input style="width:100%" [value]="bulkModel['coin:' + c]?.VolumeSpikeMaxTradeOccurance" (input)="bulkModel['coin:' + c].VolumeSpikeMaxTradeOccurance = $any($event.target).value; detectChange()" /></td>
                            <td style="padding:8px; white-space:nowrap;">
                                <button (click)="saveCoinModel(c)" [disabled]="savingPerCoin['coin:' + c]">Save coin/strategy</button>
                            </td>
                        </tr>
                    </tbody>
                    <tfoot>
                        <tr style="font-weight:600;">
                            <td style="padding:8px;">Totals</td>
                            <td style="padding:8px;">{{ totals.totalMaxFromBalance | number:'1.2-2' }} {{selectedCurrency}}</td>
                            <td style="padding:8px;">{{ totals.totalMinPerTradeFiat | number:'1.2-6' }} {{selectedCurrency}}</td>
                            <td style="padding:8px;">{{ totals.totalMaxUSDCPerBuy | number:'1.2-2' }} {{tradeToCoinValue}}</td>
                            <td style="padding:8px;"></td>
                            <td style="padding:8px;"></td>
                            <td style="padding:8px;">{{ totals.totalCoinReserveUSDC | number:'1.2-2' }} {{tradeToCoinValue}}</td>
                            <td style="padding:8px;"></td>
                            <td style="padding:8px;"></td>
                            <td style="padding:8px;"></td>
                            <td style="padding:8px;"></td>
                            <td style="padding:8px;"></td>
                        </tr>
                    </tfoot>
                </table>
            </div>
        </div>
    </div>

    <!-- When bulk mode is disabled, show the existing full UI -->
    <div *ngIf="!bulkEditMode" class="config-grid-container">

        <!-- From Coin -->
        <div class="config-box">
            <div class="config-header">
                <span>From Coin</span>
                <span class="info-icon" (click)="toggleExplanation($event)">i</span>
            </div>
            <select #tradeFromCoinSelect title="Select the cryptocurrency you want to sell or trade from." (change)="tradeFromCoinSelectChange()">
                <option value="XBT">BTC</option>
                <option value="ETH">ETH</option>
                <option value="XRP">XRP</option>
                <option value="SOL">SOL</option>
                <option value="XDG">XDG</option>
            </select>
            <div class="config-explanation">
                <p><strong>What it does:</strong> This dropdown lets you pick the cryptocurrency you'll be selling or trading fromâ€”essentially, the "source" coin in your trading pair. For DCA, you have a broader selection (e.g., BTC, ETH, XRP), while IND restricts you to BTC only due to its strategy-specific requirements.</p>
            </div>
        </div>

        <!-- To Coin (moved back here so strategy rules apply) -->
        <div class="config-box">
            <div class="config-header">
                <span>To Coin</span>
                <span class="info-icon" (click)="toggleExplanation($event)">i</span>
            </div>
            <select #tradeToCoinSelect
                title="Select the cryptocurrency you want to receive or trade to. Currently, only USDC is supported as the target coin.">
                <option value="USDC">USDC</option>
            </select>
        </div>

    <!-- Max USDC per buy -->
    <div class="config-box" [style.display]="selectedStrategy == 'HFT' ? 'none' : 'flex'">
            <div class="config-header"><span>Max USDC per Buy</span><span class="info-icon" (click)="toggleExplanation($event)">i</span></div>
            <input type="number" #tradeMaximumToTradeAmount
                title="Set the maximum amount of USDC that can be spent in a single buy transaction." />
        </div>

        <div class="config-box">
            <div class="config-header">
                <span>Spread Trigger</span>
                <span class="info-icon" (click)="toggleExplanation($event)">i</span>
            </div>
            <input type="number" #tradeTradeThreshold
                title="Specify the minimum percentage spread required to trigger a trade." />
            <div class="config-explanation">
                <p><strong>What it does:</strong> This field sets the minimum percentage difference (or "spread")
                    between
                    the current market price and a reference price (e.g., last trade price or daily open) needed to
                    trigger
                    a trade. It's a filter to ensure trades only happen when there's enough potential profit.</p>
                <p><strong>Why it matters:</strong> Trading costs moneyâ€”fees, slippage, etc. A higher threshold ensures
                    the
                    price movement justifies those costs, avoiding trades that barely break even. It's your
                    profitability
                    gatekeeper, especially for frequent traders.</p>
                <p><strong>How to use it:</strong> A value of 0.5% to 1% is commonâ€”e.g., if BTC is $50,000, a 1%
                    threshold
                    means a $500 move triggers the trade. Set it higher (e.g., 2%) for bigger, less frequent wins, or
                    lower
                    (e.g., 0.3%) for more action. Test it against past market data if possible. The default threshold
                    for
                    triggering a trade is set at {{tradeTradeThreshold.value | number:'1.4-4'}}, which translates to {{
                    multiplyBy100(tradeTradeThreshold.value) | number:'1.2-2'}}%.</p>
            </div>
        </div>

        <!-- Sell Percentage per Trade (DCA only) -->
        <div class="config-box"
            [style.display]="(selectedStrategy == 'IND' || selectedStrategy == 'HFT') ? 'none' : 'flex'">
            <div class="config-header">
                <span>Sell % of Reserves</span>
                <span class="info-icon" (click)="toggleExplanation($event)">i</span>
            </div>
            <input type="number" (input)="detectChange()" #tradeReserveSellPercentage
                title="Set what fraction of your reserved holdings to sell per trade." />
            <div *ngIf="tradeReserveSellPercentage.value" class="currentSettings">
                Worth: {{selectedCurrency}}{{ TradeReserveSellPercentUSDValue | currencySymbol:(selectedCurrency):false
                }}
            </div>
            <div class="config-explanation">
                <p><strong>What it does:</strong> This field sets the percentage of your source coin holdings (e.g.,
                    {{normalizeCoinName(tradeFromCoinSelect?.value)}} reserves) to
                    sell in each sell transaction when you have no matching buy trades to match. It's about how much you
                    offload at a time when taking profits or cutting
                    losses.</p>
                <p><strong>Why it matters:</strong> Selling too much at once can leave you with no position to benefit
                    from
                    future gains; selling too little might not lock in enough profit. This setting fine-tunes your exit
                    strategy, balancing exposure and cash flow.</p>
                <p><strong>How to use it:</strong> Use a decimalâ€”e.g., 0.04 means selling 4% of your {{
                    normalizeCoinName(tradeFromCoinSelect?.value) }} per trade. With 1
                    {{tradeFromCoinSelect?.value?.replace('XBT', 'BTC')}}, that's 0.04
                    {{normalizeCoinName(tradeFromCoinSelect?.value)}} sold. Set 0.02 (2%) for gradual exits, or 0.1
                    (10%) for quicker liquidation. Pair
                    this with market trends to time your sales effectively. The default percentage is set at
                    {{ tradeReserveSellPercentage.value | number:'1.2-2'}}, which translates to {{
                    multiplyBy100(tradeReserveSellPercentage.value) | number:'1.2-2'}}%.</p>
            </div>
        </div>


        <!-- Min USDC to Start Trading (DCA only) -->
        <div class="config-box"
            [style.display]="(selectedStrategy == 'IND' || selectedStrategy == 'HFT') ? 'none' : 'flex'">
            <div class="config-header">
                <span>{{tradeToCoinValue}} Value of {{tradeFromCoinSelect?.value}} Reserves</span>
                <span class="info-icon" (click)="toggleExplanation($event)">i</span>
            </div>
            <input type="number" (input)="detectChange()" #tradeCoinReserveUSDCValue min="5"
                title="Set the minimum amount of USDC needed to reserve and start trading." />
            <div class="config-explanation">
                <p><strong>What it does:</strong> This field sets the minimum USDC balance required in your wallet
                    before
                    trading begins/creating a reserve. It's the cash reserve your bot will use when all trades have been
                    matched and if price keeps rising beyond.</p>
                <p><strong>Why it matters:</strong> This ensures you've got enough stablecoin to 1- start trading and 2-
                    cover your reserves.</p>
                <p><strong>How to use it:</strong> Try $100 as a starting pointâ€”enough for a small
                    {{normalizeCoinName(tradeFromCoinSelect?.value)}} buy. If you're planning bigger trades, bump it to
                    $500 or more. Check your exchange's minimum
                    buy amounts and add a buffer for fees or price swings. Make this above 5.</p>
            </div>
        </div>

    <!-- Max Consecutive Buy/Sell Trades -->
    <div class="config-box" [style.display]="selectedStrategy == 'HFT' ? 'none' : 'flex'">
            <div class="config-header">
                <span>Max Consecutive Trades</span>
                <span class="info-icon" (click)="toggleExplanation($event)">i</span>
            </div>
            <input type="number" #tradeTradeMaximumTypeOccurances
                title="Set the maximum number of times a trade type (buy or sell) can occur." />
            <div class="config-explanation">
                <p><strong>What it does:</strong> This field limits how many buy or sell trades your bot can execute
                    consecutively, depending on your bot's rules. For the Indicator strategy, its per 2 hours. For the
                    DCA
                    strategy, it applies separately to buys and sellsâ€”e.g., Max
                    {{tradeTradeMaximumTypeOccurances.value}}
                    consecutive buys or {{tradeTradeMaximumTypeOccurances.value}} consecutive sells.</p>
                <p><strong>Why it matters:</strong> Overtrading can lead to losses from fees or bad timing, especially
                    in
                    choppy markets. This cap keeps your bot disciplined, preventing it from going wild during volatility
                    and
                    burning through your funds.</p>
                <p><strong>How to use it:</strong> Set to 5 for a balanced approachâ€”5 buys and 5 sells daily or in a
                    row.
                    Drop to 2 or 3 for caution, or raise to 10 if you're chasing frequent action. Check your strategy's
                    pace
                    and market conditions to find the sweet spot.</p>
            </div>
        </div>

        <!-- Max Trades During Volume Spikes (DCA only) -->
        <div class="config-box"
            [style.display]="(selectedStrategy == 'IND' || selectedStrategy == 'HFT') ? 'none' : 'flex'">
            <div class="config-header">
                <span>Max Trades During Spikes</span>
                <span class="info-icon" (click)="toggleExplanation($event)">i</span>
            </div>
            <input type="number" #tradeVolumeSpikeMaxTradeOccurance
                title="Set a lower maximum for trade occurrences during volume spikes." />
            <div class="config-explanation">
                <p><strong>What it does:</strong> This field lowers the trade limit during high-volume market periods
                    (e.g.,
                    sudden price jumps). It overrides the regular Max Buy/Sell Trades when the bot detects a volume
                    spike.
                </p>
                <p><strong>Why it matters:</strong> High volume often means high volatilityâ€”great for gains, but risky
                    for
                    losses. Cutting trades here protects you from erratic moves, letting the market settle before
                    jumping
                    back in fully.</p>
                <p><strong>How to use it:</strong> Set lower than your regular limitâ€”e.g., 2 or 3 if your normal is 5.
                    If
                    you're at 10 normally, try 4 here. It's your "calm down" switch for crazy market days. Tweak based
                    on
                    how much chaos you can handle.</p>
            </div>
        </div>

    <!-- Stop-Loss Price (DCA only) -->
    <div class="config-box" [style.display]="selectedStrategy == 'DCA' ? 'flex' : 'none'">
            <div class="config-header">
                <span>Stop-Loss Price</span>
                <span class="info-icon" (click)="toggleExplanation($event)">i</span>
            </div>
            <input type="number" #tradeStopLoss
                title="For DCA, set a USDC price point to liquidate your entire BTC position." />
            <div class="config-explanation">
                <p><strong>What it does:</strong> Exclusive to DCA, this field sets a specific USDC price for
                    {{normalizeCoinName(tradeFromCoinSelect?.value)}}
                    at which your bot sells everything if the price drops to or below this level. It's your
                    hard stop to exit the position entirely.</p>
                <p><strong>Why it matters:</strong> DCA builds positions over time, but a big crash can erase gains.
                    This
                    stop-loss caps your downside, protecting your capital from a prolonged bear market or sudden
                    collapseâ€”it's your panic button with a price tag.</p>
                <p><strong>How to use it:</strong> If your average {{normalizeCoinName(tradeFromCoinSelect?.value)}} buy
                    price is $50,000, set this 10% lower at $45,000
                    to limit losses. If {{normalizeCoinName(tradeFromCoinSelect?.value)}} hits $45,000, it's all sold to
                    USDC. Set tighter (e.g., $48,000) for caution, or
                    looser (e.g., $40,000) for more risk tolerance. Set it to 0 to have no stop-loss. Track your average
                    cost to set this smartly.</p>
            </div>
        </div>

    <!-- IND Stop-Loss Percentage (IND only) -->
    <div class="config-box" [style.display]="selectedStrategy == 'IND' ? 'flex' : 'none'">
            <div class="config-header">
                <span>IND Stop-Loss %</span>
                <span class="info-icon" (click)="toggleExplanation($event)">i</span>
            </div>
            <input type="number" #tradeStopLossPercentage
                title="For IND, set a percentage drop from the purchase price to liquidate your {{normalizeCoinName(tradeFromCoinSelect?.value)}} position." />
            <div class="config-explanation">
                <p><strong>What it does:</strong> For the indicator strategy only, this field triggers a full sell-off
                    of
                    your {{normalizeCoinName(tradeFromCoinSelect?.value)}} if its price drops by this percentage from
                    your purchase price. It's a dynamic stop-loss tied
                    to your entry point, not a fixed price.</p>
                <p><strong>Why it matters:</strong> The indicator strategy relies on indicators for timing, but markets
                    can
                    defy signals. This protects you from holding a losing position too long, automatically cutting
                    losses
                    when the trade sours beyond your set limit.</p>
                <p><strong>How to use it:</strong> Enter a number like 5 (no % sign)â€”if you bought
                    {{normalizeCoinName(tradeFromCoinSelect?.value)}} at $50,000, a 5% drop
                    to $47,500 triggers a sell. Use 3 for tight control, or 10 if you're okay riding bigger dips. It's
                    your
                    "get out" rule based on your entry, so know your average buy price.</p>
            </div>
        </div>

        <!-- Save Button -->
        <div class="config-box save-box">
            <div class="config-header">
                <span>Last Updated: {{tradeConfigLastUpdated || 'Never'}}</span>
            </div>
            <button (click)="updateCoinConfiguration()" [disabled]="isLoading">ðŸ’¾ Save Configuration</button>
        </div>
    </div>